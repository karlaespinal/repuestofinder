<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Cambiar clave</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --line:#e5e7eb;
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:var(--txt);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .card{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:18px;
    }
    h1{margin:0 0 6px;font-size:20px}
    .muted{color:var(--mut);font-size:12px;font-weight:800}
    .field{margin-top:14px}
    label{display:block;font-size:12px;font-weight:900;margin-bottom:6px}
    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-weight:800;
    }
    input:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      border:0;
      cursor:pointer;
      font-weight:900;
      border-radius:12px;
      padding:12px 14px;
    }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnGhost{background:#fff;border:1px solid var(--line)}
    .msg{
      margin-top:14px;
      font-size:12px;
      font-weight:900;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(37,99,235,.20);
      background:rgba(37,99,235,.08);
      display:none;
    }
    .msg.err{
      border-color:rgba(239,68,68,.20);
      background:rgba(239,68,68,.08);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Cambiar contraseña</h1>
    <div class="muted" id="subtitle">Verificando enlace…</div>

    <div class="field">
      <label>Nueva clave</label>
      <input id="pw1" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" disabled>
    </div>

    <div class="field">
      <label>Confirmar nueva clave</label>
      <input id="pw2" type="password" placeholder="Repite la clave" autocomplete="new-password" disabled>
    </div>

    <div class="row">
      <button class="btnPrimary" id="btnSave" disabled>Guardar</button>
      <button class="btnGhost" id="btnGo" style="display:none">Ir al Dashboard</button>
    </div>

    <div class="msg" id="msg"></div>
  </div>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";

    const $ = (id)=>document.getElementById(id);
    function setMsg(text, isErr=false){
      const el = $("msg");
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    async function init(){
      // Esto detecta si el link fue de RECOVERY
      const { data } = await supabase.auth.getSession();
      const user = data?.session?.user;

      if(!user){
        $("subtitle").textContent = "Este enlace no tiene sesión válida. Vuelve a pedir el reset.";
        setMsg("No hay sesión de recuperación activa.", true);
        return;
      }

      $("subtitle").textContent = "Listo. Escribe tu nueva clave.";
      $("pw1").disabled = false;
      $("pw2").disabled = false;
      $("btnSave").disabled = false;
    }

    $("btnSave").addEventListener("click", async ()=>{
      const pw1 = $("pw1").value.trim();
      const pw2 = $("pw2").value.trim();

      if(pw1.length < 6) return setMsg("La clave debe tener al menos 6 caracteres.", true);
      if(pw1 !== pw2) return setMsg("Las claves no coinciden.", true);

      setMsg("Guardando…");

      const { error } = await supabase.auth.updateUser({ password: pw1 });

      if(error){
        setMsg("Error actualizando clave: " + error.message, true);
        return;
      }

      setMsg("✅ Clave actualizada. Ya puedes iniciar sesión.", false);
      $("btnGo").style.display = "";
      $("btnGo").onclick = ()=> location.href = "index.html";
    });

    init();
  </script>
</body>
</html>
