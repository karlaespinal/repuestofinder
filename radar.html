<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Radar de Demanda</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.92);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --dark:#111;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(rgba(246,247,251,.92), rgba(246,247,251,.92)),
        url("assets/bg.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      min-height:100vh;
    }
    .page{ width:min(1180px, 100%); margin:0 auto; padding:18px 18px 28px; }

    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background:rgba(246,247,251,.68);
      border:1px solid rgba(230,232,240,.75);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900; user-select:none;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .brandTitle{line-height:1}
    .brandTitle b{display:block;font-size:15px}
    .brandTitle span{display:block;font-size:12px;color:#94a3b8;font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-top:2px}

    .navRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:10px 12px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnGhost{background:#fff;border:1px solid var(--line);color:#0f172a}

    .hero{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .hero h1{ margin:0; font-size:26px; letter-spacing:-.2px; }
    .hero p{ margin:10px 0 0; color:var(--mut); font-size:14px; line-height:1.45; max-width:900px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.88);
      box-shadow:0 10px 26px rgba(2,6,23,.06);
      padding:14px;
    }
    .card h2{margin:0;font-size:14px;font-weight:900}
    .sub{font-size:12px;color:#94a3b8;font-weight:900;letter-spacing:.4px;text-transform:uppercase;margin-top:4px}

    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 160px;
      border:1px solid rgba(230,232,240,.9);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:#94a3b8;font-weight:900;text-transform:uppercase;letter-spacing:.4px}
    .kpi .v{font-size:18px;font-weight:900;margin-top:6px}
    .kpi .s{font-size:12px;color:var(--mut);margin-top:6px;line-height:1.35}

    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .inp{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:800;
      outline:none;
      color:#0f172a;
    }
    .inp:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .select{ min-width:180px; }
    .text{ min-width:220px; flex:1 1 240px; }

    .tableWrap{
      margin-top:10px;
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      overflow:auto;
      background:#fff;
    }
    table{width:100%;border-collapse:collapse}
    th,td{
      padding:10px;
      border-bottom:1px solid #eef0f6;
      font-size:13px;
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky; top:0; z-index:1;
      background:#fafbff;
      font-weight:900;
      color:#0f172a;
    }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(230,232,240,.95);
      background:rgba(37,99,235,.08);
      color:var(--pri);
      white-space:nowrap;
    }
    .bOk{ background:rgba(16,185,129,.10); color:var(--ok); border-color:rgba(16,185,129,.25); }
    .bBad{ background:rgba(239,68,68,.10); color:var(--bad); border-color:rgba(239,68,68,.25); }
    .bWarn{ background:rgba(245,158,11,.10); color:var(--warn); border-color:rgba(245,158,11,.25); }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      padding:10px 12px;
      border-radius:14px;
      display:none;
    }
    .msg.err{ background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.18); }

    .footer{ margin-top:14px; text-align:center; color:#94a3b8; font-size:12px; font-weight:800; }
  </style>
</head>
<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="logo">RF</div>
        <div class="brandTitle">
          <b>RepuestoFinder</b>
          <span>Radar de Demanda</span>
        </div>
      </div>

      <div class="navRight">
        <button class="btn btnGhost" onclick="goIndex()">Volver</button>
        <button class="btn btnGhost" onclick="goApp()">Ir a la App</button>
        <button class="btn btnPrimary" onclick="refreshAll()">Actualizar</button>
      </div>
    </div>

    <div class="hero">
      <h1>Radar de Demanda RD & eBay</h1>
      <p>
        Este panel combina: (1) lo que la gente busca dentro de RepuestoFinder y (2) una señal externa (eBay) para detectar
        modelos, años, motores y oportunidades por línea (frenos, suspensión, motor, etc.).
        <b>No depende de precios</b>: detecta tendencia y demanda.
      </p>

      <div class="filters">
        <select id="range" class="inp select">
          <option value="1">Últimas 24 horas</option>
          <option value="7" selected>Últimos 7 días</option>
          <option value="30">Últimos 30 días</option>
        </select>

        <select id="category" class="inp select">
          <option value="">Todas las líneas</option>
          <option value="frenos">Frenos</option>
          <option value="suspension">Suspensión</option>
          <option value="motor">Motor</option>
          <option value="electrico">Eléctrico</option>
          <option value="cooling">Cooling</option>
          <option value="transmision">Transmisión</option>
          <option value="otros">Otros</option>
        </select>

        <input id="q" class="inp text" placeholder="Filtrar (ej: corolla, civic, 2012, rear axle brake)" />

        <button class="btn btnGhost" onclick="resetFilters()">Limpiar</button>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">Búsquedas</div>
          <div class="v" id="k1">—</div>
          <div class="s">Total en el rango seleccionado.</div>
        </div>
        <div class="kpi">
          <div class="t">No encontrado</div>
          <div class="v" id="k2">—</div>
          <div class="s">Oportunidad (gap de catálogo).</div>
        </div>
        <div class="kpi">
          <div class="t">Tasa de oportunidad</div>
          <div class="v" id="k3">—</div>
          <div class="s">% búsquedas sin resultado.</div>
        </div>
      </div>

      <div class="msg" id="msg"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Top Búsquedas (interno)</h2>
        <div class="sub">Lo más buscado en tu sistema</div>
        <div class="tableWrap">
          <table id="tTop">
            <thead>
              <tr>
                <th>Query</th>
                <th>Línea</th>
                <th>Veces</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Oportunidades (alto “no encontrado”)</h2>
        <div class="sub">Demanda sin cobertura (ideal para importación)</div>
        <div class="tableWrap">
          <table id="tOpp">
            <thead>
              <tr>
                <th>Query</th>
                <th>Línea</th>
                <th>Veces</th>
                <th>No encontrado</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Señal eBay (externo)</h2>
        <div class="sub">Preparado para traer tendencias por modelos/años/motores</div>

        <div class="msg" style="display:block">
          eBay no se consulta directo desde el navegador (para no exponer keys).
          Lo correcto es usar una <b>Supabase Edge Function</b> que consulte eBay y devuelva:
          top modelos, años, motores y marcas por categoría.
        </div>

        <div class="tableWrap" style="margin-top:10px">
          <table id="tEbay">
            <thead>
              <tr>
                <th>Modelo / Motor</th>
                <th>Línea</th>
                <th>Señal</th>
                <th>Notas</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="badge bWarn">Pendiente</span></td>
                <td>—</td>
                <td>—</td>
                <td>Conectaremos eBay vía Edge Function.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">© <span id="y"></span> RepuestoFinder</div>
  </div>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";
    const $ = (id)=>document.getElementById(id);

    function setMsg(text, isErr){
      const el = $("msg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    function dtFromRange(days){
      const d = new Date();
      d.setDate(d.getDate() - Number(days || 7));
      return d.toISOString();
    }

    function esc(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    function badgeStatus(result_status){
      if(result_status === "found") return `<span class="badge bOk">found</span>`;
      if(result_status === "not_found") return `<span class="badge bBad">not_found</span>`;
      return `<span class="badge">unknown</span>`;
    }

    function filterRows(rows){
      const q = ($("q").value || "").trim().toLowerCase();
      const cat = ($("category").value || "").trim().toLowerCase();
      return rows.filter(r=>{
        if(cat && String(r.category||"").toLowerCase() !== cat) return false;
        if(q){
          const hay = (String(r.query_raw||"") + " " + String(r.category||"") + " " + String(r.result_status||"")).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    async function loadKpis(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("id, result_status, category, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const total = (data||[]).length;
      const nf = (data||[]).filter(x=>x.result_status==="not_found").length;
      const pct = total ? Math.round((nf/total)*1000)/10 : 0;

      $("k1").textContent = String(total);
      $("k2").textContent = String(nf);
      $("k3").textContent = pct.toFixed(1) + "%";
    }

    async function loadTop(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      // Agrupar por query_raw + category y contar
      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, last_status:r.result_status };
        cur.n += 1;
        cur.last_status = r.result_status || cur.last_status;
        map.set(key, cur);
      }
      let rows = Array.from(map.values()).sort((a,b)=> b.n - a.n);

      rows = filterRows(rows);

      const tbody = $("tTop").querySelector("tbody");
      tbody.innerHTML = rows.slice(0,20).map(r=>`
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "—")}</span></td>
          <td><b>${r.n}</b></td>
          <td>${badgeStatus(r.last_status)}</td>
        </tr>
      `).join("") || `<tr><td colspan="4" style="color:#64748b;font-weight:800">Sin datos para el filtro.</td></tr>`;
    }

    async function loadOpp(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      // Agrupar y medir not_found
      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, nf:0 };
        cur.n += 1;
        if(r.result_status === "not_found") cur.nf += 1;
        map.set(key, cur);
      }

      let rows = Array.from(map.values())
        .map(x=>({ ...x, pct: x.n ? Math.round((x.nf/x.n)*1000)/10 : 0 }))
        .filter(x=> x.n >= 2) // mínimo 2 ocurrencias
        .sort((a,b)=> (b.pct - a.pct) || (b.n - a.n));

      rows = filterRows(rows);

      const tbody = $("tOpp").querySelector("tbody");
      tbody.innerHTML = rows.slice(0,20).map(r=>`
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "—")}</span></td>
          <td><b>${r.n}</b></td>
          <td><span class="badge bBad">${r.nf}</span></td>
          <td><span class="badge bWarn">${r.pct.toFixed(1)}%</span></td>
        </tr>
      `).join("") || `<tr><td colspan="5" style="color:#64748b;font-weight:800">Sin oportunidades para el filtro.</td></tr>`;
    }

    window.goIndex = function(){ window.location.href = "index.html"; };
    window.goApp = function(){ window.location.href = "app.html"; };

    window.resetFilters = function(){
      $("range").value = "7";
      $("category").value = "";
      $("q").value = "";
      refreshAll();
    };

    window.refreshAll = async function(){
      try{
        setMsg("Cargando radar...", false);
        await loadKpis();
        await loadTop();
        await loadOpp();
        setMsg("", false);
      }catch(e){
        setMsg("Error: " + (e?.message || e), true);
      }
    };

    ["range","category"].forEach(id=>{
      $(id).addEventListener("change", ()=> refreshAll());
    });
    $("q").addEventListener("input", ()=>{
      // filtra sin re-consultar: solo vuelve a pintar tablas con data actual sería mejor,
      // pero por simpleza recargamos (si luego quieres optimizamos)
      refreshAll();
    });

    document.getElementById("y").textContent = new Date().getFullYear();
    refreshAll();
  </script>
</body>
</html>
