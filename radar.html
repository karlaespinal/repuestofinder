<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Radar de Demanda</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.92);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(rgba(246,247,251,.92), rgba(246,247,251,.92)),
        url("assets/bg.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      min-height:100vh;
      overflow-x:hidden;
    }

    .page{
      width:100%;
      max-width: 100vw;
      margin:0 auto;
      padding:18px 22px 28px;
    }
    @media(min-width:1400px){
      .page{ padding-left:34px; padding-right:34px; }
    }

    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background:rgba(246,247,251,.68);
      border:1px solid rgba(230,232,240,.75);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900; user-select:none;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .brandTitle{line-height:1}
    .brandTitle b{display:block;font-size:15px}
    .brandTitle span{display:block;font-size:12px;color:#94a3b8;font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-top:2px}

    .navRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:10px 12px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnGhost{background:#fff;border:1px solid var(--line);color:#0f172a}

    .hero{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .hero h1{ margin:0; font-size:26px; letter-spacing:-.2px; }
    .hero p{ margin:10px 0 0; color:var(--mut); font-size:14px; line-height:1.45; max-width:1000px; }

    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .inp{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:800;
      outline:none;
      color:#0f172a;
    }
    .inp:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .select{ min-width:180px; }
    .text{ min-width:240px; flex:1 1 320px; }

    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 220px;
      border:1px solid rgba(230,232,240,.9);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:#94a3b8;font-weight:900;text-transform:uppercase;letter-spacing:.4px}
    .kpi .v{font-size:18px;font-weight:900;margin-top:6px}
    .kpi .s{font-size:12px;color:var(--mut);margin-top:6px;line-height:1.35}

    .gridMain{
      display:grid;
      grid-template-columns: 340px 1fr 1fr;
      grid-template-areas:
        "brands top opp"
        "brands ebay google";
      gap:12px;
      margin-top:14px;
      align-items:start;
    }
    .areaBrands{ grid-area: brands; }
    .areaTop{ grid-area: top; }
    .areaOpp{ grid-area: opp; }
    .areaEbay{ grid-area: ebay; }
    .areaGoogle{ grid-area: google; }

    @media(max-width:1200px){
      .gridMain{
        grid-template-columns: 1fr;
        grid-template-areas:
          "brands"
          "top"
          "opp"
          "ebay"
          "google";
      }
    }

    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.88);
      box-shadow:0 10px 26px rgba(2,6,23,.06);
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0;font-size:14px;font-weight:900}
    .sub{font-size:12px;color:#94a3b8;font-weight:900;letter-spacing:.4px;text-transform:uppercase;margin-top:4px}

    .tableWrap{
      margin-top:10px;
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      overflow:auto;
      background:#fff;
    }
    .tableWrap.compact{ max-height: 340px; }
    @media(min-width:1200px){
      .tableWrap.tall{ max-height: 540px; }
    }

    table{width:100%;border-collapse:collapse}
    th,td{
      padding:10px;
      border-bottom:1px solid #eef0f6;
      font-size:13px;
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky; top:0; z-index:1;
      background:#fafbff;
      font-weight:900;
      color:#0f172a;
    }

    .badge{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(230,232,240,.95);
      background:rgba(37,99,235,.08);
      color:var(--pri);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin:2px 4px 2px 0;
    }

    .badgeOffer{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.25);
      background:rgba(16,185,129,.10);
      color:#065f46;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badgeOffer.off0{
      border-color:rgba(148,163,184,.55);
      background:rgba(148,163,184,.14);
      color:rgba(30,41,59,.85);
    }

    .bOk{ background:rgba(16,185,129,.10); color:var(--ok); border-color:rgba(16,185,129,.25); }
    .bBad{ background:rgba(239,68,68,.10); color:var(--bad); border-color:rgba(239,68,68,.25); }
    .bWarn{ background:rgba(245,158,11,.10); color:var(--warn); border-color:rgba(245,158,11,.25); }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      padding:10px 12px;
      border-radius:14px;
      display:none;
    }
    .msg.err{ background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.18); }

    .mut{ color:#64748b; font-weight:800; }
    .footer{ margin-top:14px; text-align:center; color:#94a3b8; font-size:12px; font-weight:800; }

    .hideEbayCols th:nth-child(3),
    .hideEbayCols th:nth-child(4),
    .hideEbayCols td:nth-child(3),
    .hideEbayCols td:nth-child(4){
      display:none;
    }

    /* âœ… NUEVO: botÃ³n clickable para modelo */
    .chipBtn{
      border:0;
      background:transparent;
      padding:0;
      cursor:pointer;
      font:inherit;
    }
    .chipBtn:active{ transform: translateY(1px); }

    /* âœ… NUEVO: Modal de detalle de cÃ³digos por modelo */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }
    .modal{
      width:min(900px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(230,232,240,.95);
      box-shadow:0 30px 90px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      background:rgba(246,247,251,.75);
      border-bottom:1px solid rgba(230,232,240,.95);
    }
    .modalHead b{ font-size:14px; }
    .modalBody{ padding:12px 14px; }
    .modalBody .mut{ font-size:12px; }
    .modalClose{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:8px 10px;
      background:#fff; border:1px solid rgba(230,232,240,.95);
    }
  
    /* âœ… NUEVO: Modal MAPA */
    .mapModal{
      width:min(1100px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(230,232,240,.95);
      box-shadow:0 30px 90px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .mapGrid{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:12px;
      padding:12px 14px 14px;
    }
    @media(max-width:900px){
      .mapGrid{ grid-template-columns: 1fr; }
    }
    .mapSide{
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      padding:12px;
      background:#fff;
      overflow:auto;
      max-height: 560px;
    }
    .mapSide h3{ margin:0 0 8px; font-size:13px; font-weight:900; }
    .mapSide .mut{ font-size:12px; }
    .barRow{
      display:flex; align-items:center; gap:10px;
      margin:8px 0;
    }
    .barLbl{
      width:120px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .bar{
      flex:1;
      height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.20);
      overflow:hidden;
      border:1px solid rgba(230,232,240,.95);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(37,99,235,.85), rgba(16,185,129,.65));
      border-radius:999px;
    }
    .barPct{
      width:54px;
      text-align:right;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
    }
    /* âœ… MAPA: mejora visual (ocÃ©ano + brillo + grilla sutil) */
/* âœ… MAPA: mejora visual (ocÃ©ano + brillo + grilla sutil) */
.mapCanvas{
  border:1px solid rgba(230,232,240,.95);
  border-radius:16px;
  background:
    radial-gradient(900px 420px at 20% 15%, rgba(37,99,235,.16), transparent 55%),
    radial-gradient(900px 420px at 80% 35%, rgba(16,185,129,.12), transparent 55%),
    radial-gradient(1200px 650px at 50% 110%, rgba(2,6,23,.06), transparent 55%),
    linear-gradient(180deg, rgba(2,132,199,.10), rgba(15,23,42,.02));
  padding:12px;
  position:relative;
  overflow:hidden;
  min-height: 360px;
}
.mapCanvas:before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(rgba(255,255,255,.35) 1px, transparent 1px);
  background-size: 18px 18px;
  opacity:.22;
  pointer-events:none;
  mix-blend-mode: soft-light;
}
.mapCanvas:after{
  content:"";
  position:absolute; inset:-40px;
  background: radial-gradient(closest-side at 50% 30%, rgba(255,255,255,.35), transparent 70%);
  opacity:.25;
  pointer-events:none;
  filter: blur(10px);
}
.rfMapSvg{
  width:100%;
  height:auto;
  display:block;
  filter: drop-shadow(0 18px 28px rgba(2,6,23,.14));
  user-select:none;
  position:relative;
  z-index:1;
}
.rg{
  fill: rgba(255,255,255,.90);
  stroke: rgba(148,163,184,.70);
  stroke-width: 1;
  cursor:pointer;
  transition: .18s ease;
}
.rg:hover{
  fill: rgba(37,99,235,.14);
  stroke: rgba(37,99,235,.55);
  transform: translateY(-1px);
}
.rg.active{
  fill: rgba(37,99,235,.24);
  stroke: rgba(37,99,235,.72);
  stroke-width: 1.35;
  filter: drop-shadow(0 10px 18px rgba(37,99,235,.25));
  animation: rfPulse 1.35s ease-in-out infinite;
  transform-origin: center;
}
@keyframes rfPulse{
  0%,100%{ opacity: 1; }
  50%{ opacity: .78; }
}
.mapTooltip{
  position:absolute;
  left:14px; top:14px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(230,232,240,.95);
  border-radius:14px;
  padding:10px 12px;
  box-shadow:0 18px 38px rgba(2,6,23,.14);
  max-width: 380px;
  display:none;
  pointer-events:none;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 3;
}

  </style>
</head>

<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="logo">RF</div>
        <div class="brandTitle">
          <b>RepuestoFinder</b>
          <span>Radar de Demanda</span>
        </div>
      </div>

      <div class="navRight">
        <button class="btn btnGhost" onclick="goIndex()">Volver</button>
        <button class="btn btnGhost" onclick="goApp()">Ir a la App</button>
        <button class="btn btnGhost" onclick="openMapModal()" title="Ver mapa y distribuciÃ³n por modelos">Mapa</button>
        <button class="btn btnPrimary" onclick="refreshAll()">Actualizar</button>
      </div>
    </div>

    <div class="hero">
      <h1>Radar Mundial</h1>
      <p>
       
      </p>

      <div class="filters">
        <select id="range" class="inp select">
          <option value="1">Ãšltimas 24 horas</option>
          <option value="7" selected>Ãšltimos 7 dÃ­as</option>
          <option value="30">Ãšltimos 30 dÃ­as</option>
        </select>

        <select id="category" class="inp select">
          <option value="">Todas las lÃ­neas</option>
          <option value="frenos">Frenos</option>
          <option value="suspension">SuspensiÃ³n</option>
          <option value="motor">Motor</option>
          <option value="electrico">ElÃ©ctrico</option>
          <option value="cooling">Cooling</option>
          <option value="transmision">TransmisiÃ³n</option>
          <option value="otros">Otros</option>
        </select>

        <select id="gl" class="inp select" title="PaÃ­s (Google gl)">
          <option value="DO" selected>ğŸ‡©ğŸ‡´ RepÃºblica Dominicana (DO)</option>
          <option value="US">ğŸ‡ºğŸ‡¸ Estados Unidos (US)</option>
          <option value="MX">ğŸ‡²ğŸ‡½ MÃ©xico (MX)</option>
          <option value="CA">ğŸ‡¨ğŸ‡¦ CanadÃ¡ (CA)</option>
          <option value="ES">ğŸ‡ªğŸ‡¸ EspaÃ±a (ES)</option>
          <option value="CO">ğŸ‡¨ğŸ‡´ Colombia (CO)</option>
          <option value="CL">ğŸ‡¨ğŸ‡± Chile (CL)</option>
          <option value="PE">ğŸ‡µğŸ‡ª PerÃº (PE)</option>
          <option value="AR">ğŸ‡¦ğŸ‡· Argentina (AR)</option>
          <option value="BR">ğŸ‡§ğŸ‡· Brasil (BR)</option>
          <option value="EC">ğŸ‡ªğŸ‡¨ Ecuador (EC)</option>
          <option value="VE">ğŸ‡»ğŸ‡ª Venezuela (VE)</option>
          <option value="BO">ğŸ‡§ğŸ‡´ Bolivia (BO)</option>
          <option value="PY">ğŸ‡µğŸ‡¾ Paraguay (PY)</option>
          <option value="UY">ğŸ‡ºğŸ‡¾ Uruguay (UY)</option>
          <option value="PA">ğŸ‡µğŸ‡¦ PanamÃ¡ (PA)</option>
          <option value="CR">ğŸ‡¨ğŸ‡· Costa Rica (CR)</option>
          <option value="GT">ğŸ‡¬ğŸ‡¹ Guatemala (GT)</option>
          <option value="SV">ğŸ‡¸ğŸ‡» El Salvador (SV)</option>
          <option value="HN">ğŸ‡­ğŸ‡³ Honduras (HN)</option>
          <option value="NI">ğŸ‡³ğŸ‡® Nicaragua (NI)</option>
          <option value="PR">ğŸ‡µğŸ‡· Puerto Rico (PR)</option>
          <option value="JM">ğŸ‡¯ğŸ‡² Jamaica (JM)</option>
          <option value="FR">ğŸ‡«ğŸ‡· Francia (FR)</option>
          <option value="DE">ğŸ‡©ğŸ‡ª Alemania (DE)</option>
          <option value="IT">ğŸ‡®ğŸ‡¹ Italia (IT)</option>
          <option value="GB">ğŸ‡¬ğŸ‡§ Reino Unido (GB)</option>
          <option value="NL">ğŸ‡³ğŸ‡± PaÃ­ses Bajos (NL)</option>
          <option value="SE">ğŸ‡¸ğŸ‡ª Suecia (SE)</option>
          <option value="CH">ğŸ‡¨ğŸ‡­ Suiza (CH)</option>
          <option value="AU">ğŸ‡¦ğŸ‡º Australia (AU)</option>
          <option value="JP">ğŸ‡¯ğŸ‡µ JapÃ³n (JP)</option>
          <option value="KR">ğŸ‡°ğŸ‡· Corea del Sur (KR)</option>
        </select>

        <select id="hl" class="inp select" title="Idioma (Google hl)">
          <option value="es" selected>EspaÃ±ol (es)</option>
          <option value="en">English (en)</option>
          <option value="pt">PortuguÃªs (pt)</option>
          <option value="fr">FranÃ§ais (fr)</option>
          <option value="de">Deutsch (de)</option>
          <option value="it">Italiano (it)</option>
          <option value="nl">Nederlands (nl)</option>
          <option value="sv">Svenska (sv)</option>
          <option value="tr">TÃ¼rkÃ§e (tr)</option>
          <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ (ru)</option>
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (ar)</option>
          <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€ (hi)</option>
          <option value="ja">æ—¥æœ¬èª (ja)</option>
          <option value="ko">í•œêµ­ì–´ (ko)</option>
          <option value="zh-CN">ä¸­æ–‡(ç®€ä½“) (zh-CN)</option>
          <option value="zh-TW">ä¸­æ–‡(ç¹é«”) (zh-TW)</option>
        </select>

        <input id="q" class="inp text" placeholder="Filtrar / query (ej: corolla 2014 2017 brake pads)" />
        <button class="btn btnGhost" onclick="resetFilters()">Limpiar</button>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">BÃºsquedas</div>
          <div class="v" id="k1">â€”</div>
          <div class="s">Total en el rango.</div>
        </div>
        <div class="kpi">
          <div class="t">No encontrado</div>
          <div class="v" id="k2">â€”</div>
          <div class="s"></div>
        </div>
        <div class="kpi">
          <div class="t">Tasa de oportunidad</div>
          <div class="v" id="k3">â€”</div>
          <div class="s">% bÃºsquedas sin resultado.</div>
        </div>
      </div>

      <div class="msg" id="msg"></div>
    </div>

    <div class="gridMain">
      <div class="card areaBrands">
        <h2>Top Modelos (interno)</h2>
        <div class="sub"></div>
        <div class="msg" id="bMsg" style="display:block">Calculando modelos...</div>

        <div class="tableWrap tall">
          <table id="tBrands">
            <thead>
              <tr><th>Modelo</th><th>Consultas</th></tr>
            </thead>
            <tbody>
              <tr><td class="mut">â€”</td><td class="mut">â€”</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mut" style="font-size:12px;margin-top:10px;line-height:1.4">
          
        </div>
      </div>

      <div class="card areaTop">
        <h2>Top BÃºsquedas (interno)</h2>
        <div class="sub">Lo mÃ¡s buscado en tu sistema (por rango)</div>
        <div class="tableWrap compact">
          <table id="tTop">
            <thead>
              <tr><th>Query</th><th>LÃ­nea</th><th>Veces</th><th>Estado</th><th>Oferta disponible</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card areaOpp">
        <h2>Oportunidades (alto "no encontrado")</h2>
        <div class="sub">Demanda sin cobertura</div>
        <div class="tableWrap compact">
          <table id="tOpp">
            <thead>
              <tr><th>Query</th><th>LÃ­nea</th><th>Veces</th><th>No encontrado</th><th>%</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card areaEbay">
        <h2>SeÃ±al eBay (externo)</h2>
        <div class="sub">Compacto (sin Top marcas / Muestra)</div>
        <div class="msg" id="ebMsg" style="display:block">Cargando seÃ±al eBay...</div>
        <div class="tableWrap compact" style="margin-top:10px">
          <table id="tEbay" class="hideEbayCols">
            <thead><tr><th>Query</th><th>SeÃ±al</th><th>Top marcas</th><th>Muestra</th></tr></thead>
            <tbody>
              <tr><td class="mut">â€”</td><td class="mut">â€”</td><td class="mut">â€”</td><td class="mut">â€”</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card areaGoogle">
        <h2>SeÃ±al Google (autocomplete)</h2>
        <div class="sub">Mercado local por paÃ­s e idioma</div>
        <div class="msg" id="gMsg" style="display:block">Cargando sugerencias...</div>
        <div class="tableWrap compact" style="margin-top:10px">
          <table id="tGoogle">
            <thead><tr><th>Query base</th><th>Sugerencias</th><th>Insights</th></tr></thead>
            <tbody>
              <tr><td class="mut">â€”</td><td class="mut">â€”</td><td class="mut">â€”</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">Â© <span id="y"></span> RepuestoFinder</div>
  </div>

  <!-- âœ… MODAL: Detalle de cÃ³digos por modelo -->
<div id="modelModalOverlay" class="modalOverlay" onclick="closeModelModal(event)">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modelModalTitle" onclick="event.stopPropagation()">
    <div class="modalHead">
      <div>
        <b id="modelModalTitle">Detalle</b>
        <div class="mut" id="modelModalSub">â€”</div>
      </div>
      <button class="modalClose" onclick="closeModelModal()">Cerrar</button>
    </div>
    <div class="modalBody">
      <div class="tableWrap" style="max-height:420px">
        <table id="tModelCodes">
          <thead>
            <tr>
              <th>CÃ³digo buscado</th>
              <th>Veces</th>
              <th>Original (resuelto)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="mut">â€”</td><td class="mut">â€”</td><td class="mut">â€”</td></tr>
          </tbody>
        </table>
      </div>
      <div class="mut" style="margin-top:10px;line-height:1.35">
        * â€œOriginal (resuelto)â€ es el <b>original_norm</b> encontrado via <b>cambios / datos_vehiculares</b>.  
        Si sale â€œâ€”â€, ese cÃ³digo no pudo resolverse en el catÃ¡logo.
      </div>
    </div>
  </div>
</div>

<!-- âœ… MODAL: MAPA + % por modelos (incluye 'Desconocido') -->
<div id="mapOverlay" class="modalOverlay" onclick="closeMapModal(event)">
  <div class="mapModal" role="dialog" aria-modal="true" aria-labelledby="mapModalTitle" onclick="event.stopPropagation()">
    <div class="modalHead">
      <div>
        <b id="mapModalTitle">Mapa Â· Modelos mÃ¡s buscados</b>
        <div class="mut" id="mapModalSub">â€”</div>
      </div>
      <button class="modalClose" onclick="closeMapModal()">Cerrar</button>
    </div>

    <div class="mapGrid">
      <div class="mapSide">
        <h3>DistribuciÃ³n por modelo</h3>
        <div class="mut" id="mapSideNote">* â€œDesconocidoâ€ = bÃºsquedas <b>no_found</b> o cÃ³digos que no logramos mapear a un vehÃ­culo.</div>
        <div id="mapBars" style="margin-top:10px"></div>
      </div>

      <div class="mapCanvas">
        <div class="mapTitle">
          <b>Zona / paÃ­s seleccionado</b>
          <div class="mapHint">Pasa el mouse por el mapa para ver el resumen</div>
        </div>

        <div id="mapTooltip" class="mapTooltip"></div>

        <!-- Mapa estilo "real" simplificado (sin librerÃ­as externas) -->
<svg class="rfMapSvg" viewBox="0 0 1000 520" aria-label="Mapa mundial (simplificado)">
  <defs>
    <linearGradient id="landGrad" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0%" stop-color="rgba(255,255,255,.96)"/>
      <stop offset="100%" stop-color="rgba(241,245,249,.92)"/>
    </linearGradient>
  </defs>

  <!-- OcÃ©ano sutil -->
  <rect x="0" y="0" width="1000" height="520" fill="rgba(255,255,255,.22)"></rect>

  <!-- Continentes (simplificados, pero con forma real) -->
  <!-- NorteamÃ©rica -->
  <path id="rg-NA" class="rg" fill="url(#landGrad)"
    d="M90,125
       C115,88 165,72 220,72
       C300,70 345,95 380,115
       C410,130 440,158 450,192
       C460,226 440,250 410,266
       C382,282 355,287 340,305
       C320,330 290,340 258,334
       C235,330 220,312 205,304
       C180,292 150,290 125,272
       C95,250 72,212 78,172
       C82,150 84,137 90,125 Z"/>

  <!-- SuramÃ©rica -->
  <path id="rg-SA" class="rg" fill="url(#landGrad)"
    d="M310,300
       C338,284 372,286 397,305
       C420,322 430,352 426,378
       C420,414 402,444 380,470
       C358,495 332,505 307,500
       C282,494 268,472 262,448
       C255,420 260,392 268,365
       C276,338 290,318 310,300 Z"/>

  <!-- Europa -->
  <path id="rg-EU" class="rg" fill="url(#landGrad)"
    d="M485,135
       C505,118 535,108 565,110
       C600,112 632,125 654,142
       C670,154 678,170 673,185
       C667,202 646,210 620,215
       C590,220 560,220 532,210
       C506,201 486,185 478,168
       C470,152 472,144 485,135 Z"/>

  <!-- Ãfrica -->
  <path id="rg-AF" class="rg" fill="url(#landGrad)"
    d="M540,220
       C565,208 598,205 628,215
       C664,228 690,258 702,300
       C714,344 704,388 678,430
       C654,468 618,492 585,494
       C552,496 525,474 512,442
       C496,402 492,360 500,318
       C508,278 520,236 540,220 Z"/>

  <!-- Asia -->
  <path id="rg-AS" class="rg" fill="url(#landGrad)"
    d="M662,135
       C700,95 760,82 824,90
       C890,98 940,132 955,182
       C968,224 948,262 914,285
       C878,310 832,318 790,312
       C750,306 720,286 700,260
       C682,238 670,210 666,185
       C661,160 648,152 662,135 Z"/>

  <!-- OceanÃ­a -->
  <path id="rg-OC" class="rg" fill="url(#landGrad)"
    d="M820,338
       C852,320 890,318 920,332
       C948,345 965,370 962,398
       C960,425 942,448 914,462
       C885,476 852,476 826,462
       C800,448 786,424 790,398
       C795,366 800,352 820,338 Z"/>

  <!-- Labels -->
  <text x="185" y="165" font-size="14" font-weight="900" fill="rgba(100,116,139,.85)">N. AmÃ©rica</text>
  <text x="315" y="455" font-size="14" font-weight="900" fill="rgba(100,116,139,.85)">S. AmÃ©rica</text>
  <text x="550" y="165" font-size="14" font-weight="900" fill="rgba(100,116,139,.85)">Europa</text>
  <text x="585" y="390" font-size="14" font-weight="900" fill="rgba(100,116,139,.85)">Ãfrica</text>
  <text x="810" y="190" font-size="14" font-weight="900" fill="rgba(100,116,139,.85)">Asia</text>
  <text x="845" y="430" font-size="14" font-weight="900" fill="rgba(100,116,139,.85)">OceanÃ­a</text>
</svg>
      </div>
    </div>
  </div>
</div>

<script type="module">
    import { supabase } from "./assets/supabaseClient.js";
    const $ = (id)=>document.getElementById(id);

    function setMsg(text, isErr){
      const el = $("msg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setEbayMsg(text, isErr){
      const el = $("ebMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setGoogleMsg(text, isErr){
      const el = $("gMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setBrandMsg(text, isErr){
      const el = $("bMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    function dtFromRange(days){
      const d = new Date();
      d.setDate(d.getDate() - Number(days || 7));
      return d.toISOString();
    }
        function esc(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[c]));
    }
    const RF_OFFERS_TABLE = "offers";

    function normCode(v){
      return String(v||"").trim().toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
    }

    // Devuelve un map { normCode: { offers: nOffers, sellers: nSellers } } solo para ofertas activas (no expiradas)
    async function fetchOfferAvailability(normCodes){
      const out = new Map();
      const list = Array.from(new Set((normCodes||[]).filter(Boolean)));
      if(!list.length) return out;

      // limitar tamaÃ±o por seguridad (Supabase in() muy grande puede fallar)
      const chunkSize = 150;
      const nowIso = new Date().toISOString();

      for(let i=0; i<list.length; i+=chunkSize){
        const chunk = list.slice(i, i+chunkSize);
        try{
          const { data, error } = await supabase
            .from(RF_OFFERS_TABLE)
            .select("original_norm,seller_id")
            .gt("expires_at", nowIso)
            .in("original_norm", chunk)
            .limit(5000);
          if(error) throw error;

          for(const row of (data||[])){
            const key = row.original_norm || "";
            if(!key) continue;
            if(!out.has(key)) out.set(key, { offers:0, sellers:new Set() });
            const cur = out.get(key);
            cur.offers++;
            if(row.seller_id) cur.sellers.add(row.seller_id);
          }
        }catch(_){
          // si falla, devolvemos lo que tengamos (silencioso)
        }
      }

      // convertir sellers Set -> count
      for(const [k,v] of out){
        out.set(k, { offers: v.offers, sellers: v.sellers.size });
      }
      return out;
    }

    function offerBadge(nSellers){
      const n = Number(nSellers||0);
      if(n>0) return `<span class="badgeOffer">âœ… ${n}</span>`;
      return `<span class="badgeOffer off0">â€”</span>`;
    }

    function badgeStatus(result_status){
      if(result_status === "found") return `<span class="badge bOk">found</span>`;
      if(result_status === "not_found") return `<span class="badge bBad">not_found</span>`;
      return `<span class="badge">unknown</span>`;
    }

    function filterRows(rows){
      const q = ($("q").value || "").trim().toLowerCase();
      const cat = ($("category").value || "").trim().toLowerCase();
      return rows.filter(r=>{
        if(cat && String(r.category||"").toLowerCase() !== cat) return false;
        if(q){
          const hay = (String(r.query_raw||"") + " " + String(r.category||"") + " " + String(r.result_status||"")).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function normalizeCategory(cat){
      const c = String(cat||"").trim().toLowerCase();
      return c || "";
    }
    function isNumericOrCodeLike(s){
      const x = String(s||"").trim();
      if(!x) return false;
      if(/^\d{4,}$/.test(x)) return true;
      if(/^[A-Z0-9\-]{6,}$/i.test(x)) return true;
      return false;
    }
    function demoQueryByCategory(category){
      const c = String(category||"").trim().toLowerCase();
      if(c === "frenos") return "Toyota Corolla 2014-2017 brake pads";
      if(c === "suspension") return "Honda Civic 2012-2015 suspension control arm";
      if(c === "motor") return "Hyundai Elantra 2013-2016 engine mount";
      if(c === "electrico") return "Toyota Corolla 2014-2017 oxygen sensor";
      if(c === "cooling") return "Honda Civic 2012-2015 radiator";
      if(c === "transmision") return "Nissan Sentra 2013-2017 transmission mount";
      return "Toyota Corolla 2014-2017 brake pads";
    }

    function getLocale(){
      const gl = ($("gl").value || "DO").toUpperCase();
      const hl = ($("hl").value || "es").toLowerCase();
      return { gl, hl };
    }
    function marketplaceByGL(gl){
      const c = String(gl || "US").toUpperCase().trim();
      const map = {
        US: "EBAY_US",
        DO: "EBAY_US",
        PR: "EBAY_US",
        CA: "EBAY_CA",
        MX: "EBAY_US",
        CO: "EBAY_US",
        CL: "EBAY_US",
        PE: "EBAY_US",
        AR: "EBAY_US",
        BR: "EBAY_US",
        ES: "EBAY_ES",
        GB: "EBAY_GB",
        DE: "EBAY_DE",
        FR: "EBAY_FR",
        IT: "EBAY_IT",
        AU: "EBAY_AU"
      };
      return map[c] || "EBAY_US";
    }

    function saveLocale(){
      const { gl, hl } = getLocale();
      localStorage.setItem("rf_radar_gl", gl);
      localStorage.setItem("rf_radar_hl", hl);
    }
    function loadLocaleFromLocalStorage(){
      const gl = (localStorage.getItem("rf_radar_gl") || "").toUpperCase();
      const hl = (localStorage.getItem("rf_radar_hl") || "").toLowerCase();
      if(gl) $("gl").value = gl;
      if(hl) $("hl").value = hl;
    }

    async function loadProfileLocaleIfAny(){
      const alreadyChosen = localStorage.getItem("rf_radar_gl");
      if(alreadyChosen) return;

      const { data: ses } = await supabase.auth.getSession();
      if(!ses?.session) return;

      const userId = ses.session.user.id;
      const { data: prof } = await supabase
        .from("profiles")
        .select("country")
        .eq("id", userId)
        .maybeSingle();

      const c = String(prof?.country || "").trim().toUpperCase();
      if(c && Array.from($("gl").options).some(o => o.value === c)){
        $("gl").value = c;
        localStorage.setItem("rf_radar_gl", c);
      }else if(c){
        localStorage.setItem("rf_radar_gl", c);
      }
    }

    async function loadKpis(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("id, result_status, category, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const total = (data||[]).length;
      const nf = (data||[]).filter(x=>x.result_status==="not_found").length;
      const pct = total ? Math.round((nf/total)*1000)/10 : 0;

      $("k1").textContent = String(total);
      $("k2").textContent = String(nf);
      $("k3").textContent = pct.toFixed(1) + "%";
    }

    async function loadTop(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, last_status:r.result_status };
        cur.n += 1;
        cur.last_status = r.result_status || cur.last_status;
        map.set(key, cur);
      }
      let rows = Array.from(map.values()).sort((a,b)=> b.n - a.n);
      rows = filterRows(rows);

      const tbody = $("tTop").querySelector("tbody");
      const topRows = rows.slice(0,20);

      // Oferta disponible (cantidad de vendedores con oferta activa para ese OEM)
      const norms = topRows.map(r=>normCode(r.query_raw)).filter(Boolean);
      const offerMap = await fetchOfferAvailability(norms);

      tbody.innerHTML = topRows.map(r=>{
        const key = normCode(r.query_raw);
        const info = offerMap.get(key);
        const sellers = info ? info.sellers : 0;
        return `
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "â€”")}</span></td>
          <td><b>${r.n}</b></td>
          <td>${badgeStatus(r.last_status)}</td>
          <td>${offerBadge(sellers)}</td>
        </tr>
        `;
      }).join("") || `<tr><td colspan="5" class="mut">Sin datos para el filtro.</td></tr>`;

      return rows;
    }

    async function loadOpp(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, nf:0 };
        cur.n += 1;
        if(r.result_status === "not_found") cur.nf += 1;
        map.set(key, cur);
      }

      let rows = Array.from(map.values())
        .map(x=>({ ...x, pct: x.n ? Math.round((x.nf/x.n)*1000)/10 : 0 }))
        .filter(x=> x.n >= 2)
        .sort((a,b)=> (b.pct - a.pct) || (b.n - a.n));

      rows = filterRows(rows);

      const tbody = $("tOpp").querySelector("tbody");
      tbody.innerHTML = rows.slice(0,20).map(r=>`
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "â€”")}</span></td>
          <td><b>${r.n}</b></td>
          <td><span class="badge bBad">${r.nf}</span></td>
          <td><span class="badge bWarn">${r.pct.toFixed(1)}%</span></td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="mut">Sin oportunidades para el filtro.</td></tr>`;
    }

    function fmtMoney(v, cur){
      if(v === null || v === undefined) return "â€”";
      const n = Number(v);
      if(Number.isNaN(n)) return "â€”";
      const c = (cur || "USD").toUpperCase();
      return `${n.toFixed(2)} ${c}`;
    }

    // ==============================
    // TOP MODELOS (vehiculo) - usando 4 tablas
    // cambios, cambios_v2, datos_vehiculares, datos_vehiculares_v2
    // ==============================
    const TABLE_DV_1 = "datos_vehiculares";
    const TABLE_DV_2 = "datos_vehiculares_v2";
    const TABLE_C_1  = "cambios";
    const TABLE_C_2  = "cambios_v2";

    const DV_COL_ORIG_NORM = "original_norm";
    const DV_COL_ORIG      = "original";
    const DV_COL_VEH       = "vehiculo";

    const C_COL_ORIG_NORM  = "original_norm";
    const C_COL_CAMB_NORM  = "cambio_norm";
    const C_COL_ORIG       = "original";
    const C_COL_CAMB       = "cambio";

    function isCodeLike(s){
      const x = String(s||"").trim();
      if(!x) return false;
      if(/^\d{3,}$/.test(x)) return true;
      if(/^[A-Z0-9\-]{5,}$/i.test(x)) return true;
      return false;
    }

    function chunk(arr, size=250){
      const out = [];
      for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
      return out;
    }

    function normKey(s){
      return String(s||"").trim().toUpperCase();
    }

    async function resolveToOriginalNorm(queries){
      const qList = Array.from(new Set(queries.map(normKey).filter(Boolean)));
      const out = new Map();

      async function probeDV(table){
        for(const part of chunk(qList, 250)){
          const { data, error } = await supabase
            .from(table)
            .select(`${DV_COL_ORIG_NORM}, ${DV_COL_ORIG}`)
            .or(`${DV_COL_ORIG_NORM}.in.(${part.join(",")}),${DV_COL_ORIG}.in.(${part.join(",")})`);

          if(!error && Array.isArray(data)){
            for(const r of data){
              const on = normKey(r?.[DV_COL_ORIG_NORM]);
              const o  = normKey(r?.[DV_COL_ORIG]);
              if(on){
                if(on && qList.includes(on)) out.set(on, on);
                if(o && qList.includes(o) && !out.has(o)) out.set(o, on);
              }else if(o && qList.includes(o)){
                out.set(o, o);
              }
            }
          }
        }
      }

      await probeDV(TABLE_DV_2);
      await probeDV(TABLE_DV_1);

      const missing = qList.filter(x => !out.has(x));
      if(!missing.length) return out;

      async function probeCambios(table){
        for(const part of chunk(missing, 200)){
          const orExpr = [
            `${C_COL_CAMB_NORM}.in.(${part.join(",")})`,
            `${C_COL_CAMB}.in.(${part.join(",")})`,
            `${C_COL_ORIG_NORM}.in.(${part.join(",")})`,
            `${C_COL_ORIG}.in.(${part.join(",")})`,
          ].join(",");

          const { data, error } = await supabase
            .from(table)
            .select(`${C_COL_ORIG_NORM}, ${C_COL_ORIG}, ${C_COL_CAMB_NORM}, ${C_COL_CAMB}`)
            .or(orExpr);

          if(!error && Array.isArray(data)){
            for(const r of data){
              const origNorm = normKey(r?.[C_COL_ORIG_NORM]) || normKey(r?.[C_COL_ORIG]);
              if(!origNorm) continue;

              const cambNorm = normKey(r?.[C_COL_CAMB_NORM]);
              const camb     = normKey(r?.[C_COL_CAMB]);
              const orig     = normKey(r?.[C_COL_ORIG]);
              const oNorm    = normKey(r?.[C_COL_ORIG_NORM]);

              if(cambNorm && !out.has(cambNorm)) out.set(cambNorm, origNorm);
              if(camb && !out.has(camb)) out.set(camb, origNorm);
              if(oNorm && !out.has(oNorm)) out.set(oNorm, origNorm);
              if(orig && !out.has(orig)) out.set(orig, origNorm);
            }
          }
        }
      }

      await probeCambios(TABLE_C_2);
      await probeCambios(TABLE_C_1);

      return out;
    }

    async function resolveVehiculoForOriginalNorm(originalNorms){
      const list = Array.from(new Set(originalNorms.map(normKey).filter(Boolean)));
      const out = new Map();

      async function probe(table){
        for(const part of chunk(list, 250)){
          const { data, error } = await supabase
            .from(table)
            .select(`${DV_COL_ORIG_NORM}, ${DV_COL_VEH}`)
            .in(DV_COL_ORIG_NORM, part);

          if(!error && Array.isArray(data)){
            for(const r of data){
              const on = normKey(r?.[DV_COL_ORIG_NORM]);
              const veh = String(r?.[DV_COL_VEH] || "").trim();
              if(on && veh && !out.has(on)) out.set(on, veh);
            }
          }
        }
      }

      await probe(TABLE_DV_2);
      await probe(TABLE_DV_1);

      return out;
    }

    /**
     * âœ… TOP 10 modelos + detalle (click)
     * Guarda un diccionario global:
     * window.__rfModelDetails = {
     *   "SUZUKI": { total: 8, codes: { "A123...": { n: 4, original_norm: "..." }, ... } }
     * }
     */
    async function loadModelTop(){
      const tbody = document.getElementById("tBrands")?.querySelector("tbody");
      if(tbody) tbody.innerHTML = `<tr><td class="mut">â€”</td><td class="mut">â€”</td></tr>`;
      const bMsg = document.getElementById("bMsg");
      if(bMsg){ bMsg.textContent = "Calculando modelos..."; bMsg.style.display="block"; }

      window.__rfModelDetails = {}; // reset

      const from = dtFromRange(document.getElementById("range").value);
      const cat = (document.getElementById("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const events = (data||[]);
      const queries = events
        .map(r => normKey(r.query_raw))
        .filter(x => isCodeLike(x));

      if(!queries.length){
        if(tbody) tbody.innerHTML = `<tr><td colspan="2" class="mut">No hay bÃºsquedas tipo cÃ³digo en este rango.</td></tr>`;
        if(bMsg) bMsg.style.display="none";
        return;
      }

      if(bMsg) bMsg.textContent = "Resolviendo cÃ³digos (cambios + datos_vehiculares)...";
      const qToOrigNorm = await resolveToOriginalNorm(queries);

      const origNorms = Array.from(new Set(Array.from(qToOrigNorm.values())));
      if(bMsg) bMsg.textContent = "Buscando vehiculo por original_norm...";
      const origNormToVeh = await resolveVehiculoForOriginalNorm(origNorms);

      const count = new Map();                 // veh -> total
      const detail = new Map();                // veh -> Map(code -> {n, original_norm})

      for(const ev of events){
        const qx = normKey(ev.query_raw);
        if(!isCodeLike(qx)) continue;

        const on = qToOrigNorm.get(qx);        // original_norm resuelto (o undefined)
        if(!on) continue;

        const veh = origNormToVeh.get(on);
        if(!veh) continue;

        count.set(veh, (count.get(veh)||0) + 1);

        if(!detail.has(veh)) detail.set(veh, new Map());
        const m = detail.get(veh);

        const cur = m.get(qx) || { n: 0, original_norm: on || "" };
        cur.n += 1;
        cur.original_norm = on || cur.original_norm;
        m.set(qx, cur);
      }

      const rows = Array.from(count.entries())
        .map(([veh, n]) => ({ veh, n }))
        .sort((a,b)=> b.n - a.n)
        .slice(0,10); // âœ… TOP 10

      if(!rows.length){
        if(tbody) tbody.innerHTML = `<tr><td colspan="2" class="mut">No se pudo mapear a vehiculo (revisa si tus bÃºsquedas estÃ¡n entrando como cÃ³digos reales).</td></tr>`;
        if(bMsg) bMsg.style.display="none";
        return;
      }

      // Guardar detalles en window.__rfModelDetails
      const outObj = {};
      for(const r of rows){
        const m = detail.get(r.veh) || new Map();
        const codesArr = Array.from(m.entries())
          .map(([code, info]) => ({ code, n: info.n, original_norm: info.original_norm || "" }))
          .sort((a,b)=> b.n - a.n);

        outObj[r.veh] = { total: r.n, codes: codesArr };
      }
      window.__rfModelDetails = outObj;

      if(tbody){
        tbody.innerHTML = rows.map(r=>`
          <tr>
            <td>
              <button class="chipBtn" onclick="openModelCodes('${esc(r.veh)}')"
                title="Ver cÃ³digos buscados para ${esc(r.veh)}">
                <span class="badge">${esc(r.veh)}</span>
              </button>
            </td>
            <td><b>${r.n}</b></td>
          </tr>
        `).join("");
      }

      if(bMsg) bMsg.style.display="none";
    }

    
    // ==============================
    // âœ… MAPA (ligero): regiones + % modelos + 'Desconocido'
    // - Usa el paÃ­s (gl) seleccionado + label del profile si aplica
    // - 'Desconocido' = result_status not_found OR sin mapeo a vehiculo
    // ==============================
    const ISO_TO_REGION = (() => {
      const NA = new Set(["US","CA","MX","GT","HN","SV","NI","CR","PA","CU","JM","DO","PR","HT","BS","BZ"]);
      const SA = new Set(["CO","VE","EC","PE","BO","BR","PY","UY","AR","CL","GY","SR"]);
      const EU = new Set(["ES","FR","DE","IT","GB","NL","SE","CH","BE","PT","NO","DK","FI","IE","AT","PL","CZ","HU","RO","GR","UA"]);
      const AF = new Set(["ZA","NG","EG","MA","DZ","TN","GH","KE","ET","SN","CI","CM"]);
      const AS = new Set(["JP","KR","CN","IN","ID","TH","VN","PH","MY","SG","HK","TW","AE","SA","TR","RU","IL","QA","KW"]);
      const OC = new Set(["AU","NZ","FJ","PG"]);
      return (iso) => {
        const c = String(iso||"").toUpperCase().trim();
        if(NA.has(c)) return "NA";
        if(SA.has(c)) return "SA";
        if(EU.has(c)) return "EU";
        if(AF.has(c)) return "AF";
        if(AS.has(c)) return "AS";
        if(OC.has(c)) return "OC";
        return "NA"; // default
      };
    })();

    function glLabel(){
      const gl = ($("gl")?.value || "DO").toUpperCase();
      const opt = Array.from($("gl").options).find(o=>o.value===gl);
      const t = opt ? opt.textContent : gl;
      return { gl, label: t };
    }

    function setActiveRegion(regionCode){
      ["NA","SA","EU","AF","AS","OC"].forEach(r=>{
        const el = document.getElementById("rg-"+r);
        if(el) el.classList.toggle("active", r === regionCode);
      });
    }

    function tooltipHTML(title, lines){
      const items = (lines||[]).slice(0,6).map(x=>`<div class="mini">${esc(x.name)} <span>Â· ${esc(x.pct)}</span></div>`).join("");
      return `
        <b>${esc(title)}</b>
        ${items ? items : `<div class="mut">Sin datos para mostrar.</div>`}
        <div class="mut" style="margin-top:8px">Tip: â€œDesconocidoâ€ son bÃºsquedas sin resultado o sin mapeo a vehÃ­culo.</div>
      `;
    }

    function renderBars(dist){
      const box = document.getElementById("mapBars");
      if(!box) return;
      const total = dist.reduce((a,b)=>a + (b.count||0), 0) || 0;

      const top = dist
        .slice()
        .sort((a,b)=> (b.count||0) - (a.count||0))
        .slice(0, 12);

      box.innerHTML = top.map(x=>{
        const pct = total ? (x.count/total)*100 : 0;
        const pctTxt = pct.toFixed(1) + "%";
        const w = Math.max(0, Math.min(100, pct));
        const isUnk = String(x.name).toUpperCase()==="DESCONOCIDO";
        return `
          <div class="barRow" title="${esc(x.name)} Â· ${x.count} (${pctTxt})">
            <div class="barLbl">${isUnk ? "Desconocido" : esc(x.name)}</div>
            <div class="bar"><i style="width:${w}%"></i></div>
            <div class="barPct">${pctTxt}</div>
          </div>
        `;
      }).join("") || `<div class="mut" style="margin-top:10px">Sin distribuciÃ³n para mostrar.</div>`;
    }

    async function buildModelDistributionForMap(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const events = (data||[]);
      const codeEvents = events
        .map(r=>({ q: normKey(r.query_raw), status: String(r.result_status||"") }))
        .filter(x=> isCodeLike(x.q));

      if(!codeEvents.length){
        return { dist: [], total: 0, unknown: 0, top: [] };
      }

      const queries = codeEvents.map(x=>x.q);
      const qToOrigNorm = await resolveToOriginalNorm(queries);
      const origNorms = Array.from(new Set(Array.from(qToOrigNorm.values())));
      const origNormToVeh = await resolveVehiculoForOriginalNorm(origNorms);

      const counts = new Map(); // veh -> count
      let unknown = 0;

      for(const ev of codeEvents){
        // regla del usuario: lo "no encontrado" -> Desconocido
        if(ev.status === "not_found"){
          unknown++;
          continue;
        }

        const on = qToOrigNorm.get(ev.q);
        if(!on){ unknown++; continue; }
        const veh = origNormToVeh.get(on);
        if(!veh){ unknown++; continue; }
        counts.set(veh, (counts.get(veh)||0) + 1);
      }

      const dist = Array.from(counts.entries()).map(([name,count])=>({ name, count }));
      if(unknown>0) dist.push({ name:"DESCONOCIDO", count: unknown });

      const total = dist.reduce((a,b)=>a+(b.count||0),0);
      const top = dist
        .slice()
        .sort((a,b)=> (b.count||0) - (a.count||0))
        .slice(0,5)
        .map(x=>({ name:x.name==="DESCONOCIDO" ? "Desconocido" : x.name, pct: (total?((x.count/total)*100):0).toFixed(1)+"%" }));

      return { dist, total, unknown, top };
    }

    window.openMapModal = async function(){
      const overlay = document.getElementById("mapOverlay");
      const sub = document.getElementById("mapModalSub");
      const tip = document.getElementById("mapTooltip");

      if(sub){
        const { gl, label } = glLabel();
        sub.textContent = `PaÃ­s: ${label} Â· Rango: ${$("range").value} dÃ­a(s) Â· LÃ­nea: ${$("category").value || "todas"}`;
        setActiveRegion(ISO_TO_REGION(gl));
      }

      if(overlay) overlay.style.display = "flex";

      // cargar distribuciÃ³n
      try{
        if(tip){ tip.style.display="none"; tip.innerHTML=""; }
        const { dist, total, top } = await buildModelDistributionForMap();
        renderBars(dist);

        // tooltip inicial (paÃ­s actual)
        const { label, gl } = glLabel();
        if(tip){
          tip.innerHTML = tooltipHTML(`Resumen Â· ${label}`, top);
          tip.style.display = "block";
        }

        // Bind hover por regiones (una sola vez)
        const bindOnceKey = "__rf_map_bound";
        if(!window[bindOnceKey]){
          ["NA","SA","EU","AF","AS","OC"].forEach(region=>{
            const el = document.getElementById("rg-"+region);
            if(!el) return;

            el.addEventListener("mouseenter", ()=>{
              if(!tip) return;
              const regionName = ({
                NA:"NorteamÃ©rica", SA:"SuramÃ©rica", EU:"Europa", AF:"Ãfrica", AS:"Asia", OC:"OceanÃ­a"
              })[region] || region;

              // Mostramos el mismo top (por ahora) porque search_events no tiene paÃ­s por evento.
              // Visualmente el usuario entiende la zona del paÃ­s seleccionado.
              tip.innerHTML = tooltipHTML(`Zona Â· ${regionName} (paÃ­s ${glLabel().gl})`, top);
              tip.style.display = "block";
            });

            el.addEventListener("mouseleave", ()=>{
              if(!tip) return;
              const { label } = glLabel();
              tip.innerHTML = tooltipHTML(`Resumen Â· ${label}`, top);
              tip.style.display = "block";
            });

            el.addEventListener("click", ()=>{
              // al click, lo marcamos como activo visualmente
              setActiveRegion(region);
            });
          });

          window[bindOnceKey] = true;
        }
      }catch(e){
        renderBars([{ name:"DESCONOCIDO", count: 0 }]);
        if(tip){
          tip.innerHTML = `<b>Error</b><div class="mut" style="margin-top:6px">${esc(e?.message || e)}</div>`;
          tip.style.display="block";
        }
      }
    };

    window.closeMapModal = function(){
      const overlay = document.getElementById("mapOverlay");
      if(overlay) overlay.style.display = "none";
    };


    // âœ… Modal handlers
    window.openModelCodes = function(veh){
      const v = String(veh||"").trim();
      const data = window.__rfModelDetails?.[v];

      const overlay = document.getElementById("modelModalOverlay");
      const title = document.getElementById("modelModalTitle");
      const sub = document.getElementById("modelModalSub");
      const tbody = document.getElementById("tModelCodes")?.querySelector("tbody");

      if(title) title.textContent = `CÃ³digos buscados: ${v}`;
      if(sub) sub.textContent = data ? `Total consultas: ${data.total}` : "Sin detalle disponible";
      if(tbody){
        if(!data || !Array.isArray(data.codes) || !data.codes.length){
          tbody.innerHTML = `<tr><td colspan="3" class="mut">No hay cÃ³digos para mostrar.</td></tr>`;
        }else{
          tbody.innerHTML = data.codes.slice(0,200).map(x=>`
            <tr>
              <td><span class="badge">${esc(x.code)}</span></td>
              <td><b>${x.n}</b></td>
              <td class="mut">${x.original_norm ? esc(x.original_norm) : "â€”"}</td>
            </tr>
          `).join("");
        }
      }

      if(overlay) overlay.style.display = "flex";
    };

    window.closeModelModal = function(ev){
      // si se llama por click en overlay, cerrar
      const overlay = document.getElementById("modelModalOverlay");
      if(!overlay) return;
      overlay.style.display = "none";
    };

    // Cerrar con ESC
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        const o1 = document.getElementById("modelModalOverlay");
        if(o1 && o1.style.display === "flex") o1.style.display = "none";
        const o2 = document.getElementById("mapOverlay");
        if(o2 && o2.style.display === "flex") o2.style.display = "none";
      }
    });

    async function loadEbay(topRows){
      const userQ = ($("q").value || "").trim();
      let fallback = (topRows && topRows.length) ? String(topRows[0].query_raw || "").trim() : "";
      const category = normalizeCategory($("category").value);

      if(!userQ && isNumericOrCodeLike(fallback)){
        fallback = demoQueryByCategory(category);
      }
      const q = userQ || fallback;

      const tbody = $("tEbay").querySelector("tbody");
      tbody.innerHTML = `<tr><td class="mut">â€”</td><td class="mut">Cargandoâ€¦</td><td class="mut">â€”</td><td class="mut">â€”</td></tr>`;

      if(!q){
        setEbayMsg("No hay query para consultar eBay todavÃ­a.", false);
        tbody.innerHTML = `<tr><td colspan="4" class="mut">Sin query para eBay.</td></tr>`;
        return;
      }

      try{
        setEbayMsg(`Consultando eBay para: "${q}"...`, false);

        const { gl } = getLocale();
        const payload = {
          q,
          limit: 20,
          marketplaceId: marketplaceByGL(gl),
          category: category || undefined
        };

        const { data, error } = await supabase.functions.invoke("ebay-radar", { body: payload });
        if(error) throw error;
        if(!data) throw new Error("Respuesta vacÃ­a de ebay-radar.");

        const total = Number(data.total || 0);
        const env = data.env || "â€”";
        const mp = data.marketplaceId || "â€”";

        const median = fmtMoney(data?.price?.median, data?.price?.currency);
        const low = fmtMoney(data?.price?.low, data?.price?.currency);
        const high = fmtMoney(data?.price?.high, data?.price?.currency);

        const signalBadge = total > 0
          ? `<span class="badge bOk">total ${total}</span>`
          : `<span class="badge bWarn">total 0</span>`;

        tbody.innerHTML = `
          <tr>
            <td>
              <div><b>${esc(q)}</b></div>
              <div class="mut" style="margin-top:4px">gl: ${esc(getLocale().gl)} Â· env: ${esc(env)} Â· marketplace: ${esc(mp)} Â· categorÃ­a: ${esc(category || "â€”")}</div>
            </td>
            <td>
              <div>${signalBadge}</div>
              <div style="margin-top:6px" class="mut">median: <b>${esc(median)}</b></div>
              <div class="mut">low: ${esc(low)} Â· high: ${esc(high)}</div>
              <div class="mut" style="margin-top:6px">
              
              </div>
            </td>
            <td class="mut">â€”</td>
            <td class="mut">â€”</td>
          </tr>
        `;

        setEbayMsg("", false);
      }catch(e){
        setEbayMsg("Error eBay: " + (e?.message || e), true);
        tbody.innerHTML = `<tr><td colspan="4" class="mut">No se pudo cargar seÃ±al eBay.</td></tr>`;
      }
    }

    function wordInsights(list){
      const stop = new Set(["de","la","el","y","para","con","en","por","un","una","del","los","las","o","a"]);
      const counts = new Map();
      for(const s of list){
        const parts = String(s||"").toLowerCase().split(/\s+/)
          .map(x=>x.replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±\-]/gi,"")).filter(Boolean);
        for(const p of parts){
          if(p.length < 3) continue;
          if(stop.has(p)) continue;
          counts.set(p, (counts.get(p)||0)+1);
        }
      }
      return Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
    }

    async function loadGoogleSuggest(topRows){
      const { gl, hl } = getLocale();

      const userQ = ($("q").value || "").trim();
      let fallback = (topRows && topRows.length) ? String(topRows[0].query_raw || "").trim() : "";
      const category = normalizeCategory($("category").value);

      if(!userQ && isNumericOrCodeLike(fallback)){
        fallback = demoQueryByCategory(category);
      }
      const baseQ = userQ || fallback;

      const tbody = $("tGoogle").querySelector("tbody");

      if(!baseQ){
        setGoogleMsg("No hay query para Google Suggest todavÃ­a.", false);
        tbody.innerHTML = `<tr><td colspan="3" class="mut">Sin query.</td></tr>`;
        return;
      }

      try{
        setGoogleMsg(`Google Suggest (${gl}/${hl}) para: "${baseQ}"...`, false);

        const { data, error } = await supabase.functions.invoke("google-suggest", {
          body: { q: baseQ, hl, gl, limit: 10 }
        });
        if(error) throw error;

        const sug = Array.isArray(data?.suggestions) ? data.suggestions : [];
        const sugHtml = sug.length
          ? sug.map(x=>`<div style="margin-bottom:6px"><span class="badge">${esc(x)}</span></div>`).join("")
          : `<span class="badge bWarn">sin sugerencias</span>`;

        const ins = wordInsights(sug);
        const insHtml = ins.length
          ? ins.map(([w,n])=> `<span class="badge">${esc(w)} Â· ${n}</span>`).join(" ")
          : `<span class="badge bWarn">sin insights</span>`;

        tbody.innerHTML = `
          <tr>
            <td>
              <b>${esc(baseQ)}</b>
              <div class="mut" style="margin-top:4px">paÃ­s: ${esc(gl)} Â· idioma: ${esc(hl)}</div>
            </td>
            <td style="min-width:320px">${sugHtml}</td>
            <td>${insHtml}</td>
          </tr>
        `;

        setGoogleMsg("", false);
      }catch(e){
        setGoogleMsg("Error Google: " + (e?.message || e), true);
        tbody.innerHTML = `<tr><td colspan="3" class="mut">No se pudo cargar Google Suggest.</td></tr>`;
      }
    }

    window.goIndex = function(){ window.location.href = "index.html"; };
    window.goApp = function(){ window.location.href = "app.html"; };

    window.resetFilters = function(){
      $("range").value = "7";
      $("category").value = "";
      $("q").value = "";
      refreshAll();
    };

    window.refreshAll = async function(){
      try{
        setMsg("Cargando radar...", false);
        setBrandMsg("Calculando modelos...", false);
        await loadKpis();
        await loadModelTop();          // âœ… ahora top10 + click detalle
        const topRows = await loadTop();
        await loadOpp();
        await loadEbay(topRows);
        await loadGoogleSuggest(topRows);
        setMsg("", false);
      }catch(e){
        setMsg("Error: " + (e?.message || e), true);
      }
    };

    ["range","category"].forEach(id=>{
      $(id).addEventListener("change", ()=> refreshAll());
    });

    let tDeb = null;
    $("q").addEventListener("input", ()=>{
      clearTimeout(tDeb);
      tDeb = setTimeout(()=> refreshAll(), 450);
    });

    ["gl","hl"].forEach(id=>{
      $(id).addEventListener("change", ()=>{
        saveLocale();
        refreshAll();
      });
    });

    document.getElementById("y").textContent = new Date().getFullYear();
    loadLocaleFromLocalStorage();
    await loadProfileLocaleIfAny();
    refreshAll();
  </script>
</body>
</html>
