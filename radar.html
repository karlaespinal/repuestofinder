<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Radar de Demanda</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.92);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(rgba(246,247,251,.92), rgba(246,247,251,.92)),
        url("assets/bg.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      min-height:100vh;
      overflow-x:hidden;
    }

    /* ‚úÖ Antes: width:min(1180px,100%) -> encajonaba el radar */
    .page{
      width:100%;
      max-width: 100vw;
      margin:0 auto;
      padding:18px 22px 28px;
    }
    /* En monitores grandes, lo dejamos respirar sin verse ‚Äúvac√≠o‚Äù */
    @media(min-width:1400px){
      .page{ padding-left:34px; padding-right:34px; }
    }

    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background:rgba(246,247,251,.68);
      border:1px solid rgba(230,232,240,.75);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900; user-select:none;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .brandTitle{line-height:1}
    .brandTitle b{display:block;font-size:15px}
    .brandTitle span{display:block;font-size:12px;color:#94a3b8;font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-top:2px}

    .navRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:10px 12px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnGhost{background:#fff;border:1px solid var(--line);color:#0f172a}

    .hero{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .hero h1{ margin:0; font-size:26px; letter-spacing:-.2px; }
    .hero p{ margin:10px 0 0; color:var(--mut); font-size:14px; line-height:1.45; max-width:1000px; }

    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .inp{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:800;
      outline:none;
      color:#0f172a;
    }
    .inp:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .select{ min-width:180px; }
    .text{ min-width:240px; flex:1 1 320px; }

    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 220px;
      border:1px solid rgba(230,232,240,.9);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:#94a3b8;font-weight:900;text-transform:uppercase;letter-spacing:.4px}
    .kpi .v{font-size:18px;font-weight:900;margin-top:6px}
    .kpi .s{font-size:12px;color:var(--mut);margin-top:6px;line-height:1.35}

    /* ‚úÖ NUEVO: Layout tipo BI con sidebar izquierda */
    .gridMain{
      display:grid;
      grid-template-columns: 340px 1fr 1fr;
      grid-template-areas:
        "brands top opp"
        "brands ebay google";
      gap:12px;
      margin-top:14px;
      align-items:start;
    }
    .areaBrands{ grid-area: brands; }
    .areaTop{ grid-area: top; }
    .areaOpp{ grid-area: opp; }
    .areaEbay{ grid-area: ebay; }
    .areaGoogle{ grid-area: google; }

    @media(max-width:1200px){
      .gridMain{
        grid-template-columns: 1fr;
        grid-template-areas:
          "brands"
          "top"
          "opp"
          "ebay"
          "google";
      }
    }

    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.88);
      box-shadow:0 10px 26px rgba(2,6,23,.06);
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0;font-size:14px;font-weight:900}
    .sub{font-size:12px;color:#94a3b8;font-weight:900;letter-spacing:.4px;text-transform:uppercase;margin-top:4px}

    .tableWrap{
      margin-top:10px;
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      overflow:auto;
      background:#fff;
    }

    /* ‚úÖ para que no se vean ‚Äúgigantes‚Äù */
    .tableWrap.compact{
      max-height: 340px;
    }
    @media(min-width:1200px){
      .tableWrap.tall{
        max-height: 540px;
      }
    }

    table{width:100%;border-collapse:collapse}
    th,td{
      padding:10px;
      border-bottom:1px solid #eef0f6;
      font-size:13px;
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky; top:0; z-index:1;
      background:#fafbff;
      font-weight:900;
      color:#0f172a;
    }

    .badge{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(230,232,240,.95);
      background:rgba(37,99,235,.08);
      color:var(--pri);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin:2px 4px 2px 0;
    }
    .bOk{ background:rgba(16,185,129,.10); color:var(--ok); border-color:rgba(16,185,129,.25); }
    .bBad{ background:rgba(239,68,68,.10); color:var(--bad); border-color:rgba(239,68,68,.25); }
    .bWarn{ background:rgba(245,158,11,.10); color:var(--warn); border-color:rgba(245,158,11,.25); }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      padding:10px 12px;
      border-radius:14px;
      display:none;
    }
    .msg.err{ background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.18); }

    .mut{ color:#64748b; font-weight:800; }
    .link{ color:var(--pri); font-weight:900; text-decoration:none; }
    .link:hover{ text-decoration:underline; }

    .footer{ margin-top:14px; text-align:center; color:#94a3b8; font-size:12px; font-weight:800; }

    /* ‚úÖ eBay: ocultar columnas pesadas (Top marcas + Muestra) */
    .hideEbayCols th:nth-child(3),
    .hideEbayCols th:nth-child(4),
    .hideEbayCols td:nth-child(3),
    .hideEbayCols td:nth-child(4){
      display:none;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="logo">RF</div>
        <div class="brandTitle">
          <b>RepuestoFinder</b>
          <span>Radar de Demanda</span>
        </div>
      </div>

      <div class="navRight">
        <button class="btn btnGhost" onclick="goIndex()">Volver</button>
        <button class="btn btnGhost" onclick="goApp()">Ir a la App</button>
        <button class="btn btnPrimary" onclick="refreshAll()">Actualizar</button>
      </div>
    </div>

    <div class="hero">
      <h1>Radar Mundial (Interno + Se√±ales Externas por Pa√≠s)</h1>
      <p>
        El pa√≠s se toma del <b>perfil</b> (profiles.country) y el usuario puede cambiarlo aqu√≠.
        Google Suggest usa <b>gl</b> (pa√≠s) e <b>hl</b> (idioma) para reflejar mercado local.
      </p>

      <div class="filters">
        <select id="range" class="inp select">
          <option value="1">√öltimas 24 horas</option>
          <option value="7" selected>√öltimos 7 d√≠as</option>
          <option value="30">√öltimos 30 d√≠as</option>
        </select>

        <select id="category" class="inp select">
          <option value="">Todas las l√≠neas</option>
          <option value="frenos">Frenos</option>
          <option value="suspension">Suspensi√≥n</option>
          <option value="motor">Motor</option>
          <option value="electrico">El√©ctrico</option>
          <option value="cooling">Cooling</option>
          <option value="transmision">Transmisi√≥n</option>
          <option value="otros">Otros</option>
        </select>

        <select id="gl" class="inp select" title="Pa√≠s (Google gl)">
          <option value="DO">üá©üá¥ Rep√∫blica Dominicana (DO)</option>
          <option value="US">üá∫üá∏ Estados Unidos (US)</option>
          <option value="MX">üá≤üáΩ M√©xico (MX)</option>
          <option value="CO">üá®üá¥ Colombia (CO)</option>
          <option value="CL">üá®üá± Chile (CL)</option>
          <option value="PE">üáµüá™ Per√∫ (PE)</option>
          <option value="AR">üá¶üá∑ Argentina (AR)</option>
          <option value="BR">üáßüá∑ Brasil (BR)</option>
          <option value="ES">üá™üá∏ Espa√±a (ES)</option>
          <option value="CA">üá®üá¶ Canad√° (CA)</option>
        </select>

        <select id="hl" class="inp select" title="Idioma (Google hl)">
          <option value="es" selected>Espa√±ol (es)</option>
          <option value="en">English (en)</option>
          <option value="pt">Portugu√™s (pt)</option>
        </select>

        <input id="q" class="inp text" placeholder="Filtrar / query (ej: corolla 2014 2017 brake pads)" />
        <button class="btn btnGhost" onclick="resetFilters()">Limpiar</button>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">B√∫squedas</div>
          <div class="v" id="k1">‚Äî</div>
          <div class="s">Total en el rango.</div>
        </div>
        <div class="kpi">
          <div class="t">No encontrado</div>
          <div class="v" id="k2">‚Äî</div>
          <div class="s">Oportunidad (gap de cat√°logo).</div>
        </div>
        <div class="kpi">
          <div class="t">Tasa de oportunidad</div>
          <div class="v" id="k3">‚Äî</div>
          <div class="s">% b√∫squedas sin resultado.</div>
        </div>
      </div>

      <div class="msg" id="msg"></div>
    </div>

    <!-- ‚úÖ NUEVO GRID PRINCIPAL con sidebar izquierda -->
    <div class="gridMain">

      <!-- ‚úÖ Top Marcas a la izquierda -->
      <div class="card areaBrands">
      <h2>Top Modelos (interno)</h2>
      <div class="sub">Top 20 modelos/veh√≠culos m√°s consultados (por rango)</div>
      <div class="msg" id="bMsg" style="display:block">Calculando modelos...</div>

      <div class="tableWrap tall">
        <table id="tBrands">
          <thead>
            <tr><th>Modelo</th><th>Consultas</th></tr>
          </thead>
          <tbody>
            <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
          </tbody>
        </table>
      </div>

      <div class="mut" style="font-size:12px;margin-top:10px;line-height:1.4">
        * Este ranking se calcula resolviendo cada b√∫squeda a su <b>modelo</b> desde tu cat√°logo en Supabase.
      </div>
    </div>


      <div class="card areaTop">
        <h2>Top B√∫squedas (interno)</h2>
        <div class="sub">Lo m√°s buscado en tu sistema (por rango)</div>
        <div class="tableWrap compact">
          <table id="tTop">
            <thead>
              <tr><th>Query</th><th>L√≠nea</th><th>Veces</th><th>Estado</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card areaOpp">
        <h2>Oportunidades (alto ‚Äúno encontrado‚Äù)</h2>
        <div class="sub">Demanda sin cobertura</div>
        <div class="tableWrap compact">
          <table id="tOpp">
            <thead>
              <tr><th>Query</th><th>L√≠nea</th><th>Veces</th><th>No encontrado</th><th>%</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card areaEbay">
        <h2>Se√±al eBay (externo)</h2>
        <div class="sub">Compacto (sin Top marcas / Muestra)</div>
        <div class="msg" id="ebMsg" style="display:block">Cargando se√±al eBay...</div>
        <div class="tableWrap compact" style="margin-top:10px">
          <table id="tEbay" class="hideEbayCols">
            <thead><tr><th>Query</th><th>Se√±al</th><th>Top marcas</th><th>Muestra</th></tr></thead>
            <tbody>
              <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card areaGoogle">
        <h2>Se√±al Google (autocomplete)</h2>
        <div class="sub">Mercado local por pa√≠s e idioma</div>
        <div class="msg" id="gMsg" style="display:block">Cargando sugerencias...</div>
        <div class="tableWrap compact" style="margin-top:10px">
          <table id="tGoogle">
            <thead><tr><th>Query base</th><th>Sugerencias</th><th>Insights</th></tr></thead>
            <tbody>
              <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <div class="footer">¬© <span id="y"></span> RepuestoFinder</div>
  </div>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";
    const $ = (id)=>document.getElementById(id);

    function setMsg(text, isErr){
      const el = $("msg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setEbayMsg(text, isErr){
      const el = $("ebMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setGoogleMsg(text, isErr){
      const el = $("gMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setBrandMsg(text, isErr){
      const el = $("bMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    // ==============================
// TOP 20 MODELOS (vehiculo) - usando 4 tablas
// cambios, cambios_v2, datos_vehiculares, datos_vehiculares_v2
// ==============================

const TABLE_DV_1 = "datos_vehiculares";
const TABLE_DV_2 = "datos_vehiculares_v2";
const TABLE_C_1  = "cambios";
const TABLE_C_2  = "cambios_v2";

// columnas reales (seg√∫n tu screenshot)
const DV_COL_ORIG_NORM = "original_norm";
const DV_COL_ORIG      = "original";
const DV_COL_VEH       = "vehiculo";

// Para cambios, asumimos estas columnas t√≠picas.
// Si alguna no existe, la query igual puede fallar. Pero en tu proyecto anterior ya usabas cambios/original/cambio.
const C_COL_ORIG_NORM  = "original_norm";
const C_COL_CAMB_NORM  = "cambio_norm";
const C_COL_ORIG       = "original";
const C_COL_CAMB       = "cambio";

function isCodeLike(s){
  const x = String(s||"").trim();
  if(!x) return false;
  if(/^\d{3,}$/.test(x)) return true;                 // n√∫meros
  if(/^[A-Z0-9\-]{5,}$/i.test(x)) return true;        // A2730904040 / BL1060 / etc
  return false;
}

// trocea arrays para .in() (evita l√≠mites)
function chunk(arr, size=250){
  const out = [];
  for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
  return out;
}

// Normaliza a may√∫scula y quita espacios
function normKey(s){
  return String(s||"").trim().toUpperCase();
}

/**
 * Paso A: dado un listado de queries (c√≥digos), intenta mapear a "original_norm"
 * - Si el query ya existe como original_norm en datos_vehiculares => ok
 * - Si el query es un cambio => busca en cambios/cambios_v2 y trae su original_norm
 * Retorna: Map(query -> original_norm)
 */
async function resolveToOriginalNorm(queries){
  const qList = Array.from(new Set(queries.map(normKey).filter(Boolean)));
  const out = new Map();

  // 1) Si el query ya es un original_norm en datos_vehiculares(_v2), lo damos por bueno
  async function probeDV(table){
    for(const part of chunk(qList, 250)){
      const { data, error } = await supabase
        .from(table)
        .select(`${DV_COL_ORIG_NORM}, ${DV_COL_ORIG}`)
        .or(`${DV_COL_ORIG_NORM}.in.(${part.join(",")}),${DV_COL_ORIG}.in.(${part.join(",")})`);

      if(!error && Array.isArray(data)){
        for(const r of data){
          const on = normKey(r?.[DV_COL_ORIG_NORM]);
          const o  = normKey(r?.[DV_COL_ORIG]);
          // si el query matchea por original_norm u original, lo resolvemos a original_norm (prioridad)
          if(on){
            if(on && qList.includes(on)) out.set(on, on);
            if(o && qList.includes(o) && !out.has(o)) out.set(o, on);
          }else if(o && qList.includes(o)){
            // si no hay original_norm, usamos original como fallback
            out.set(o, o);
          }
        }
      }
    }
  }

  await probeDV(TABLE_DV_2); // prioridad v2 primero
  await probeDV(TABLE_DV_1);

  const missing = qList.filter(x => !out.has(x));
  if(!missing.length) return out;

  // 2) Buscar en cambios/cambios_v2: query puede ser cambio_norm o cambio o incluso original*
  async function probeCambios(table){
    for(const part of chunk(missing, 200)){
      // usamos .or para intentar todas las columnas t√≠picas
      const orExpr = [
        `${C_COL_CAMB_NORM}.in.(${part.join(",")})`,
        `${C_COL_CAMB}.in.(${part.join(",")})`,
        `${C_COL_ORIG_NORM}.in.(${part.join(",")})`,
        `${C_COL_ORIG}.in.(${part.join(",")})`,
      ].join(",");

      const { data, error } = await supabase
        .from(table)
        .select(`${C_COL_ORIG_NORM}, ${C_COL_ORIG}, ${C_COL_CAMB_NORM}, ${C_COL_CAMB}`)
        .or(orExpr);

      if(!error && Array.isArray(data)){
        for(const r of data){
          const origNorm = normKey(r?.[C_COL_ORIG_NORM]) || normKey(r?.[C_COL_ORIG]);
          if(!origNorm) continue;

          const cambNorm = normKey(r?.[C_COL_CAMB_NORM]);
          const camb     = normKey(r?.[C_COL_CAMB]);
          const orig     = normKey(r?.[C_COL_ORIG]);
          const oNorm    = normKey(r?.[C_COL_ORIG_NORM]);

          // si el query coincide con cualquiera, lo mapeamos a origNorm
          if(cambNorm && !out.has(cambNorm)) out.set(cambNorm, origNorm);
          if(camb && !out.has(camb)) out.set(camb, origNorm);
          if(oNorm && !out.has(oNorm)) out.set(oNorm, origNorm);
          if(orig && !out.has(orig)) out.set(orig, origNorm);
        }
      }
    }
  }

  await probeCambios(TABLE_C_2); // prioridad v2
  await probeCambios(TABLE_C_1);

  return out;
}

/**
 * Paso B: dado un listado de original_norm, buscar vehiculo en datos_vehiculares(_v2)
 * Retorna: Map(original_norm -> vehiculo)
 */
async function resolveVehiculoForOriginalNorm(originalNorms){
  const list = Array.from(new Set(originalNorms.map(normKey).filter(Boolean)));
  const out = new Map();

  async function probe(table){
    for(const part of chunk(list, 250)){
      const { data, error } = await supabase
        .from(table)
        .select(`${DV_COL_ORIG_NORM}, ${DV_COL_VEH}`)
        .in(DV_COL_ORIG_NORM, part);

      if(!error && Array.isArray(data)){
        for(const r of data){
          const on = normKey(r?.[DV_COL_ORIG_NORM]);
          const veh = String(r?.[DV_COL_VEH] || "").trim();
          if(on && veh && !out.has(on)) out.set(on, veh);
        }
      }
    }
  }

  await probe(TABLE_DV_2); // prioridad v2
  await probe(TABLE_DV_1);

  return out;
}

async function loadModelTop(){
  // UI
  const tbody = document.getElementById("tBrands")?.querySelector("tbody");
  if(tbody) tbody.innerHTML = `<tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>`;
  const bMsg = document.getElementById("bMsg");
  if(bMsg){ bMsg.textContent = "Calculando modelos..."; bMsg.style.display="block"; }

  const from = dtFromRange(document.getElementById("range").value);
  const cat = (document.getElementById("category").value || "").trim();

  let q = supabase
    .from("search_events")
    .select("query_raw, category, searched_at")
    .gte("searched_at", from);

  if(cat) q = q.eq("category", cat);

  const { data, error } = await q;
  if(error) throw error;

  const events = (data||[]);
  const queries = events
    .map(r => normKey(r.query_raw))
    .filter(x => isCodeLike(x));

  if(!queries.length){
    if(tbody) tbody.innerHTML = `<tr><td colspan="2" class="mut">No hay b√∫squedas tipo c√≥digo en este rango.</td></tr>`;
    if(bMsg) bMsg.style.display="none";
    return;
  }

  // 1) query -> original_norm
  if(bMsg) bMsg.textContent = "Resolviendo c√≥digos (cambios + datos_vehiculares)...";
  const qToOrigNorm = await resolveToOriginalNorm(queries);

  // 2) original_norm -> vehiculo
  const origNorms = Array.from(new Set(Array.from(qToOrigNorm.values())));
  if(bMsg) bMsg.textContent = "Buscando vehiculo por original_norm...";
  const origNormToVeh = await resolveVehiculoForOriginalNorm(origNorms);

  // 3) Contar vehiculo
  const count = new Map();
  for(const ev of events){
    const qx = normKey(ev.query_raw);
    if(!isCodeLike(qx)) continue;

    const on = qToOrigNorm.get(qx);
    if(!on) continue;

    const veh = origNormToVeh.get(on);
    if(!veh) continue;

    count.set(veh, (count.get(veh)||0) + 1);
  }

  const rows = Array.from(count.entries())
    .map(([veh, n]) => ({ veh, n }))
    .sort((a,b)=> b.n - a.n)
    .slice(0,20);

  if(!rows.length){
    if(tbody) tbody.innerHTML = `<tr><td colspan="2" class="mut">No se pudo mapear a vehiculo (revisa si tus b√∫squedas est√°n entrando como c√≥digos reales).</td></tr>`;
    if(bMsg) bMsg.style.display="none";
    return;
  }

  if(tbody){
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td><span class="badge">${esc(r.veh)}</span></td>
        <td><b>${r.n}</b></td>
      </tr>
    `).join("");
  }

  if(bMsg) bMsg.style.display="none";
}


    function dtFromRange(days){
      const d = new Date();
      d.setDate(d.getDate() - Number(days || 7));
      return d.toISOString();
    }
    function esc(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }
    function badgeStatus(result_status){
      if(result_status === "found") return `<span class="badge bOk">found</span>`;
      if(result_status === "not_found") return `<span class="badge bBad">not_found</span>`;
      return `<span class="badge">unknown</span>`;
    }

    function filterRows(rows){
      const q = ($("q").value || "").trim().toLowerCase();
      const cat = ($("category").value || "").trim().toLowerCase();
      return rows.filter(r=>{
        if(cat && String(r.category||"").toLowerCase() !== cat) return false;
        if(q){
          const hay = (String(r.query_raw||"") + " " + String(r.category||"") + " " + String(r.result_status||"")).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function normalizeCategory(cat){
      const c = String(cat||"").trim().toLowerCase();
      return c || "";
    }
    function isNumericOrCodeLike(s){
      const x = String(s||"").trim();
      if(!x) return false;
      if(/^\d{4,}$/.test(x)) return true;
      if(/^[A-Z0-9\-]{6,}$/i.test(x)) return true;
      return false;
    }
    function demoQueryByCategory(category){
      const c = String(category||"").trim().toLowerCase();
      if(c === "frenos") return "Toyota Corolla 2014-2017 brake pads";
      if(c === "suspension") return "Honda Civic 2012-2015 suspension control arm";
      if(c === "motor") return "Hyundai Elantra 2013-2016 engine mount";
      if(c === "electrico") return "Toyota Corolla 2014-2017 oxygen sensor";
      if(c === "cooling") return "Honda Civic 2012-2015 radiator";
      if(c === "transmision") return "Nissan Sentra 2013-2017 transmission mount";
      return "Toyota Corolla 2014-2017 brake pads";
    }

    function getLocale(){
      const gl = ($("gl").value || "DO").toUpperCase();
      const hl = ($("hl").value || "es").toLowerCase();
      return { gl, hl };
    }
    function marketplaceByGL(gl){
      const c = String(gl || "US").toUpperCase().trim();
      const map = {
        US: "EBAY_US",
        DO: "EBAY_US",
        PR: "EBAY_US",
        CA: "EBAY_CA",
        MX: "EBAY_US",
        CO: "EBAY_US",
        CL: "EBAY_US",
        PE: "EBAY_US",
        AR: "EBAY_US",
        BR: "EBAY_US",
        ES: "EBAY_ES",
        GB: "EBAY_GB",
        DE: "EBAY_DE",
        FR: "EBAY_FR",
        IT: "EBAY_IT",
        AU: "EBAY_AU"
      };
      return map[c] || "EBAY_US";
    }

    function saveLocale(){
      const { gl, hl } = getLocale();
      localStorage.setItem("rf_radar_gl", gl);
      localStorage.setItem("rf_radar_hl", hl);
    }
    function loadLocaleFromLocalStorage(){
      const gl = (localStorage.getItem("rf_radar_gl") || "").toUpperCase();
      const hl = (localStorage.getItem("rf_radar_hl") || "").toLowerCase();
      if(gl) $("gl").value = gl;
      if(hl) $("hl").value = hl;
    }

    async function loadProfileLocaleIfAny(){
      const alreadyChosen = localStorage.getItem("rf_radar_gl");
      if(alreadyChosen) return;

      const { data: ses } = await supabase.auth.getSession();
      if(!ses?.session) return;

      const userId = ses.session.user.id;
      const { data: prof } = await supabase
        .from("profiles")
        .select("country")
        .eq("id", userId)
        .maybeSingle();

      const c = String(prof?.country || "").trim().toUpperCase();
      if(c && Array.from($("gl").options).some(o => o.value === c)){
        $("gl").value = c;
        localStorage.setItem("rf_radar_gl", c);
      }else if(c){
        localStorage.setItem("rf_radar_gl", c);
      }
    }

    async function loadKpis(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("id, result_status, category, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const total = (data||[]).length;
      const nf = (data||[]).filter(x=>x.result_status==="not_found").length;
      const pct = total ? Math.round((nf/total)*1000)/10 : 0;

      $("k1").textContent = String(total);
      $("k2").textContent = String(nf);
      $("k3").textContent = pct.toFixed(1) + "%";
    }

    async function loadTop(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, last_status:r.result_status };
        cur.n += 1;
        cur.last_status = r.result_status || cur.last_status;
        map.set(key, cur);
      }
      let rows = Array.from(map.values()).sort((a,b)=> b.n - a.n);
      rows = filterRows(rows);

      const tbody = $("tTop").querySelector("tbody");
      tbody.innerHTML = rows.slice(0,20).map(r=>`
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "‚Äî")}</span></td>
          <td><b>${r.n}</b></td>
          <td>${badgeStatus(r.last_status)}</td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="mut">Sin datos para el filtro.</td></tr>`;

      return rows;
    }

    async function loadOpp(){
      const from = dtFromRange($("range").value);
      const cat = ($("category").value || "").trim();

      let q = supabase
        .from("search_events")
        .select("query_raw, category, result_status, searched_at")
        .gte("searched_at", from);

      if(cat) q = q.eq("category", cat);

      const { data, error } = await q;
      if(error) throw error;

      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, nf:0 };
        cur.n += 1;
        if(r.result_status === "not_found") cur.nf += 1;
        map.set(key, cur);
      }

      let rows = Array.from(map.values())
        .map(x=>({ ...x, pct: x.n ? Math.round((x.nf/x.n)*1000)/10 : 0 }))
        .filter(x=> x.n >= 2)
        .sort((a,b)=> (b.pct - a.pct) || (b.n - a.n));

      rows = filterRows(rows);

      const tbody = $("tOpp").querySelector("tbody");
      tbody.innerHTML = rows.slice(0,20).map(r=>`
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "‚Äî")}</span></td>
          <td><b>${r.n}</b></td>
          <td><span class="badge bBad">${r.nf}</span></td>
          <td><span class="badge bWarn">${r.pct.toFixed(1)}%</span></td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="mut">Sin oportunidades para el filtro.</td></tr>`;
    }

    function fmtMoney(v, cur){
      if(v === null || v === undefined) return "‚Äî";
      const n = Number(v);
      if(Number.isNaN(n)) return "‚Äî";
      const c = (cur || "USD").toUpperCase();
      return `${n.toFixed(2)} ${c}`;
    }

    /* ‚úÖ NUEVO: Top marcas interno (heur√≠stico por texto) */
    function extractBrandCandidates(query){
      const s = String(query||"").toLowerCase();

      // Lista base (la puedes ampliar sin romper nada)
      const known = [
        "mercedes", "mercedes-benz", "benz", "mb",
        "bosch", "mahle", "mann", "bilstein", "febi", "ngk",
        "denso", "delphi", "vale o", "valeo", "brembo",
        "ate", "trw", "lemforder", "sachs", "luk", "ina",
        "gates", "continental", "contitech", "hella",
        "magneti", "monroe", "kyb", "kayaba",
        "toyota", "honda", "hyundai", "kia", "nissan", "bmw"
      ];

      // Si el usuario busc√≥ un c√≥digo puro, aqu√≠ NO inventamos marca:
      // (la marca real debe salir del cat√°logo; esto evita datos falsos)
      if(isNumericOrCodeLike(query) && !known.some(k => s.includes(k.replace(/\s+/g,'')) || s.includes(k))){
        return [];
      }

      const hits = [];
      for(const k of known){
        const kk = k.toLowerCase();
        if(s.includes(kk)) hits.push(k.toUpperCase());
      }

      // Normalizaciones peque√±as
      return hits.map(x=>{
        if(x === "BENZ" || x === "MB") return "MERCEDES-BENZ";
        if(x === "MERCEDES") return "MERCEDES-BENZ";
        if(x === "MERCEDES-BENZ") return "MERCEDES-BENZ";
        if(x === "VALE O") return "VALEO";
        if(x === "KAYABA") return "KYB";
        return x;
      });
    }

    // ==============================
// CONFIG (AJUSTA SOLO ESTO)
// ==============================
// 1) Tabla que tiene la relaci√≥n c√≥digo -> modelo/veh√≠culo
//    Ejemplos t√≠picos: datos_vehiculares, maestro, catalogo, items
const TABLE_VEH = "datos_vehiculares";

// 2) Columna donde est√° el c√≥digo OEM/original (el que el usuario busca)
//    Ajusta seg√∫n tu tabla: "codigo", "oem", "original", "codigo_original", etc.
const COL_CODE = "codigo_original";

// 3) Columna del modelo (Toyota, Honda, Hyundai, Mitsubishi, etc.)
//    Ajusta: "vehiculo", "marca", "modelo", "make", "vehicle_model"
const COL_MODEL = "vehiculo"; // <-- si tu campo se llama "modelo", c√°mbialo a "modelo"

// 4) (Opcional) Si tu modelo est√° en otra tabla y necesitas puente por 'cambios'
const TABLE_CAMBIOS = "cambios";
const CAMBIOS_COL_ORIGINAL = "original";
const CAMBIOS_COL_CAMBIO = "cambio";

function isCodeLike(s){
  const x = String(s||"").trim();
  if(!x) return false;
  // n√∫meros largos
  if(/^\d{4,}$/.test(x)) return true;
  // patrones tipo A2730904040 / 111242 / A-1234 etc.
  if(/^[A-Z0-9\-]{5,}$/i.test(x)) return true;
  return false;
}

/**
 * Resuelve un listado de c√≥digos a un mapa code -> model (vehiculo)
 * Estrategia:
 *  A) Busca directo en TABLE_VEH (columna COL_CODE)
 *  B) Si no aparece, intenta por TABLE_CAMBIOS para encontrar el "original" y vuelve a TABLE_VEH
 */
async function resolveModelsForCodes(codes){
  const clean = Array.from(new Set((codes||[]).map(x=>String(x||"").trim()).filter(Boolean)));

  if(!clean.length) return new Map();

  const out = new Map();

  // ---- A) Directo a datos_vehiculares (o tabla que uses)
  try{
    // OJO: Supabase limita el tama√±o del IN; si tienes demasiados, se puede trocear.
    const { data: veh, error: e1 } = await supabase
      .from(TABLE_VEH)
      .select(`${COL_CODE}, ${COL_MODEL}`)
      .in(COL_CODE, clean);

    if(!e1 && Array.isArray(veh)){
      for(const r of veh){
        const code = String(r?.[COL_CODE] ?? "").trim();
        const model = String(r?.[COL_MODEL] ?? "").trim();
        if(code && model) out.set(code, model);
      }
    }
  }catch(_){}

  // Si ya resolvimos casi todo, retornamos
  const missing = clean.filter(c => !out.has(c));
  if(!missing.length) return out;

  // ---- B) Puente por cambios: si el usuario busc√≥ "cambio" o un c√≥digo que exista ah√≠
  try{
    const { data: cambios, error: e2 } = await supabase
      .from(TABLE_CAMBIOS)
      .select(`${CAMBIOS_COL_ORIGINAL}, ${CAMBIOS_COL_CAMBIO}`)
      .or([
        `${CAMBIOS_COL_ORIGINAL}.in.(${missing.join(",")})`,
        `${CAMBIOS_COL_CAMBIO}.in.(${missing.join(",")})`
      ].join(","));

    if(!e2 && Array.isArray(cambios) && cambios.length){
      // construimos un mapa de lookup: buscado -> original
      const toOriginal = new Map();
      for(const r of cambios){
        const orig = String(r?.[CAMBIOS_COL_ORIGINAL] ?? "").trim();
        const camb = String(r?.[CAMBIOS_COL_CAMBIO] ?? "").trim();
        if(orig){
          if(orig) toOriginal.set(orig, orig);
          if(camb) toOriginal.set(camb, orig);
        }
      }

      const originals = Array.from(new Set(missing.map(m => toOriginal.get(m)).filter(Boolean)));

      if(originals.length){
        const { data: veh2, error: e3 } = await supabase
          .from(TABLE_VEH)
          .select(`${COL_CODE}, ${COL_MODEL}`)
          .in(COL_CODE, originals);

        if(!e3 && Array.isArray(veh2)){
          const origToModel = new Map();
          for(const r of veh2){
            const code = String(r?.[COL_CODE] ?? "").trim();
            const model = String(r?.[COL_MODEL] ?? "").trim();
            if(code && model) origToModel.set(code, model);
          }
          // Asignamos al buscado el modelo del original
          for(const m of missing){
            const o = toOriginal.get(m);
            const model = o ? origToModel.get(o) : null;
            if(model) out.set(m, model);
          }
        }
      }
    }
  }catch(_){}

  return out;
}

/**
 * TOP 20 MODELOS:
 * 1) Lee search_events del rango
 * 2) Se queda con queries tipo c√≥digo
 * 3) Resuelve cada c√≥digo a un modelo
 * 4) Cuenta y pinta Top 20
 */
async function loadModelTop(){
  const from = dtFromRange($("range").value);
  const cat = ($("category").value || "").trim();

  let q = supabase
    .from("search_events")
    .select("query_raw, category, searched_at")
    .gte("searched_at", from);

  if(cat) q = q.eq("category", cat);

  const { data, error } = await q;
  if(error) throw error;

  const events = (data||[]);
  const codes = events
    .map(r => String(r.query_raw||"").trim())
    .filter(isCodeLike);

  // Resolver modelos
  setBrandMsg("Resolviendo modelos desde Supabase...", false);
  const codeToModel = await resolveModelsForCodes(codes);

  // Contar
  const count = new Map();
  for(const r of events){
    const code = String(r.query_raw||"").trim();
    if(!isCodeLike(code)) continue;

    const model = codeToModel.get(code);
    if(!model) continue;

    count.set(model, (count.get(model)||0) + 1);
  }

  const rows = Array.from(count.entries())
    .map(([model,n]) => ({ model, n }))
    .sort((a,b)=> b.n - a.n)
    .slice(0,20);

  const tbody = $("tBrands").querySelector("tbody");

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="2" class="mut">No hay modelos detectables a√∫n (revisa config: tabla/columnas).</td></tr>`;
    setBrandMsg("", false);
    return;
  }

  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td><span class="badge">${esc(r.model)}</span></td>
      <td><b>${r.n}</b></td>
    </tr>
  `).join("");

  setBrandMsg("", false);
}


    async function loadEbay(topRows){
      const userQ = ($("q").value || "").trim();
      let fallback = (topRows && topRows.length) ? String(topRows[0].query_raw || "").trim() : "";
      const category = normalizeCategory($("category").value);

      if(!userQ && isNumericOrCodeLike(fallback)){
        fallback = demoQueryByCategory(category);
      }
      const q = userQ || fallback;

      const tbody = $("tEbay").querySelector("tbody");
      tbody.innerHTML = `<tr><td class="mut">‚Äî</td><td class="mut">Cargando‚Ä¶</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>`;

      if(!q){
        setEbayMsg("No hay query para consultar eBay todav√≠a.", false);
        tbody.innerHTML = `<tr><td colspan="4" class="mut">Sin query para eBay.</td></tr>`;
        return;
      }

      try{
        setEbayMsg(`Consultando eBay para: "${q}"...`, false);

        const { gl } = getLocale();
        const payload = {
          q,
          limit: 20,
          marketplaceId: marketplaceByGL(gl),
          category: category || undefined
        };

        const { data, error } = await supabase.functions.invoke("ebay-radar", { body: payload });
        if(error) throw error;
        if(!data) throw new Error("Respuesta vac√≠a de ebay-radar.");

        const total = Number(data.total || 0);
        const env = data.env || "‚Äî";
        const mp = data.marketplaceId || "‚Äî";

        const median = fmtMoney(data?.price?.median, data?.price?.currency);
        const low = fmtMoney(data?.price?.low, data?.price?.currency);
        const high = fmtMoney(data?.price?.high, data?.price?.currency);

        const signalBadge = total > 0
          ? `<span class="badge bOk">total ${total}</span>`
          : `<span class="badge bWarn">total 0</span>`;

        /* ‚úÖ Compacto: sin top_brands ni sample */
        tbody.innerHTML = `
          <tr>
            <td>
              <div><b>${esc(q)}</b></div>
              <div class="mut" style="margin-top:4px">gl: ${esc(getLocale().gl)} ¬∑ env: ${esc(env)} ¬∑ marketplace: ${esc(mp)} ¬∑ categor√≠a: ${esc(category || "‚Äî")}</div>
            </td>
            <td>
              <div>${signalBadge}</div>
              <div style="margin-top:6px" class="mut">median: <b>${esc(median)}</b></div>
              <div class="mut">low: ${esc(low)} ¬∑ high: ${esc(high)}</div>
              <div class="mut" style="margin-top:6px">
                Nota: en <b>Sandbox</b> eBay suele devolver <b>0</b> resultados aunque est√© ‚ÄúOK‚Äù.
              </div>
            </td>
            <td class="mut">‚Äî</td>
            <td class="mut">‚Äî</td>
          </tr>
        `;

        setEbayMsg("", false);
      }catch(e){
        setEbayMsg("Error eBay: " + (e?.message || e), true);
        tbody.innerHTML = `<tr><td colspan="4" class="mut">No se pudo cargar se√±al eBay.</td></tr>`;
      }
    }

    function wordInsights(list){
      const stop = new Set(["de","la","el","y","para","con","en","por","un","una","del","los","las","o","a"]);
      const counts = new Map();
      for(const s of list){
        const parts = String(s||"").toLowerCase().split(/\s+/)
          .map(x=>x.replace(/[^a-z0-9√°√©√≠√≥√∫√±\-]/gi,"")).filter(Boolean);
        for(const p of parts){
          if(p.length < 3) continue;
          if(stop.has(p)) continue;
          counts.set(p, (counts.get(p)||0)+1);
        }
      }
      return Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
    }

    async function loadGoogleSuggest(topRows){
      const { gl, hl } = getLocale();

      const userQ = ($("q").value || "").trim();
      let fallback = (topRows && topRows.length) ? String(topRows[0].query_raw || "").trim() : "";
      const category = normalizeCategory($("category").value);

      if(!userQ && isNumericOrCodeLike(fallback)){
        fallback = demoQueryByCategory(category);
      }
      const baseQ = userQ || fallback;

      const tbody = $("tGoogle").querySelector("tbody");

      if(!baseQ){
        setGoogleMsg("No hay query para Google Suggest todav√≠a.", false);
        tbody.innerHTML = `<tr><td colspan="3" class="mut">Sin query.</td></tr>`;
        return;
      }

      try{
        setGoogleMsg(`Google Suggest (${gl}/${hl}) para: "${baseQ}"...`, false);

        const { data, error } = await supabase.functions.invoke("google-suggest", {
          body: { q: baseQ, hl, gl, limit: 10 }
        });
        if(error) throw error;

        const sug = Array.isArray(data?.suggestions) ? data.suggestions : [];
        const sugHtml = sug.length
          ? sug.map(x=>`<div style="margin-bottom:6px"><span class="badge">${esc(x)}</span></div>`).join("")
          : `<span class="badge bWarn">sin sugerencias</span>`;

        const ins = wordInsights(sug);
        const insHtml = ins.length
          ? ins.map(([w,n])=> `<span class="badge">${esc(w)} ¬∑ ${n}</span>`).join(" ")
          : `<span class="badge bWarn">sin insights</span>`;

        tbody.innerHTML = `
          <tr>
            <td>
              <b>${esc(baseQ)}</b>
              <div class="mut" style="margin-top:4px">pa√≠s: ${esc(gl)} ¬∑ idioma: ${esc(hl)}</div>
            </td>
            <td style="min-width:320px">${sugHtml}</td>
            <td>${insHtml}</td>
          </tr>
        `;

        setGoogleMsg("", false);
      }catch(e){
        setGoogleMsg("Error Google: " + (e?.message || e), true);
        tbody.innerHTML = `<tr><td colspan="3" class="mut">No se pudo cargar Google Suggest.</td></tr>`;
      }
    }

    window.goIndex = function(){ window.location.href = "index.html"; };
    window.goApp = function(){ window.location.href = "app.html"; };

    window.resetFilters = function(){
      $("range").value = "7";
      $("category").value = "";
      $("q").value = "";
      refreshAll();
    };

    window.refreshAll = async function(){
      try{
        setMsg("Cargando radar...", false);
        setBrandMsg("Calculando marcas...", false);
        await loadKpis();
        await loadModelTop();          // ‚úÖ nuevo
        const topRows = await loadTop();
        await loadOpp();
        await loadEbay(topRows);
        await loadGoogleSuggest(topRows);
        setMsg("", false);
      }catch(e){
        setMsg("Error: " + (e?.message || e), true);
      }
    };

    ["range","category"].forEach(id=>{
      $(id).addEventListener("change", ()=> refreshAll());
    });

    let tDeb = null;
    $("q").addEventListener("input", ()=>{
      clearTimeout(tDeb);
      tDeb = setTimeout(()=> refreshAll(), 450);
    });

    ["gl","hl"].forEach(id=>{
      $(id).addEventListener("change", ()=>{
        saveLocale();
        refreshAll();
      });
    });

    document.getElementById("y").textContent = new Date().getFullYear();
    loadLocaleFromLocalStorage();
    await loadProfileLocaleIfAny();
    refreshAll();
  </script>
</body>
</html>


