<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Radar de Demanda</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.92);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
      --ok:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(rgba(246,247,251,.92), rgba(246,247,251,.92)),
        url("assets/bg.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      min-height:100vh;
      overflow-x:hidden;
    }

    .page{
      width:100%;
      max-width: 100vw;
      margin:0 auto;
      padding:18px 22px 28px;
    }
    @media(min-width:1400px){
      .page{ padding-left:34px; padding-right:34px; }
    }

    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background:rgba(246,247,251,.68);
      border:1px solid rgba(230,232,240,.75);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900; user-select:none;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .brandTitle{line-height:1}
    .brandTitle b{display:block;font-size:15px}
    .brandTitle span{display:block;font-size:12px;color:#94a3b8;font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-top:2px}

    .navRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:10px 12px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnGhost{background:#fff;border:1px solid var(--line);color:#0f172a}

    .hero{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .hero h1{ margin:0; font-size:26px; letter-spacing:-.2px; }
    .hero p{ margin:10px 0 0; color:var(--mut); font-size:14px; line-height:1.45; max-width:1000px; }

    .filters{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .inp{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:800;
      outline:none;
      color:#0f172a;
    }
    .inp:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .select{ min-width:180px; }
    .text{ min-width:240px; flex:1 1 320px; }

    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1 1 220px;
      border:1px solid rgba(230,232,240,.9);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kpi .t{font-size:12px;color:#94a3b8;font-weight:900;text-transform:uppercase;letter-spacing:.4px}
    .kpi .v{font-size:18px;font-weight:900;margin-top:6px}
    .kpi .s{font-size:12px;color:var(--mut);margin-top:6px;line-height:1.35}

    .gridMain{
      display:grid;
      grid-template-columns: 340px 1fr 1fr;
      grid-template-areas:
        "brands top opp"
        "brands ebay google";
      gap:12px;
      margin-top:14px;
      align-items:start;
    }
    .areaBrands{ grid-area: brands; }
    .areaTop{ grid-area: top; }
    .areaOpp{ grid-area: opp; }
    .areaEbay{ grid-area: ebay; }
    .areaGoogle{ grid-area: google; }

    @media(max-width:1200px){
      .gridMain{
        grid-template-columns: 1fr;
        grid-template-areas:
          "brands"
          "top"
          "opp"
          "ebay"
          "google";
      }
    }

    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.88);
      box-shadow:0 10px 26px rgba(2,6,23,.06);
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0;font-size:14px;font-weight:900}
    .sub{font-size:12px;color:#94a3b8;font-weight:900;letter-spacing:.4px;text-transform:uppercase;margin-top:4px}

    .tableWrap{
      margin-top:10px;
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      overflow:auto;
      background:#fff;
    }
    .tableWrap.compact{ max-height: 340px; }
    @media(min-width:1200px){
      .tableWrap.tall{ max-height: 540px; }
    }

    table{width:100%;border-collapse:collapse}
    th,td{
      padding:10px;
      border-bottom:1px solid #eef0f6;
      font-size:13px;
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky; top:0; z-index:1;
      background:#fafbff;
      font-weight:900;
      color:#0f172a;
    }

    .badge{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(230,232,240,.95);
      background:rgba(37,99,235,.08);
      color:var(--pri);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin:2px 4px 2px 0;
    }

    .badgeOffer{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.25);
      background:rgba(16,185,129,.10);
      color:#065f46;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badgeOffer.off0{
      border-color:rgba(148,163,184,.55);
      background:rgba(148,163,184,.14);
      color:rgba(30,41,59,.85);
    }

    .bOk{ background:rgba(16,185,129,.10); color:var(--ok); border-color:rgba(16,185,129,.25); }
    .bBad{ background:rgba(239,68,68,.10); color:var(--bad); border-color:rgba(239,68,68,.25); }
    .bWarn{ background:rgba(245,158,11,.10); color:var(--warn); border-color:rgba(245,158,11,.25); }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      padding:10px 12px;
      border-radius:14px;
      display:none;
    }
    .msg.err{ background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.18); }

    .mut{ color:#64748b; font-weight:800; }
    .footer{ margin-top:14px; text-align:center; color:#94a3b8; font-size:12px; font-weight:800; }

    .hideEbayCols th:nth-child(3),
    .hideEbayCols th:nth-child(4),
    .hideEbayCols td:nth-child(3),
    .hideEbayCols td:nth-child(4){
      display:none;
    }

    /* ‚úÖ NUEVO: bot√≥n clickable para modelo */
    .chipBtn{
      border:0;
      background:transparent;
      padding:0;
      cursor:pointer;
      font:inherit;
    }
    .chipBtn:active{ transform: translateY(1px); }

    /* ‚úÖ NUEVO: Modal de detalle de c√≥digos por modelo */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:18px;
    }
    .modal{
      width:min(900px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(230,232,240,.95);
      box-shadow:0 30px 90px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      background:rgba(246,247,251,.75);
      border-bottom:1px solid rgba(230,232,240,.95);
    }
    .modalHead b{ font-size:14px; }
    .modalBody{ padding:12px 14px; }
    .modalBody .mut{ font-size:12px; }
    .modalClose{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:8px 10px;
      background:#fff; border:1px solid rgba(230,232,240,.95);
    }
  
    /* ‚úÖ NUEVO: Modal MAPA */
    .mapModal{
      width:min(1100px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(230,232,240,.95);
      box-shadow:0 30px 90px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .mapGrid{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:12px;
      padding:12px 14px 14px;
    }
    @media(max-width:900px){
      .mapGrid{ grid-template-columns: 1fr; }
    }
    .mapSide{
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      padding:12px;
      background:#fff;
      overflow:auto;
      max-height: 560px;
    }
    .mapSide h3{ margin:0 0 8px; font-size:13px; font-weight:900; }
    .mapSide .mut{ font-size:12px; }
    .barRow{
      display:flex; align-items:center; gap:10px;
      margin:8px 0;
    }
    .barLbl{
      width:120px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .bar{
      flex:1;
      height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.20);
      overflow:hidden;
      border:1px solid rgba(230,232,240,.95);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(37,99,235,.85), rgba(16,185,129,.65));
      border-radius:999px;
    }
    .barPct{
      width:54px;
      text-align:right;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
    }
    .mapCanvas{
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(37,99,235,.06), rgba(16,185,129,.04));
      padding:12px;
      position:relative;
      overflow:hidden;
      min-height: 360px;
    }
    .mapTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .mapTitle b{ font-size:13px; }
    .mapHint{ font-size:12px; color:#64748b; font-weight:800; }
    .rfMapSvg{
      width:100%;
      height:auto;
      display:block;
      filter: drop-shadow(0 10px 18px rgba(2,6,23,.10));
      user-select:none;
    }
    .rg{
      fill: rgba(255,255,255,.85);
      stroke: rgba(148,163,184,.65);
      stroke-width: 1;
      cursor:pointer;
      transition: .15s ease;
    }
    .rg:hover{ fill: rgba(37,99,235,.12); }
    .rg.active{
      fill: rgba(37,99,235,.22);
      stroke: rgba(37,99,235,.65);
      stroke-width: 1.2;
    }
    .mapTooltip{
      position:absolute;
      left:12px; top:12px;
      z-index: 5000; /* ‚úÖ siempre por encima del mapa Leaflet */
      background:rgba(255,255,255,.94);
      border:1px solid rgba(230,232,240,.95);
      border-radius:16px;
      padding:12px 14px;
      box-shadow:0 18px 45px rgba(2,6,23,.18);
      max-width: 380px;
      display:none;
      pointer-events:none;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      outline: 3px solid rgba(37,99,235,.10);
      animation: rfPop .14s ease-out;
    }
    @keyframes rfPop{
      from{ transform: translateY(6px); opacity:.0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .mapTooltip b{ font-size:12px; display:block; }
    .mapTooltip .mut{ font-size:12px; margin-top:4px; }
    .mapTooltip .mini{ margin-top:8px; font-size:12px; color:#0f172a; font-weight:900; }
    .mapTooltip .mini span{ font-weight:800; color:#64748b; }


/* ‚úÖ Leaflet container (Mapa real) */
#rfLeafletMap{
  position: relative;
  z-index: 1;
  width:100%;
  height:420px;
  border-radius:14px;
  overflow:hidden;
}
.leaflet-container{
  border-radius:14px;
  font-family: Arial,Helvetica,sans-serif;
}
/* Mantener controles visibles pero debajo del tooltip */
.leaflet-top, .leaflet-bottom{ z-index: 800; }
.leaflet-pane{ z-index: 400; }
  .btnIcon{ margin-right:8px; font-size:16px; vertical-align:-2px; }
</style>
<!-- Leaflet (Mapa real) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>

<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="logo">RF</div>
        <div class="brandTitle">
          <b>RepuestoFinder</b>
          <span>Radar de Demanda</span>
        </div>
      </div>

      <div class="navRight">
        <button class="btn btnGhost" onclick="goIndex()">Volver</button>
        <button class="btn btnGhost" onclick="goApp()">Ir a la App</button>
        <button class="btn btnGhost" onclick="openMapModal()" title="Ver mapa y distribuci√≥n por modelos"><span class="btnIcon">üó∫Ô∏è</span> Mapa</button>
        <button class="btn btnPrimary" onclick="refreshAll()">Actualizar</button>
      </div>
    </div>

    <div class="hero">
      <h1>Radar Mundial</h1>
      <p>
       
      </p>

      <div class="filters">
        <select id="range" class="inp select">
          <option value="1">√öltimas 24 horas</option>
          <option value="7" selected>√öltimos 7 d√≠as</option>
          <option value="30">√öltimos 30 d√≠as</option>
        </select>

        <select id="category" class="inp select">
          <option value="">Todas las l√≠neas</option>
          <option value="frenos">Frenos</option>
          <option value="suspension">Suspensi√≥n</option>
          <option value="motor">Motor</option>
          <option value="electrico">El√©ctrico</option>
          <option value="cooling">Cooling</option>
          <option value="transmision">Transmisi√≥n</option>
          <option value="otros">Otros</option>
        </select>

        <select id="gl" class="inp select" title="Pa√≠s (Google gl)">
          <option value="DO">DO Rep√∫blica Dominicana (DO)</option>
          <option value="US">US Estados Unidos (US)</option>
          <option value="MX">MX M√©xico (MX)</option>
          <option value="CA">CA Canad√° (CA)</option>
          <option value="ES">ES Espa√±a (ES)</option>
          <option value="PT">PT Portugal (PT)</option>
          <option value="FR">FR Francia (FR)</option>
          <option value="DE">DE Alemania (DE)</option>
          <option value="IT">IT Italia (IT)</option>
          <option value="GB">GB Reino Unido (GB)</option>
          <option value="NL">NL Pa√≠ses Bajos (NL)</option>
          <option value="BE">BE B√©lgica (BE)</option>
          <option value="CH">CH Suiza (CH)</option>
          <option value="SE">SE Suecia (SE)</option>
          <option value="NO">NO Noruega (NO)</option>
          <option value="DK">DK Dinamarca (DK)</option>
          <option value="FI">FI Finlandia (FI)</option>
          <option value="PL">PL Polonia (PL)</option>
          <option value="TR">TR Turqu√≠a (TR)</option>
          <option value="RU">RU Rusia (RU)</option>
          <option value="UA">UA Ucrania (UA)</option>
          <option value="SA">SA Arabia Saudita (SA)</option>
          <option value="AE">AE Emiratos √Årabes Unidos (AE)</option>
          <option value="EG">EG Egipto (EG)</option>
          <option value="MA">MA Marruecos (MA)</option>
          <option value="ZA">ZA Sud√°frica (ZA)</option>
          <option value="NG">NG Nigeria (NG)</option>
          <option value="KE">KE Kenia (KE)</option>
          <option value="IN">IN India (IN)</option>
          <option value="TH">TH Tailandia (TH)</option>
          <option value="VN">VN Vietnam (VN)</option>
          <option value="MY">MY Malasia (MY)</option>
          <option value="SG">SG Singapur (SG)</option>
          <option value="ID">ID Indonesia (ID)</option>
          <option value="PH">PH Filipinas (PH)</option>
          <option value="CN">CN China (CN)</option>
          <option value="JP">JP Jap√≥n (JP)</option>
          <option value="KR">KR Corea del Sur (KR)</option>
          <option value="AU">AU Australia (AU)</option>
          <option value="NZ">NZ Nueva Zelanda (NZ)</option>
          <option value="CO">CO Colombia (CO)</option>
          <option value="CL">CL Chile (CL)</option>
          <option value="PE">PE Per√∫ (PE)</option>
          <option value="AR">AR Argentina (AR)</option>
          <option value="BR">BR Brasil (BR)</option>
          <option value="EC">EC Ecuador (EC)</option>
          <option value="VE">VE Venezuela (VE)</option>
          <option value="BO">BO Bolivia (BO)</option>
          <option value="PY">PY Paraguay (PY)</option>
          <option value="UY">UY Uruguay (UY)</option>
          <option value="PA">PA Panam√° (PA)</option>
          <option value="CR">CR Costa Rica (CR)</option>
          <option value="GT">GT Guatemala (GT)</option>
          <option value="SV">SV El Salvador (SV)</option>
          <option value="HN">HN Honduras (HN)</option>
          <option value="NI">NI Nicaragua (NI)</option>
          <option value="CU">CU Cuba (CU)</option>
          <option value="PR">PR Puerto Rico (PR)</option>
          <option value="JM">JM Jamaica (JM)</option>
          <option value="HT">HT Hait√≠ (HT)</option>
          <option value="TT">TT Trinidad y Tobago (TT)</option>
          <option value="BS">BS Bahamas (BS)</option>
          <option value="BZ">BZ Belice (BZ)</option>
          <option value="GY">GY Guyana (GY)</option>
          <option value="SR">SR Surinam (SR)</option>
          <option value="ALL">üåé Todos (GLOBAL)</option>
        </select>

        <select id="hl" class="inp select" title="Idioma (Google hl)">
          <option value="es" selected>Espa√±ol (es)</option>
          <option value="en">English (en)</option>
          <option value="pt">Portugu√™s (pt)</option>
          <option value="fr">Fran√ßais (fr)</option>
          <option value="de">Deutsch (de)</option>
          <option value="it">Italiano (it)</option>
          <option value="nl">Nederlands (nl)</option>
          <option value="sv">Svenska (sv)</option>
          <option value="tr">T√ºrk√ße (tr)</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π (ru)</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (ar)</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (hi)</option>
          <option value="ja">Êó•Êú¨Ë™û (ja)</option>
          <option value="ko">ÌïúÍµ≠Ïñ¥ (ko)</option>
          <option value="zh-CN">‰∏≠Êñá(ÁÆÄ‰Ωì) (zh-CN)</option>
          <option value="zh-TW">‰∏≠Êñá(ÁπÅÈ´î) (zh-TW)</option>
        </select>

        <input id="q" class="inp text" placeholder="Filtrar / query (ej: corolla 2014 2017 brake pads)" />
        <button class="btn btnGhost" onclick="resetFilters()">Limpiar</button>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="t">B√∫squedas</div>
          <div class="v" id="k1">‚Äî</div>
          <div class="s">Total en el rango.</div>
        </div>
        <div class="kpi">
          <div class="t">No encontrado</div>
          <div class="v" id="k2">‚Äî</div>
          <div class="s"></div>
        </div>
        <div class="kpi">
          <div class="t">Tasa de oportunidad</div>
          <div class="v" id="k3">‚Äî</div>
          <div class="s">% b√∫squedas sin resultado.</div>
        </div>
      </div>

      <div class="msg" id="msg"></div>
    </div>

    <div class="gridMain">
      <div class="card areaBrands">
        <h2>Top Modelos (interno)</h2>
        <div class="sub"></div>
        <div class="msg" id="bMsg" style="display:block">Calculando modelos...</div>

        <div class="tableWrap tall">
          <table id="tBrands">
            <thead>
              <tr><th>Modelo</th><th>Consultas</th></tr>
            </thead>
            <tbody>
              <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mut" style="font-size:12px;margin-top:10px;line-height:1.4">
          
        </div>
      </div>

      <div class="card areaTop">
        <h2>Top B√∫squedas (interno)</h2>
        <div class="sub">Lo m√°s buscado en tu sistema (por rango)</div>
        <div class="tableWrap compact">
          <table id="tTop">
            <thead>
              <tr><th>Query</th><th>L√≠nea</th><th>Veces</th><th>Estado</th><th>Oferta disponible</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card areaOpp">
        <h2>Oportunidades (alto "no encontrado")</h2>
        <div class="sub">Demanda sin cobertura</div>
        <div class="tableWrap compact">
          <table id="tOpp">
            <thead>
              <tr><th>Query</th><th>L√≠nea</th><th>Veces</th><th>No encontrado</th><th>%</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card areaEbay">
        <h2>Se√±al eBay (externo)</h2>
        <div class="sub">Compacto (sin Top marcas / Muestra)</div>
        <div class="msg" id="ebMsg" style="display:block">Cargando se√±al eBay...</div>
        <div class="tableWrap compact" style="margin-top:10px">
          <table id="tEbay" class="hideEbayCols">
            <thead><tr><th>Query</th><th>Se√±al</th><th>Top marcas</th><th>Muestra</th></tr></thead>
            <tbody>
              <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card areaGoogle">
        <h2>Se√±al Google (autocomplete)</h2>
        <div class="sub">Mercado local por pa√≠s e idioma</div>
        <div class="msg" id="gMsg" style="display:block">Cargando sugerencias...</div>
        <div class="tableWrap compact" style="margin-top:10px">
          <table id="tGoogle">
            <thead><tr><th>Query base</th><th>Sugerencias</th><th>Insights</th></tr></thead>
            <tbody>
              <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">¬© <span id="y"></span> RepuestoFinder</div>
  </div>

  <!-- ‚úÖ MODAL: Detalle de c√≥digos por modelo -->
<div id="modelModalOverlay" class="modalOverlay" onclick="closeModelModal(event)">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modelModalTitle" onclick="event.stopPropagation()">
    <div class="modalHead">
      <div>
        <b id="modelModalTitle">Detalle</b>
        <div class="mut" id="modelModalSub">‚Äî</div>
      </div>
      <button class="modalClose" onclick="closeModelModal()">Cerrar</button>
    </div>
    <div class="modalBody">
      <div class="tableWrap" style="max-height:420px">
        <table id="tModelCodes">
          <thead>
            <tr>
              <th>C√≥digo buscado</th>
              <th>Veces</th>
              <th>Original (resuelto)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>
          </tbody>
        </table>
      </div>
      <div class="mut" style="margin-top:10px;line-height:1.35">
        * ‚ÄúOriginal (resuelto)‚Äù es el <b>original_norm</b> encontrado via <b>cambios / datos_vehiculares</b>.  
        Si sale ‚Äú‚Äî‚Äù, ese c√≥digo no pudo resolverse en el cat√°logo.
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL: MAPA + % por modelos (incluye 'Desconocido') -->
<div id="mapOverlay" class="modalOverlay" onclick="closeMapModal(event)">
  <div class="mapModal" role="dialog" aria-modal="true" aria-labelledby="mapModalTitle" onclick="event.stopPropagation()">
    <div class="modalHead">
      <div>
        <b id="mapModalTitle">Mapa ¬∑ Modelos m√°s buscados</b>
        <div class="mut" id="mapModalSub">‚Äî</div>
      </div>
      <button class="modalClose" onclick="closeMapModal()">Cerrar</button>
    </div>

    <div class="mapGrid">
      <div class="mapSide">
        <h3>Distribuci√≥n por modelo</h3>
        <div class="mut" id="mapSideNote">* ‚ÄúDesconocido‚Äù = b√∫squedas <b>no_found</b> o c√≥digos que no logramos mapear a un veh√≠culo.</div>
        <div id="mapBars" style="margin-top:10px"></div>
      </div>

      <div class="mapCanvas">
        <div class="mapTitle">
          <b>Zona / pa√≠s seleccionado</b>
          <div class="mapHint">Pasa el mouse por el mapa para ver el resumen</div>
        </div>

        <div id="mapTooltip" class="mapTooltip"></div>

        <!-- ‚úÖ MAPA REAL (Leaflet + OpenStreetMap Outdoor / fallback OSM) -->
<div id="rfLeafletMap" style="width:100%;height:420px;border-radius:14px;"></div>
</div>
    </div>
  </div>
</div>

<script type="module">
    import { supabase } from "./assets/supabaseClient.js";
    const $ = (id)=>document.getElementById(id);

    // ==========================
    // Pa√≠s activo (dropdown o selecci√≥n en el mapa)
    // ==========================
    function activeISO(){
      const isoRaw = (window.__rfCountryPinnedISO || $("gl")?.value || "").toString().toUpperCase().trim();
      if(isoRaw === "ALL") return "";
      return isoRaw;
    }

    // Helper: trae eventos filtrados (por rango, categor√≠a y pa√≠s)
    async function fetchSearchEventsFiltered(selectCols){
      const from = dtFromRange($("range").value);
      const cat  = ($("category").value || "").trim();
      const iso  = activeISO();

      const makeBase = () => {
        let q = supabase
          .from("search_events")
          .select(selectCols)
          .gte("searched_at", from);
        if(cat) q = q.eq("category", cat);
        return q;
      };

      // sin pa√≠s
      if(!iso){
        const { data, error } = await makeBase();
        if(error) throw error;
        return data || [];
      }

      // primero intentamos con 'gl'
      {
        const { data, error } = await makeBase().eq("gl", iso);
        if(!error) return data || [];
        // si la columna no existe o no est√° habilitada, intentamos con 'country'
        const msg = (error?.message || "").toLowerCase();
        const isMissingColumn = msg.includes("column") && (msg.includes("gl") || msg.includes("country"));
        const isBadRequest = String(error?.code || "").includes("42703") || String(error?.status || "").includes("400");
        if(!(isMissingColumn || isBadRequest)){
          // Si fue otro error real, lo lanzamos
          throw error;
        }
      }

      // fallback: 'country'
      {
        const { data, error } = await makeBase().eq("country", iso);
        if(error) throw error;
        return data || [];
      }
    }

    function setMsg(text, isErr){
      const el = $("msg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setEbayMsg(text, isErr){
      const el = $("ebMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setGoogleMsg(text, isErr){
      const el = $("gMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }
    function setBrandMsg(text, isErr){
      const el = $("bMsg");
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    function dtFromRange(days){
      const d = new Date();
      d.setDate(d.getDate() - Number(days || 7));
      return d.toISOString();
    }
        function esc(s){
      return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[c]));
    }
    

// ‚úÖ OpenStreetMap Outdoor (Basemap premium)
// Para activar OpenStreetMap, guarda tu API Key en el navegador:
// localStorage.setItem("RF_OpenStreetMap_KEY","TU_KEY");


// ‚úÖ KEY GLOBAL (para TODOS los usuarios)
// Reemplaza el texto PASTE_OpenStreetMap_KEY_HERE por tu API Key real de OpenStreetMap.
// Puedes restringir por dominio desde el panel de OpenStreetMap.
let __rfLeafletMap = null;
let __rfLeafletLayer = null;

// Centro/zoom por pa√≠s (solo pa√≠s)
const COUNTRY_CENTER = {
  DO:[18.7357,-70.1627], PR:[18.2208,-66.5901], US:[39.8283,-98.5795], CA:[56.1304,-106.3468],
  MX:[23.6345,-102.5528], CO:[4.5709,-74.2973], CL:[-35.6751,-71.5430], PE:[-9.1900,-75.0152],
  AR:[-38.4161,-63.6167], BR:[-14.2350,-51.9253], EC:[-1.8312,-78.1834], VE:[6.4238,-66.5897],
  BO:[-16.2902,-63.5887], PY:[-23.4425,-58.4438], UY:[-32.5228,-55.7658], PA:[8.5380,-80.7821],
  CR:[9.7489,-83.7534], GT:[15.7835,-90.2308], SV:[13.7942,-88.8965], HN:[15.2000,-86.2419],
  NI:[12.8654,-85.2072], JM:[18.1096,-77.2975], FR:[46.2276,2.2137], DE:[51.1657,10.4515],
  IT:[41.8719,12.5674], ES:[40.4637,-3.7492], GB:[55.3781,-3.4360], NL:[52.1326,5.2913],
  SE:[60.1282,18.6435], CH:[46.8182,8.2275], AU:[-25.2744,133.7751], JP:[36.2048,138.2529],
  KR:[35.9078,127.7669]
};

function initLeafletMapOnce(){
  const el = document.getElementById("rfLeafletMap");
  if(!el) return;

  if(!__rfLeafletMap){
    __rfLeafletMap = L.map(el, { zoomControl:true, attributionControl:true });

    // ‚úÖ OpenStreetMap (sin API key, global para todos)
    __rfLeafletLayer = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 19, attribution: "&copy; OpenStreetMap contributors" }
    ).addTo(__rfLeafletMap);
  }else{
    // Si ya existe el mapa, aseg√∫rate de que Leaflet recalcule tama√±os cuando abras el modal
    try{ __rfLeafletMap.invalidateSize(); }catch(_e){}
  }
}

/* ===========================
   ===========================
   ‚úÖ Pa√≠ses interactivos (hover/click) en el mapa
   - Carga GeoJSON mundial (ISO_A2)
   - Al pasar el mouse por un pa√≠s:
       * Muestra tooltip con Top Modelos del pa√≠s
       * Actualiza el panel izquierdo (Distribuci√≥n por modelo)
   - Al hacer click: fija la selecci√≥n del pa√≠s y hace zoom al pa√≠s
   =========================== */

let __rfCountriesLayer = null;
let __rfCountriesGeo = null;
let __rfCountryDistCache = new Map();
let __rfCountryHoverTimer = null;
let __rfCountryPinnedISO = null;

// ‚úÖ Burbujeo por pa√≠s (solo cuando gl = ALL)
let __rfCountryBubbleLayer = null;
let __rfCountryActivityCache = new Map();
let __rfCountryLayerByISO = new Map(); // iso -> leaflet layer


async function fetchCountriesGeoJSONOnce(){
  if(__rfCountriesGeo) return __rfCountriesGeo;
  const url = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";
  const res = await fetch(url, { cache: "force-cache" });
  if(!res.ok) throw new Error("No se pudo cargar el GeoJSON de pa√≠ses ("+res.status+").");
  const geo = await res.json();
  __rfCountriesGeo = geo;
  return geo;
}

function isoFromFeature(f){
  const p = (f && f.properties) ? f.properties : {};
  const iso = String(p.ISO_A2 || p.ISO_A2_EH || "").toUpperCase().trim();
  if(!iso || iso === "-99") return "";
  return iso;
}

function nameFromFeature(f){
  const p = (f && f.properties) ? f.properties : {};
  return String(p.ADMIN || p.NAME_EN || p.name || p.NAME || "").trim() || "Pa√≠s";
}

function styleCountryDefault(){
  return {
    weight: 1,
    color: "rgba(148,163,184,.55)",
    fillColor: "rgba(37,99,235,.08)",
    fillOpacity: 0.08
  };
}
function styleCountryHover(){
  return {
    weight: 2,
    color: "rgba(37,99,235,.85)",
    fillColor: "rgba(37,99,235,.20)",
    fillOpacity: 0.22
  };
}
function styleCountryPinned(){
  return {
    weight: 2.5,
    color: "rgba(16,185,129,.95)",
    fillColor: "rgba(16,185,129,.18)",
    fillOpacity: 0.22
  };
}

function setCountryLayerStyle(layer, styleObj){
  try{ layer.setStyle(styleObj); }catch(_e){}
}


/* ===========================
   ‚úÖ Burbuja de actividad por pa√≠s (cuando gl = ALL)
   - Tama√±o = m√°s b√∫squedas = burbuja m√°s grande
   - Click: fija el pa√≠s en el dropdown y refresca todo
   =========================== */
function __rfBubbleRadius(count){
  const c = Math.max(0, Number(count||0));
  // escala suave (sqrt) para no explotar el tama√±o
  return Math.min(42, 6 + Math.sqrt(c) * 2.2);
}
function __rfBubbleColor(count){
  const c = Math.max(0, Number(count||0));
  if(c >= 200) return "#1d4ed8"; // alto
  if(c >= 80)  return "#2563eb"; // medio
  if(c >= 20)  return "#3b82f6"; // bajo
  return "#93c5fd"; // muy bajo
}

async function getCountryActivityCountsCached(){
  // Cache por filtros (range + category + query + line + hl)
  const from = dtFromRange($("range").value);
  const cat = ($("category").value || "").trim();
  const qf  = ($("q").value || "").trim().toLowerCase();
  const line = String($("category").value||"").trim(); // category ya hace de l√≠nea en tu UI
  const hl = String($("hl").value||"").trim();

  const key = JSON.stringify({ from, cat, qf, line, hl });
  if(__rfCountryActivityCache.has(key)) return __rfCountryActivityCache.get(key);

  // Query base
  const baseQ = (fromCol) => {
    let qq = supabase
      .from("search_events")
      .select(fromCol)
      .gte("searched_at", from);
    if(cat) qq = qq.eq("category", cat);
    if(qf)  qq = qq.ilike("query_raw", `%${qf}%`);
    return qq;
  };

  // Paginaci√≥n defensiva
  async function pullAll(colName){
    const out = [];
    let fromI = 0;
    const pageSize = 1000;
    const maxRows = 50000; // l√≠mite defensivo
    while(fromI < maxRows){
      const toI = fromI + pageSize - 1;
      const { data, error } = await baseQ(colName).range(fromI, toI);
      if(error) throw error;
      const arr = data || [];
      out.push(...arr);
      if(arr.length < pageSize) break;
      fromI += pageSize;
    }
    return out;
  }

  let rows = null;
  let usedCol = null;

  // Intento 1: gl
  try{
    rows = await pullAll("gl");
    usedCol = "gl";
  }catch(_e1){
    // Intento 2: country
    try{
      rows = await pullAll("country");
      usedCol = "country";
    }catch(_e2){
      rows = [];
      usedCol = null;
    }
  }

  const counts = new Map();
  if(usedCol){
    for(const r of (rows||[])){
      const iso = String(r[usedCol]||"").toUpperCase().trim();
      if(!iso) continue;
      counts.set(iso, (counts.get(iso)||0) + 1);
    }
  }

  const payload = { key, counts, usedCol };
  __rfCountryActivityCache.set(key, payload);
  return payload;
}

function clearCountryBubbles(){
  if(__rfCountryBubbleLayer){
    try{ __rfCountryBubbleLayer.clearLayers(); }catch(_e){}
    try{ __rfLeafletMap.removeLayer(__rfCountryBubbleLayer); }catch(_e){}
  }
  __rfCountryBubbleLayer = L.layerGroup().addTo(__rfLeafletMap);
  // pane arriba de pa√≠ses
  try{
    if(!__rfLeafletMap.getPane("rfBubbles")){
      const p = __rfLeafletMap.createPane("rfBubbles");
      p.style.zIndex = 650;
    }
  }catch(_e){}
}

async function renderCountryBubblesIfAll(){
  if(!__rfLeafletMap) return;
  const { gl } = glLabel();
  const iso = String(gl||"").toUpperCase().trim();

  // Solo en ALL mostramos burbujas globales (por pa√≠s)
  if(iso !== "ALL"){
    // Si no es ALL, solo resalta pa√≠s (sin burbujas globales)
    if(__rfCountryBubbleLayer){
      try{ __rfCountryBubbleLayer.clearLayers(); }catch(_e){}
    }
    return;
  }

  // Asegura capa pa√≠ses y bubble layer
  await addCountriesLayerOnce();
  clearCountryBubbles();

  const { counts, usedCol } = await getCountryActivityCountsCached();
  if(!usedCol || !counts || counts.size === 0){
    // Sin datos de pa√≠s guardados
    return;
  }

  // Para escalar tama√±o con relaci√≥n al m√°ximo
  let max = 0;
  for(const v of counts.values()) max = Math.max(max, v||0);
  if(!max) return;

  // Creamos burbujas sobre el centro del pa√≠s (centroid basado en bounds del pol√≠gono)
  for(const [iso2, count] of counts.entries()){
    const layer = __rfCountryLayerByISO.get(iso2);
    if(!layer) continue;

    let center = null;
    try{
      const b = layer.getBounds();
      center = b.getCenter();
    }catch(_e){}

    if(!center) continue;

    const r = __rfBubbleRadius(count);
    const col = __rfBubbleColor(count);

    const marker = L.circleMarker(center, {
      pane: "rfBubbles",
      radius: r,
      color: col,
      weight: 2,
      fillColor: col,
      fillOpacity: 0.35
    });

    // Tooltip + click
    marker.bindTooltip(`${iso2}: ${count} b√∫squedas`, { direction:"top", opacity:0.95, sticky:true });

    marker.on("click", async ()=>{
      // fija pa√≠s y refresca todo (incluye mapa y paneles)
      const sel = $("gl");
      if(sel){
        sel.value = iso2;
        // dispara change real
        sel.dispatchEvent(new Event("change", { bubbles:true }));
      }
      // en el modal, tambi√©n actualiza el panel de distribuci√≥n de inmediato
      try{
        __rfCountryPinnedISO = iso2;
        await updateUIForCountry(iso2);
        setMapViewByCountry(iso2);
      }catch(_e){}
    });

    marker.addTo(__rfCountryBubbleLayer);
  }
}

async function getCountryDistributionCached(iso){
  const key = String(iso||"").toUpperCase().trim();
  if(!key) return { dist: [], top: [], total: 0, noCountry:false };
  if(__rfCountryDistCache.has(key)) return __rfCountryDistCache.get(key);
  const res = await buildModelDistributionForMap(key);
  __rfCountryDistCache.set(key, res);
  return res;
}

async function updateUIForCountry(iso, displayName, opts){

  const sub = document.getElementById("mapModalSub");
  const tip = document.getElementById("mapTooltip");

  // Actualizar header del modal
  if(sub){
    const label = iso ? (displayName ? `${displayName} (${iso})` : iso) : "üåé GLOBAL";
    sub.textContent = `Pa√≠s: ${label} ¬∑ Rango: ${document.getElementById("range").value} d√≠a(s) ¬∑ L√≠nea: ${(document.getElementById("category").value || "todas")}`;
  }

  // Distribuci√≥n + tooltip
  const { dist, top, noCountry } = await getCountryDistributionCached(iso);
  renderBars(dist);

  if(tip){
    const label = displayName ? `${displayName} (${iso})` : iso;
    const badge = (opts && opts.badge) ? opts.badge : null;
const badgeCls = (opts && opts.badgeCls) ? opts.badgeCls : "rfHasData";
const countTxt = (opts && typeof opts.count === "number") ? ` ¬∑ ${opts.count} b√∫squedas` : "";

tip.innerHTML = tooltipHTML(`Resumen ¬∑ ${label}`, top, badge, badgeCls, countTxt) +
  (noCountry ? `<div class="mut" style="margin-top:8px">‚ö†Ô∏è A√∫n no hay pa√≠s por b√∫squeda en <b>search_events</b>. Agrega la columna <b>country</b> (ISO2) al guardar cada evento.</div>` : ``);
tip.style.display = "block";    tip.style.display = "block";
  }
}

async function addCountriesLayerOnce(){
  if(!__rfLeafletMap) return;
  if(__rfCountriesLayer) return;

  const geo = await fetchCountriesGeoJSONOnce();

  __rfCountriesLayer = L.geoJSON(geo, {
    style: ()=> styleCountryDefault(),
    onEachFeature: (feature, layer)=>{
      const iso = isoFromFeature(feature);
      const nm = nameFromFeature(feature);

      if(!iso) return;

      __rfCountryLayerByISO.set(iso, layer);
      layer.on("mousemove", ()=>{
        // Hover = solo vista previa (NO cambia el filtro global del radar).
        // Click = selecciona pa√≠s y actualiza todo.
        if(__rfCountryHoverTimer) clearTimeout(__rfCountryHoverTimer);
        __rfCountryHoverTimer = setTimeout(async ()=>{
          if(__rfCountryPinnedISO && __rfCountryPinnedISO === iso){
            setCountryLayerStyle(layer, styleCountryPinned());
          }else{
            setCountryLayerStyle(layer, styleCountryHover());
          }

          // ‚úÖ Vista previa: panel izquierdo + tooltip con "HAY DATOS / SIN DATOS"
          try{
            const { counts, usedCol } = await getCountryActivityCountsCached();
            const c = (counts && counts.get(iso)) ? counts.get(iso) : 0;
            const badge = usedCol ? (c>0 ? "HAY DATOS" : "SIN DATOS") : "SIN DATOS";
            const badgeCls = (c>0 ? "rfHasData" : "rfNoData");
            await updateUIForCountry(iso, nm, { badge, badgeCls, count: c });
          }catch(_e){
            await updateUIForCountry(iso, nm);
          }
        }, 60);
      });

      layer.on("mouseout", ()=>{
        if(__rfCountryPinnedISO === iso){
          setCountryLayerStyle(layer, styleCountryPinned());
        }else{
          setCountryLayerStyle(layer, styleCountryDefault());
        }
      });

      layer.on("click", async ()=>{
        // fijar selecci√≥n
        __rfCountryPinnedISO = iso;

        // reset estilos de todos y aplicar pinned al seleccionado
        try{
          __rfCountriesLayer.eachLayer(l=>{
            const f = l.feature;
            const i = isoFromFeature(f);
            if(!i) return;
            if(i === iso) setCountryLayerStyle(l, styleCountryPinned());
            else setCountryLayerStyle(l, styleCountryDefault());
          });
        }catch(_e){}

        // zoom al pa√≠s
        try{
          const b = layer.getBounds();
          if(b && b.isValid()) __rfLeafletMap.fitBounds(b, { padding:[20,20] });
        }catch(_e){}

        // sincronizar filtro pa√≠s del radar (dropdown) y recargar m√≥dulos
        try{
          const sel = document.getElementById("gl");
          if(sel && sel.value !== iso){ sel.value = iso; }
          try{ saveLocale(); }catch(_e){}
          if(typeof refreshAll === "function"){ refreshAll(); }
        }catch(_e){}

        await updateUIForCountry(iso, nm);
      });

      // Tooltip nativo simple
      layer.bindTooltip(`${nm} (${iso})`, { sticky:true, direction:"top", opacity:0.9 });
    }
  }).addTo(__rfLeafletMap);

  // Mantener arriba los bordes
  try{ __rfCountriesLayer.bringToFront(); }catch(_e){}
}

function setMapViewByCountry(iso){
  const c = String(iso||"DO").toUpperCase().trim();
  const center = COUNTRY_CENTER[c] || [20, 0];
  const zoom = COUNTRY_CENTER[c] ? 5 : 2;
  try{
    __rfLeafletMap.setView(center, zoom, { animate: true });
  }catch(_e){}
}


function pinCountryISO(iso){
  const c = String(iso||"").toUpperCase().trim();
  __rfCountryPinnedISO = c && c !== "ALL" ? c : null;

  if(!__rfCountriesLayer) return;

  try{
    __rfCountriesLayer.eachLayer((ly)=>{
      // reset a default
      try{ setCountryLayerStyle(ly, styleCountryDefault()); }catch(_e){}
    });
  }catch(_e){}

  if(!__rfCountryPinnedISO) return;

  const ly = __rfCountryLayerByISO.get(__rfCountryPinnedISO);
  if(ly){
    try{ setCountryLayerStyle(ly, styleCountryPinned()); }catch(_e){}
  }
}

const RF_OFFERS_TABLE = "offers";

    function normCode(v){
      return String(v||"").trim().toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
    }

    // Devuelve un map { normCode: { offers: nOffers, sellers: nSellers } } solo para ofertas activas (no expiradas)
    async function fetchOfferAvailability(normCodes){
      const out = new Map();
      const list = Array.from(new Set((normCodes||[]).filter(Boolean)));
      if(!list.length) return out;

      // limitar tama√±o por seguridad (Supabase in() muy grande puede fallar)
      const chunkSize = 150;
      const nowIso = new Date().toISOString();

      for(let i=0; i<list.length; i+=chunkSize){
        const chunk = list.slice(i, i+chunkSize);
        try{
          const { data, error } = await supabase
            .from(RF_OFFERS_TABLE)
            .select("original_norm,seller_id")
            .gt("expires_at", nowIso)
            .in("original_norm", chunk)
            .limit(5000);
          if(error) throw error;

          for(const row of (data||[])){
            const key = row.original_norm || "";
            if(!key) continue;
            if(!out.has(key)) out.set(key, { offers:0, sellers:new Set() });
            const cur = out.get(key);
            cur.offers++;
            if(row.seller_id) cur.sellers.add(row.seller_id);
          }
        }catch(_){
          // si falla, devolvemos lo que tengamos (silencioso)
        }
      }

      // convertir sellers Set -> count
      for(const [k,v] of out){
        out.set(k, { offers: v.offers, sellers: v.sellers.size });
      }
      return out;
    }

    function offerBadge(nSellers){
      const n = Number(nSellers||0);
      if(n>0) return `<span class="badgeOffer">‚úÖ ${n}</span>`;
      return `<span class="badgeOffer off0">‚Äî</span>`;
    }

    function badgeStatus(result_status){
      if(result_status === "found") return `<span class="badge bOk">found</span>`;
      if(result_status === "not_found") return `<span class="badge bBad">not_found</span>`;
      return `<span class="badge">unknown</span>`;
    }

    function filterRows(rows){
      const q = ($("q").value || "").trim().toLowerCase();
      const cat = ($("category").value || "").trim().toLowerCase();
      return rows.filter(r=>{
        if(cat && String(r.category||"").toLowerCase() !== cat) return false;
        if(q){
          const hay = (String(r.query_raw||"") + " " + String(r.category||"") + " " + String(r.result_status||"")).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    function normalizeCategory(cat){
      const c = String(cat||"").trim().toLowerCase();
      return c || "";
    }
    function isNumericOrCodeLike(s){
      const x = String(s||"").trim();
      if(!x) return false;
      if(/^\d{4,}$/.test(x)) return true;
      if(/^[A-Z0-9\-]{6,}$/i.test(x)) return true;
      return false;
    }
    function demoQueryByCategory(category){
      const c = String(category||"").trim().toLowerCase();
      if(c === "frenos") return "Toyota Corolla 2014-2017 brake pads";
      if(c === "suspension") return "Honda Civic 2012-2015 suspension control arm";
      if(c === "motor") return "Hyundai Elantra 2013-2016 engine mount";
      if(c === "electrico") return "Toyota Corolla 2014-2017 oxygen sensor";
      if(c === "cooling") return "Honda Civic 2012-2015 radiator";
      if(c === "transmision") return "Nissan Sentra 2013-2017 transmission mount";
      return "Toyota Corolla 2014-2017 brake pads";
    }

    function getLocale(){
      const glRaw = ($("gl").value || "DO").toUpperCase();
      const hl = ($("hl").value || "es").toLowerCase();
      const gl = (glRaw === "ALL") ? "US" : glRaw; // para eBay/Google (ALL usa un default)
      return { gl, hl, glRaw };
    }
    function marketplaceByGL(gl){
      const c = String(gl || "US").toUpperCase().trim();
      const map = {
        US: "EBAY_US",
        DO: "EBAY_US",
        PR: "EBAY_US",
        CA: "EBAY_CA",
        MX: "EBAY_US",
        CO: "EBAY_US",
        CL: "EBAY_US",
        PE: "EBAY_US",
        AR: "EBAY_US",
        BR: "EBAY_US",
        ES: "EBAY_ES",
        GB: "EBAY_GB",
        DE: "EBAY_DE",
        FR: "EBAY_FR",
        IT: "EBAY_IT",
        AU: "EBAY_AU"
      };
      return map[c] || "EBAY_US";
    }

    function saveLocale(){
      const glRaw = ($("gl").value || "DO").toUpperCase();
      const hl = ($("hl").value || "es").toLowerCase();
      localStorage.setItem("rf_radar_gl", glRaw);
      localStorage.setItem("rf_radar_hl", hl);
    }
    function loadLocaleFromLocalStorage(){
      const gl = (localStorage.getItem("rf_radar_gl") || "").toUpperCase();
      const hl = (localStorage.getItem("rf_radar_hl") || "").toLowerCase();
      if(gl && [...$("gl").options].some(o=>o.value===gl)) $("gl").value = gl;
      if(hl && [...$("hl").options].some(o=>o.value===hl)) $("hl").value = hl;
    }

    async function loadProfileLocaleIfAny(){
      const alreadyChosen = localStorage.getItem("rf_radar_gl");
      if(alreadyChosen) return;

      const { data: ses } = await supabase.auth.getSession();
      if(!ses?.session) return;

      const userId = ses.session.user.id;
      const { data: prof } = await supabase
        .from("profiles")
        .select("country")
        .eq("id", userId)
        .maybeSingle();

      const c = String(prof?.country || "").trim().toUpperCase();
      if(c && Array.from($("gl").options).some(o => o.value === c)){
        $("gl").value = c;
        localStorage.setItem("rf_radar_gl", c);
      }else if(c){
        localStorage.setItem("rf_radar_gl", c);
      }
    }

    async function loadKpis(){
      const data = await fetchSearchEventsFiltered("id, result_status");
      const total = (data||[]).length;
      const nf = (data||[]).filter(x=>x.result_status==="not_found").length;
      const pct = total ? Math.round((nf/total)*1000)/10 : 0;

      $("k1").textContent = String(total);
      $("k2").textContent = String(nf);
      $("k3").textContent = pct.toFixed(1) + "%";
    }

    async function loadTop(){
      const data = await fetchSearchEventsFiltered("query_raw, category, result_status");


      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, last_status:r.result_status };
        cur.n += 1;
        cur.last_status = r.result_status || cur.last_status;
        map.set(key, cur);
      }
      let rows = Array.from(map.values()).sort((a,b)=> b.n - a.n);
      rows = filterRows(rows);

      const tbody = $("tTop").querySelector("tbody");
      const topRows = rows.slice(0,20);

      // Oferta disponible (cantidad de vendedores con oferta activa para ese OEM)
      const norms = topRows.map(r=>normCode(r.query_raw)).filter(Boolean);
      const offerMap = await fetchOfferAvailability(norms);

      tbody.innerHTML = topRows.map(r=>{
        const key = normCode(r.query_raw);
        const info = offerMap.get(key);
        const sellers = info ? info.sellers : 0;
        return `
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "‚Äî")}</span></td>
          <td><b>${r.n}</b></td>
          <td>${badgeStatus(r.last_status)}</td>
          <td>${offerBadge(sellers)}</td>
        </tr>
        `;
      }).join("") || `<tr><td colspan="5" class="mut">Sin datos para el filtro.</td></tr>`;

      return rows;
    }

    async function loadOpp(){
      const data = await fetchSearchEventsFiltered("query_raw, category, result_status");


      const map = new Map();
      for(const r of (data||[])){
        const key = (r.query_raw||"") + "||" + (r.category||"");
        const cur = map.get(key) || { query_raw:r.query_raw, category:r.category, n:0, nf:0 };
        cur.n += 1;
        if(r.result_status === "not_found") cur.nf += 1;
        map.set(key, cur);
      }

      let rows = Array.from(map.values())
        .map(x=>({ ...x, pct: x.n ? Math.round((x.nf/x.n)*1000)/10 : 0 }))
        .filter(x=> x.n >= 2)
        .sort((a,b)=> (b.pct - a.pct) || (b.n - a.n));

      rows = filterRows(rows);

      const tbody = $("tOpp").querySelector("tbody");
      tbody.innerHTML = rows.slice(0,20).map(r=>`
        <tr>
          <td>${esc(r.query_raw)}</td>
          <td><span class="badge">${esc(r.category || "‚Äî")}</span></td>
          <td><b>${r.n}</b></td>
          <td><span class="badge bBad">${r.nf}</span></td>
          <td><span class="badge bWarn">${r.pct.toFixed(1)}%</span></td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="mut">Sin oportunidades para el filtro.</td></tr>`;
    }

    function fmtMoney(v, cur){
      if(v === null || v === undefined) return "‚Äî";
      const n = Number(v);
      if(Number.isNaN(n)) return "‚Äî";
      const c = (cur || "USD").toUpperCase();
      return `${n.toFixed(2)} ${c}`;
    }

    // ==============================
    // TOP MODELOS (vehiculo) - usando 4 tablas
    // cambios, cambios_v2, datos_vehiculares, datos_vehiculares_v2
    // ==============================
    const TABLE_DV_1 = "datos_vehiculares";
    const TABLE_DV_2 = "datos_vehiculares_v2";
    const TABLE_C_1  = "cambios";
    const TABLE_C_2  = "cambios_v2";

    const DV_COL_ORIG_NORM = "original_norm";
    const DV_COL_ORIG      = "original";
    const DV_COL_VEH       = "vehiculo";

    const C_COL_ORIG_NORM  = "original_norm";
    const C_COL_CAMB_NORM  = "cambio_norm";
    const C_COL_ORIG       = "original";
    const C_COL_CAMB       = "cambio";

    function isCodeLike(s){
      const x = String(s||"").trim();
      if(!x) return false;
      if(/^\d{3,}$/.test(x)) return true;
      if(/^[A-Z0-9\-]{5,}$/i.test(x)) return true;
      return false;
    }

    function chunk(arr, size=250){
      const out = [];
      for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
      return out;
    }

    function normKey(s){
      return String(s||"").trim().toUpperCase();
    }


    async function resolveToOriginalNorm(queries){
      const qList = Array.from(new Set(queries.map(normKey).filter(Boolean)));
      const out = new Map();

      async function probeDV(table){
        for(const part of chunk(qList, 250)){
          const { data, error } = await supabase
            .from(table)
            .select(`${DV_COL_ORIG_NORM}, ${DV_COL_ORIG}`)
            .or(`${DV_COL_ORIG_NORM}.in.(${part.join(",")}),${DV_COL_ORIG}.in.(${part.join(",")})`);

          if(!error && Array.isArray(data)){
            for(const r of data){
              const on = normKey(r?.[DV_COL_ORIG_NORM]);
              const o  = normKey(r?.[DV_COL_ORIG]);
              if(on){
                if(on && qList.includes(on)) out.set(on, on);
                if(o && qList.includes(o) && !out.has(o)) out.set(o, on);
              }else if(o && qList.includes(o)){
                out.set(o, o);
              }
            }
          }
        }
      }

      await probeDV(TABLE_DV_2);
      await probeDV(TABLE_DV_1);

      const missing = qList.filter(x => !out.has(x));
      if(!missing.length) return out;

      async function probeCambios(table){
        for(const part of chunk(missing, 200)){
          const orExpr = [
            `${C_COL_CAMB_NORM}.in.(${part.join(",")})`,
            `${C_COL_CAMB}.in.(${part.join(",")})`,
            `${C_COL_ORIG_NORM}.in.(${part.join(",")})`,
            `${C_COL_ORIG}.in.(${part.join(",")})`,
          ].join(",");

          const { data, error } = await supabase
            .from(table)
            .select(`${C_COL_ORIG_NORM}, ${C_COL_ORIG}, ${C_COL_CAMB_NORM}, ${C_COL_CAMB}`)
            .or(orExpr);

          if(!error && Array.isArray(data)){
            for(const r of data){
              const origNorm = normKey(r?.[C_COL_ORIG_NORM]) || normKey(r?.[C_COL_ORIG]);
              if(!origNorm) continue;

              const cambNorm = normKey(r?.[C_COL_CAMB_NORM]);
              const camb     = normKey(r?.[C_COL_CAMB]);
              const orig     = normKey(r?.[C_COL_ORIG]);
              const oNorm    = normKey(r?.[C_COL_ORIG_NORM]);

              if(cambNorm && !out.has(cambNorm)) out.set(cambNorm, origNorm);
              if(camb && !out.has(camb)) out.set(camb, origNorm);
              if(oNorm && !out.has(oNorm)) out.set(oNorm, origNorm);
              if(orig && !out.has(orig)) out.set(orig, origNorm);
            }
          }
        }
      }

      await probeCambios(TABLE_C_2);
      await probeCambios(TABLE_C_1);

      return out;
    }

    async function resolveVehiculoForOriginalNorm(originalNorms){
      const list = Array.from(new Set(originalNorms.map(normKey).filter(Boolean)));
      const out = new Map();

      async function probe(table){
        for(const part of chunk(list, 250)){
          const { data, error } = await supabase
            .from(table)
            .select(`${DV_COL_ORIG_NORM}, ${DV_COL_VEH}`)
            .in(DV_COL_ORIG_NORM, part);

          if(!error && Array.isArray(data)){
            for(const r of data){
              const on = normKey(r?.[DV_COL_ORIG_NORM]);
              const veh = String(r?.[DV_COL_VEH] || "").trim();
              if(on && veh && !out.has(on)) out.set(on, veh);
            }
          }
        }
      }

      await probe(TABLE_DV_2);
      await probe(TABLE_DV_1);

      return out;
    }

    /**
     * ‚úÖ TOP 10 modelos + detalle (click)
     * Guarda un diccionario global:
     * window.__rfModelDetails = {
     *   "SUZUKI": { total: 8, codes: { "A123...": { n: 4, original_norm: "..." }, ... } }
     * }
     */
    async function loadModelTop(){
      const tbody = document.getElementById("tBrands")?.querySelector("tbody");
      if(tbody) tbody.innerHTML = `<tr><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>`;
      const bMsg = document.getElementById("bMsg");
      if(bMsg){ bMsg.textContent = "Calculando modelos..."; bMsg.style.display="block"; }

      window.__rfModelDetails = {}; // reset

      const data = await fetchSearchEventsFiltered("query_raw, category");

      const events = (data||[]);
      const queries = events
        .map(r => normKey(r.query_raw))
        .filter(x => isCodeLike(x));

      if(!queries.length){
        if(tbody) tbody.innerHTML = `<tr><td colspan="2" class="mut">No hay b√∫squedas tipo c√≥digo en este rango.</td></tr>`;
        if(bMsg) bMsg.style.display="none";
        return;
      }

      if(bMsg) bMsg.textContent = "Resolviendo c√≥digos (cambios + datos_vehiculares)...";
      const qToOrigNorm = await resolveToOriginalNorm(queries);

      const origNorms = Array.from(new Set(Array.from(qToOrigNorm.values())));
      if(bMsg) bMsg.textContent = "Buscando vehiculo por original_norm...";
      const origNormToVeh = await resolveVehiculoForOriginalNorm(origNorms);

      const count = new Map();                 // veh -> total
      const detail = new Map();                // veh -> Map(code -> {n, original_norm})

      for(const ev of events){
        const qx = normKey(ev.query_raw);
        if(!isCodeLike(qx)) continue;

        const on = qToOrigNorm.get(qx);        // original_norm resuelto (o undefined)
        if(!on) continue;

        const veh = origNormToVeh.get(on);
        if(!veh) continue;

        count.set(veh, (count.get(veh)||0) + 1);

        if(!detail.has(veh)) detail.set(veh, new Map());
        const m = detail.get(veh);

        const cur = m.get(qx) || { n: 0, original_norm: on || "" };
        cur.n += 1;
        cur.original_norm = on || cur.original_norm;
        m.set(qx, cur);
      }

      const rows = Array.from(count.entries())
        .map(([veh, n]) => ({ veh, n }))
        .sort((a,b)=> b.n - a.n)
        .slice(0,10); // ‚úÖ TOP 10

      if(!rows.length){
        if(tbody) tbody.innerHTML = `<tr><td colspan="2" class="mut">No se pudo mapear a vehiculo (revisa si tus b√∫squedas est√°n entrando como c√≥digos reales).</td></tr>`;
        if(bMsg) bMsg.style.display="none";
        return;
      }

      // Guardar detalles en window.__rfModelDetails
      const outObj = {};
      for(const r of rows){
        const m = detail.get(r.veh) || new Map();
        const codesArr = Array.from(m.entries())
          .map(([code, info]) => ({ code, n: info.n, original_norm: info.original_norm || "" }))
          .sort((a,b)=> b.n - a.n);

        outObj[r.veh] = { total: r.n, codes: codesArr };
      }
      window.__rfModelDetails = outObj;

      if(tbody){
        tbody.innerHTML = rows.map(r=>`
          <tr>
            <td>
              <button class="chipBtn" onclick="openModelCodes('${esc(r.veh)}')"
                title="Ver c√≥digos buscados para ${esc(r.veh)}">
                <span class="badge">${esc(r.veh)}</span>
              </button>
            </td>
            <td><b>${r.n}</b></td>
          </tr>
        `).join("");
      }

      if(bMsg) bMsg.style.display="none";
    }

    
    // ==============================
    // ‚úÖ MAPA (ligero): regiones + % modelos + 'Desconocido'
    // - Usa el pa√≠s (gl) seleccionado + label del profile si aplica
    // - 'Desconocido' = result_status not_found OR sin mapeo a vehiculo
    // ==============================
    const ISO_TO_REGION = (() => {
      const NA = new Set(["US","CA","MX","GT","HN","SV","NI","CR","PA","CU","JM","DO","PR","HT","BS","BZ"]);
      const SA = new Set(["CO","VE","EC","PE","BO","BR","PY","UY","AR","CL","GY","SR"]);
      const EU = new Set(["ES","FR","DE","IT","GB","NL","SE","CH","BE","PT","NO","DK","FI","IE","AT","PL","CZ","HU","RO","GR","UA"]);
      const AF = new Set(["ZA","NG","EG","MA","DZ","TN","GH","KE","ET","SN","CI","CM"]);
      const AS = new Set(["JP","KR","CN","IN","ID","TH","VN","PH","MY","SG","HK","TW","AE","SA","TR","RU","IL","QA","KW"]);
      const OC = new Set(["AU","NZ","FJ","PG"]);
      return (iso) => {
        const c = String(iso||"").toUpperCase().trim();
        if(NA.has(c)) return "NA";
        if(SA.has(c)) return "SA";
        if(EU.has(c)) return "EU";
        if(AF.has(c)) return "AF";
        if(AS.has(c)) return "AS";
        if(OC.has(c)) return "OC";
        return "NA"; // default
      };
    })();

    function glLabel(){
      const gl = ($("gl")?.value || "DO").toUpperCase();
      const opt = Array.from($("gl").options).find(o=>o.value===gl);
      const t = opt ? opt.textContent : gl;
      return { gl, label: t };
    }

    function setActiveRegion(regionCode){
      ["NA","SA","EU","AF","AS","OC"].forEach(r=>{
        const el = document.getElementById("rg-"+r);
        if(el) el.classList.toggle("active", r === regionCode);
      });
    }

    function tooltipHTML(title, lines, badgeText, badgeCls, countTxt){
  const list = (lines||[]).slice(0,6);
  const has = list.length > 0;
  const items = list.map(x=>`<div class="mini">${esc(x.name)} <span>¬∑ ${esc(x.pct)}</span></div>`).join("");
  const badge = badgeText ? `<span class="rfBadge ${badgeCls}">${esc(badgeText)}</span>` : "";
  const ct = countTxt ? `<span class="mut" style="margin-left:8px">${esc(countTxt)}</span>` : "";
  return `
    <div class="ttCard">
      <div class="ttTop">
        <div class="ttTitle">${esc(title)}${ct}</div>
        ${badge}
      </div>
      ${has ? items : `<div class="mut">Sin datos para mostrar.</div>`}
      <div class="mut" style="margin-top:8px">Tip: ‚ÄúDesconocido‚Äù son b√∫squedas sin resultado o sin mapeo a veh√≠culo.</div>
    </div>
  `;
}

    function renderBars(dist){
      const box = document.getElementById("mapBars");
      if(!box) return;
      const total = dist.reduce((a,b)=>a + (b.count||0), 0) || 0;

      const top = dist
        .slice()
        .sort((a,b)=> (b.count||0) - (a.count||0))
        .slice(0, 12);

      box.innerHTML = top.map(x=>{
        const pct = total ? (x.count/total)*100 : 0;
        const pctTxt = pct.toFixed(1) + "%";
        const w = Math.max(0, Math.min(100, pct));
        const isUnk = String(x.name).toUpperCase()==="DESCONOCIDO";
        return `
          <div class="barRow" title="${esc(x.name)} ¬∑ ${x.count} (${pctTxt})">
            <div class="barLbl">${isUnk ? "Desconocido" : esc(x.name)}</div>
            <div class="bar"><i style="width:${w}%"></i></div>
            <div class="barPct">${pctTxt}</div>
          </div>
        `;
      }).join("") || `<div class="mut" style="margin-top:10px">Sin distribuci√≥n para mostrar.</div>`;
    }


    async function buildModelDistributionForMap(isoFilter){
  const from = dtFromRange($("range").value);
  const cat = ($("category").value || "").trim();

  // Construye el query base cada vez (importante para no "ensuciar" el builder con eqs previos)
  const baseQ = () => {
    let qq = supabase
      .from("search_events")
      .select("query_raw, category, result_status, searched_at")
      .gte("searched_at", from);
    if(cat) qq = qq.eq("category", cat);
    return qq;
  };

  // ‚úÖ Filtrar por pa√≠s cuando exista columna en search_events (gl o country)
  let __rf_noCountryColumn = false;
  const iso = String(isoFilter||"").toUpperCase().trim();

  let eventsData = null;

  if(iso){
    // Intento 1: columna "gl"
    try{
      const { data: d1, error: e1 } = await baseQ().eq("gl", iso);
      if(e1) throw e1;
      eventsData = d1 || [];
    }catch(_e1){
      // Intento 2: columna "country"
      try{
        const { data: d2, error: e2 } = await baseQ().eq("country", iso);
        if(e2) throw e2;
        eventsData = d2 || [];
      }catch(_e2){
        // No hay columna de pa√≠s; caemos al comportamiento original (sin filtro)
        __rf_noCountryColumn = true;
      }
    }
  }

  if(eventsData === null){
    const { data: d, error } = await baseQ();
    if(error) throw error;
    eventsData = d || [];
  }

  const events = eventsData || [];

  const codeEvents = events
    .map(r=>({ q: normKey(r.query_raw), status: String(r.result_status||"") }))
    .filter(x=> isCodeLike(x.q));

  if(!codeEvents.length){
    return { dist: [], total: 0, unknown: 0, top: [], noCountry: __rf_noCountryColumn };
  }

  const queries = codeEvents.map(x=>x.q);
  const qToOrigNorm = await resolveToOriginalNorm(queries);
  const origNorms = Array.from(new Set(Array.from(qToOrigNorm.values())));
  const origNormToVeh = await resolveVehiculoForOriginalNorm(origNorms);

  const counts = new Map(); // veh -> count
  let unknown = 0;

  for(const ev of codeEvents){
    // regla del usuario: lo "no encontrado" -> Desconocido
    if(ev.status === "not_found"){
      unknown++;
      continue;
    }

    const on = qToOrigNorm.get(ev.q);
    if(!on){ unknown++; continue; }
    const veh = origNormToVeh.get(on);
    if(!veh){ unknown++; continue; }
    counts.set(veh, (counts.get(veh)||0) + 1);
  }

  const dist = Array.from(counts.entries()).map(([name,count])=>({ name, count }));
  if(unknown>0) dist.push({ name:"DESCONOCIDO", count: unknown });

  const total = dist.reduce((a,b)=>a+(b.count||0),0);
  const top = dist
    .slice()
    .sort((a,b)=> (b.count||0) - (a.count||0))
    .slice(0,5)
    .map(x=>({ name:x.name==="DESCONOCIDO" ? "Desconocido" : x.name, pct: (total?((x.count/total)*100):0).toFixed(1)+"%" }));

  return { dist, total, unknown, top, noCountry: __rf_noCountryColumn };
}

    window.openMapModal = async function(){
      const overlay = document.getElementById("mapOverlay");
      const sub = document.getElementById("mapModalSub");
      const tip = document.getElementById("mapTooltip");

      if(sub){
        const { gl, label } = glLabel();
        sub.textContent = `Pa√≠s: ${label} ¬∑ Rango: ${$("range").value} d√≠a(s) ¬∑ L√≠nea: ${$("category").value || "todas"}`;
        setActiveRegion(ISO_TO_REGION(gl));
      }

      if(overlay) overlay.style.display = "flex";

      // ‚úÖ Inicializar mapa real (Leaflet) y centrar por pa√≠s
      initLeafletMapOnce();
      // ‚úÖ Capa interactiva de pa√≠ses
      try{ await addCountriesLayerOnce(); }catch(_e){}
      // reset cache por si cambi√≥ rango/l√≠nea
      __rfCountryDistCache = new Map();
      __rfCountryPinnedISO = null;
      const { gl: __glNow } = glLabel();
      setMapViewByCountry(__glNow);
      try{ pinCountryISO(__glNow); }catch(_e){}
      // Inicializar panel izquierdo con el pa√≠s seleccionado
      try{ await updateUIForCountry(__glNow, glLabel().label); }catch(_e){}
      // ‚úÖ Si es GLOBAL (ALL), pintar burbujas por pa√≠s (actividad)
      try{ await renderCountryBubblesIfAll(); }catch(_e){}
      setTimeout(()=>{ try{ __rfLeafletMap.invalidateSize(); }catch(_e){} }, 250);

      // ‚úÖ Tooltip: seguir el mouse sobre el mapa (solo visual)
      const __tip = document.getElementById("mapTooltip");
      const __mapEl = document.getElementById("rfLeafletMap");
      if(__tip && __mapEl && !window.__rf_map_leaflet_tip_bound){
        __mapEl.addEventListener("mousemove", (ev)=>{
          const r = __mapEl.getBoundingClientRect();
          const x = Math.max(12, Math.min(r.width-380, ev.clientX - r.left + 12));
          const y = Math.max(12, Math.min(r.height-140, ev.clientY - r.top + 12));
          __tip.style.left = x + "px";
          __tip.style.top  = y + "px";
        });
        window.__rf_map_leaflet_tip_bound = true;
      }

      // cargar distribuci√≥n
      try{
        if(tip){ tip.style.display="none"; tip.innerHTML=""; }
        const { dist, total, top, noCountry } = await buildModelDistributionForMap(__glNow);
        renderBars(dist);

        // tooltip inicial (pa√≠s actual)
        const { label, gl } = glLabel();
        if(tip){
          tip.innerHTML = tooltipHTML(`Resumen ¬∑ ${label}`, top) + (noCountry ? `<div class="mut" style="margin-top:8px">‚ö†Ô∏è A√∫n no hay pa√≠s por b√∫squeda en <b>search_events</b>. Para que el hover funcione por pa√≠s, agrega la columna <b>gl</b> (ISO2) al guardar cada evento.</div>` : ``);
          tip.style.display = "block";
        }

        // Bind hover por regiones (una sola vez)
        const bindOnceKey = "__rf_map_bound";
        if(!window[bindOnceKey]){
          ["NA","SA","EU","AF","AS","OC"].forEach(region=>{
            const el = document.getElementById("rg-"+region);
            if(!el) return;

            el.addEventListener("mouseenter", ()=>{
              if(!tip) return;
              const regionName = ({
                NA:"Norteam√©rica", SA:"Suram√©rica", EU:"Europa", AF:"√Åfrica", AS:"Asia", OC:"Ocean√≠a"
              })[region] || region;

              // Mostramos el mismo top (por ahora) porque search_events no tiene pa√≠s por evento.
              // Visualmente el usuario entiende la zona del pa√≠s seleccionado.
              tip.innerHTML = tooltipHTML(`Zona ¬∑ ${regionName} (pa√≠s ${glLabel().gl})`, top);
              tip.style.display = "block";
            });

            el.addEventListener("mouseleave", ()=>{
              if(!tip) return;
              const { label } = glLabel();
              tip.innerHTML = tooltipHTML(`Resumen ¬∑ ${label}`, top) + (noCountry ? `<div class="mut" style="margin-top:8px">‚ö†Ô∏è A√∫n no hay pa√≠s por b√∫squeda en <b>search_events</b>. Para que el hover funcione por pa√≠s, agrega la columna <b>gl</b> (ISO2) al guardar cada evento.</div>` : ``);
              tip.style.display = "block";
            });

            el.addEventListener("click", ()=>{
              // al click, lo marcamos como activo visualmente
              setActiveRegion(region);
            });
          });

          window[bindOnceKey] = true;
        }
      }catch(e){
        renderBars([{ name:"DESCONOCIDO", count: 0 }]);
        if(tip){
          tip.innerHTML = `<b>Error</b><div class="mut" style="margin-top:6px">${esc(e?.message || e)}</div>`;
          tip.style.display="block";
        }
      }
    };

    window.closeMapModal = function(){
      const overlay = document.getElementById("mapOverlay");
      if(overlay) overlay.style.display = "none";
    };


    // ‚úÖ Modal handlers
    window.openModelCodes = function(veh){
      const v = String(veh||"").trim();
      const data = window.__rfModelDetails?.[v];

      const overlay = document.getElementById("modelModalOverlay");
      const title = document.getElementById("modelModalTitle");
      const sub = document.getElementById("modelModalSub");
      const tbody = document.getElementById("tModelCodes")?.querySelector("tbody");

      if(title) title.textContent = `C√≥digos buscados: ${v}`;
      if(sub) sub.textContent = data ? `Total consultas: ${data.total}` : "Sin detalle disponible";
      if(tbody){
        if(!data || !Array.isArray(data.codes) || !data.codes.length){
          tbody.innerHTML = `<tr><td colspan="3" class="mut">No hay c√≥digos para mostrar.</td></tr>`;
        }else{
          tbody.innerHTML = data.codes.slice(0,200).map(x=>`
            <tr>
              <td><span class="badge">${esc(x.code)}</span></td>
              <td><b>${x.n}</b></td>
              <td class="mut">${x.original_norm ? esc(x.original_norm) : "‚Äî"}</td>
            </tr>
          `).join("");
        }
      }

      if(overlay) overlay.style.display = "flex";
    };

    window.closeModelModal = function(ev){
      // si se llama por click en overlay, cerrar
      const overlay = document.getElementById("modelModalOverlay");
      if(!overlay) return;
      overlay.style.display = "none";
    };

    // Cerrar con ESC
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        const o1 = document.getElementById("modelModalOverlay");
        if(o1 && o1.style.display === "flex") o1.style.display = "none";
        const o2 = document.getElementById("mapOverlay");
        if(o2 && o2.style.display === "flex") o2.style.display = "none";
      }
    });

    async function loadEbay(topRows){
      const userQ = ($("q").value || "").trim();
      let fallback = (topRows && topRows.length) ? String(topRows[0].query_raw || "").trim() : "";
      const category = normalizeCategory($("category").value);

      if(!userQ && isNumericOrCodeLike(fallback)){
        fallback = demoQueryByCategory(category);
      }
      const q = userQ || fallback;

      const tbody = $("tEbay").querySelector("tbody");
      tbody.innerHTML = `<tr><td class="mut">‚Äî</td><td class="mut">Cargando‚Ä¶</td><td class="mut">‚Äî</td><td class="mut">‚Äî</td></tr>`;

      if(!q){
        setEbayMsg("No hay query para consultar eBay todav√≠a.", false);
        tbody.innerHTML = `<tr><td colspan="4" class="mut">Sin query para eBay.</td></tr>`;
        return;
      }

      try{
        setEbayMsg(`Consultando eBay para: "${q}"...`, false);

        const { gl } = getLocale();
        const payload = {
          q,
          limit: 20,
          marketplaceId: marketplaceByGL(gl),
          category: category || undefined
        };

        const { data, error } = await supabase.functions.invoke("ebay-radar", { body: payload });
        if(error) throw error;
        if(!data) throw new Error("Respuesta vac√≠a de ebay-radar.");

        const total = Number(data.total || 0);
        const env = data.env || "‚Äî";
        const mp = data.marketplaceId || "‚Äî";

        const median = fmtMoney(data?.price?.median, data?.price?.currency);
        const low = fmtMoney(data?.price?.low, data?.price?.currency);
        const high = fmtMoney(data?.price?.high, data?.price?.currency);

        const signalBadge = total > 0
          ? `<span class="badge bOk">total ${total}</span>`
          : `<span class="badge bWarn">total 0</span>`;

        tbody.innerHTML = `
          <tr>
            <td>
              <div><b>${esc(q)}</b></div>
              <div class="mut" style="margin-top:4px">gl: ${esc(getLocale().gl)} ¬∑ env: ${esc(env)} ¬∑ marketplace: ${esc(mp)} ¬∑ categor√≠a: ${esc(category || "‚Äî")}</div>
            </td>
            <td>
              <div>${signalBadge}</div>
              <div style="margin-top:6px" class="mut">median: <b>${esc(median)}</b></div>
              <div class="mut">low: ${esc(low)} ¬∑ high: ${esc(high)}</div>
              <div class="mut" style="margin-top:6px">
              
              </div>
            </td>
            <td class="mut">‚Äî</td>
            <td class="mut">‚Äî</td>
          </tr>
        `;

        setEbayMsg("", false);
      }catch(e){
        setEbayMsg("Error eBay: " + (e?.message || e), true);
        tbody.innerHTML = `<tr><td colspan="4" class="mut">No se pudo cargar se√±al eBay.</td></tr>`;
      }
    }

    function wordInsights(list){
      const stop = new Set(["de","la","el","y","para","con","en","por","un","una","del","los","las","o","a"]);
      const counts = new Map();
      for(const s of list){
        const parts = String(s||"").toLowerCase().split(/\s+/)
          .map(x=>x.replace(/[^a-z0-9√°√©√≠√≥√∫√±\-]/gi,"")).filter(Boolean);
        for(const p of parts){
          if(p.length < 3) continue;
          if(stop.has(p)) continue;
          counts.set(p, (counts.get(p)||0)+1);
        }
      }
      return Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
    }

    async function loadGoogleSuggest(topRows){
      const { gl, hl } = getLocale();

      const userQ = ($("q").value || "").trim();
      let fallback = (topRows && topRows.length) ? String(topRows[0].query_raw || "").trim() : "";
      const category = normalizeCategory($("category").value);

      if(!userQ && isNumericOrCodeLike(fallback)){
        fallback = demoQueryByCategory(category);
      }
      const baseQ = userQ || fallback;

      const tbody = $("tGoogle").querySelector("tbody");

      if(!baseQ){
        setGoogleMsg("No hay query para Google Suggest todav√≠a.", false);
        tbody.innerHTML = `<tr><td colspan="3" class="mut">Sin query.</td></tr>`;
        return;
      }

      try{
        setGoogleMsg(`Google Suggest (${gl}/${hl}) para: "${baseQ}"...`, false);

        const { data, error } = await supabase.functions.invoke("google-suggest", {
          body: { q: baseQ, hl, gl, limit: 10 }
        });
        if(error) throw error;

        const sug = Array.isArray(data?.suggestions) ? data.suggestions : [];
        const sugHtml = sug.length
          ? sug.map(x=>`<div style="margin-bottom:6px"><span class="badge">${esc(x)}</span></div>`).join("")
          : `<span class="badge bWarn">sin sugerencias</span>`;

        const ins = wordInsights(sug);
        const insHtml = ins.length
          ? ins.map(([w,n])=> `<span class="badge">${esc(w)} ¬∑ ${n}</span>`).join(" ")
          : `<span class="badge bWarn">sin insights</span>`;

        tbody.innerHTML = `
          <tr>
            <td>
              <b>${esc(baseQ)}</b>
              <div class="mut" style="margin-top:4px">pa√≠s: ${esc(gl)} ¬∑ idioma: ${esc(hl)}</div>
            </td>
            <td style="min-width:320px">${sugHtml}</td>
            <td>${insHtml}</td>
          </tr>
        `;

        setGoogleMsg("", false);
      }catch(e){
        setGoogleMsg("Error Google: " + (e?.message || e), true);
        tbody.innerHTML = `<tr><td colspan="3" class="mut">No se pudo cargar Google Suggest.</td></tr>`;
      }
    }

    window.goIndex = function(){ window.location.href = "index.html"; };
    window.goApp = function(){ window.location.href = "app.html"; };

    window.resetFilters = function(){
      $("range").value = "7";
      $("category").value = "";
      $("q").value = "";
      refreshAll();
    };

    window.refreshAll = async function(){
      try{
        setMsg("Cargando radar...", false);
        setBrandMsg("Calculando modelos...", false);
        await loadKpis();
        await loadModelTop();          // ‚úÖ ahora top10 + click detalle
        const topRows = await loadTop();
        await loadOpp();
        await loadEbay(topRows);
        await loadGoogleSuggest(topRows);

        // ‚úÖ Si el modal del mapa est√° abierto, actualiza panel + zoom + burbujas seg√∫n pa√≠s
        try{
          const ov = document.getElementById("mapOverlay");
          if(ov && ov.style.display === "flex"){
            __rfCountryDistCache = new Map();
            const { gl: __glNow } = glLabel();
            try{ await updateUIForCountry(__glNow, glLabel().label); }catch(_e){}
            try{ setMapViewByCountry(__glNow); }catch(_e){}
            try{ pinCountryISO(__glNow); }catch(_e){}
            try{ await renderCountryBubblesIfAll(); }catch(_e){}
          }
        }catch(_e){}

        setMsg("", false);
      }catch(e){
        setMsg("Error: " + (e?.message || e), true);
      }
    };

    ["range","category"].forEach(id=>{
      $(id).addEventListener("change", ()=> refreshAll());
    });

    let tDeb = null;
    $("q").addEventListener("input", ()=>{
      clearTimeout(tDeb);
      tDeb = setTimeout(()=> refreshAll(), 450);
    });

    ["gl","hl"].forEach(id=>{
      $(id).addEventListener("change", ()=>{
        saveLocale();
        refreshAll();
      });
    });

    document.getElementById("y").textContent = new Date().getFullYear();
    loadLocaleFromLocalStorage();
    await loadProfileLocaleIfAny();
    refreshAll();
  </script>
</body>
</html>
