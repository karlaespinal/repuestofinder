<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - App</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:22px;color:#111}

    .topbar{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin:0 0 14px 0;}
    h1{margin:0;font-size:26px}
    .watermark{font-size:12px;color:#9ca3af;font-weight:800;letter-spacing:.4px;user-select:none;white-space:nowrap;opacity:.65;text-transform:uppercase;}
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    a.navlink{color:#2563eb;text-decoration:none;font-weight:900}
    a.navlink:hover{text-decoration:underline}

    .card{background:#fff;border:1px solid #e6e8f0;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #d7dbe7;font-size:15px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800}
    .btn{background:#2563eb;color:#fff}
    .btn2{background:#e5e7eb}
    .btn3{background:#111;color:#fff}
    .muted{color:#6b7280;font-size:13px}
    .ok{display:inline-flex;align-items:center;gap:8px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%;background:#10b981;display:inline-block}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eef0f6;padding:10px;text-align:left;font-size:13px;vertical-align:top}
    th{background:#fafbff}
    .pill{background:#f3f4f6;border-radius:999px;padding:4px 10px;font-size:12px}
    a{color:#2563eb;text-decoration:none}
    a:hover{text-decoration:underline}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .searchBox{max-width:420px}
    @media(max-width:900px){.searchBox{max-width:100%}}

    /* Copiar */
    .copyBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;border:1px solid #e6e8f0;
      background:#fff;color:#111;font-weight:900;font-size:13px;cursor:pointer;
    }
    .copyBtn:hover{background:#f6f7fb}
    .copyBtn:disabled{opacity:.5;cursor:not-allowed}
    .copyIcon{width:16px;height:16px;display:inline-block}

    /* Acordeon */
    .accHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:default;}
    .accTitle{display:flex;align-items:center;gap:10px;font-weight:900;}
    .accBody{margin-top:10px;}
    .chev{width:18px;height:18px;transition:transform .18s ease;opacity:.8;flex:0 0 auto;}
    .accRight{display:flex;align-items:center;gap:10px;}

    @media(max-width:1024px){
      .topbar{flex-direction:column;align-items:flex-start}
      .card.menuCard{padding:14px 16px}
      .accHeader{cursor:pointer;user-select:none}
      .accHeader{justify-content:center;position:relative;min-height:44px}
      .accTitle{justify-content:center;font-size:15px;font-weight:900;width:100%;text-align:center}
      .accRight{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:0;pointer-events:none}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .accRight{opacity:1;pointer-events:auto}
      .card.open .chev{transform:rotate(180deg)}
      th,td{padding:8px;font-size:12px}
      .copyBtn{padding:7px 9px;font-size:12px}
    }

    @media (pointer:coarse), (hover:none){
      .accHeader{cursor:pointer; user-select:none;}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .chev{transform:rotate(180deg);}
    }

    /* Raw box (blanco) */
    .rawBox{
      margin-top:10px;
      border:1px solid #eef0f6;
      background:#fafbff;
      border-radius:10px;
      padding:12px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      white-space:pre-wrap;
      color:#111;
    }

    /* ToyoDIY look */
    table.xref{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      border:1px solid #b7cbe2;
      border-radius:10px;
      overflow:hidden;
      background:#cfe0f2;
      box-shadow:0 1px 6px rgba(0,0,0,.04);
    }
    table.xref thead{display:none;}
    table.xref tbody:first-child tr th{
      background:#8fb4d8;
      color:#0b2a44;
      font-weight:900;
      padding:10px;
      border-bottom:1px solid #7ea6cd;
      font-size:13px;
      text-transform:none;
    }
    table.xref td, table.xref th{
      border:0 !important;
      padding:8px 10px;
      font-size:13px;
      vertical-align:top;
      color:#0b2a44;
    }
    table.xref tbody[id^="cat"] tr td{
      border-bottom:1px solid rgba(11,42,68,.12) !important;
    }
    table.xref td.nw{white-space:nowrap}
    table.xref td.sm{font-size:12px; line-height:1.25}
    table.xref a{
      color:#0b4aa2;
      font-weight:900;
      text-decoration:none;
    }
    table.xref a:hover{text-decoration:underline}
    table.xref tbody.hidden{display:none;}

    /* Comercializacion */
    .comCell{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .comEmoji{
      font-size:18px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:24px;
      padding:2px 4px;
      border-radius:8px;
      background:#f3f4f6;
      border:1px solid #e6e8f0;
    }
    .btn-evidencia{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 9px;
      border-radius:10px;
      border:1px solid #e6e8f0;
      background:#fff;
      color:#111;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn-evidencia:hover{background:#f6f7fb}
    .btn-evidencia:disabled{opacity:.45;cursor:not-allowed}
    .infoIcon{width:14px;height:14px;display:inline-block}
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>RepuestoFinder</h1>
      <div class="watermark">App / DTD STAR PARTS</div>
    </div>

    <div class="nav">
      <a class="navlink" href="index.html">Volver al sitio</a>
      <span class="pill" id="modePill" title="Cambia a API cuando tengas Supabase listo">Modo: DEMO</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:flex-end">
      <div class="grow">
        <div class="muted">Buscar por codigo OEM o equivalente:</div>
        <div style="margin-top:10px" class="searchBox">
          <input id="code" placeholder="Ej: 55300-3X100" value="90389-16002"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
        <button class="btn" onclick="buscar()">Buscar</button>
        <button class="btn2" onclick="limpiar()">Limpiar</button>
        <button class="btn3" onclick="exportar()" id="btnExport" disabled title="Lo activamos cuando conectemos backend real">Exportar a Excel</button>
      </div>
    </div>

    <div style="margin-top:10px" class="ok">
      <span class="dot"></span><span id="status">Listo</span>
    </div>

    <div class="muted" style="margin-top:8px">
      Nota: este HTML ya no usa google.script.run. Para producciÃ³n conectamos el endpoint de Supabase (Edge Function).
    </div>
  </div>

  <div class="grid2">

    <!-- PRODUCTO -->
    <div class="card menuCard open" id="cardProducto">
      <div class="accHeader" onclick="toggleAcc('cardProducto')">
        <div class="accTitle">Producto</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <span class="pill" id="pillCode">-</span>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div class="muted">URL: <a id="productUrl" href="#" target="_blank">-</a></div>
        <div style="margin-top:8px" class="muted" id="counts">Vehicles: 0 | OE Numbers: 0 | Refs: 0 | ToyoDIY: 0</div>
        <div style="margin-top:8px" class="muted" id="notes"></div>
      </div>
    </div>

    <!-- OE NUMBERS -->
    <div class="card menuCard" id="cardOE">
      <div class="accHeader" onclick="toggleAcc('cardOE')">
        <div class="accTitle">Cambios</div>

        <div class="accRight" onclick="event.stopPropagation()">
          <button class="copyBtn" id="btnCopyOE" onclick="copiarOE()" disabled title="Copiar tabla para Excel">
            <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copiar
          </button>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div id="oeWrap" class="muted">No hay filas detectadas.</div>
      </div>
    </div>

  </div>

  <!-- VEHICLES -->
  <div class="card menuCard" id="cardVeh">
    <div class="accHeader" onclick="toggleAcc('cardVeh')">
      <div class="accTitle">Vehicles</div>

      <div class="accRight" onclick="event.stopPropagation()">
        <button class="copyBtn" id="btnCopyVeh" onclick="copiarVehicles()" disabled title="Copiar tabla para Excel">
          <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copiar
        </button>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>

    <div class="accBody">
      <div id="vehWrap" class="muted">No hay filas detectadas.</div>
    </div>
  </div>

  <!-- TOYODIY -->
  <div class="card menuCard" id="cardToy">
    <div class="accHeader" onclick="toggleAcc('cardToy')">
      <div class="accTitle">Toyota/Lexus</div>

      <div class="accRight" onclick="event.stopPropagation()">
        <button class="copyBtn" id="btnCopyToy" onclick="copiarToyoDIY()" disabled title="Copiar tabla para Excel">
          <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copiar
        </button>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>

    <div class="accBody">
      <div class="muted" id="toyMeta"></div>
      <div id="toyWrap" class="muted" style="margin-top:8px">No hay filas detectadas.</div>
      <div id="toyRaw" class="rawBox" style="display:none"></div>
    </div>
  </div>

  <!-- REFERENCIAS -->
  <div class="card menuCard" id="cardRef">
    <div class="accHeader" onclick="toggleAcc('cardRef')">
      <div class="accTitle">Referencias / Cambios</div>
      <div class="accRight" onclick="event.stopPropagation()">
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>

    <div class="accBody">
      <div id="refWrap" class="muted">No hay filas detectadas.</div>
    </div>
  </div>

  <!-- SUB ASSEMBLY -->
  <div class="card menuCard" id="cardSub">
    <div class="accHeader" onclick="toggleAcc('cardSub')">
      <div class="accTitle">Sub Assembly</div>
      <div class="accRight" onclick="event.stopPropagation()">
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>

    <div class="accBody">
      <div id="subWrap" class="muted">No hay filas detectadas.</div>
    </div>
  </div>

<script>
  /*
    CONFIG:
    - Ahora esta en modo DEMO para que puedas abrir app.html y ver el UI funcionando.
    - Cuando tengas Supabase, cambias USE_DEMO=false y pones tu endpoint real.
  */
  var USE_DEMO = true;
  var API_ENDPOINT = ""; // Ej: "https://TU_PROYECTO.supabase.co/functions/v1/search"

  var lastPayload = null;

  function setStatus(txt){
    document.getElementById("status").textContent = txt;
  }

  function updateModePill_(){
    document.getElementById("modePill").textContent = "Modo: " + (USE_DEMO ? "DEMO" : "API");
  }
  updateModePill_();

  function isMobile_(){
    var w = Math.min(window.innerWidth || 9999, screen.width || 9999);
    var isTouch = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
                  (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    return (w <= 1024) || isTouch;
  }

  function setMobileDefault_(){
    ["cardProducto","cardOE","cardVeh","cardToy","cardRef","cardSub"].forEach(function(id){
      var c = document.getElementById(id);
      if(c) c.classList.remove("open");
    });
    var p = document.getElementById("cardProducto");
    if(p) p.classList.add("open");
  }

  function setDesktopDefault_(){
    ["cardProducto","cardOE","cardVeh","cardToy","cardRef","cardSub"].forEach(function(id){
      var c = document.getElementById(id);
      if(c) c.classList.add("open");
    });
  }

  function toggleAcc(cardId){
    if(!isMobile_()) return;
    var el = document.getElementById(cardId);
    if(!el) return;

    var willOpen = !el.classList.contains("open");

    ["cardProducto","cardOE","cardVeh","cardToy","cardRef","cardSub"].forEach(function(id){
      var c = document.getElementById(id);
      if(c) c.classList.remove("open");
    });

    if(willOpen) el.classList.add("open");
  }

  window.addEventListener("resize", function(){
    if(isMobile_()) setMobileDefault_();
    else setDesktopDefault_();
  });

  document.addEventListener("DOMContentLoaded", function(){
    if(isMobile_()) setMobileDefault_();
    else setDesktopDefault_();
  });

  function limpiar(){
    lastPayload = null;
    window.__LAST_PAYLOAD__ = null;

    document.getElementById("btnExport").disabled = true;

    document.getElementById("btnCopyOE").disabled = true;
    document.getElementById("btnCopyVeh").disabled = true;
    document.getElementById("btnCopyToy").disabled = true;

    document.getElementById("pillCode").textContent = "-";
    document.getElementById("productUrl").textContent = "-";
    document.getElementById("productUrl").href = "#";
    document.getElementById("counts").textContent = "Vehicles: 0 | OE Numbers: 0 | Refs: 0 | ToyoDIY: 0";
    document.getElementById("notes").textContent = "";

    document.getElementById("oeWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("vehWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("toyWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("toyMeta").textContent = "";
    document.getElementById("toyRaw").style.display = "none";
    document.getElementById("toyRaw").textContent = "";

    document.getElementById("refWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("subWrap").innerHTML = "No hay filas detectadas.";
    setStatus("Listo");

    if(isMobile_()) setMobileDefault_();
  }

  async function buscar(){
    var code = (document.getElementById("code").value || "").trim();
    if(!code){
      setStatus("Escribe un codigo.");
      return;
    }

    setStatus("Buscando...");
    document.getElementById("btnExport").disabled = true;
    document.getElementById("btnCopyOE").disabled = true;
    document.getElementById("btnCopyVeh").disabled = true;
    document.getElementById("btnCopyToy").disabled = true;

    try{
      var payload;

      if (USE_DEMO) {
        payload = demoPayload_(code);
        await sleep_(250);
      } else {
        if(!API_ENDPOINT){
          setStatus("Falta API_ENDPOINT.");
          alert("Configura API_ENDPOINT con tu Edge Function de Supabase.");
          return;
        }
        var url = API_ENDPOINT + "?code=" + encodeURIComponent(code);
        var r = await fetch(url, { method: "GET" });
        var j = await r.json();
        if(!j || j.ok === false){
          throw new Error((j && j.error) ? j.error : "Respuesta invalida");
        }
        payload = j.data || j.payload || j;
      }

      render(payload);
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e && e.message ? e.message : e));
      alert("Error consultando: " + (e && e.message ? e.message : e));
    }
  }

  function render(payload){
    lastPayload = payload;
    window.__LAST_PAYLOAD__ = payload;

    // Export lo activamos cuando backend real genere xlsx
    document.getElementById("btnExport").disabled = true;

    document.getElementById("pillCode").textContent = payload.codigo || payload.code || "-";
    document.getElementById("productUrl").textContent = payload.productUrl || "-";
    document.getElementById("productUrl").href = payload.productUrl || "#";

    var c = payload.counts || {};
    document.getElementById("counts").textContent =
      "Vehicles: " + (c.vehicles_groups || c.vehicles || 0) +
      " | OE Numbers: " + (c.oe_numbers || c.oe || 0) +
      " | Refs: " + (c.related_products || c.refs || 0) +
      " | ToyoDIY: " + (c.toyodiy_rows || c.toy || 0);

    document.getElementById("notes").textContent =
      (payload.productId ? ("product_id=" + payload.productId + " | ") : "") +
      (payload.guestId ? ("guest_id=" + payload.guestId) : "");

    // OE Numbers
    var oe = (payload.tablas && payload.tablas.oeNumbers) ? payload.tablas.oeNumbers : (payload.oeNumbers || []);
    document.getElementById("oeWrap").innerHTML = (oe.length ? tableHTML(oe, ["PartNumber","Owner"]) : "No hay filas detectadas.");
    document.getElementById("btnCopyOE").disabled = !oe.length;

    // Vehicles
    renderVehiclesTable_();

    // ToyoDIY
    var toy = (payload.tablas && payload.tablas.toyodiyXref) ? payload.tablas.toyodiyXref : (payload.toyodiyXref || null);
    renderToyoDIY_(toy);

    // Referencias
    var refs = (payload.tablas && payload.tablas.referencias) ? payload.tablas.referencias : (payload.referencias || []);
    document.getElementById("refWrap").innerHTML = (refs.length ? tableHTML(refs) : "No hay filas detectadas.");

    // Sub Assembly
    var sub = (payload.tablas && payload.tablas.subAssembly) ? payload.tablas.subAssembly : (payload.subAssembly || []);
    document.getElementById("subWrap").innerHTML = (sub.length ? tableHTML(sub) : "No hay filas detectadas.");

    setStatus("Listo âœ…");
    if(isMobile_()) setMobileDefault_();
  }

  function renderVehiclesTable_(){
    if(!lastPayload || !lastPayload.tablas){
      // permitir payload flat
    }

    var vehData = (lastPayload && lastPayload.tablas && lastPayload.tablas.vehicles) ? lastPayload.tablas.vehicles : (lastPayload.vehicles || null);
    var rows = [];
    var headers = [];

    if (vehData && vehData.headers && vehData.rows) {
      headers = vehData.headers || [];
      rows = vehData.rows || [];
    } else if (Array.isArray(vehData)) {
      rows = vehData;
      headers = rows.length ? Object.keys(rows[0]) : [];
    }

    if(rows.length){
      document.getElementById("vehWrap").innerHTML = tableHTMLVehicles_(rows, headers);
      document.getElementById("btnCopyVeh").disabled = false;
    }else{
      document.getElementById("vehWrap").innerHTML = "No hay filas detectadas.";
      document.getElementById("btnCopyVeh").disabled = true;
    }
  }

  function renderToyoDIY_(toy){
    var meta = document.getElementById("toyMeta");
    var wrap = document.getElementById("toyWrap");
    var rawBox = document.getElementById("toyRaw");
    rawBox.style.display = "none";
    rawBox.textContent = "";

    if(!toy || toy.mode === "skipped"){
      meta.textContent = toy && toy.reason ? ("Nota: " + toy.reason) : "";
      wrap.innerHTML = "No hay filas detectadas.";
      document.getElementById("btnCopyToy").disabled = true;
      return;
    }

    var srcUrl = toy.sourceUrl || "";
    var warn = toy.warn || "";
    meta.innerHTML = (srcUrl ? ('Fuente: <a href="'+escapeAttr(srcUrl)+'" target="_blank">abrir ToyoDIY</a>') : "Fuente: ToyoDIY") +
                     (warn ? (' | <span class="muted">'+escapeHtml(warn)+'</span>') : "");

    if(toy.tableHtml){
      wrap.innerHTML = toy.tableHtml;
      document.getElementById("btnCopyToy").disabled = !(toy.rows && toy.rows.length);
      return;
    }

    if(toy.headers && toy.rows && toy.rows.length){
      wrap.innerHTML = tableHTML(toy.rows, toy.headers);
      document.getElementById("btnCopyToy").disabled = false;
      return;
    }

    wrap.innerHTML = "No hay filas detectadas.";
    document.getElementById("btnCopyToy").disabled = true;

    if(toy.rawText){
      rawBox.style.display = "block";
      rawBox.textContent = toy.rawText;
    }
  }

  /* =================== COPIAR TABLAS (Excel friendly TSV) =================== */

  async function copiarOE(){
    if(!lastPayload) return;
    var oe = (lastPayload.tablas && lastPayload.tablas.oeNumbers) ? lastPayload.tablas.oeNumbers : (lastPayload.oeNumbers || []);
    await copiarComoTSV_(oe, ["PartNumber","Owner"], "OE Numbers copiado âœ…");
  }

  async function copiarVehicles(){
    var vehData = (lastPayload && lastPayload.tablas && lastPayload.tablas.vehicles) ? lastPayload.tablas.vehicles : (lastPayload.vehicles || null);
    var rows = [];
    var headers = null;

    if (vehData && vehData.headers && vehData.rows) {
      headers = vehData.headers;
      rows = vehData.rows || [];
    } else if (Array.isArray(vehData)) {
      rows = vehData;
      headers = rows.length ? Object.keys(rows[0]) : [];
    } else {
      headers = [];
      rows = [];
    }

    await copiarComoTSV_(rows, headers, "Vehicles copiado âœ…");
  }

  async function copiarToyoDIY(){
    if(!lastPayload) return;
    var toy = (lastPayload.tablas && lastPayload.tablas.toyodiyXref) ? lastPayload.tablas.toyodiyXref : (lastPayload.toyodiyXref || null);
    if(!toy || !toy.rows || !toy.rows.length) return;
    await copiarComoTSV_(toy.rows, toy.headers, "ToyoDIY copiado âœ…");
  }

  async function copiarComoTSV_(rows, headers, okMsg){
    if(!rows || !rows.length){
      setStatus("No hay filas para copiar.");
      return;
    }
    headers = (headers && headers.length) ? headers : Object.keys(rows[0] || {});
    if(!headers.length){
      setStatus("No hay columnas para copiar.");
      return;
    }

    var lines = [];
    lines.push(headers.join("\t"));

    for (var i=0;i<rows.length;i++){
      var r = rows[i] || {};
      var line = headers.map(function(h){
        var v = (r[h] === null || r[h] === undefined) ? "" : String(r[h]);
        v = v.replace(/\r?\n/g, " ").trim();
        return v;
      }).join("\t");
      lines.push(line);
    }

    var tsv = lines.join("\n");

    try{
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(tsv);
      } else {
        fallbackCopy_(tsv);
      }
      setStatus(okMsg);
    }catch(e){
      console.error(e);
      try{
        fallbackCopy_(tsv);
        setStatus(okMsg);
      }catch(e2){
        console.error(e2);
        setStatus("No pude copiar. Tu navegador bloqueo el portapapeles.");
      }
    }
  }

  function fallbackCopy_(text){
    var ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    ta.style.top = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    var ok = document.execCommand("copy");
    ta.remove();
    if(!ok) throw new Error("execCommand(copy) fallo");
  }

  /* =================== TABLAS HTML =================== */

  function tableHTML(rows, headersForced){
    var headers = (headersForced && headersForced.length) ? headersForced : Object.keys(rows[0] || {});
    var html = "<table><thead><tr>";
    for (var i=0;i<headers.length;i++){
      html += "<th>" + escapeHtml(headers[i]) + "</th>";
    }
    html += "</tr></thead><tbody>";

    for (var r=0;r<rows.length;r++){
      html += "<tr>";
      for (var h=0;h<headers.length;h++){
        var key = headers[h];
        var v = (rows[r][key] === null || rows[r][key] === undefined) ? "" : String(rows[r][key]);

        if (/^https?:\/\//i.test(v)){
          html += "<td><a href=\"" + escapeAttr(v) + "\" target=\"_blank\">ver</a></td>";
        } else {
          var vv = v.split(" | ").map(escapeHtml).join("<br>");
          html += "<td>" + vv + "</td>";
        }
      }
      html += "</tr>";
    }

    html += "</tbody></table>";
    return html;
  }

  function tableHTMLVehicles_(rows, headers){
    headers = (headers && headers.length) ? headers : Object.keys(rows[0] || {});
    var html = "<table><thead><tr>";
    for (var i=0;i<headers.length;i++){
      html += "<th>" + escapeHtml(headers[i]) + "</th>";
    }
    html += "</tr></thead><tbody>";

    for (var r=0;r<rows.length;r++){
      var row = rows[r] || {};
      html += "<tr>";
      for (var h=0;h<headers.length;h++){
        var key = headers[h];
        var v = (row[key] === null || row[key] === undefined) ? "" : String(row[key]);

        if (key === "Comercializacion") {
          var url = row.__comUrl || "";
          var tip = row.__comLabel || "Sin evidencia";
          var emoji = v || "";

          html += "<td><div class=\"comCell\">";

          if (url) {
            html += "<a class=\"comEmoji\" href=\"" + escapeAttr(url) + "\" target=\"_blank\" title=\"" + escapeAttr(tip) + "\">" + escapeHtml(emoji) + "</a>";
          } else {
            html += "<span class=\"comEmoji\" title=\"" + escapeAttr(tip) + "\">" + escapeHtml(emoji) + "</span>";
          }

          html += "<button class=\"btn-evidencia\" onclick=\"alert('Evidencia lazy se activa cuando conectemos el backend.');\">" +
                  "<svg class=\"infoIcon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z\"/><path d=\"M12 16v-4\"/><path d=\"M12 8h.01\"/></svg>" +
                  "Ver evidencia</button>";

          html += "</div></td>";
          continue;
        }

        if (/^https?:\/\//i.test(v)){
          html += "<td><a href=\"" + escapeAttr(v) + "\" target=\"_blank\">ver</a></td>";
        } else {
          var vv = v.split(" | ").map(escapeHtml).join("<br>");
          html += "<td>" + vv + "</td>";
        }
      }
      html += "</tr>";
    }

    html += "</tbody></table>";
    return html;
  }

  function escapeHtml(s){
    return String(s)
      .split("&").join("&amp;")
      .split("<").join("&lt;")
      .split(">").join("&gt;")
      .split('"').join("&quot;")
      .split("'").join("&#039;");
  }

  function escapeAttr(s){
    return String(s).split('"').join("&quot;");
  }

  function exportar(){
    alert("Export a Excel se activa cuando conectemos el backend (Supabase) para generar el archivo.");
  }

  function sleep_(ms){ return new Promise(function(res){ setTimeout(res, ms); }); }

  /* =================== DEMO PAYLOAD (para que se vea funcionando) =================== */
  function demoPayload_(code){
    var codeUp = String(code || "").trim().toUpperCase();
    return {
      codigo: codeUp,
      productUrl: "https://example.com/product/" + encodeURIComponent(codeUp),
      productId: "demo-001",
      guestId: "demo",
      counts: { vehicles_groups: 2, oe_numbers: 3, related_products: 2, toyodiy_rows: 4 },
      tablas: {
        oeNumbers: [
          { PartNumber: codeUp, Owner: "OEM" },
          { PartNumber: codeUp + "-ALT", Owner: "ALT" },
          { PartNumber: "12345-ABCDE", Owner: "CROSS" }
        ],
        vehicles: {
          headers: ["Vehiculo","Modelo","Motor","Serie","AÃ±o Inicial","AÃ±o Final","Posicion","Version","Comercializacion"],
          rows: [
            {"Vehiculo":"TOYOTA","Modelo":"HILUX","Motor":"2KD","Serie":"KUN","AÃ±o Inicial":"2006","AÃ±o Final":"2015","Posicion":"Front","Version":"LATAM","Comercializacion":"ðŸŸ¡","__comLabel":"Pendiente (demo)"},
            {"Vehiculo":"TOYOTA","Modelo":"PRADO","Motor":"1KD","Serie":"KDJ","AÃ±o Inicial":"2010","AÃ±o Final":"2018","Posicion":"Rear","Version":"JDM","Comercializacion":"ðŸŸ¢","__comLabel":"Buena seÃ±al (demo)","__comUrl":"https://example.com/search?q=" + encodeURIComponent(codeUp)}
          ]
        },
        toyodiyXref: {
          sourceUrl: "https://example.com/toyodiy",
          warn: "Demo",
          headers: ["Pais","Modelo","Desde","Hasta","Link"],
          rows: [
            { Pais:"JP", Modelo:"HILUX", Desde:"2006", Hasta:"2011", Link:"https://example.com/a" },
            { Pais:"JP", Modelo:"HILUX", Desde:"2012", Hasta:"2015", Link:"https://example.com/b" },
            { Pais:"US", Modelo:"PRADO", Desde:"2010", Hasta:"2014", Link:"https://example.com/c" },
            { Pais:"US", Modelo:"PRADO", Desde:"2015", Hasta:"2018", Link:"https://example.com/d" }
          ]
        },
        referencias: [
          { Ref: "Relacionado 1", Nota: "demo" },
          { Ref: "Relacionado 2", Nota: "demo" }
        ],
        subAssembly: [
          { Item: "Sub assembly 1", Nota: "demo" }
        ]
      }
    };
  }
</script>
</body>
</html>

