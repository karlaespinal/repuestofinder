<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - App</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:22px;color:#111}
    .topbar{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin:0 0 14px 0;}
    h1{margin:0;font-size:26px}
    .watermark{font-size:12px;color:#9ca3af;font-weight:800;letter-spacing:.4px;user-select:none;white-space:nowrap;opacity:.65;text-transform:uppercase;}
    .nav{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    a.navlink{color:#2563eb;text-decoration:none;font-weight:900}
    a.navlink:hover{text-decoration:underline}
    .card{background:#fff;border:1px solid #e6e8f0;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #d7dbe7;font-size:15px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800}
    .btn{background:#2563eb;color:#fff}
    .btn2{background:#e5e7eb}
    .btn3{background:#111;color:#fff}
    .muted{color:#6b7280;font-size:13px}
    .ok{display:inline-flex;align-items:center;gap:8px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%;background:#10b981;display:inline-block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eef0f6;padding:10px;text-align:left;font-size:13px;vertical-align:top;white-space:nowrap}
    th{background:#fafbff;position:sticky;top:0;z-index:1}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .searchBox{max-width:420px}
    @media(max-width:900px){.searchBox{max-width:100%}}

    .copyBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;border:1px solid #e6e8f0;
      background:#fff;color:#111;font-weight:900;font-size:13px;cursor:pointer;
    }
    .copyBtn:hover{background:#f6f7fb}
    .copyBtn:disabled{opacity:.5;cursor:not-allowed}
    .copyIcon{width:16px;height:16px;display:inline-block}

    .accHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:default;}
    .accTitle{display:flex;align-items:center;gap:10px;font-weight:900;}
    .accBody{margin-top:10px;}
    .chev{width:18px;height:18px;transition:transform .18s ease;opacity:.8;flex:0 0 auto;}
    .accRight{display:flex;align-items:center;gap:10px;}
    .tableWrap{overflow:auto;border-radius:12px;border:1px solid #eef0f6}

    @media(max-width:1024px){
      .topbar{flex-direction:column;align-items:flex-start}
      .card.menuCard{padding:14px 16px}
      .accHeader{cursor:pointer;user-select:none}
      .accHeader{justify-content:center;position:relative;min-height:44px}
      .accTitle{justify-content:center;font-size:15px;font-weight:900;width:100%;text-align:center}
      .accRight{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:0;pointer-events:none}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .accRight{opacity:1;pointer-events:auto}
      .card.open .chev{transform:rotate(180deg)}
      th,td{padding:8px;font-size:12px}
      .copyBtn{padding:7px 9px;font-size:12px}
    }

    @media (pointer:coarse), (hover:none){
      .accHeader{cursor:pointer; user-select:none;}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .chev{transform:rotate(180deg);}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>RepuestoFinder</h1>
      <div class="watermark">App</div>
    </div>

    <div class="nav">
      <a class="navlink" href="/?stay=1">Volver al sitio</a>
      <a class="navlink" href="#" onclick="cerrarSesion();return false;" id="logoutLink" style="display:none">Cerrar sesion</a>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:flex-end">
      <div class="grow">
        <div class="muted">Buscar por codigo OEM o equivalente:</div>
        <div style="margin-top:10px" class="searchBox">
          <input id="code" placeholder="Ej: 55300-3X100" value="111242"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
        <button class="btn" onclick="buscar()">Buscar</button>
        <button class="btn2" onclick="limpiar()">Limpiar</button>
        <button class="btn3" onclick="exportar()" id="btnExport" disabled>Exportar a Excel</button>
      </div>
    </div>

    <div style="margin-top:10px" class="ok">
      <span class="dot"></span><span id="status">Listo</span>
    </div>
  </div>

  <div class="grid2">
    <div class="card menuCard open" id="cardProducto">
      <div class="accHeader" onclick="toggleAcc('cardProducto')">
        <div class="accTitle">Producto</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <span class="pill" id="pillCode">-</span>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div class="muted">URL: <a id="productUrl" href="#" target="_blank">-</a></div>
        <div style="margin-top:8px" class="muted" id="counts">Vehicles: 0 | Cambios: 0</div>
        <div style="margin-top:8px" class="muted" id="notes"></div>
      </div>
    </div>

    <div class="card menuCard" id="cardOE">
      <div class="accHeader" onclick="toggleAcc('cardOE')">
        <div class="accTitle">Cambios</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <button class="copyBtn" id="btnCopyOE" onclick="copiarOE()" disabled title="Copiar tabla para Excel">
            <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copiar
          </button>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div id="oeWrap" class="muted">No hay filas detectadas.</div>
      </div>
    </div>
  </div>

  <div class="card menuCard" id="cardVeh">
    <div class="accHeader" onclick="toggleAcc('cardVeh')">
      <div class="accTitle">Vehicles</div>
      <div class="accRight" onclick="event.stopPropagation()">
        <button class="copyBtn" id="btnCopyVeh" onclick="copiarVehicles()" disabled title="Copiar tabla para Excel">
          <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copiar
        </button>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>

    <div class="accBody">
      <div id="vehWrap" class="muted">No hay filas detectadas.</div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://pjkbipdjxxxzjiuyfkaq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_G7uvRyHNLSew2HKJY_h6ag_M2NZDYx4";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let lastPayload = null;

  function setStatus(txt){ document.getElementById("status").textContent = txt; }

  function isMobile_(){
    const w = Math.min(window.innerWidth || 9999, screen.width || 9999);
    const isTouch = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    return (w <= 1024) || isTouch;
  }
  function setMobileDefault_(){
    ["cardProducto","cardOE","cardVeh"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.remove("open"); });
    const p = document.getElementById("cardProducto"); if(p) p.classList.add("open");
  }
  function setDesktopDefault_(){
    ["cardProducto","cardOE","cardVeh"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.add("open"); });
  }
  window.toggleAcc = function(cardId){
    if(!isMobile_()) return;
    const el = document.getElementById(cardId);
    if(!el) return;
    const willOpen = !el.classList.contains("open");
    ["cardProducto","cardOE","cardVeh"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.remove("open"); });
    if(willOpen) el.classList.add("open");
  };
  window.addEventListener("resize", ()=>{ if(isMobile_()) setMobileDefault_(); else setDesktopDefault_(); });
  document.addEventListener("DOMContentLoaded", ()=>{ if(isMobile_()) setMobileDefault_(); else setDesktopDefault_(); });

  window.cerrarSesion = async function(){
    try{ await supabase.auth.signOut(); }catch(e){}
    window.location.href = "/?stay=1";
  };

  async function initAuth_(){
  const logoutLink = document.getElementById("logoutLink");

  const params = new URLSearchParams(window.location.search);
  const isDemo = params.get("demo") === "1";

  const { data } = await supabase.auth.getSession();

  // ✅ Si NO hay sesión pero es DEMO => permitir entrar
  if(!data || !data.session){
    if(isDemo){
      if(logoutLink) logoutLink.style.display = "none";
      return;
    }
    // ❌ No hay sesión y NO es demo => fuera
    window.location.href = "/?stay=1";
    return;
  }

  // ✅ hay sesión => mostrar logout
  if(logoutLink) logoutLink.style.display = "inline-flex";
}

  function escapeHtml_(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function renderTableInto_(wrapId, tableObj){
    const wrap = document.getElementById(wrapId);
    if(!wrap) return;

    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows) || tableObj.rows.length === 0){
      wrap.innerHTML = "No hay filas detectadas.";
      return;
    }

    const headers = tableObj.headers;
    const rows = tableObj.rows;

    let html = '<div class="tableWrap"><table><thead><tr>';
    for(const h of headers) html += '<th>' + escapeHtml_(h) + '</th>';
    html += '</tr></thead><tbody>';

    for(const r of rows){
      html += '<tr>';
      for(let i=0;i<headers.length;i++){
        const v = (r && r[i] !== undefined) ? r[i] : "";
        html += '<td>' + escapeHtml_(v) + '</td>';
      }
      html += '</tr>';
    }

    html += '</tbody></table></div>';
    wrap.innerHTML = html;
  }

  function tableToTSV_(tableObj){
    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows)) return "";
    const lines = [];
    lines.push(tableObj.headers.join("\t"));
    for(const r of tableObj.rows){
      const row = tableObj.headers.map((_,i)=> (r && r[i] !== undefined && r[i] !== null) ? String(r[i]) : "");
      lines.push(row.join("\t"));
    }
    return lines.join("\n");
  }

  function normalizeCode_(s){
    return String(s||"")
      .trim()
      .toUpperCase()
      .replace(/\s+/g,"")
      .replace(/[^A-Z0-9]/g,"");
  }

  function unique_(arr){
    const out = [];
    const seen = new Set();
    for(const x of arr){
      const k = String(x);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  function buildGoogleUrl_(code){
    return "https://www.google.com/search?q=" + encodeURIComponent(code);
  }

  async function resolveOriginals_(codeNorm){
    const { data, error } = await supabase
      .from("cambios")
      .select("original_norm")
      .or(`original_norm.eq.${codeNorm},cambio_norm.eq.${codeNorm}`)
      .limit(5000);

    if(error) throw error;

    const originals = unique_((data || []).map(x => x.original_norm).filter(Boolean));
    if(originals.length === 0) return [codeNorm];
    return originals;
  }

  async function fetchCambiosByOriginals_(originalNorms){
    const { data, error } = await supabase
      .from("cambios")
      .select("cambio, owner, posicion")
      .in("original_norm", originalNorms)
      .order("posicion", { ascending: true, nullsFirst: false })
      .order("cambio", { ascending: true });

    if(error) throw error;

    const rows = (data || []).map(r => ([
      r.cambio || "",
      r.owner || ""
    ]));

    return { headers: ["cambio", "owner"], rows };
  }

  // ✅ Vehicles: quitar columnas + reordenar + renombrar headers
  async function fetchVehiclesByOriginals_(originalNorms){
    const { data, error } = await supabase
      .from("datos_vehiculares")
      .select("*")
      .in("original_norm", originalNorms)
      .limit(5000);

    if(error) throw error;

    const rowsData = data || [];
    if(rowsData.length === 0) return { headers: [], rows: [] };

    // Columnas que NO quieres ver
    const exclude = new Set([
      "id",
      "original",
      "original_norm",
      "comercializacion",
      "created_at",
      "createdAt"
    ]);

    // Orden deseado: Vehiculo -> Año inicio -> Año final -> Modelo -> resto
    const preferred = [
      "vehiculo",
      "anio_inicio",
      "anio_final",
      "modelo",
      "motor",
      "serie",
      "cilindro",
      "posicion",
      "version",
      "notas"
    ];

    // headers base según keys reales
    const allKeys = Object.keys(rowsData[0] || {}).filter(k => !exclude.has(k));

    const preferredExisting = preferred.filter(k => allKeys.includes(k));
    const rest = allKeys.filter(k => !preferredExisting.includes(k));

    const headersKeys = [...preferredExisting, ...rest];

    // Renombrar headers visibles
    const headerLabel = (k) => {
      if(k === "anio_inicio") return "Año inicio";
      if(k === "anio_final") return "Año final";
      // default: Capitalizar primera letra y reemplazar _ por espacio
      return k.replace(/_/g," ").replace(/^./, c => c.toUpperCase());
    };

    const headers = headersKeys.map(headerLabel);
    const rows = rowsData.map(obj => headersKeys.map(k => (obj[k] ?? "")));

    return { headers, rows };
  }

  window.limpiar = function(){
    lastPayload = null;
    document.getElementById("btnExport").disabled = true;
    document.getElementById("btnCopyOE").disabled = true;
    document.getElementById("btnCopyVeh").disabled = true;

    document.getElementById("pillCode").textContent = "-";
    document.getElementById("productUrl").textContent = "-";
    document.getElementById("productUrl").href = "#";
    document.getElementById("counts").textContent = "Vehicles: 0 | Cambios: 0";
    document.getElementById("notes").textContent = "";

    document.getElementById("oeWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("vehWrap").innerHTML = "No hay filas detectadas.";

    setStatus("Listo");
    if(isMobile_()) setMobileDefault_();
  };

  window.buscar = async function(){
    const raw = (document.getElementById("code").value || "").trim();
    if(!raw){ setStatus("Escribe un codigo."); return; }

    const norm = normalizeCode_(raw);
    const candidates = unique_([ raw, raw.toUpperCase(), norm ]).filter(Boolean);

    setStatus("Buscando...");
    try{
      const codigoMostrado = candidates[0] || raw;
      const originalNorms = await resolveOriginals_(norm);

      const [veh, camb] = await Promise.all([
        fetchVehiclesByOriginals_(originalNorms),
        fetchCambiosByOriginals_(originalNorms),
      ]);

      const payload = {
        codigo: codigoMostrado,
        codigo_norm: norm,
        original_norms: originalNorms,
        productUrl: buildGoogleUrl_(codigoMostrado),
        tablas: { vehicles: veh, cambios: camb }
      };

      render(payload);
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e && e.message ? e.message : e));
      alert("Error consultando: " + (e && e.message ? e.message : e));
    }
  };

  function render(payload){
    lastPayload = payload;

    const codigo = payload.codigo || "-";
    const productUrl = payload.productUrl || buildGoogleUrl_(codigo);

    document.getElementById("pillCode").textContent = codigo;
    document.getElementById("productUrl").textContent = productUrl;
    document.getElementById("productUrl").href = productUrl;

    const vehicles = payload.tablas?.vehicles || null;
    const cambios  = payload.tablas?.cambios  || null;

    renderTableInto_("vehWrap", vehicles);
    renderTableInto_("oeWrap", cambios);

    const hasVeh = vehicles && Array.isArray(vehicles.rows) && vehicles.rows.length > 0;
    const hasCamb = cambios && Array.isArray(cambios.rows) && cambios.rows.length > 0;

    document.getElementById("btnCopyVeh").disabled = !hasVeh;
    document.getElementById("btnCopyOE").disabled = !hasCamb;

    document.getElementById("counts").textContent =
      "Vehicles: " + (hasVeh ? vehicles.rows.length : 0) +
      " | Cambios: " + (hasCamb ? cambios.rows.length : 0);

    document.getElementById("notes").textContent = "";
    document.getElementById("btnExport").disabled = !(hasVeh || hasCamb);

    setStatus("Listo ✅");
    if(isMobile_()) setMobileDefault_();
  }

  window.copiarVehicles = async function(){
    const vehicles = lastPayload?.tablas?.vehicles || null;
    const tsv = tableToTSV_(vehicles);
    if(!tsv){ alert("No hay Vehicles para copiar."); return; }
    try{
      await navigator.clipboard.writeText(tsv);
      alert("Vehicles copiado ✅ (pega en Excel)");
    }catch(e){
      alert("No pude copiar. (Tu navegador bloqueo el clipboard)");
    }
  };

  window.copiarOE = async function(){
    const cambios = lastPayload?.tablas?.cambios || null;
    const tsv = tableToTSV_(cambios);
    if(!tsv){ alert("No hay Cambios para copiar."); return; }
    try{
      await navigator.clipboard.writeText(tsv);
      alert("Cambios copiado ✅ (pega en Excel)");
    }catch(e){
      alert("No pude copiar. (Tu navegador bloqueo el clipboard)");
    }
  };

  window.exportar = function(){
    if(!lastPayload){ alert("No hay datos para exportar."); return; }

    const codigo = (lastPayload.codigo || "export").toString();
    const vehicles = lastPayload?.tablas?.vehicles || null;
    const cambios  = lastPayload?.tablas?.cambios  || null;

    const parts = [];
    parts.push("CODIGO\t" + codigo);
    parts.push("");
    parts.push("=== VEHICLES ===");
    parts.push(tableToTSV_(vehicles) || "No hay filas");
    parts.push("");
    parts.push("=== CAMBIOS ===");
    parts.push(tableToTSV_(cambios) || "No hay filas");

    const content = parts.join("\n");
    const blob = new Blob([content], { type:"text/tab-separated-values;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "RepuestoFinder_" + codigo.replace(/[^a-zA-Z0-9_-]/g,"_") + ".tsv";
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  await initAuth_();
  supabase.auth.onAuthStateChange((event, session) => {
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";

    // ✅ Si es demo, no rebotes aunque no haya sesión
    if (!session && !isDemo) window.location.href = "/?stay=1";
  });

</script>
</body>
</html>










