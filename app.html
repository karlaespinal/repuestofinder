<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - App</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0;padding:22px;color:#111}
    .topbar{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin:0 0 14px 0;}
    h1{margin:0;font-size:26px}
    .watermark{font-size:12px;color:#9ca3af;font-weight:800;letter-spacing:.4px;user-select:none;white-space:nowrap;opacity:.65;text-transform:uppercase;}
    .nav{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    a.navlink{color:#2563eb;text-decoration:none;font-weight:900}
    a.navlink:hover{text-decoration:underline}
    .card{background:#fff;border:1px solid #e6e8f0;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #d7dbe7;font-size:15px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800}
    .btn{background:#2563eb;color:#fff}
    .btn2{background:#e5e7eb}
    .btn3{background:#111;color:#fff}
    .muted{color:#6b7280;font-size:13px}
    .ok{display:inline-flex;align-items:center;gap:8px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%;background:#10b981;display:inline-block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eef0f6;padding:10px;text-align:left;font-size:13px;vertical-align:top;white-space:nowrap}
    th{background:#fafbff;position:sticky;top:0;z-index:1}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .searchBox{max-width:420px}
    @media(max-width:900px){.searchBox{max-width:100%}}

    .copyBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;border:1px solid #e6e8f0;
      background:#fff;color:#111;font-weight:900;font-size:13px;cursor:pointer;
    }
    .copyBtn:hover{background:#f6f7fb}
    .copyBtn:disabled{opacity:.5;cursor:not-allowed}
    .copyIcon{width:16px;height:16px;display:inline-block}

    .accHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:default;}
    .accTitle{display:flex;align-items:center;gap:10px;font-weight:900;}
    .accBody{margin-top:10px;}
    .chev{width:18px;height:18px;transition:transform .18s ease;opacity:.8;flex:0 0 auto;}
    .accRight{display:flex;align-items:center;gap:10px;}
    .tableWrap{overflow:auto;border-radius:12px;border:1px solid #eef0f6}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid #e6e8f0;
      background:#fff;font-weight:900;font-size:12px;color:#111
    }

    @media(max-width:1024px){
      .topbar{flex-direction:column;align-items:flex-start}
      .card.menuCard{padding:14px 16px}
      .accHeader{cursor:pointer;user-select:none}
      .accHeader{justify-content:center;position:relative;min-height:44px}
      .accTitle{justify-content:center;font-size:15px;font-weight:900;width:100%;text-align:center}
      .accRight{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:0;pointer-events:none}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .accRight{opacity:1;pointer-events:auto}
      .card.open .chev{transform:rotate(180deg)}
      th,td{padding:8px;font-size:12px}
      .copyBtn{padding:7px 9px;font-size:12px}
    }

    @media (pointer:coarse), (hover:none){
      .accHeader{cursor:pointer; user-select:none;}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .chev{transform:rotate(180deg);}
    }
  
    /* ===== FILTRO VEHICULAR ===== */
    .filterBar{
      display:grid;
      grid-template-columns:
        minmax(180px, 1.1fr)
        minmax(110px, 0.6fr)
        minmax(160px, 0.9fr)
        minmax(160px, 0.9fr)
        minmax(240px, 1.5fr)
        auto;
      gap:14px;
      align-items:end;
      margin-top:14px;
      width:100%;
    }

    .filterItem{display:flex;flex-direction:column;min-width:0}
    .filterLabel{font-size:12px;color:#6b7280;margin:0 0 6px 2px;font-weight:800}
    .filterBar input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d7dbe7;
      font-size:14px;
      height:40px;
      box-sizing:border-box;
    }
    .filterActions{display:flex;gap:10px;align-items:end}
    .filterActions button{height:40px;padding:0 16px;white-space:nowrap}
    @media (max-width:1100px){
      .filterBar{grid-template-columns:repeat(2, minmax(0,1fr));}
      .filterActions{justify-content:flex-end}
    }
    @media (max-width:600px){
      .filterBar{grid-template-columns:1fr;}
      .filterActions{width:100%}
      .filterActions button{flex:1}
    }

    /* ===== Logos de Vehiculos ===== */
    .vehLogos{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .vehLogoItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #eef0f6;
      border-radius:12px;
      background:#fff;
      box-shadow:0 1px 8px rgba(0,0,0,.03);
      max-width:220px;
    }
    .vehLogoImg{
      width:34px;
      height:22px;
      object-fit:contain;
      display:block;
      filter:grayscale(0%);
      opacity:.95;
    }
    .vehLogoText{
      font-size:12px;
      font-weight:900;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:150px;
    }
    .codeLink{color:#2563eb;text-decoration:underline;font-weight:900;cursor:pointer;}
    .codeLink:hover{filter:brightness(.9)}
    
    /* Estilo para el selector de paÃ­s */
    .country-selector {
      margin-left:12px;
      display:inline-block;
    }
    .country-selector select {
      font-weight:800;
      background:white;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e6e8f0;
      font-size:12px;
      cursor:pointer;
      outline:none;
    }
    .country-selector select:hover {
      background:#f6f7fb;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>RepuestoFinder</h1>
      <div class="watermark">App</div>
    </div>
    <div class="nav">
      <a class="navlink" href="/?stay=1">Volver al sitio</a>
      <a class="navlink" href="#" onclick="cerrarSesion();return false;" id="logoutLink" style="display:none">Cerrar sesion</a>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:flex-end">
      <div class="grow">
        <div class="muted">Buscar por codigo OEM o equivalente:</div>
        <div style="margin-top:10px" class="searchBox">
          <input id="code" placeholder="Ej: 55300-3X100" value="111242"/>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
        <button class="btn" onclick="buscar()">Buscar</button>
        <button class="btn2" onclick="limpiar()">Limpiar</button>
        <button class="btn3" onclick="exportar()" id="btnExport" disabled>Exportar a Excel</button>
      </div>
    </div>
    <div style="margin-top:10px" class="ok">
      <span class="dot"></span><span id="status">Listo</span>
    </div>
    <div style="margin-top:8px" class="muted">
      Mercado (pais): <span class="pill" id="pillCountry">â€”</span>
      <span id="pillCityWrap" style="display:none"> Â· ciudad: <span class="pill" id="pillCity">â€”</span></span>
      
      <!-- SELECTOR DE PAÃS COMPLETO -->
      <span class="country-selector">
        Â· <span style="margin-left:4px">ğŸŒ</span>
        <select id="countrySelector" title="PaÃ­s para bÃºsquedas">
          <option value="DO">ğŸ‡©ğŸ‡´ DO - Rep. Dominicana</option>
          <option value="US">ğŸ‡ºğŸ‡¸ US - Estados Unidos</option>
          <option value="MX">ğŸ‡²ğŸ‡½ MX - MÃ©xico</option>
          <option value="CA">ğŸ‡¨ğŸ‡¦ CA - CanadÃ¡</option>
          <option value="ES">ğŸ‡ªğŸ‡¸ ES - EspaÃ±a</option>
          <option value="PT">ğŸ‡µğŸ‡¹ PT - Portugal</option>
          <option value="FR">ğŸ‡«ğŸ‡· FR - Francia</option>
          <option value="DE">ğŸ‡©ğŸ‡ª DE - Alemania</option>
          <option value="IT">ğŸ‡®ğŸ‡¹ IT - Italia</option>
          <option value="GB">ğŸ‡¬ğŸ‡§ GB - Reino Unido</option>
          <option value="NL">ğŸ‡³ğŸ‡± NL - PaÃ­ses Bajos</option>
          <option value="BE">ğŸ‡§ğŸ‡ª BE - BÃ©lgica</option>
          <option value="CH">ğŸ‡¨ğŸ‡­ CH - Suiza</option>
          <option value="SE">ğŸ‡¸ğŸ‡ª SE - Suecia</option>
          <option value="NO">ğŸ‡³ğŸ‡´ NO - Noruega</option>
          <option value="DK">ğŸ‡©ğŸ‡° DK - Dinamarca</option>
          <option value="FI">ğŸ‡«ğŸ‡® FI - Finlandia</option>
          <option value="PL">ğŸ‡µğŸ‡± PL - Polonia</option>
          <option value="TR">ğŸ‡¹ğŸ‡· TR - TurquÃ­a</option>
          <option value="RU">ğŸ‡·ğŸ‡º RU - Rusia</option>
          <option value="UA">ğŸ‡ºğŸ‡¦ UA - Ucrania</option>
          <option value="SA">ğŸ‡¸ğŸ‡¦ SA - Arabia Saudita</option>
          <option value="AE">ğŸ‡¦ğŸ‡ª AE - Emiratos Ãrabes</option>
          <option value="EG">ğŸ‡ªğŸ‡¬ EG - Egipto</option>
          <option value="MA">ğŸ‡²ğŸ‡¦ MA - Marruecos</option>
          <option value="ZA">ğŸ‡¿ğŸ‡¦ ZA - SudÃ¡frica</option>
          <option value="NG">ğŸ‡³ğŸ‡¬ NG - Nigeria</option>
          <option value="KE">ğŸ‡°ğŸ‡ª KE - Kenia</option>
          <option value="IN">ğŸ‡®ğŸ‡³ IN - India</option>
          <option value="TH">ğŸ‡¹ğŸ‡­ TH - Tailandia</option>
          <option value="VN">ğŸ‡»ğŸ‡³ VN - Vietnam</option>
          <option value="MY">ğŸ‡²ğŸ‡¾ MY - Malasia</option>
          <option value="SG">ğŸ‡¸ğŸ‡¬ SG - Singapur</option>
          <option value="ID">ğŸ‡®ğŸ‡© ID - Indonesia</option>
          <option value="PH">ğŸ‡µğŸ‡­ PH - Filipinas</option>
          <option value="CN">ğŸ‡¨ğŸ‡³ CN - China</option>
          <option value="JP">ğŸ‡¯ğŸ‡µ JP - JapÃ³n</option>
          <option value="KR">ğŸ‡°ğŸ‡· KR - Corea del Sur</option>
          <option value="AU">ğŸ‡¦ğŸ‡º AU - Australia</option>
          <option value="NZ">ğŸ‡³ğŸ‡¿ NZ - Nueva Zelanda</option>
          <option value="CO">ğŸ‡¨ğŸ‡´ CO - Colombia</option>
          <option value="CL">ğŸ‡¨ğŸ‡± CL - Chile</option>
          <option value="PE">ğŸ‡µğŸ‡ª PE - PerÃº</option>
          <option value="AR">ğŸ‡¦ğŸ‡· AR - Argentina</option>
          <option value="BR">ğŸ‡§ğŸ‡· BR - Brasil</option>
          <option value="EC">ğŸ‡ªğŸ‡¨ EC - Ecuador</option>
          <option value="VE">ğŸ‡»ğŸ‡ª VE - Venezuela</option>
          <option value="BO">ğŸ‡§ğŸ‡´ BO - Bolivia</option>
          <option value="PY">ğŸ‡µğŸ‡¾ PY - Paraguay</option>
          <option value="UY">ğŸ‡ºğŸ‡¾ UY - Uruguay</option>
          <option value="PA">ğŸ‡µğŸ‡¦ PA - PanamÃ¡</option>
          <option value="CR">ğŸ‡¨ğŸ‡· CR - Costa Rica</option>
          <option value="GT">ğŸ‡¬ğŸ‡¹ GT - Guatemala</option>
          <option value="SV">ğŸ‡¸ğŸ‡» SV - El Salvador</option>
          <option value="HN">ğŸ‡­ğŸ‡³ HN - Honduras</option>
          <option value="NI">ğŸ‡³ğŸ‡® NI - Nicaragua</option>
          <option value="CU">ğŸ‡¨ğŸ‡º CU - Cuba</option>
          <option value="PR">ğŸ‡µğŸ‡· PR - Puerto Rico</option>
          <option value="JM">ğŸ‡¯ğŸ‡² JM - Jamaica</option>
          <option value="HT">ğŸ‡­ğŸ‡¹ HT - HaitÃ­</option>
          <option value="TT">ğŸ‡¹ğŸ‡¹ TT - Trinidad y Tobago</option>
          <option value="BS">ğŸ‡§ğŸ‡¸ BS - Bahamas</option>
          <option value="BZ">ğŸ‡§ğŸ‡¿ BZ - Belice</option>
          <option value="GY">ğŸ‡¬ğŸ‡¾ GY - Guyana</option>
          <option value="SR">ğŸ‡¸ğŸ‡· SR - Surinam</option>
          <option value="ALL">ğŸŒ GLOBAL - Todos</option>
        </select>
      </span>
    </div>
  </div>

  <!-- ===== Filtro vehicular ===== -->
  <div class="card" id="cardFiltroVehicular">
    <div class="muted" style="font-weight:900">Buscador por Vehiculo / AÃ±o / Modelo / Motor / Descripcion</div>
    <div class="filterBar">
      <div class="filterItem medium">
        <div class="filterLabel">Vehiculo</div>
        <input id="fVehiculo" placeholder="Ej: Honda, Hyundai, Mercedes..." autocomplete="off"/>
      </div>
      <div class="filterItem small">
        <div class="filterLabel">AÃ±o</div>
        <input id="fAnio" placeholder="Ej: 1989" inputmode="numeric" autocomplete="off"/>
      </div>
      <div class="filterItem medium">
        <div class="filterLabel">Modelo</div>
        <input id="fModelo" placeholder="Ej: Civic, H100..." autocomplete="off"/>
      </div>
      <div class="filterItem medium">
        <div class="filterLabel">Motor</div>
        <input id="fMotor" placeholder="Ej: 1.6, D4BB, M276..." autocomplete="off"/>
      </div>
      <div class="filterItem">
        <div class="filterLabel">Descripcion</div>
        <input id="fDescripcion" placeholder="Ej: alternador, filtro, bomba..." autocomplete="off"/>
      </div>
      <div class="filterActions">
        <button class="btn" onclick="aplicarFiltroVehicular()">Buscar</button>
        <button class="btn2" onclick="limpiarFiltroVehicular()">Limpiar</button>
      </div>
    </div>
    <div class="muted" style="margin-top:10px">
      <span class="pill" id="pillFiltroEstado">Sin filtro</span>
      <span class="muted" id="filtroHint" style="margin-left:8px;display:none"></span>
    </div>
  </div>

  <div class="grid2">
    <div class="card menuCard open" id="cardProducto">
      <div class="accHeader" onclick="toggleAcc('cardProducto')">
        <div class="accTitle">Producto</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <span class="pill" id="pillCode">-</span>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>
      <div class="accBody">
        <div class="muted">URL: <a id="productUrl" href="#" target="_blank">-</a></div>
        <div style="margin-top:8px" class="muted" id="counts">Vehicles: 0 | Cambios: 0</div>
        <div id="vehLogos" class="vehLogos" style="display:none"></div>
        <div style="margin-top:8px" class="muted" id="notes"></div>
      </div>
    </div>

    <div class="card menuCard" id="cardSimilitud">
      <div class="accHeader" onclick="toggleAcc('cardSimilitud')">
        <div class="accTitle">Similitud</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <span class="pill" id="pillSimCount">0</span>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>
      <div class="accBody">
        <div class="muted" id="simHint">Si no encontramos coincidencia exacta, te mostraremos codigos similares aqui.</div>
        <div id="simWrap" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card menuCard" id="cardOE">
      <div class="accHeader" onclick="toggleAcc('cardOE')">
        <div class="accTitle">Cambios</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <button class="copyBtn" id="btnCopyOE" onclick="copiarOE()" disabled title="Copiar tabla para Excel">
            <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copiar
          </button>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>
      <div class="accBody">
        <div id="oeWrap" class="muted">No hay filas detectadas.</div>
      </div>
    </div>
  </div>

  <div class="card menuCard" id="cardVeh">
    <div class="accHeader" onclick="toggleAcc('cardVeh')">
      <div class="accTitle">Vehicles</div>
      <div class="accRight" onclick="event.stopPropagation()">
        <button class="copyBtn" id="btnCopyVeh" onclick="copiarVehicles()" disabled title="Copiar tabla para Excel">
          <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copiar
        </button>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>
    <div class="accBody">
      <div id="vehWrap" class="muted">No hay filas detectadas.</div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://pjkbipdjxxxzjiuyfkaq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_G7uvRyHNLSew2HKJY_h6ag_M2NZDYx4";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // âœ… Tablas (v1 + v2)
  const VEH_TABLES = ["datos_vehiculares", "datos_vehiculares_v2"];
  const CAMBIOS_TABLES = ["cambios", "cambios_v2"];

  // âœ… Logos por marca
  const AUTO_LOGO_BASE = "assets/logos/autos/";
  const DEFAULT_CAR_SVG_DATAURI =
    "data:image/svg+xml;charset=utf-8," +
    encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="120" height="80" viewBox="0 0 120 80">
        <rect x="0" y="0" width="120" height="80" rx="14" fill="#f3f4f6"/>
        <path d="M30 48l8-16c2-4 6-6 10-6h24c4 0 8 2 10 6l8 16" fill="none" stroke="#9ca3af" stroke-width="4" stroke-linecap="round"/>
        <path d="M26 48h68c6 0 10 4 10 10v6H16v-6c0-6 4-10 10-10z" fill="none" stroke="#9ca3af" stroke-width="4" stroke-linejoin="round"/>
        <circle cx="34" cy="64" r="7" fill="#9ca3af"/>
        <circle cx="86" cy="64" r="7" fill="#9ca3af"/>
      </svg>
    `);

  let lastPayload = null;
  let currentSearchSessionId = null;

  // âœ… Perfil y paÃ­s seleccionado
  let profileCountry = null;
  let profileCity = null;

  // ========== FUNCIONES PARA EL SELECTOR DE PAÃS ==========
  function getSelectedCountry() {
    const selector = document.getElementById("countrySelector");
    return selector ? selector.value : (profileCountry || "DO");
  }

  function saveCountryPreference(country) {
    try {
      localStorage.setItem("rf_preferred_country", country);
    } catch(e) {}
  }

  function loadCountryPreference() {
    try {
      return localStorage.getItem("rf_preferred_country");
    } catch(e) {
      return null;
    }
  }

  function syncCountrySelector() {
    const selector = document.getElementById("countrySelector");
    if (!selector) return;
    
    // Prioridad: 1. Preferencia guardada, 2. Perfil, 3. Default "DO"
    const saved = loadCountryPreference();
    if (saved && selector.querySelector(`option[value="${saved}"]`)) {
      selector.value = saved;
      profileCountry = saved;
    } else if (profileCountry && selector.querySelector(`option[value="${profileCountry}"]`)) {
      selector.value = profileCountry;
    } else {
      selector.value = "DO";
      profileCountry = "DO";
    }
    
    // Actualizar pill
    const pillCountry = document.getElementById("pillCountry");
    if (pillCountry) pillCountry.textContent = profileCountry || "â€”";
  }
  // ========================================================

  function setStatus(txt){ document.getElementById("status").textContent = txt; }

  function isMobile_(){
    const w = Math.min(window.innerWidth || 9999, screen.width || 9999);
    const isTouch = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    return (w <= 1024) || isTouch;
  }

  function setMobileDefault_(){
    ["cardProducto","cardOE","cardVeh","cardSimilitud"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.remove("open"); });
    const p = document.getElementById("cardProducto"); if(p) p.classList.add("open");
  }

  function setDesktopDefault_(){
    ["cardProducto","cardOE","cardVeh","cardSimilitud"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.add("open"); });
  }

  window.toggleAcc = function(cardId){
    if(!isMobile_()) return;
    const el = document.getElementById(cardId);
    if(!el) return;
    const willOpen = !el.classList.contains("open");
    ["cardProducto","cardOE","cardVeh","cardSimilitud"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.remove("open"); });
    if(willOpen) el.classList.add("open");
  };

  window.addEventListener("resize", ()=>{ if(isMobile_()) setMobileDefault_(); else setDesktopDefault_(); });

  window.cerrarSesion = async function(){
    try{ await supabase.auth.signOut(); }catch(e){}
    window.location.href = "/?stay=1";
  };

  async function initAuth_(){
    const logoutLink = document.getElementById("logoutLink");
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";
    const { data } = await supabase.auth.getSession();

    if(!data || !data.session){
      if(isDemo){
        if(logoutLink) logoutLink.style.display = "none";
        return;
      }
      window.location.href = "/?stay=1";
      return;
    }
    if(logoutLink) logoutLink.style.display = "inline-flex";
  }

  function escapeHtml_(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function slugifyMake_(make){
    return String(make||"").trim().toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "");
  }

  function titleCase_(s){
    const t = String(s||"").trim().toLowerCase();
    if(!t) return "";
    return t.charAt(0).toUpperCase() + t.slice(1);
  }

  function getLogoCandidates_(make){
    const slug = slugifyMake_(make);
    const tcase = titleCase_(make).replace(/\s+/g, "");
    const list = [];
    if(slug)  list.push(AUTO_LOGO_BASE + slug + ".png", AUTO_LOGO_BASE + slug + ".jpg", AUTO_LOGO_BASE + slug + ".jpeg");
    if(tcase) list.push(AUTO_LOGO_BASE + tcase + ".png", AUTO_LOGO_BASE + tcase + ".jpg", AUTO_LOGO_BASE + tcase + ".jpeg");
    return list;
  }

  function renderVehicleLogos_(vehiclesTable){
    const wrap = document.getElementById("vehLogos");
    if(!wrap) return;
    wrap.innerHTML = "";
    wrap.style.display = "none";
    if(!vehiclesTable || !Array.isArray(vehiclesTable.headers) || !Array.isArray(vehiclesTable.rows)) return;
    if(!vehiclesTable.rows.length) return;
    const headers = vehiclesTable.headers.map(h => String(h||"").toLowerCase());
    const idxMake = headers.findIndex(h => h === "vehiculo" || h.includes("vehiculo") || h === "vehicle" || h.includes("vehicle"));
    if(idxMake < 0) return;
    const makes = [];
    const seen = new Set();
    for(const r of vehiclesTable.rows){
      const mk = (r && r[idxMake] !== undefined) ? String(r[idxMake]||"").trim() : "";
      if(!mk) continue;
      const key = mk.toLowerCase();
      if(seen.has(key)) continue;
      seen.add(key);
      makes.push(mk);
      if(makes.length >= 10) break;
    }
    if(makes.length === 0) return;
    let html = "";
    for(const mk of makes){
      const candidates = getLogoCandidates_(mk);
      const firstSrc = candidates[0] || DEFAULT_CAR_SVG_DATAURI;
      const escMk = escapeHtml_(mk);
      const candJson = escapeHtml_(JSON.stringify(candidates));
      html += `
        <div class="vehLogoItem" title="${escMk}">
          <img class="vehLogoImg"
               src="${firstSrc}"
               alt="${escMk}"
               data-candidates='${candJson}'
               onerror="(function(img){
                 try{
                   const c = JSON.parse(img.getAttribute('data-candidates')||'[]');
                   const i = Number(img.getAttribute('data-idx')||'0');
                   const next = c[i+1];
                   if(next){
                     img.setAttribute('data-idx', String(i+1));
                     img.src = next;
                     return;
                   }
                 }catch(e){}
                 img.onerror=null;
                 img.src='${DEFAULT_CAR_SVG_DATAURI}';
               })(this)">
          <div class="vehLogoText">${escMk}</div>
        </div>
      `;
    }
    wrap.innerHTML = html;
    wrap.style.display = "flex";
  }

  function renderTableInto_(wrapId, tableObj){
    const wrap = document.getElementById(wrapId);
    if(!wrap) return;
    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows) || tableObj.rows.length === 0){
      wrap.innerHTML = "No hay filas detectadas.";
      return;
    }
    const headers = tableObj.headers;
    const rows = tableObj.rows;
    let html = '<div class="tableWrap"><table><thead><tr>';
    for(const h of headers) html += '<th>' + escapeHtml_(h) + '</th>';
    html += '</tr></thead><tbody>';
    for(const r of rows){
      html += '<tr>';
      for(let i=0;i<headers.length;i++){
        const v = (r && r[i] !== undefined) ? r[i] : "";
        const hName = String(headers[i] || "").toLowerCase();
        const cell = (v !== undefined && v !== null) ? String(v) : "";
        if(hName.includes("codigo principal") || hName.includes("cÃ³digo principal") || hName.includes("principal code")){
          const clean = cell.trim();
          if(clean){
            const esc = escapeHtml_(clean);
            html += '<td><a class="codeLink" href="#" onclick="buscarCodigoPrincipal(\'' + esc + '\');return false;">' + esc + '</a></td>';
          }else{
            html += '<td></td>';
          }
        }else{
          html += '<td>' + escapeHtml_(cell) + '</td>';
        }
      }
      html += '</tr>';
    }
    html += '</tbody></table></div>';
    wrap.innerHTML = html;
  }

  function tableToTSV_(tableObj){
    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows)) return "";
    const lines = [];
    lines.push(tableObj.headers.join("\t"));
    for(const r of tableObj.rows){
      const row = tableObj.headers.map((_,i)=> (r && r[i] !== undefined && r[i] !== null) ? String(r[i]) : "");
      lines.push(row.join("\t"));
    }
    return lines.join("\n");
  }

  function normalizeCode_(s){
    return String(s||"").trim().toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
  }

  function unique_(arr){
    const out = [];
    const seen = new Set();
    for(const x of arr){
      const k = String(x);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  function buildGoogleUrl_(code){
    return "https://www.google.com/search?q=" + encodeURIComponent(code);
  }

  // ======================================================
  // âœ… MARKET INTEL: anon_id + session + country + logging
  // ======================================================

  function getOrCreateAnonId_(){
    try{
      const key = "rf_anon_id";
      let v = localStorage.getItem(key);
      if(v) return v;
      v = "anon_" + crypto.getRandomValues(new Uint32Array(4)).join("-");
      localStorage.setItem(key, v);
      return v;
    }catch(e){
      return "anon_" + Math.random().toString(16).slice(2);
    }
  }

  function detectDevice_(){
    const w = Math.min(window.innerWidth || 9999, screen.width || 9999);
    const isTouch = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    return ((w <= 1024) || isTouch) ? "mobile" : "desktop";
  }

  function classifyCategory_(q){
    const s = String(q||"").toLowerCase();
    const has = (...words) => words.some(w => s.includes(w));
    if(has("amortigu", "shock", "rotula", "buje", "bushing", "stabil", "terminal", "cremallera", "rack", "biela", "suspension")) return "suspension";
    if(has("pastilla", "disco", "caliper", "zapata", "freno", "brake", "cilindro maestro", "master cylinder")) return "frenos";
    if(has("piston", "anillo", "ring", "junta", "empaque", "culata", "head gasket", "bomba aceite", "oil pump", "cadena tiempo", "timing")) return "motor";
    if(has("filtro", "filter", "mann", "mahle", "aceite", "oil filter", "air filter", "cabina")) return "filtros";
    if(has("alternador", "arranque", "starter", "sensor", "bobina", "coil", "bujia", "spark", "relay", "rele", "fusible")) return "electrico";
    if(has("radiador", "bomba agua", "water pump", "termostato", "coolant", "manguera", "fan", "abanico")) return "cooling";
    return "otros";
  }

  function classifyCategoryFromPosition_(posText){
    const s = String(posText || "").toLowerCase();
    const has = (...words) => words.some(w => s.includes(w));
    if (has("brake","freno","rear axle brake","front brake","disc","pad","caliper","zapata","drum","rotor","master cylinder","abs")) return "frenos";
    if (has("suspension","shock","strut","control arm","arm","ball joint","rotula","bushing","buje","stabilizer","stabilizer link","tie rod","rack","steering","terminal")) return "suspension";
    if (has("engine","timing","gasket","head","piston","ring","bearing","oil pump","camshaft","crankshaft","valve","culata","empaque","anillo")) return "motor";
    if (has("transmission","gear","clutch","cv joint","driveshaft","axle shaft","differential")) return "transmision";
    if (has("sensor","ignition","coil","spark","alternator","starter","relay","fuse","wiring")) return "electrico";
    if (has("radiator","water pump","thermostat","coolant","fan","hose")) return "cooling";
    return null;
  }

  function extractBestPosition_(vehiclesTable){
    if(!vehiclesTable || !Array.isArray(vehiclesTable.headers) || !Array.isArray(vehiclesTable.rows)) return null;
    const headers = vehiclesTable.headers.map(h => String(h||"").toLowerCase());
    let idx = headers.findIndex(h => h === "posicion" || h.includes("posicion") || h === "position" || h.includes("position"));
    if(idx < 0) return null;
    for(const r of vehiclesTable.rows){
      const v = r && r[idx] !== undefined ? String(r[idx] || "").trim() : "";
      if(v) return v;
    }
    return null;
  }

  function extractVehicleSummary_(vehiclesTable){
    if(!vehiclesTable || !Array.isArray(vehiclesTable.headers) || !Array.isArray(vehiclesTable.rows)) return null;
    const headers = vehiclesTable.headers.map(h => String(h||"").toLowerCase());
    const idx = (name) => headers.findIndex(h => h === name || h.includes(name));
    const iMake   = idx("vehiculo");
    const iModel  = idx("modelo");
    const iYFrom  = idx("aÃ±o inicio");
    const iYTo    = idx("aÃ±o final");
    const iEngine = idx("motor");
    const iSerie  = idx("serie");
    for(const r of vehiclesTable.rows){
      return {
        make:   iMake  >=0 ? r[iMake]  : null,
        model:  iModel >=0 ? r[iModel] : null,
        year_from: iYFrom >=0 ? r[iYFrom] : null,
        year_to:   iYTo   >=0 ? r[iYTo]   : null,
        engine: iEngine>=0 ? r[iEngine] : null,
        serie:  iSerie >=0 ? r[iSerie]  : null
      };
    }
    return null;
  }

  async function getCurrentUserId_(){
    try{
      const { data } = await supabase.auth.getSession();
      return data?.session?.user?.id || null;
    }catch(e){
      return null;
    }
  }

  async function loadProfileMarket_(){
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";
    const savedCountry = loadCountryPreference();

    if(isDemo){
      profileCountry = savedCountry || "DO";
      profileCity = null;
      paintMarketPills_();
      syncCountrySelector();
      return;
    }

    const userId = await getCurrentUserId_();
    if(!userId){
      profileCountry = savedCountry || null;
      profileCity = null;
      paintMarketPills_();
      syncCountrySelector();
      return;
    }

    try{
      const { data, error } = await supabase
        .from("profiles")
        .select("country, city")
        .eq("id", userId)
        .maybeSingle();

      if(error){
        console.warn("No pude leer profiles.country:", error.message);
        profileCountry = savedCountry || null;
        profileCity = null;
      }else{
        profileCountry = savedCountry || (data?.country || null);
        profileCity = (data?.city || null);
      }
    }catch(e){
      console.warn("No pude leer profiles:", e?.message || e);
      profileCountry = savedCountry || null;
      profileCity = null;
    }

    paintMarketPills_();
    syncCountrySelector();
  }

  function paintMarketPills_(){
    const elC = document.getElementById("pillCountry");
    const elCity = document.getElementById("pillCity");
    const wrap = document.getElementById("pillCityWrap");

    if(elC) elC.textContent = profileCountry ? String(profileCountry).toUpperCase() : "â€”";
    if(profileCity){
      if(elCity) elCity.textContent = String(profileCity);
      if(wrap) wrap.style.display = "inline";
    }else{
      if(wrap) wrap.style.display = "none";
    }
  }

  async function ensureSearchSession_(){
    if(currentSearchSessionId) return currentSearchSessionId;
    const anonId = getOrCreateAnonId_();
    const userId = await getCurrentUserId_();
    
    // âœ… Usamos el paÃ­s del selector SIEMPRE
    const selectedCountry = getSelectedCountry();
    
    const { data, error } = await supabase
      .from("search_sessions")
      .insert([{
        user_id: userId,
        anon_id: anonId,
        source: "web",
        device: detectDevice_(),
        country: selectedCountry,  // âœ… Columna country con el paÃ­s del selector
        city: profileCity
      }])
      .select("id")
      .single();

    if(error){
      console.warn("No pude crear search_session:", error.message);
      return null;
    }
    currentSearchSessionId = data?.id || null;
    return currentSearchSessionId;
  }

  async function logSearchEvent_({ queryRaw, queryType, normalizedQuery, category, resultStatus, resultsCount, responseTimeMs, meta }){
    try{
      const sessionId = await ensureSearchSession_();
      const userId = await getCurrentUserId_();
      
      // âœ… Usamos el paÃ­s del selector SIEMPRE
      const selectedCountry = getSelectedCountry();

      const payload = {
        session_id: sessionId,
        user_id: userId,
        query_raw: queryRaw,
        query_type: queryType || "mixed",
        normalized_query: normalizedQuery || null,
        category: category || null,
        result_status: resultStatus || "unknown",
        results_count: Number.isFinite(resultsCount) ? resultsCount : 0,
        response_time_ms: Number.isFinite(responseTimeMs) ? responseTimeMs : null,
        // âœ… NUEVO: country en su propia columna (NO dentro de meta)
        country: selectedCountry,
        // âœ… meta SOLO para datos extra, SIN market_country duplicado
        meta: {
          ...(meta || {}),
          // âŒ Eliminamos market_country de aquÃ­ para no duplicar
          market_city: profileCity || null
        }
      };

      const { error } = await supabase.from("search_events").insert([payload]);
      if(error) console.warn("No pude insertar search_event:", error.message);
    }catch(e){
      console.warn("Error logSearchEvent_:", e?.message || e);
    }
  }

  // ======================================================
  // âœ… Helpers multi-tabla (v1 + v2)
  // ======================================================

  function dedupeByKey_(arr, keyFn){
    const out = [];
    const seen = new Set();
    for(const item of (arr||[])){
      const k = keyFn(item);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(item);
    }
    return out;
  }

  function normCell_(v){
    return String(v ?? "").trim().toUpperCase().replace(/\s+/g, " ");
  }

  function normCodeCell_(v){
    return String(v ?? "").trim().toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
  }

  function uniqueJoin_(arr, sep=" / "){
    const out = [];
    const seen = new Set();
    for(const x of (arr||[])){
      const v = String(x ?? "").trim();
      if(!v) continue;
      const k = v.toUpperCase();
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(v);
    }
    return out.join(sep);
  }

  async function resolveOriginals_(codeNorm){
    let all = [];
    for(const t of CAMBIOS_TABLES){
      const { data, error } = await supabase
        .from(t)
        .select("original_norm")
        .or(`original_norm.eq.${codeNorm},cambio_norm.eq.${codeNorm}`)
        .limit(5000);
      if(error) throw error;
      all = all.concat(data || []);
    }
    const originals = unique_((all || []).map(x => x.original_norm).filter(Boolean));
    if(originals.length === 0) return [codeNorm];
    return originals;
  }

  async function fetchCambiosByOriginals_(originalNorms){
    let all = [];
    for(const t of CAMBIOS_TABLES){
      const { data, error } = await supabase
        .from(t)
        .select("cambio, owner, posicion")
        .in("original_norm", originalNorms)
        .limit(5000);
      if(error) throw error;
      all = all.concat(data || []);
    }
    const map = new Map();
    for(const r of (all || [])){
      const cambioRaw = (r?.cambio ?? "");
      const key = normCodeCell_(cambioRaw);
      if(!key) continue;
      if(!map.has(key)){
        map.set(key, {
          cambio: String(cambioRaw || "").trim(),
          owners: new Set(),
          posicion: String(r?.posicion || "").trim()
        });
      }
      const obj = map.get(key);
      const owner = String(r?.owner || "").trim();
      if(owner) obj.owners.add(owner);
      const pos = String(r?.posicion || "").trim();
      if(!obj.posicion && pos) obj.posicion = pos;
    }
    let merged = Array.from(map.values()).map(x => ({
      cambio: x.cambio,
      owner: uniqueJoin_(Array.from(x.owners), " / "),
      posicion: x.posicion
    }));
    merged.sort((a,b)=>{
      const pa = String(a?.posicion||"");
      const pb = String(b?.posicion||"");
      if(pa && pb && pa !== pb) return pa.localeCompare(pb);
      return String(a?.cambio||"").localeCompare(String(b?.cambio||""));
    });
    const rows = merged.map(r => ([ r.cambio || "", r.owner || "" ]));
    return { headers: ["cambio", "owner"], rows };
  }

  async function fetchVehiclesByOriginals_(originalNorms){
    const selectCols = "vehiculo, anio_inicio, anio_final, modelo, motor, serie, cilindro, posicion, version, descripcion, original_norm";
    let all = [];
    for(const t of VEH_TABLES){
      const { data, error } = await supabase
        .from(t)
        .select(selectCols)
        .in("original_norm", originalNorms)
        .limit(5000);
      if(error) throw error;
      all = all.concat(data || []);
    }
    if(all.length === 0) return { headers: [], rows: [] };
    const canonDesc = (all.find(r => String(r?.descripcion ?? "").trim() !== "")?.descripcion ?? "").toString().trim();
    all = dedupeByKey_(all, r => [
      r.vehiculo, r.anio_inicio, r.anio_final, r.modelo, r.motor,
      r.serie, r.cilindro, r.posicion, r.version, r.descripcion
    ].map(normCell_).join("|"));
    all.sort((a,b)=>{
      const va = String(a?.vehiculo||"");
      const vb = String(b?.vehiculo||"");
      if(va !== vb) return va.localeCompare(vb);
      const ma = String(a?.modelo||"");
      const mb = String(b?.modelo||"");
      if(ma !== mb) return ma.localeCompare(mb);
      const ya = Number(a?.anio_inicio || 0);
      const yb = Number(b?.anio_inicio || 0);
      return ya - yb;
    });
    if(canonDesc){
      for(const r of all){
        const cur = String(r?.descripcion ?? "").trim();
        if(!cur) r.descripcion = canonDesc;
      }
    }
    const headersKeys = [
      "vehiculo","anio_inicio","anio_final","modelo","motor","serie","cilindro","posicion","version","descripcion"
    ];
    const headerLabel = (k) => {
      if(k === "anio_inicio") return "AÃ±o inicio";
      if(k === "anio_final") return "AÃ±o final";
      if(k === "vehiculo") return "Vehiculo";
      if(k === "modelo") return "Modelo";
      if(k === "motor") return "Motor";
      if(k === "serie") return "Serie";
      if(k === "cilindro") return "Cilindro";
      if(k === "posicion") return "Posicion";
      if(k === "version") return "Version";
      if(k === "descripcion") return "Descripcion";
      return k.replace(/_/g," ").replace(/^./, c => c.toUpperCase());
    };
    const headers = headersKeys.map(headerLabel);
    const rows = all.map(obj => headersKeys.map(k => (obj?.[k] ?? "")));
    return { headers, rows };
  }

  // ======================================================
  // âœ… SIMILITUD
  // ======================================================
  async function fetchSimilitudByPrefix_(normalized, signal) {
    const norm = String(normalized || "").trim().toUpperCase();
    if (!norm) return [];
    const prefLen = Math.min(8, norm.length);
    const prefix = norm.slice(0, prefLen);
    if (prefix.length < 4) return [];
    const selectCols = "original, original_norm, descripcion, vehiculo, modelo, anio_inicio, anio_final";
    let all = [];
    for (const t of VEH_TABLES) {
      const { data, error } = await supabase
        .from(t)
        .select(selectCols)
        .ilike("original_norm", prefix + "%")
        .abortSignal(signal)
        .limit(40);
      if (error) {
        if (error.name === 'AbortError' || error.message?.includes('abort')) throw error;
        console.warn(`Error en similitud ${t}:`, error.message);
      }
      all = all.concat(data || []);
    }
    if (all.length === 0) return [];
    const seen = new Set();
    const out = [];
    for (const r of all) {
      const k = String(r?.original_norm || "").trim().toUpperCase();
      if (!k || seen.has(k)) continue;
      seen.add(k);
      const disp = String(r?.original ?? "").toString().trim() || k;
      out.push({
        code: disp,
        code_norm: k,
        desc: (r?.descripcion ?? "").toString().trim(),
        vehiculo: (r?.vehiculo ?? "").toString().trim(),
        modelo: (r?.modelo ?? "").toString().trim(),
        from: r?.anio_inicio ?? "",
        to: r?.anio_final ?? ""
      });
      if (out.length >= 10) break;
    }
    return out;
  }

  function renderSimilitud_(items, searchedNorm){
    const wrap = document.getElementById("simWrap");
    const pill = document.getElementById("pillSimCount");
    const hint = document.getElementById("simHint");
    if(pill) pill.textContent = String((items||[]).length);
    if(!wrap) return;
    if(!items || items.length === 0){
      wrap.innerHTML = '<div class="muted">No hay sugerencias.</div>';
      if(hint) hint.textContent = "No encontramos coincidencia exacta. Si existen codigos parecidos, apareceran aqui.";
      return;
    }
    if(hint) hint.textContent = `No encontramos "${String(searchedNorm||"").toUpperCase()}". Te sugerimos estos codigos similares:`;
    const rows = items.map(it=>{
      const title = escapeHtml_(it.code);
      const sub = [it.vehiculo, it.modelo, (it.from||it.to) ? `${it.from||""}-${it.to||""}` : ""].filter(Boolean).join(" Â· ");
      const desc = it.desc ? `<div class="muted" style="margin-top:4px">${escapeHtml_(it.desc)}</div>` : "";
      const subHtml = sub ? `<div class="muted" style="margin-top:4px">${escapeHtml_(sub)}</div>` : "";
      return `
        <div class="row" style="justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid rgba(20,28,45,.08)">
          <div style="min-width:0">
            <div style="font-weight:900">${title}</div>
            ${subHtml}
            ${desc}
          </div>
          <div style="flex:0 0 auto">
            <button class="btn2" onclick="useSimilarCode_('${escapeJs_(it.code)}')">Usar</button>
          </div>
        </div>
      `;
    }).join("");
    wrap.innerHTML = `<div>${rows}</div>`;
  }

  window.useSimilarCode_ = async function(code){
    try{
      const ci = document.getElementById("code");
      if(ci){
        ci.value = String(code||"").toUpperCase();
        ci.focus();
      }
      if(typeof window.buscar === 'function') { await window.buscar(); } else { try{ document.getElementById('btnBuscar')?.click(); }catch(e){} }
      try{ toggleAcc('cardSimilitud', false); }catch(e){}
      try{ toggleAcc('cardProducto', true); }catch(e){}
    }catch(e){}
  }

  function escapeJs_(s){
    return String(s ?? "").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
  }

  // ======================================================
  // âœ… Buscador Vehicular
  // ======================================================
  function strNorm_(v){ return String(v ?? "").trim().toLowerCase(); }

  function readFiltro_(){
    const vehiculo = strNorm_(document.getElementById("fVehiculo")?.value);
    const modelo   = strNorm_(document.getElementById("fModelo")?.value);
    const motor    = strNorm_(document.getElementById("fMotor")?.value);
    const desc     = strNorm_(document.getElementById("fDescripcion")?.value);
    const anioRaw  = strNorm_(document.getElementById("fAnio")?.value);
    const anioNum  = anioRaw ? Number(anioRaw.replace(/[^0-9]/g,"")) : null;
    const anio = (anioNum && Number.isFinite(anioNum)) ? anioNum : null;
    const hasAny = !!(vehiculo || modelo || motor || desc || anio);
    return { vehiculo, modelo, motor, desc, anio, hasAny };
  }

  function setFiltroPill_(txt, hint){
    const pill = document.getElementById("pillFiltroEstado");
    const hintEl = document.getElementById("filtroHint");
    if(pill) pill.textContent = txt || "Sin filtro";
    if(hintEl){
      if(hint){
        hintEl.style.display = "inline";
        hintEl.textContent = hint;
      }else{
        hintEl.style.display = "none";
        hintEl.textContent = "";
      }
    }
  }

  async function fetchVehiclesByFilters_(f){
    const selectCols = "vehiculo, anio_inicio, anio_final, modelo, motor, serie, cilindro, posicion, version, descripcion";
    let all = [];
    for(const t of VEH_TABLES){
      let q = supabase.from(t).select(selectCols).limit(5000);
      if(f.vehiculo) q = q.ilike("vehiculo", "%" + f.vehiculo + "%");
      if(f.modelo)   q = q.ilike("modelo",   "%" + f.modelo   + "%");
      if(f.motor)    q = q.ilike("motor",    "%" + f.motor    + "%");
      if(f.desc)     q = q.ilike("descripcion", "%" + f.desc  + "%");
      if(f.anio)     q = q.lte("anio_inicio", f.anio).gte("anio_final", f.anio);
      const { data, error } = await q;
      if(error) throw error;
      all = all.concat(data || []);
    }
    if(all.length === 0) return { headers: [], rows: [] };
    all = dedupeByKey_(all, r => [
      r.vehiculo, r.anio_inicio, r.anio_final, r.modelo, r.motor,
      r.serie, r.cilindro, r.posicion, r.version, r.descripcion
    ].map(normCell_).join("|"));
    all.sort((a,b)=>{
      const va = String(a?.vehiculo||"");
      const vb = String(b?.vehiculo||"");
      if(va !== vb) return va.localeCompare(vb);
      const ma = String(a?.modelo||"");
      const mb = String(b?.modelo||"");
      if(ma !== mb) return ma.localeCompare(mb);
      return (Number(a?.anio_inicio||0) - Number(b?.anio_inicio||0));
    });
    const headersKeys = ["vehiculo","anio_inicio","anio_final","modelo","motor","serie","cilindro","posicion","version","descripcion"];
    const headerLabel = (k)=>{
      if(k === "vehiculo") return "Vehiculo";
      if(k === "anio_inicio") return "AÃ±o inicio";
      if(k === "anio_final")  return "AÃ±o final";
      if(k === "modelo") return "Modelo";
      if(k === "motor") return "Motor";
      if(k === "serie") return "Serie";
      if(k === "cilindro") return "Cilindro";
      if(k === "posicion") return "Posicion";
      if(k === "version") return "Version";
      if(k === "descripcion") return "Descripcion";
      return k.replace(/_/g," ").replace(/^./, c => c.toUpperCase());
    };
    const headers = headersKeys.map(headerLabel);
    const rows = all.map(obj => headersKeys.map(k => (obj?.[k] ?? "")));
    return { headers, rows };
  }

  window.aplicarFiltroVehicular = async function(){
    const filtro = readFiltro_();
    if(!filtro.hasAny){
      setFiltroPill_("Sin filtro");
      alert("Escribe al menos un campo para buscar.");
      return;
    }
    if(lastPayload && lastPayload.tablas && lastPayload.tablas.vehicles_full){
      const base = lastPayload.tablas.vehicles_full;
      const idxVeh = base.headers.findIndex(h => String(h).toLowerCase().includes("vehiculo"));
      const idxY1  = base.headers.findIndex(h => String(h).toLowerCase().includes("aÃ±o inicio") || String(h).toLowerCase().includes("anio inicio"));
      const idxY2  = base.headers.findIndex(h => String(h).toLowerCase().includes("aÃ±o final")  || String(h).toLowerCase().includes("anio final"));
      const idxMod = base.headers.findIndex(h => String(h).toLowerCase().includes("modelo"));
      const idxMot = base.headers.findIndex(h => String(h).toLowerCase().includes("motor"));
      const idxDes = base.headers.findIndex(h => String(h).toLowerCase().includes("descripcion") || String(h).toLowerCase().includes("descripciÃ³n") || String(h).toLowerCase().includes("description"));
      const rows = (base.rows||[]).filter(r=>{
        const vVeh = idxVeh>=0 ? strNorm_(r[idxVeh]) : "";
        const vMod = idxMod>=0 ? strNorm_(r[idxMod]) : "";
        const vMot = idxMot>=0 ? strNorm_(r[idxMot]) : "";
        const vDes = idxDes>=0 ? strNorm_(r[idxDes]) : "";
        if(filtro.vehiculo && !vVeh.includes(filtro.vehiculo)) return false;
        if(filtro.modelo && !vMod.includes(filtro.modelo)) return false;
        if(filtro.motor && !vMot.includes(filtro.motor)) return false;
        if(filtro.desc && !vDes.includes(filtro.desc)) return false;
        if(filtro.anio && (idxY1>=0 || idxY2>=0)){
          const y1 = idxY1>=0 ? Number(String(r[idxY1]??"").replace(/[^0-9]/g,"")) : NaN;
          const y2 = idxY2>=0 ? Number(String(r[idxY2]??"").replace(/[^0-9]/g,"")) : NaN;
          if(Number.isFinite(y1) && Number.isFinite(y2)){
            if(!(filtro.anio >= y1 && filtro.anio <= y2)) return false;
          }
        }
        return true;
      });
      let filtered = { headers: base.headers, rows };
      filtered = decorateDescWithOriginal_(filtered);
      lastPayload.tablas.vehicles = filtered;
      renderTableInto_("vehWrap", filtered);
      renderVehicleLogos_(filtered);
      document.getElementById("btnCopyVeh").disabled = !(rows.length>0);
      document.getElementById("counts").textContent = "Vehicles: " + rows.length + " | Cambios: " + ((lastPayload.tablas?.cambios?.rows||[]).length || 0);
      document.getElementById("btnExport").disabled = rows.length===0 && ((lastPayload.tablas?.cambios?.rows||[]).length||0)===0;
      const used = [];
      if(filtro.vehiculo) used.push("Vehiculo");
      if(filtro.anio) used.push("AÃ±o");
      if(filtro.modelo) used.push("Modelo");
      if(filtro.motor) used.push("Motor");
      if(filtro.desc) used.push("Descripcion");
      setFiltroPill_("Filtro activo", "Campos: " + used.join(", "));
      return;
    }
    setStatus("Buscando vehiculos...");
    try{
      const veh = await fetchVehiclesByFilters_(filtro);
      lastPayload = {
        codigo: "FILTRO_VEHICULAR",
        productUrl: buildGoogleUrl_("vehiculo " + (filtro.vehiculo||"")),
        tablas: { vehicles: veh, cambios: { headers: [], rows: [] }, vehicles_full: veh }
      };
      renderTableInto_("vehWrap", veh);
      renderVehicleLogos_(veh);
      renderTableInto_("oeWrap", { headers: [], rows: [] });
      const vehCount = (veh?.rows||[]).length;
      document.getElementById("pillCode").textContent = "Filtro Vehicular";
      document.getElementById("counts").textContent = "Vehicles: " + vehCount + " | Cambios: 0";
      document.getElementById("btnCopyVeh").disabled = vehCount===0;
      document.getElementById("btnCopyOE").disabled = true;
      document.getElementById("btnExport").disabled = vehCount===0;
      const used = [];
      if(filtro.vehiculo) used.push("Vehiculo");
      if(filtro.anio) used.push("AÃ±o");
      if(filtro.modelo) used.push("Modelo");
      if(filtro.motor) used.push("Motor");
      if(filtro.desc) used.push("Descripcion");
      setFiltroPill_(vehCount? "Filtro activo" : "Sin resultados", "Campos: " + used.join(", "));
      setStatus("Listo âœ…");
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e?.message || e));
      alert("Error buscando en BD: " + (e?.message || e));
    }
  };

  window.limpiarFiltroVehicular = function(){
    ["fVehiculo","fAnio","fModelo","fMotor","fDescripcion"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
    setFiltroPill_("Sin filtro");
    if(lastPayload && lastPayload.tablas && lastPayload.tablas.vehicles_full){
      lastPayload.tablas.vehicles = lastPayload.tablas.vehicles_full;
      renderTableInto_("vehWrap", lastPayload.tablas.vehicles_full);
      renderVehicleLogos_(lastPayload.tablas.vehicles_full);
      const vehCount = (lastPayload.tablas.vehicles_full?.rows||[]).length;
      const cambCount = (lastPayload.tablas?.cambios?.rows||[]).length;
      document.getElementById("btnCopyVeh").disabled = vehCount===0;
      document.getElementById("counts").textContent = "Vehicles: " + vehCount + " | Cambios: " + cambCount;
      document.getElementById("btnExport").disabled = (vehCount===0 && cambCount===0);
    }
  };

  window.buscarCodigoPrincipal = async function(code){
    const c = String(code || "").trim();
    if(!c) return;
    const input = document.getElementById("code");
    if(input) input.value = c;
    try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
    try{
      await window.buscar();
    }catch(e){
      const btn = document.querySelector('button[onclick*="buscar"]');
      if(btn) btn.click();
    }
  };

  window.limpiar = function(){
    lastPayload = null;
    document.getElementById("btnExport").disabled = true;
    document.getElementById("btnCopyOE").disabled = true;
    document.getElementById("btnCopyVeh").disabled = true;
    document.getElementById("pillCode").textContent = "-";
    document.getElementById("productUrl").textContent = "-";
    document.getElementById("productUrl").href = "#";
    document.getElementById("counts").textContent = "Vehicles: 0 | Cambios: 0";
    document.getElementById("notes").textContent = "";
    document.getElementById("oeWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("vehWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("vehLogos").innerHTML = "";
    document.getElementById("vehLogos").style.display = "none";
    const simWrap = document.getElementById("simWrap");
    if(simWrap) simWrap.innerHTML = "";
    const pillSim = document.getElementById("pillSimCount");
    if(pillSim) pillSim.textContent = "0";
    const simHint = document.getElementById("simHint");
    if(simHint) simHint.textContent = "Si no encontramos coincidencia exacta, te mostraremos codigos similares aqui.";
    setStatus("Listo");
    if(isMobile_()) setMobileDefault_();
  };

  window.buscar = async function(){
    const t0 = performance.now();
    const raw = (document.getElementById("code").value || "").trim();
    if(!raw){ setStatus("Escribe un codigo."); return; }
    const norm = normalizeCode_(raw);
    const candidates = unique_([ raw, raw.toUpperCase(), norm ]).filter(Boolean);
    setStatus("Buscando...");
    try{
      const codigoMostrado = candidates[0] || raw;
      const originalNorms = await resolveOriginals_(norm);
      const [veh, camb] = await Promise.all([
        fetchVehiclesByOriginals_(originalNorms),
        fetchCambiosByOriginals_(originalNorms),
      ]);
      const payload = {
        codigo: codigoMostrado,
        codigo_norm: norm,
        original_norms: originalNorms,
        productUrl: buildGoogleUrl_(codigoMostrado),
        tablas: { vehicles: veh, cambios: camb }
      };
      render(payload);
      const vehCount = (veh && Array.isArray(veh.rows)) ? veh.rows.length : 0;
      const cambCount = (camb && Array.isArray(camb.rows)) ? camb.rows.length : 0;
      const totalResults = vehCount + cambCount;
      const resultStatus = totalResults > 0 ? "found" : "not_found";
      const pos = extractBestPosition_(veh);
      const catFromPos = classifyCategoryFromPosition_(pos);
      const category = catFromPos || classifyCategory_(raw);
      const vehSummary = extractVehicleSummary_(veh);
      const t1 = performance.now();
      const responseMs = Math.round(t1 - t0);
      await logSearchEvent_({
        queryRaw: raw,
        queryType: "oem",
        normalizedQuery: norm,
        category,
        resultStatus,
        resultsCount: totalResults,
        responseTimeMs: responseMs,
        meta: {
          original_norms_count: Array.isArray(originalNorms) ? originalNorms.length : 0,
          vehicles_count: vehCount,
          cambios_count: cambCount,
          position_sample: pos || null,
          category_source: catFromPos ? "posicion" : "query",
          vehicle_make: vehSummary?.make || null,
          vehicle_model: vehSummary?.model || null,
          vehicle_year_from: vehSummary?.year_from || null,
          vehicle_year_to: vehSummary?.year_to || null,
          vehicle_engine: vehSummary?.engine || null,
          vehicle_serie: vehSummary?.serie || null,
          used_vehicle_tables: VEH_TABLES,
          used_cambios_tables: CAMBIOS_TABLES
        }
      });
      if (resultStatus === "not_found") {
        setTimeout(async () => {
          try {
            const sim = await fetchSimilitudByPrefix_(norm, new AbortController().signal);
            renderSimilitud_(sim, norm);
            try { toggleAcc('cardSimilitud', true); } catch(e) {}
          } catch (e) {
            renderSimilitud_([], norm);
          }
        }, 0);
      }
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e && e.message ? e.message : e));
      alert("Error consultando: " + (e && e.message ? e.message : e));
      const t1 = performance.now();
      await logSearchEvent_({
        queryRaw: raw,
        queryType: "oem",
        normalizedQuery: norm,
        category: classifyCategory_(raw),
        resultStatus: "unknown",
        resultsCount: 0,
        responseTimeMs: Math.round(t1 - t0),
        meta: { error: (e && e.message) ? e.message : String(e) }
      });
    }
  };

  function render(payload){
    lastPayload = payload;
    const codigo = payload.codigo || "-";
    const productUrl = payload.productUrl || buildGoogleUrl_(codigo);
    document.getElementById("pillCode").textContent = codigo;
    document.getElementById("productUrl").textContent = productUrl;
    document.getElementById("productUrl").href = productUrl;
    const vehicles = payload.tablas?.vehicles || null;
    if(payload.tablas) payload.tablas.vehicles_full = vehicles;
    setFiltroPill_("Sin filtro");
    const cambios  = payload.tablas?.cambios  || null;
    renderTableInto_("vehWrap", vehicles);
    renderVehicleLogos_(vehicles);
    renderTableInto_("oeWrap", cambios);
    const hasVeh = vehicles && Array.isArray(vehicles.rows) && vehicles.rows.length > 0;
    const hasCamb = cambios && Array.isArray(cambios.rows) && cambios.rows.length > 0;
    document.getElementById("btnCopyVeh").disabled = !hasVeh;
    document.getElementById("btnCopyOE").disabled = !hasCamb;
    document.getElementById("counts").textContent =
      "Vehicles: " + (hasVeh ? vehicles.rows.length : 0) +
      " | Cambios: " + (hasCamb ? cambios.rows.length : 0);
    document.getElementById("notes").textContent = "";
    document.getElementById("btnExport").disabled = !(hasVeh || hasCamb);
    setStatus("Listo âœ…");
    if(isMobile_()) setMobileDefault_();
  }

  window.copiarVehicles = async function(){
    const vehicles = lastPayload?.tablas?.vehicles || null;
    const tsv = tableToTSV_(vehicles);
    if(!tsv){ alert("No hay Vehicles para copiar."); return; }
    try{
      await navigator.clipboard.writeText(tsv);
      alert("Vehicles copiado âœ… (pega en Excel)");
    }catch(e){
      alert("No pude copiar. (Tu navegador bloqueo el clipboard)");
    }
  };

  window.copiarOE = async function(){
    const cambios = lastPayload?.tablas?.cambios || null;
    const tsv = tableToTSV_(cambios);
    if(!tsv){ alert("No hay Cambios para copiar."); return; }
    try{
      await navigator.clipboard.writeText(tsv);
      alert("Cambios copiado âœ… (pega en Excel)");
    }catch(e){
      alert("No pude copiar. (Tu navegador bloqueo el clipboard)");
    }
  };

  window.exportar = function(){
    if(!lastPayload){ alert("No hay datos para exportar."); return; }
    const codigo = (lastPayload.codigo || "export").toString();
    const vehicles = lastPayload?.tablas?.vehicles || null;
    const cambios  = lastPayload?.tablas?.cambios  || null;
    const parts = [];
    parts.push("CODIGO\t" + codigo);
    parts.push("");
    parts.push("=== VEHICLES ===");
    parts.push(tableToTSV_(vehicles) || "No hay filas");
    parts.push("");
    parts.push("=== CAMBIOS ===");
    parts.push(tableToTSV_(cambios) || "No hay filas");
    const content = parts.join("\n");
    const blob = new Blob([content], { type:"text/tab-separated-values;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "RepuestoFinder_" + codigo.replace(/[^a-zA-Z0-9_-]/g,"_") + ".tsv";
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  function decorateDescWithOriginal_(tableObj){
    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows)) return tableObj;
    const hs = tableObj.headers.map(h => String(h||"").trim().toLowerCase());
    const iDesc = hs.findIndex(h => h === "descripcion" || h === "descripciÃ³n" || h.includes("descripcion") || h.includes("description"));
    let iOri = hs.findIndex(h => h === "original");
    if(iOri < 0){
      iOri = hs.findIndex(h => h.includes("codigo original") || h.includes("cÃ³digo original") || h.includes("oem") || h.includes("itemcode") || (h.includes("codigo") && !h.includes("descripcion")));
    }
    if(iDesc < 0 || iOri < 0) return tableObj;
    const out = { headers: [...tableObj.headers], rows: tableObj.rows.map(r => [...r]) };
    for(let k=0;k<out.rows.length;k++){
      const r = out.rows[k];
      const desc = String(r[iDesc] ?? "").trim();
      const ori  = String(r[iOri]  ?? "").trim();
      if(!ori) continue;
      const already = desc.toLowerCase().includes(ori.toLowerCase()) || desc.toLowerCase().includes("oem:");
      if(!already){
        r[iDesc] = (desc ? desc + "  â€”  " : "") + "OEM: " + ori;
      }
    }
    out.headers.splice(iOri, 1);
    out.rows = out.rows.map(r => { r.splice(iOri, 1); return r; });
    return out;
  }

  // âœ… init
  await initAuth_();

  // âœ… Forzar MAYUSCULA en el input de codigo
  try{
    const codeInput = document.getElementById("code");
    if(codeInput){
      const up = ()=>{
        const s = String(codeInput.value || "");
        const u = s.toUpperCase();
        if(s !== u){
          const p = codeInput.selectionStart;
          const q = codeInput.selectionEnd;
          codeInput.value = u;
          if(typeof p === "number" && typeof q === "number"){
            codeInput.setSelectionRange(p, q);
          }
        }
      };
      codeInput.addEventListener("input", up);
      codeInput.addEventListener("paste", ()=> setTimeout(up, 0));
    }
  }catch(e){}

  // ===== PRESENCIA ONLINE =====
  const { data: ses } = await supabase.auth.getSession();
  const user = ses?.session?.user;
  if (user) {
    const PRESENCE_CHANNEL = "rf-online-users";
    const presenceChannel = supabase.channel(PRESENCE_CHANNEL, {
      config: { presence: { key: user.id } }
    });
    await presenceChannel.subscribe(async (status) => {
      if (status === "SUBSCRIBED") {
        await presenceChannel.track({
          at: new Date().toISOString(),
          page: "app"
        });
      }
    });
  }

  await loadProfileMarket_();

  // âœ… Event listener para el selector de paÃ­s
  document.addEventListener("DOMContentLoaded", function() {
    const countrySelector = document.getElementById("countrySelector");
    if (countrySelector) {
      countrySelector.addEventListener("change", function(e) {
        const newCountry = e.target.value;
        profileCountry = newCountry;
        saveCountryPreference(newCountry);
        const pillCountry = document.getElementById("pillCountry");
        if (pillCountry) pillCountry.textContent = newCountry;
        console.log("PaÃ­s cambiado a:", newCountry);
      });
    }
  });

  supabase.auth.onAuthStateChange((event, session) => {
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";
    if (!session && !isDemo) window.location.href = "/?stay=1";
  });

  // Trigger inicial del DOMContentLoaded para configurar el selector
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {});
  } else {
    setTimeout(() => {
      const event = new Event('DOMContentLoaded');
      document.dispatchEvent(event);
    }, 0);
  }
</script>
</body>
</html>
