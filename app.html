<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - App</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --rf-bg:#f6f7fb;
      --rf-card:#ffffff;
      --rf-surface:#fafbff;
    }
    body.theme-sky{
      --rf-bg:#eaf3ff;
      --rf-card:#ffffff;
      --rf-surface:#f3f8ff;
    }
    body.theme-mint{
      --rf-bg:#e9fff6;
      --rf-card:#ffffff;
      --rf-surface:#f2fffb;
    }

    body{font-family:Arial,Helvetica,sans-serif;background:var(--rf-bg);margin:0;padding:22px;color:#111}
    .topbar{display:flex;justify-content:space-between;align-items:baseline;gap:12px;margin:0 0 14px 0;}
    h1{margin:0;font-size:26px}
    .watermark{font-size:12px;color:#9ca3af;font-weight:800;letter-spacing:.4px;user-select:none;white-space:nowrap;opacity:.65;text-transform:uppercase;}
    .nav{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    a.navlink{color:#2563eb;text-decoration:none;font-weight:900}
    a.navlink:hover{text-decoration:underline}
    .card{background:var(--rf-card);border:1px solid #e6e8f0;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #d7dbe7;font-size:15px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800}
    .btn{background:#2563eb;color:#fff}
    .btn2{background:#e5e7eb}
    .btn3{background:#111;color:#fff}
    .muted{color:#6b7280;font-size:13px}
    .ok{display:inline-flex;align-items:center;gap:8px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%;background:#10b981;display:inline-block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eef0f6;padding:10px;text-align:left;font-size:13px;vertical-align:top;white-space:nowrap}
    th{background:var(--rf-surface);position:sticky;top:0;z-index:1}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .searchBox{max-width:420px}
    @media(max-width:900px){.searchBox{max-width:100%}}

    .copyBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;border:1px solid #e6e8f0;
      background:#fff;color:#111;font-weight:900;font-size:13px;cursor:pointer;
    }
    .copyBtn:hover{background:#f6f7fb}
    .copyBtn:disabled{opacity:.5;cursor:not-allowed}
    .copyIcon{width:16px;height:16px;display:inline-block}

    .accHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:default;}
    .accTitle{display:flex;align-items:center;gap:10px;font-weight:900;}
    .accBody{margin-top:10px;}
    .chev{width:18px;height:18px;transition:transform .18s ease;opacity:.8;flex:0 0 auto;}
    .accRight{display:flex;align-items:center;gap:10px;}
    .tableWrap{overflow:auto;border-radius:12px;border:1px solid #eef0f6}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid #e6e8f0;
      background:#fff;font-weight:900;font-size:12px;color:#111
    }

    @media(max-width:1024px){
      .topbar{flex-direction:column;align-items:flex-start}
      .card.menuCard{padding:14px 16px}
      .accHeader{cursor:pointer;user-select:none}
      .accHeader{justify-content:center;position:relative;min-height:44px}
      .accTitle{justify-content:center;font-size:15px;font-weight:900;width:100%;text-align:center}
      .accRight{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:0;pointer-events:none}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .accRight{opacity:1;pointer-events:auto}
      .card.open .chev{transform:rotate(180deg)}
      th,td{padding:8px;font-size:12px}
      .copyBtn{padding:7px 9px;font-size:12px}
    }

    @media (pointer:coarse), (hover:none){
      .accHeader{cursor:pointer; user-select:none;}
      .accBody{display:none;}
      .card.open .accBody{display:block;}
      .card.open .chev{transform:rotate(180deg);}
    }
  
    /* ===== FILTRO VEHICULAR (barra entre buscador OEM y Producto) ===== */
    .filterBar{
      display:grid;
      grid-template-columns:
        minmax(180px, 1.1fr)  /* Vehiculo */
        minmax(110px, 0.6fr)  /* AÃ±o */
        minmax(160px, 0.9fr)  /* Modelo */
        minmax(160px, 0.9fr)  /* Motor */
        minmax(240px, 1.5fr)  /* Descripcion */
        auto;                 /* Botones */
      gap:14px;
      align-items:end;
      margin-top:14px;
      width:100%;
    }

    .filterItem{display:flex;flex-direction:column;min-width:0}
    .filterLabel{font-size:12px;color:#6b7280;margin:0 0 6px 2px;font-weight:800}

    /* inputs del filtro (mÃ¡s compactos que el input principal) */
    .filterBar input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d7dbe7;
      font-size:14px;
      height:40px;
      box-sizing:border-box;
    }

    .filterActions{display:flex;gap:10px;align-items:end}
    .filterActions button{height:40px;padding:0 16px;white-space:nowrap}

    /* Responsive */
    @media (max-width:1100px){
      .filterBar{grid-template-columns:repeat(2, minmax(0,1fr));}
      .filterActions{justify-content:flex-end}
    }
    @media (max-width:600px){
      .filterBar{grid-template-columns:1fr;}
      .filterActions{width:100%}
      .filterActions button{flex:1}
    }


  
    /* ===== OFERTAS (Obsolescencia) dentro de APP ===== */
    .offerBox{margin-top:12px;border:1px solid #eef0f6;border-radius:12px;padding:12px;background:var(--rf-surface)}
    .offerRow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .offerTitle{font-weight:900}
    .offerMeta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .offerTag{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;border:1px solid #e6e8f0;background:#fff;font-weight:900;font-size:12px}
    .offerBtn{padding:8px 10px;border-radius:10px;border:1px solid #e6e8f0;background:#fff;font-weight:900;cursor:pointer}
    .offerBtn:hover{background:#f6f7fb}
    .offerBtnPrimary{background:#2563eb;color:#fff;border:0}
    .offerBtnPrimary:hover{filter:brightness(.95)}
    .offerEmpty{color:#6b7280;font-size:13px}

    
    /* ===== Logos de Vehiculos (por marca) ===== */
    .vehLogos{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .vehLogoItem{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #eef0f6;
      border-radius:12px;
      background:#fff;
      box-shadow:0 1px 8px rgba(0,0,0,.03);
      max-width: 220px;
    }
    .vehLogoImg{
      width:34px;
      height:22px;
      object-fit:contain;
      display:block;
      filter: grayscale(0%);
      opacity:.95;
    }
    .vehLogoText{
      font-size:12px;
      font-weight:900;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:150px;
    }

  /* Codigo principal (link) */
    .codeLink{color:#2563eb;text-decoration:underline;font-weight:900;cursor:pointer;}
    .codeLink:hover{filter:brightness(.9)}

    /* Modal */
    .rfModalBack{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .rfModal{width:min(720px,100%);background:#fff;border-radius:16px;border:1px solid #e6e8f0;box-shadow:0 12px 40px rgba(0,0,0,.25);overflow:hidden}
    .rfModalHead{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:14px 16px;border-bottom:1px solid #eef0f6;background:#fafbff}
    .rfModalHead h3{margin:0;font-size:16px}
    .rfModalClose{border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer;font-weight:900;color:#111}
    .rfModalBody{padding:16px}
    .rfModalGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.rfModalGrid{grid-template-columns:1fr}}
    .rfModalActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px}
    textarea.rfMsg{width:100%;min-height:96px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid #d7dbe7;font-size:14px;box-sizing:border-box}
    .rfSmall{font-size:12px;color:#6b7280}

  
    /* ===== Microfono (busqueda por voz) ===== */
    .micBtn{
      display:inline-flex;align-items:center;justify-content:center;
      width:42px;height:38px;border-radius:12px;border:1px solid #e6e8f0;
      background:#fff;color:#111;cursor:pointer;position:relative;
      box-shadow:0 1px 8px rgba(0,0,0,.04);
    }
    .micBtn:hover{background:#f6f7fb}
    .micBtn:active{transform:translateY(1px)}
    .micBtn.listening{border-color:#2563eb}
    .micIcon{width:18px;height:18px}
    .micDot{
      position:absolute;right:8px;top:9px;width:8px;height:8px;border-radius:50%;
      background:#ef4444;display:none;
      box-shadow:0 0 0 3px rgba(239,68,68,.15);
    }
    .micBtn.listening .micDot{display:block; animation: rfPulse 1.1s infinite;}
    @keyframes rfPulse{
      0%{transform:scale(1);opacity:1}
      70%{transform:scale(1.25);opacity:.55}
      100%{transform:scale(1);opacity:1}
    }

/* ===== Theme (cambios de fondo) ===== */
.themeBar{display:inline-flex;align-items:center;gap:8px;margin-left:6px}
.themeBtn{
  width:26px;height:26px;border-radius:999px;border:1px solid #e6e8f0;
  cursor:pointer;box-shadow:0 1px 8px rgba(0,0,0,.04);
  background:#fff;
}
.themeBtn:hover{filter:brightness(.97)}
.themeBtn:active{transform:translateY(1px)}
.themeBtn.active{outline:3px solid rgba(37,99,235,.22);border-color:#2563eb}
.themeBtn[data-theme="default"]{background:#f6f7fb}
.themeBtn[data-theme="sky"]{background:#eaf3ff}
.themeBtn[data-theme="mint"]{background:#e9fff6}

    .rfToast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,17,17,.92);color:#fff;padding:10px 12px;border-radius:12px;
      font-size:13px;font-weight:800;z-index:10000;max-width:min(520px, 92vw);
      box-shadow:0 12px 40px rgba(0,0,0,.25);
    }

  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>RepuestoFinder</h1>
      <div class="watermark">App</div>
    </div>

    <div class="nav">
      
      <button class="micBtn" id="micBtn" title="Buscar con microfono" aria-label="Buscar con microfono">
        <svg class="micIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"></path>
          <path d="M19 11a7 7 0 0 1-14 0"></path>
          <path d="M12 19v3"></path>
          <path d="M8 22h8"></path>
        </svg>
        <span class="micDot" id="micDot" aria-hidden="true"></span>
      </button>


<div class="themeBar" aria-label="Cambiar fondo">
  <button class="themeBtn" data-theme="default" title="Fondo por defecto" aria-label="Fondo por defecto"></button>
  <button class="themeBtn" data-theme="sky" title="Fondo azul" aria-label="Fondo azul"></button>
  <button class="themeBtn" data-theme="mint" title="Fondo verde" aria-label="Fondo verde"></button>
  </div>

      <a class="navlink" href="/?stay=1">Volver al sitio</a>
      <a class="navlink" href="#" id="loginLink" style="display:none">Iniciar sesion</a>
      <a class="navlink" href="#" onclick="cerrarSesion();return false;" id="logoutLink" style="display:none">Cerrar sesion</a>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:flex-end">
      <div class="grow">
        <div class="muted">Buscar por codigo OEM o equivalente:</div>
        <div style="margin-top:10px" class="searchBox">
          <input id="code" placeholder="Ej: 55300-3X100" value="111242"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap">
        <button class="btn" id="btnBuscarCodigo" onclick="window.buscar && window.buscar()">Buscar</button>
        <button class="btn2" onclick="limpiar()">Limpiar</button>
        <button class="btn3" onclick="exportar()" id="btnExport" disabled>Exportar a Excel</button>
      </div>
    </div>

    <div style="margin-top:10px" class="ok">
      <span class="dot"></span><span id="status">Listo</span>
    </div>

    <div style="margin-top:8px" class="muted">
      Mercado (pais): <span class="pill" id="pillCountry">â€”</span>
      <span id="pillCityWrap" style="display:none"> Â· ciudad: <span class="pill" id="pillCity">â€”</span></span>
    </div>
  </div>


  <!-- ===== Filtro vehicular (client-side) ===== -->
  <div class="card" id="cardFiltroVehicular">
    <div class="muted" style="font-weight:900">Buscador por Vehiculo / AÃ±o / Modelo / Motor / Descripcion</div>

    <div class="filterBar">
      <div class="filterItem medium">
        <div class="filterLabel">Vehiculo</div>
        <input id="fVehiculo" placeholder="Ej: Honda, Hyundai, Mercedes..." autocomplete="off"/>
      </div>

      <div class="filterItem small">
        <div class="filterLabel">AÃ±o</div>
        <input id="fAnio" placeholder="Ej: 1989" inputmode="numeric" autocomplete="off"/>
      </div>

      <div class="filterItem medium">
        <div class="filterLabel">Modelo</div>
        <input id="fModelo" placeholder="Ej: Civic, H100..." autocomplete="off"/>
      </div>

      <div class="filterItem medium">
        <div class="filterLabel">Motor</div>
        <input id="fMotor" placeholder="Ej: 1.6, D4BB, M276..." autocomplete="off"/>
      </div>

      <div class="filterItem">
        <div class="filterLabel">Descripcion</div>
        <input id="fDescripcion" placeholder="Ej: alternador, filtro, bomba..." autocomplete="off"/>
      </div>

      <div class="filterActions">
        <button class="btn" id="btnBuscarFiltro" onclick="aplicarFiltroVehicular()">Buscar</button>
        <button class="btn2" onclick="limpiarFiltroVehicular()">Limpiar</button>
      </div>
    </div>

    <div class="muted" style="margin-top:10px">
      <span class="pill" id="pillFiltroEstado">Sin filtro</span>
      <span class="muted" id="filtroHint" style="margin-left:8px;display:none"></span>
    </div>
  </div>


  <div class="grid2">
    <div class="card menuCard open" id="cardProducto">
      <div class="accHeader" onclick="toggleAcc('cardProducto')">
        <div class="accTitle">Producto</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <span class="pill" id="pillCode">-</span>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div class="muted">URL: <a id="productUrl" href="#" target="_blank">-</a></div>
        <div style="margin-top:8px" class="muted" id="counts">Vehicles: 0 | Cambios: 0</div>
        <div id="vehLogos" class="vehLogos" style="display:none"></div>
        <div id="offersWrap" class="offerBox" style="display:none"></div>
        <div style="margin-top:8px" class="muted" id="notes"></div>
      </div>
    </div>

    

    <div class="card menuCard" id="cardSimilitud">
      <div class="accHeader" onclick="toggleAcc('cardSimilitud')">
        <div class="accTitle">Similitud</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <span class="pill" id="pillSimCount">0</span>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div class="muted" id="simHint">Si no encontramos coincidencia exacta, te mostraremos codigos similares aqui.</div>
        <div id="simWrap" style="margin-top:10px"></div>
      </div>
    </div>


<div class="card menuCard" id="cardOE">
      <div class="accHeader" onclick="toggleAcc('cardOE')">
        <div class="accTitle">Cambios</div>
        <div class="accRight" onclick="event.stopPropagation()">
          <button class="copyBtn" id="btnCopyOE" onclick="copiarOE()" disabled title="Copiar tabla para Excel">
            <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copiar
          </button>
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </div>
      </div>

      <div class="accBody">
        <div id="oeWrap" class="muted">No hay filas detectadas.</div>
      </div>
    </div>
  </div>

  <div class="card menuCard" id="cardVeh">
    <div class="accHeader" onclick="toggleAcc('cardVeh')">
      <div class="accTitle">Vehicles</div>
      <div class="accRight" onclick="event.stopPropagation()">
        <button class="copyBtn" id="btnCopyVeh" onclick="copiarVehicles()" disabled title="Copiar tabla para Excel">
          <svg class="copyIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copiar
        </button>
        <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </div>
    </div>

    <div class="accBody">
      <div id="vehWrap" class="muted">No hay filas detectadas.</div>
    </div>
  </div>


  <!-- ===== Modal Oferta (ver + chat) ===== -->
  <div class="rfModalBack" id="offerModalBack" aria-hidden="true">
    <div class="rfModal" role="dialog" aria-modal="true" aria-labelledby="offerModalTitle">
      <div class="rfModalHead">
        <div>
          <h3 id="offerModalTitle">Oferta</h3>
          <div class="rfSmall" id="offerModalSub">â€”</div>
        </div>
        <button class="rfModalClose" id="btnCloseOfferModal" title="Cerrar">Ã—</button>
      </div>
      <div class="rfModalBody">
        <div class="rfModalGrid">
          <div class="offerTag">OEM: <span id="mOfferOEM">â€”</span></div>
          <div class="offerTag">Marca: <span id="mOfferBrand">â€”</span></div>
          <div class="offerTag">Precio: <span id="mOfferPrice">â€”</span></div>
          <div class="offerTag">Moneda: <span id="mOfferCurrency">â€”</span></div>
          <div class="offerTag">Pais: <span id="mOfferCountry">â€”</span></div>
          <div class="offerTag">Expira: <span id="mOfferExpires">â€”</span></div>
        </div>

        <div style="margin-top:12px">
          <div class="muted" style="font-weight:900">Mensaje al vendedor</div>
          <textarea class="rfMsg" id="mOfferMsg" placeholder="Escribe tu mensaje..."></textarea>
          <div class="rfSmall" style="margin-top:6px">
            Nota: la descripcion interna no se muestra al cliente, solo al vendedor.
          </div>
        </div>

        <div class="rfModalActions">
          <button class="btn2" id="btnOpenOfferChat">Abrir chat de ofertas</button>
          <button class="btn offerBtnPrimary" id="btnSendOfferMsg">Enviar mensaje</button>
          <button class="btn" id="btnLoginToSend" style="display:none">Iniciar sesion para enviar</button>
        </div>

        <div class="rfSmall" style="margin-top:10px" id="offerModalStatus"></div>
      </div>
    </div>
  </div>


<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://pjkbipdjxxxzjiuyfkaq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_G7uvRyHNLSew2HKJY_h6ag_M2NZDYx4";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // âœ… Tablas (v1 + v2)
  const VEH_TABLES = ["datos_vehiculares", "datos_vehiculares_v2"];
  const CAMBIOS_TABLES = ["cambios", "cambios_v2"];

  // âœ… Logos por marca (ruta dentro del repo)
  const AUTO_LOGO_BASE = "assets/logos/autos/";

  // Placeholder (SVG) para cuando no exista un logo
  const DEFAULT_CAR_SVG_DATAURI =
    "data:image/svg+xml;charset=utf-8," +
    encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="120" height="80" viewBox="0 0 120 80">
        <rect x="0" y="0" width="120" height="80" rx="14" fill="#f3f4f6"/>
        <path d="M30 48l8-16c2-4 6-6 10-6h24c4 0 8 2 10 6l8 16" fill="none" stroke="#9ca3af" stroke-width="4" stroke-linecap="round"/>
        <path d="M26 48h68c6 0 10 4 10 10v6H16v-6c0-6 4-10 10-10z" fill="none" stroke="#9ca3af" stroke-width="4" stroke-linejoin="round"/>
        <circle cx="34" cy="64" r="7" fill="#9ca3af"/>
        <circle cx="86" cy="64" r="7" fill="#9ca3af"/>
      </svg>
    `);


  // âœ… Ofertas (Obsolescencia) en la App
  // Ajusta estos nombres si en tu BD difieren:
  const OFFERS_TABLE = "offers";               // tabla de ofertas
  const OFFERS_CHATS_TABLE = "offer_chats";      // chats por oferta
  const OFFERS_MESSAGES_TABLE = "offer_messages"; // mensajes por chat
  const OFFERS_CHAT_PAGE = "/obsolescencia.html"; // fallback: pagina de obsolescencia

  let lastOffers = [];
  let lastOffersError = "";     // ofertas encontradas para el codigo actual
  let modalOffer = null;   // oferta seleccionada en modal

  let lastPayload = null;
  let currentSearchSessionId = null;

  // âœ… Perfil (country/city)
  let profileCountry = null;
  let profileCity = null;
  let __marketLoaded = false;

  async function ensureMarketLoaded_(){
    // Garantiza que profileCountry/profileCity ya fueron leidos antes de loggear.
    if(__marketLoaded) return;
    try{ await loadProfileMarket_(); }catch(e){}
    __marketLoaded = true;
  }


  function setStatus(txt){ document.getElementById("status").textContent = txt; }

function clearInputsAfterCodeSearch_(){
  // limpia casillas para que el usuario pueda buscar otro codigo de inmediato
  const codeEl = document.getElementById("code");
  if(codeEl){ codeEl.value = ""; codeEl.focus(); }

  // opcional: limpiar filtro vehicular tambien
  ["fVehiculo","fAnio","fModelo","fMotor","fDescripcion"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = "";
  });
  setFiltroPill_("Sin filtro");
}


// ======================================================
// âœ… Anti-cuelgue: control de busqueda en curso + timeout
// ======================================================
let __isSearching = false;
  window.__isSearching = false;

// ==== Anti-cuelgue PRO: cancelacion logica + watchdog ====
// - Si una busqueda tarda demasiado, se libera el boton y el flag para permitir nuevas busquedas.
// - Si el usuario inicia otra busqueda, ignoramos resultados viejos.
let __searchSeq = 0;
let __activeSearchId = 0;
let __watchdogTimer = null;

function startSearchGuard_(label){
  __searchSeq += 1;
  __activeSearchId = __searchSeq;
  // watchdog de UI (no cancela la request, pero evita que se quede bloqueado)
  try{ if(__watchdogTimer) clearTimeout(__watchdogTimer); }catch(e){}
  __watchdogTimer = setTimeout(()=>{
    // si aun es la misma busqueda y sigue "buscando", liberamos UI
    if(window.__isSearching && __activeSearchId === __searchSeq){
      try{ window.__isSearching = false; }catch(e){}
      try{ const b=document.getElementById('btnBuscarCodigo'); if(b) b.disabled=false; }catch(e){}
      try{ const st=(document.getElementById("status")?.textContent||"").toLowerCase();
           if(st.includes("buscando")) setStatus("Listo âœ…"); }catch(e){}
    }
  }, 35000);
  return __activeSearchId;
}

function isSearchStale_(id){
  return id !== __activeSearchId;
}

function endSearchGuard_(){
  try{ if(__watchdogTimer) clearTimeout(__watchdogTimer); }catch(e){}
  __watchdogTimer = null;
}

function withTimeout_(promise, ms, label){
  let t;
  const timeoutP = new Promise((_, reject)=> {
    t = setTimeout(()=> reject(new Error(`Timeout (${label||"operacion"}) - ${ms}ms`)), ms);
  });
  return Promise.race([promise, timeoutP]).finally(()=> {
    try{ clearTimeout(t); }catch(e){}
  });
}

// Reintentos simples (solo en timeouts / fallos temporales)
async function retryWithTimeout_(fn, opts){
  const retries = Number(opts?.retries ?? 1);
  const timeoutMs = Number(opts?.timeoutMs ?? 15000);
  const label = String(opts?.label ?? "operacion");
  const baseDelay = Number(opts?.baseDelay ?? 350);

  let lastErr = null;
  for(let attempt=0; attempt<=retries; attempt++){
    try{
      return await withTimeout_(Promise.resolve().then(fn), timeoutMs, label);
    }catch(e){
      lastErr = e;
      const msg = String(e?.message || e || "");
      const isTimeout = msg.toLowerCase().includes("timeout");
      if(attempt >= retries || !isTimeout){
        throw lastErr;
      }
      // small backoff
      const wait = baseDelay * (attempt + 1);
      await new Promise(r=> setTimeout(r, wait));
    }
  }
  throw lastErr;
}

  // ======================================================
  // âœ… VOZ (busqueda por microfono) - APP
  //  - 1 vez por periodo del dia (maÃ±ana/tarde/noche) muestra ayuda (toast)
  //  - escucha hasta 25s sin resultados y se apaga solo
  //  - entiende:
  //      "11 12 42 buscar" / "11 12 guion 42 buscar" => busca por codigo
  //      "honda 2005 civic buscar" => llena filtros vehiculares y busca
  // ======================================================

  function toast_(msg, ms=2600){
    try{
      const t = document.createElement("div");
      t.className = "rfToast";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, ms);
    }catch(e){}
  }

  function periodKey_(){
    const now = new Date();
    const h = now.getHours();
    // maÃ±ana: 05-11, tarde: 12-18, noche: 19-04
    if(h >= 5 && h <= 11) return "manana";
    if(h >= 12 && h <= 18) return "tarde";
    return "noche";
  }

  function todayKey_(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function helpOncePerPeriod_(){
    const k = `rf_voice_help_app_${todayKey_()}_${periodKey_()}`;
    if(localStorage.getItem(k) === "1") return;
    localStorage.setItem(k, "1");
    toast_("Voz: di un codigo y luego 'buscar' (ej: 11 12 42 buscar) o di 'Honda 2005 Civic buscar'.");
  }

  function isSpeechAvailable_(){
    return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  }

  
  function normalizeSpoken_(t){
    let s = String(t || "").toLowerCase();

    // limpiar puntuacion / relleno
    s = s.replace(/[ï¼Œ,.;:!?]/g, " ");
    s = s.replace(/\s+/g, " ").trim();

    // convertir "guion" -> "-"
    s = s.replace(/\b(gui[oÃ³]n|guion|dash)\b/g, "-");

    // numeros en palabras (basico)
    const map = {
      "cero":"0","uno":"1","un":"1","una":"1","dos":"2","tres":"3","cuatro":"4","cinco":"5",
      "seis":"6","siete":"7","ocho":"8","nueve":"9","diez":"10","once":"11","doce":"12",
      "trece":"13","catorce":"14","quince":"15","dieciseis":"16","diecisÃ©is":"16","diecisiete":"17",
      "dieciocho":"18","diecinueve":"19","veinte":"20",
      "treinta":"30","cuarenta":"40","cincuenta":"50","sesenta":"60","setenta":"70","ochenta":"80","noventa":"90"
    };
    s = s.split(" ").map(w => map[w] ?? w).join(" ");

    // normalizar espacios alrededor de guiones
    s = s.replace(/\s*-\s*/g, "-");

    // unir numeros separados por espacios (sin limite)
    // ej: "11 12 42" => "111242"
    s = s.replace(/(?<=\d)\s+(?=\d)/g, "");

    // unir letra+numero con espacios SOLO en ese sentido (ej: "m 276" => "m276")
    // OJO: no unir numero+letra porque pegaria "111242 encontrar"
    s = s.replace(/(?<=[a-z])\s+(?=\d)/g, "");

    return s.trim();
  }



  function parseVoiceCommand_(raw){
    const text0 = normalizeSpoken_(raw);

    // palabra reservada para ejecutar: "encontrar"
    const hasEncontrar = /\b(encontrar|encuentra|encontralo|encuÃ©ntralo)\b/.test(text0);

    // quitar palabra reservada antes de escribir en inputs
    const text = text0
      .replace(/\b(encontrar|encuentra|encontralo|encuÃ©ntralo)\b/g, " ")
      .replace(/\s+/g," ")
      .trim();

    const hasYear = /\b(19[5-9]\d|20[0-4]\d|2050)\b/.test(text);

    const brands = ["honda","hyundai","mercedes","toyota","kia","bmw","nissan","mazda","ford","chevrolet","vw","volkswagen","audi","jeep","lexus","acura","mitsubishi","suzuki"];
    const brandHit = brands.find(b => text.includes(b)) || "";
    const hasBrand = !!brandHit;

    const hasVehicularHints = /\b(vehiculo|vehÃ­culo|modelo|motor|descripcion|descripci[oÃ³]n)\b/.test(text);

    const digitCount = (text.match(/\d/g) || []).length;
    const wordCount = text.split(/\s+/).filter(Boolean).length;

    // -------------------------
    // VEHICULAR (buscador de abajo)
    // -------------------------
    if(hasYear || hasBrand || hasVehicularHints){
      const tokens = text
        .replace(/[ï¼Œ,.;:!?]/g," ")
        .replace(/\s+/g," ")
        .trim()
        .split(" ")
        .filter(Boolean);

      // aÃ±o
      let anio = "";
      let idxYear = -1;
      for(let i=0;i<tokens.length;i++){
        if(/^(19[5-9]\d|20[0-4]\d|2050)$/.test(tokens[i])){
          anio = tokens[i];
          idxYear = i;
          break;
        }
      }

      // vehiculo = marca (si la detectamos)
      let vehiculo = "";
      let idxBrand = -1;
      for(let i=0;i<tokens.length;i++){
        const t = tokens[i].toLowerCase();
        if(brands.includes(t)){
          vehiculo = t;
          idxBrand = i;
          break;
        }
      }

      // motor por keyword o por patron
      let motor = "";
      const lower = text.toLowerCase();
      const motorMatch = lower.match(/\bmotor\s+([a-z0-9.]+)/i);
      if(motorMatch) motor = motorMatch[1];

      // descripcion (keyword simple)
      let desc = "";
      const descKeywords = ["alternador","filtro","bomba","radiador","pastilla","disco","amortiguador","sensor","bobina","bujia","terminal","rotula","empaque","junta","cadena","termostato"];
      for(const kw of descKeywords){
        if(lower.includes(kw)){ desc = kw; break; }
      }

      // modelo: mas estricto
      const stopWords = new Set(["motor","vehiculo","vehÃ­culo","descripcion","descripciÃ³n","modelo","por","favor"]);
      function cleanModelTokens(arr){
        return arr.filter(t => !stopWords.has(t.toLowerCase()) && !/^(19[5-9]\d|20[0-4]\d|2050)$/.test(t));
      }

      let modeloToks = [];
      if(idxYear >= 0){
        modeloToks = tokens.slice(idxYear+1);
      }else if(idxBrand >= 0){
        modeloToks = tokens.slice(idxBrand+1);
      }else{
        modeloToks = tokens.slice(1);
      }
      modeloToks = cleanModelTokens(modeloToks);

      if(!motor && modeloToks[0] && /(\d\.\d|^[a-z]+\d+)/i.test(modeloToks[0])){
        motor = modeloToks[0];
        modeloToks = modeloToks.slice(1);
      }

      const modelo = (modeloToks.slice(0,2).join(" ")).trim();

      return {
        type: "vehicular",
        hasEncontrar,
        fields: { vehiculo, anio, modelo, motor, desc }
      };
    }

    // -------------------------
    // CODIGO (buscador de arriba)
    // -------------------------
    const m = text.match(/([a-z0-9]+(?:-[a-z0-9]+)*)/i);
    const codeCandidate = m ? m[1] : "";

    const looksLikeCode =
      (digitCount >= 4) &&
      (
        /^[a-z0-9]+(-[a-z0-9]+)*$/i.test(codeCandidate)
      ) &&
      !(wordCount >= 3 && digitCount < 5);

    if(looksLikeCode && codeCandidate){
      return { type:"codigo", hasEncontrar, code: codeCandidate };
    }

    // -------------------------
    // DESCRIPCION (default si no hay marca/aÃ±o y son palabras)
    // -------------------------
    const lettersOnly = /^[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s-]+$/i.test(text) && digitCount === 0;
    if(lettersOnly && text.length >= 2){
      return { type:"descripcion", hasEncontrar, desc: text };
    }

    return { type:"unknown", hasEncontrar, text };
  }


  let recog_ = null;
  let isListening_ = false;
  let silenceTimer_ = null;

  function stopListening_(reason){
    try{ if(silenceTimer_) clearTimeout(silenceTimer_); }catch(e){}
    silenceTimer_ = null;

    if(recog_){
      try{ recog_.stop(); }catch(e){}
    }
    isListening_ = false;

    const btn = document.getElementById("micBtn");
    if(btn) btn.classList.remove("listening");

    if(reason === "timeout") toast_("Microfono apagado (sin respuesta).");
  }

  async function handleVoiceText_(t){
    const parsed = parseVoiceCommand_(t);

    // Si solo dicen "encontrar" sin data, usar lo que ya esta escrito
    const onlyEncontrar = /^\s*(encontrar|encuentra|encontralo|encuÃ©ntralo)\s*$/i.test(String(t||"").trim());

    if(onlyEncontrar){
      const codeNowRaw = String(document.getElementById("code")?.value || "").trim();
      const codeNow = codeNowRaw.replace(/\b(encontrar|buscar)\b/ig,"").trim();

      const fVeh = String(document.getElementById("fVehiculo")?.value || "").trim();
      const fAnio = String(document.getElementById("fAnio")?.value || "").trim();
      const fMod = String(document.getElementById("fModelo")?.value || "").trim();
      const fMot = String(document.getElementById("fMotor")?.value || "").trim();
      const fDes = String(document.getElementById("fDescripcion")?.value || "").trim();

      if(codeNow){
        document.getElementById("code").value = codeNow;
        toast_("Encontrando codigo: " + codeNow);
        const btn = document.querySelector('#btnBuscarCodigo') || document.querySelector('button[onclick*="buscar"]');
        if(btn){ btn.click(); } else { await window.window.buscar && window.buscar(); }
        return;
      }
      if(fVeh || fAnio || fMod || fMot || fDes){
        toast_("Encontrando por filtrosâ€¦");
        const btn2 = document.querySelector('#btnBuscarFiltro') || document.querySelector('button[onclick*="aplicarFiltroVehicular"]');
        if(btn2){ btn2.click(); } else { await window.aplicarFiltroVehicular(); }
        return;
      }
      toast_("Di un codigo o un filtro primero, luego di 'encontrar'.");
      return;
    }

    if(parsed.type === "codigo"){
      const code = String(parsed.code || "").replace(/\b(encontrar|buscar)\b/ig,"").toUpperCase().trim();
      if(code){
        document.getElementById("code").value = code;
        if(parsed.hasEncontrar){
          toast_("Encontrando codigo: " + code);
          const btn = document.querySelector('#btnBuscarCodigo') || document.querySelector('button[onclick*="buscar"]');
        if(btn){ btn.click(); } else { await window.window.buscar && window.buscar(); }
        }else{
          toast_("Codigo listo: " + code + ". Ahora di 'encontrar'.");
        }
      }
      return;
    }

    if(parsed.type === "vehicular"){
      const f = parsed.fields || {};
      if(f.vehiculo) document.getElementById("fVehiculo").value = (f.vehiculo || "").replace(/^./,c=>c.toUpperCase());
      if(f.anio)     document.getElementById("fAnio").value = f.anio;
      if(f.modelo)   document.getElementById("fModelo").value = (f.modelo || "").replace(/^./,c=>c.toUpperCase());
      if(f.motor)    document.getElementById("fMotor").value = String(f.motor || "").toUpperCase();
      if(f.desc)     document.getElementById("fDescripcion").value = (f.desc || "").toLowerCase();

      const resumen = [f.vehiculo, f.anio, f.modelo].filter(Boolean).join(" ");
      if(parsed.hasEncontrar){
        toast_("Encontrando por filtros: " + resumen);
        const btn2 = document.querySelector('#btnBuscarFiltro') || document.querySelector('button[onclick*="aplicarFiltroVehicular"]');
        if(btn2){ btn2.click(); } else { await window.aplicarFiltroVehicular(); }
      }else{
        toast_("Filtros listos: " + resumen + ". Ahora di 'encontrar'.");
      }
      return;
    }

    if(parsed.type === "descripcion"){
      const desc = String(parsed.desc || "").replace(/\b(encontrar|buscar)\b/ig,"").trim();
      if(desc){
        document.getElementById("fDescripcion").value = desc;
        if(parsed.hasEncontrar){
          toast_("Encontrando por descripcion: " + desc);
          const btn2 = document.querySelector('#btnBuscarFiltro') || document.querySelector('button[onclick*="aplicarFiltroVehicular"]');
        if(btn2){ btn2.click(); } else { await window.aplicarFiltroVehicular(); }
        }else{
          toast_("Descripcion lista: " + desc + ". Ahora di 'encontrar'.");
        }
      }
      return;
    }

    toast_("No entendi. Di un codigo, o 'Marca AÃ±o Modelo', o una descripcion; y di 'encontrar'.");
  }

  function startListening_(){
    if(!isSpeechAvailable_()){
      alert("Tu navegador no soporta reconocimiento de voz. Prueba Chrome o Edge.");
      return;
    }

    helpOncePerPeriod_();

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recog_ = new SR();
    recog_.lang = "es-ES";
    recog_.interimResults = true;
    recog_.continuous = true;

    let lastFinal = "";
    let lastInterimAt = Date.now();

    recog_.onresult = async (ev)=>{
      lastInterimAt = Date.now();
      try{
        let interim = "";
        let finalText = "";

        for(let i=ev.resultIndex; i<ev.results.length; i++){
          const r = ev.results[i];
          const txt = r[0]?.transcript || "";
          if(r.isFinal) finalText += " " + txt;
          else interim += " " + txt;
        }

        const mergedFinal = (lastFinal + " " + finalText).trim();
        const mergedInterim = interim.trim();

        // feedback leve
        if(mergedInterim){
          const cleanInterim = mergedInterim.replace(/\b(encontrar|encuentra|encontralo|encuÃ©ntralo)\b/ig,"").replace(/\s+/g," ").trim();
          if(cleanInterim) setStatus("ðŸŽ™ï¸ " + cleanInterim);
        }

        // Si tenemos final y contiene "encontrar", ejecutamos
        if(mergedFinal && /(encontrar|encuentra|encontralo|encuÃ©ntralo)/i.test(mergedFinal)){
          lastFinal = mergedFinal;
          setStatus("Procesando voz...");
          stopListening_();
          await handleVoiceText_(mergedFinal);
          setStatus("Listo âœ…");
        }else{
          lastFinal = mergedFinal || lastFinal;
        }
      }catch(e){
        console.warn("voz onresult error:", e);
      }
    };

    recog_.onerror = (ev)=>{
      console.warn("voz error:", ev?.error || ev);
      stopListening_();
    };

    recog_.onend = ()=>{
      // si se corto por permisos, aseguramos UI
      stopListening_();
    };

    isListening_ = true;
    const btn = document.getElementById("micBtn");
    if(btn) btn.classList.add("listening");

    // auto off si 25s sin reconocer nada
    silenceTimer_ = setTimeout(()=> stopListening_("timeout"), 25000);

    try{ recog_.start(); }catch(e){ console.warn("no pude iniciar voz", e); stopListening_(); }
  }

  function toggleListening_(){
    if(isListening_) stopListening_();
    else startListening_();
  }

  function isMobile_(){
    const w = Math.min(window.innerWidth || 9999, screen.width || 9999);
    const isTouch = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    return (w <= 1024) || isTouch;
  }
  function setMobileDefault_(){
    ["cardProducto","cardOE","cardVeh"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.remove("open"); });
    const p = document.getElementById("cardProducto"); if(p) p.classList.add("open");
  }
  function setDesktopDefault_(){
    ["cardProducto","cardOE","cardVeh"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.add("open"); });
  }
  window.toggleAcc = function(cardId){
    if(!isMobile_()) return;
    const el = document.getElementById(cardId);
    if(!el) return;
    const willOpen = !el.classList.contains("open");
    ["cardProducto","cardOE","cardVeh"].forEach(id => { const c=document.getElementById(id); if(c) c.classList.remove("open"); });
    if(willOpen) el.classList.add("open");
  };
  window.addEventListener("resize", ()=>{ if(isMobile_()) setMobileDefault_(); else setDesktopDefault_(); });
  document.addEventListener("DOMContentLoaded", ()=>{ if(isMobile_()) setMobileDefault_(); else setDesktopDefault_();

    // ===== Modal oferta handlers =====
    const back = document.getElementById("offerModalBack");
    const btnClose = document.getElementById("btnCloseOfferModal");
    const btnOpenChat = document.getElementById("btnOpenOfferChat");
    const btnSend = document.getElementById("btnSendOfferMsg");

    if(btnClose) btnClose.addEventListener("click", closeOfferModal_);
    if(back) back.addEventListener("click", (ev)=>{ if(ev.target === back) closeOfferModal_(); });
    document.addEventListener("keydown", (ev)=>{ if(ev.key === "Escape") closeOfferModal_(); });

    if(btnOpenChat) btnOpenChat.addEventListener("click", async ()=>{
      const params = new URLSearchParams(window.location.search);
      const isDemo = params.get("demo") === "1";
      if(isDemo){ alert("En modo DEMO no se puede abrir el chat."); return; }

      const { data } = await supabase.auth.getSession();
      const user = data?.session?.user;
      if(!user){
        alert("Debes iniciar sesion para abrir el chat.");
        const next = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = "/?stay=1&next=" + next;
        return;
      }

      const msg = String(document.getElementById("mOfferMsg")?.value || "").trim();
      const q = new URLSearchParams();
      if(modalOffer?.id) q.set("offer", modalOffer.id);
      if(modalOffer?.original_norm) q.set("code", modalOffer.original_norm);
      if(msg) q.set("msg", msg);
      window.open(OFFERS_CHAT_PAGE + "?" + q.toString(), "_blank");
    });

    if(btnSend) btnSend.addEventListener("click", async ()=>{
      const msg = document.getElementById("mOfferMsg")?.value || "";
      await sendOfferMessage_(msg);
    });

    // Enter en filtros => aplicar
  ["fVehiculo","fAnio","fModelo","fMotor","fDescripcion"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("keydown", (ev)=>{
        if(ev.key === "Enter"){ ev.preventDefault(); window.aplicarFiltroVehicular(); }
      });
    }
  });

  // Estado inicial de botones de mensajeria (si alguien abre modal)
  updateOfferModalAuthUI_();


// ===== Theme (fondos) =====
function applyTheme_(name){
  const b = document.body;
  b.classList.remove("theme-sky","theme-mint");
  if(name === "sky") b.classList.add("theme-sky");
  else if(name === "mint") b.classList.add("theme-mint");
  
  // default = sin clase
  try{ localStorage.setItem("rf_app_theme", name || "default"); }catch(e){}
  // UI active state
  document.querySelectorAll(".themeBtn").forEach(btn=>{
    const t = btn.getAttribute("data-theme") || "default";
    btn.classList.toggle("active", t === (name || "default"));
  });
}

// iniciar theme guardado
try{
  const saved = localStorage.getItem("rf_app_theme") || "default";
  applyTheme_(saved);
}catch(e){}

// clicks
document.querySelectorAll(".themeBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-theme") || "default";
    applyTheme_(t);
  });
});

  // Microfono (voz)
  const micBtn = document.getElementById("micBtn");
  if(micBtn){
    micBtn.addEventListener("click", (ev)=>{ ev.preventDefault(); toggleListening_(); });
  }
});

  window.cerrarSesion = async function(){
    try{ await supabase.auth.signOut(); }catch(e){}
    window.location.href = "/?stay=1";
  };

  async function initAuth_(){
    const logoutLink = document.getElementById("logoutLink");
    const loginLink  = document.getElementById("loginLink");

    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";
    const { data } = await supabase.auth.getSession();

    const hasSession = !!(data && data.session);

    // âœ… Si NO hay sesion: la App se puede usar, pero Mensajeria de Ofertas queda bloqueada
    if(!hasSession){
      if(logoutLink) logoutLink.style.display = "none";

      if(loginLink){
        loginLink.style.display = "inline-flex";
        // Redirige a la pagina principal (login) y vuelve a esta pagina con ?next=
        const next = encodeURIComponent(window.location.pathname + window.location.search);
        loginLink.href = "/?stay=1&next=" + next;
      }
      return;
    }

    // âœ… Si hay sesion: mostrar cerrar sesion y ocultar login
    if(loginLink) loginLink.style.display = "none";
    if(logoutLink) logoutLink.style.display = "inline-flex";
  }

  function escapeHtml_(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function slugifyMake_(make){
    return String(make||"")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/[^a-z0-9_]/g, "");
  }

  function titleCase_(s){
    const t = String(s||"").trim().toLowerCase();
    if(!t) return "";
    return t.charAt(0).toUpperCase() + t.slice(1);
  }

  function getLogoCandidates_(make){
    const slug = slugifyMake_(make);
    const tcase = titleCase_(make).replace(/\s+/g, "");
    // Intentamos varias combinaciones (por si el repo tiene mayusculas/extension distinta)
    const list = [];
    if(slug)  list.push(AUTO_LOGO_BASE + slug + ".png", AUTO_LOGO_BASE + slug + ".jpg", AUTO_LOGO_BASE + slug + ".jpeg");
    if(tcase) list.push(AUTO_LOGO_BASE + tcase + ".png", AUTO_LOGO_BASE + tcase + ".jpg", AUTO_LOGO_BASE + tcase + ".jpeg");
    return list;
  }

  function renderVehicleLogos_(vehiclesTable){
    const wrap = document.getElementById("vehLogos");
    if(!wrap) return;

    // limpiar por defecto
    wrap.innerHTML = "";
    wrap.style.display = "none";

    if(!vehiclesTable || !Array.isArray(vehiclesTable.headers) || !Array.isArray(vehiclesTable.rows)) return;
    if(!vehiclesTable.rows.length) return;

    const headers = vehiclesTable.headers.map(h => String(h||"").toLowerCase());
    const idxMake = headers.findIndex(h => h === "vehiculo" || h.includes("vehiculo") || h === "vehicle" || h.includes("vehicle"));
    if(idxMake < 0) return;

    const makes = [];
    const seen = new Set();
    for(const r of vehiclesTable.rows){
      const mk = (r && r[idxMake] !== undefined) ? String(r[idxMake]||"").trim() : "";
      if(!mk) continue;
      const key = mk.toLowerCase();
      if(seen.has(key)) continue;
      seen.add(key);
      makes.push(mk);
      if(makes.length >= 10) break; // max 10 logos (2 filas de 5 aprox)
    }

    if(makes.length === 0) return;

    // Construir HTML
    let html = "";
    for(const mk of makes){
      const candidates = getLogoCandidates_(mk);
      const firstSrc = candidates[0] || DEFAULT_CAR_SVG_DATAURI;

      // onerror: intenta siguiente candidato, y si no, placeholder
      const escMk = escapeHtml_(mk);
      const candJson = escapeHtml_(JSON.stringify(candidates));
      html += `
        <div class="vehLogoItem" title="${escMk}">
          <img class="vehLogoImg"
               src="${firstSrc}"
               alt="${escMk}"
               data-candidates='${candJson}'
               onerror="(function(img){
                 try{
                   const c = JSON.parse(img.getAttribute('data-candidates')||'[]');
                   const i = Number(img.getAttribute('data-idx')||'0');
                   const next = c[i+1];
                   if(next){
                     img.setAttribute('data-idx', String(i+1));
                     img.src = next;
                     return;
                   }
                 }catch(e){}
                 img.onerror=null;
                 img.src='${DEFAULT_CAR_SVG_DATAURI}';
               })(this)">
          <div class="vehLogoText">${escMk}</div>
        </div>
      `;
    }

    wrap.innerHTML = html;
    wrap.style.display = "flex";
  }


  function renderTableInto_(wrapId, tableObj){
    const wrap = document.getElementById(wrapId);
    if(!wrap) return;

    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows) || tableObj.rows.length === 0){
      wrap.innerHTML = "No hay filas detectadas.";
      return;
    }

    const headers = tableObj.headers;
    const rows = tableObj.rows;

    let html = '<div class="tableWrap"><table><thead><tr>';
    for(const h of headers) html += '<th>' + escapeHtml_(h) + '</th>';
    html += '</tr></thead><tbody>';

    for(const r of rows){
      html += '<tr>';
      for(let i=0;i<headers.length;i++){
        const v = (r && r[i] !== undefined) ? r[i] : "";
        // âœ… Si es columna "Codigo principal", render como link que dispara busqueda por codigo
        const hName = String(headers[i] || "").toLowerCase();
        const cell = (v !== undefined && v !== null) ? String(v) : "";
        if(hName.includes("codigo principal") || hName.includes("cÃ³digo principal") || hName.includes("principal code")){
          const clean = cell.trim();
          if(clean){
            const esc = escapeHtml_(clean);
            html += '<td><a class="codeLink" href="#" onclick="buscarCodigoPrincipal(\'' + esc + '\');return false;">' + esc + '</a></td>';
          }else{
            html += '<td></td>';
          }
        }else{
          html += '<td>' + escapeHtml_(cell) + '</td>';
        }
      }
      html += '</tr>';
    }

    html += '</tbody></table></div>';
    wrap.innerHTML = html;
  }

  function tableToTSV_(tableObj){
    if(!tableObj || !Array.isArray(tableObj.headers) || !Array.isArray(tableObj.rows)) return "";
    const lines = [];
    lines.push(tableObj.headers.join("\t"));
    for(const r of tableObj.rows){
      const row = tableObj.headers.map((_,i)=> (r && r[i] !== undefined && r[i] !== null) ? String(r[i]) : "");
      lines.push(row.join("\t"));
    }
    return lines.join("\n");
  }

  function normalizeCode_(s){
    return String(s||"")
      .trim()
      .toUpperCase()
      .replace(/\s+/g,"")
      .replace(/[^A-Z0-9]/g,"");
  }

  function unique_(arr){
    const out = [];
    const seen = new Set();
    for(const x of arr){
      const k = String(x);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  function buildGoogleUrl_(code){
    return "https://www.google.com/search?q=" + encodeURIComponent(code);
  }

  
  // ======================================================
  // âœ… COUNTRY OPTIONS (mismas siglas usadas en RADAR)
  //  - Se usan para normalizar lo que venga guardado en profiles.country
  //  - Ejemplos soportados: "DO", "DO RepÃºblica Dominicana (DO)", "RepÃºblica Dominicana", "GLOBAL", "Todos (GLOBAL)"
  // ======================================================
  const COUNTRY_OPTIONS = [
    { code:"DO", name:"RepÃºblica Dominicana" },
    { code:"US", name:"Estados Unidos" },
    { code:"MX", name:"MÃ©xico" },
    { code:"CA", name:"CanadÃ¡" },
    { code:"ES", name:"EspaÃ±a" },
    { code:"PT", name:"Portugal" },
    { code:"FR", name:"Francia" },
    { code:"DE", name:"Alemania" },
    { code:"IT", name:"Italia" },
    { code:"GB", name:"Reino Unido" },
    { code:"NL", name:"PaÃ­ses Bajos" },
    { code:"BE", name:"BÃ©lgica" },
    { code:"CH", name:"Suiza" },
    { code:"SE", name:"Suecia" },
    { code:"NO", name:"Noruega" },
    { code:"DK", name:"Dinamarca" },
    { code:"FI", name:"Finlandia" },
    { code:"PL", name:"Polonia" },
    { code:"TR", name:"TurquÃ­a" },
    { code:"RU", name:"Rusia" },
    { code:"UA", name:"Ucrania" },
    { code:"BR", name:"Brasil" },
    { code:"AR", name:"Argentina" },
    { code:"CL", name:"Chile" },
    { code:"CO", name:"Colombia" },
    { code:"PE", name:"PerÃº" },
    { code:"EC", name:"Ecuador" },
    { code:"PA", name:"PanamÃ¡" },
    { code:"CR", name:"Costa Rica" },
    { code:"GT", name:"Guatemala" },
    { code:"SV", name:"El Salvador" },
    { code:"HN", name:"Honduras" },
    { code:"NI", name:"Nicaragua" },
    { code:"PR", name:"Puerto Rico" },
    { code:"VE", name:"Venezuela" },
  ];

  function normalizeCountryCode_(value){
    if(value === undefined || value === null) return null;

    let s = String(value).trim();
    if(!s) return null;

    const u = s.toUpperCase();

    // GLOBAL/TODOS
    if(u === "GLOBAL" || u === "TODOS" || u === "TODOS (GLOBAL)" || u === "ALL" || u === "WORLD"){
      return null; // no guardamos country en search_events (queda NULL)
    }

    // Formato: "DO RepÃºblica Dominicana (DO)" o "... (DO)"
    const m1 = s.match(/\(([A-Z]{2})\)\s*$/);
    if(m1) return m1[1];

    // Formato: "DO ..." o "DO-..."
    const m2 = s.match(/^\s*([A-Z]{2})\b/);
    if(m2) return m2[1];

    // Si viene solo el codigo
    if(/^[A-Z]{2}$/.test(u)) return u;

    // Buscar por nombre
    const low = s.toLowerCase();
    for(const opt of COUNTRY_OPTIONS){
      if(!opt) continue;
      const code = String(opt.code||"").toUpperCase();
      const name = String(opt.name||"").toLowerCase();
      if(code && low.includes(code.toLowerCase())) return code;
      if(name && low.includes(name)) return code || null;
    }

    return null;
  }

// ======================================================
  // âœ… MARKET INTEL: anon_id + session + country + logging
  // ======================================================

  function getOrCreateAnonId_(){
    try{
      const key = "rf_anon_id";
      let v = localStorage.getItem(key);
      if(v) return v;
      v = "anon_" + crypto.getRandomValues(new Uint32Array(4)).join("-");
      localStorage.setItem(key, v);
      return v;
    }catch(e){
      return "anon_" + Math.random().toString(16).slice(2);
    }
  }

  function detectDevice_(){
    const w = Math.min(window.innerWidth || 9999, screen.width || 9999);
    const isTouch = (window.matchMedia && window.matchMedia("(pointer:coarse)").matches) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    return ((w <= 1024) || isTouch) ? "mobile" : "desktop";
  }

  function classifyCategory_(q){
    const s = String(q||"").toLowerCase();
    const has = (...words) => words.some(w => s.includes(w));

    if(has("amortigu", "shock", "rotula", "buje", "bushing", "stabil", "terminal", "cremallera", "rack", "biela", "suspension")){
      return "suspension";
    }
    if(has("pastilla", "disco", "caliper", "zapata", "freno", "brake", "cilindro maestro", "master cylinder")){
      return "frenos";
    }
    if(has("piston", "anillo", "ring", "junta", "empaque", "culata", "head gasket", "bomba aceite", "oil pump", "cadena tiempo", "timing")){
      return "motor";
    }
    if(has("filtro", "filter", "mann", "mahle", "aceite", "oil filter", "air filter", "cabina")){
      return "filtros";
    }
    if(has("alternador", "arranque", "starter", "sensor", "bobina", "coil", "bujia", "spark", "relay", "rele", "fusible")){
      return "electrico";
    }
    if(has("radiador", "bomba agua", "water pump", "termostato", "coolant", "manguera", "fan", "abanico")){
      return "cooling";
    }
    return "otros";
  }

  function classifyCategoryFromPosition_(posText){
    const s = String(posText || "").toLowerCase();
    const has = (...words) => words.some(w => s.includes(w));

    if (has("brake","freno","rear axle brake","front brake","disc","pad","caliper","zapata","drum","rotor","master cylinder","abs")) {
      return "frenos";
    }
    if (has("suspension","shock","strut","control arm","arm","ball joint","rotula","bushing","buje","stabilizer","stabilizer link","tie rod","rack","steering","terminal")) {
      return "suspension";
    }
    if (has("engine","timing","gasket","head","piston","ring","bearing","oil pump","camshaft","crankshaft","valve","culata","empaque","anillo")) {
      return "motor";
    }
    if (has("transmission","gear","clutch","cv joint","driveshaft","axle shaft","differential")) {
      return "transmision";
    }
    if (has("sensor","ignition","coil","spark","alternator","starter","relay","fuse","wiring")) {
      return "electrico";
    }
    if (has("radiator","water pump","thermostat","coolant","fan","hose")) {
      return "cooling";
    }
    return null;
  }

  function extractBestPosition_(vehiclesTable){
    if(!vehiclesTable || !Array.isArray(vehiclesTable.headers) || !Array.isArray(vehiclesTable.rows)) return null;

    const headers = vehiclesTable.headers.map(h => String(h||"").toLowerCase());
    let idx = headers.findIndex(h => h === "posicion" || h.includes("posicion") || h === "position" || h.includes("position"));
    if(idx < 0) return null;

    for(const r of vehiclesTable.rows){
      const v = r && r[idx] !== undefined ? String(r[idx] || "").trim() : "";
      if(v) return v;
    }
    return null;
  }

  function extractVehicleSummary_(vehiclesTable){
    if(!vehiclesTable || !Array.isArray(vehiclesTable.headers) || !Array.isArray(vehiclesTable.rows)) return null;

    const headers = vehiclesTable.headers.map(h => String(h||"").toLowerCase());
    const idx = (name) => headers.findIndex(h => h === name || h.includes(name));

    const iMake   = idx("vehiculo");
    const iModel  = idx("modelo");
    const iYFrom  = idx("aÃ±o inicio");
    const iYTo    = idx("aÃ±o final");
    const iEngine = idx("motor");
    const iSerie  = idx("serie");

    for(const r of vehiclesTable.rows){
      return {
        make:   iMake  >=0 ? r[iMake]  : null,
        model:  iModel >=0 ? r[iModel] : null,
        year_from: iYFrom >=0 ? r[iYFrom] : null,
        year_to:   iYTo   >=0 ? r[iYTo]   : null,
        engine: iEngine>=0 ? r[iEngine] : null,
        serie:  iSerie >=0 ? r[iSerie]  : null
      };
    }
    return null;
  }

  async function getCurrentUserId_(){
    try{
      const { data } = await supabase.auth.getSession();
      return data?.session?.user?.id || null;
    }catch(e){
      return null;
    }
  }

  async function loadProfileMarket_(){
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";

    if(isDemo){
      profileCountry = "DO";
      profileCity = null;
      paintMarketPills_();
      return;
    }

    const userId = await getCurrentUserId_();
    if(!userId){
      profileCountry = null;
      profileCity = null;
      paintMarketPills_();
      return;
    }

    try{
      const { data, error } = await supabase
        .from("profiles")
        .select("country, city")
        .eq("id", userId)
        .maybeSingle();

      if(error){
        console.warn("No pude leer profiles.country:", error.message);
        profileCountry = null;
        profileCity = null;
      }else{
        profileCountry = normalizeCountryCode_(data?.country);
        profileCity = (data?.city || null);
      }
    }catch(e){
      console.warn("No pude leer profiles:", e?.message || e);
      profileCountry = null;
      profileCity = null;
    }

    paintMarketPills_();
    __marketLoaded = true;
  }

  function paintMarketPills_(){
    const elC = document.getElementById("pillCountry");
    const elCity = document.getElementById("pillCity");
    const wrap = document.getElementById("pillCityWrap");

    if(elC) elC.textContent = profileCountry ? String(profileCountry).toUpperCase() : "GLOBAL";

    if(profileCity){
      if(elCity) elCity.textContent = String(profileCity);
      if(wrap) wrap.style.display = "inline";
    }else{
      if(wrap) wrap.style.display = "none";
    }
  }

  async function ensureSearchSession_(){
    if(currentSearchSessionId) return currentSearchSessionId;

    const anonId = getOrCreateAnonId_();
    const userId = await getCurrentUserId_();

    const { data, error } = await supabase
      .from("search_sessions")
      .insert([{
        user_id: userId,
        anon_id: anonId,
        source: "web",
        device: detectDevice_(),
        country: profileCountry,
        city: profileCity
      }])
      .select("id")
      .single();

    if(error){
      console.warn("No pude crear search_session:", error.message);
      return null;
    }

    currentSearchSessionId = data?.id || null;
    return currentSearchSessionId;
  }

  async function logSearchEvent_({ queryRaw, queryType, normalizedQuery, category, resultStatus, resultsCount, responseTimeMs, meta }){
    try{
      const sessionId = await ensureSearchSession_();
      const userId = await getCurrentUserId_();

      const payload = {
        session_id: sessionId,
        user_id: userId,
        query_raw: queryRaw,
        query_type: queryType || "mixed",
        normalized_query: normalizedQuery || null,
        category: category || null,
        country: profileCountry ? String(profileCountry).toUpperCase() : null,
        result_status: resultStatus || "unknown",
        results_count: Number.isFinite(resultsCount) ? resultsCount : 0,
        response_time_ms: Number.isFinite(responseTimeMs) ? responseTimeMs : null,
        meta: {
          ...(meta || {}),
          market_country: profileCountry || null,
          market_city: profileCity || null
        }
      };

      const { error } = await supabase.from("search_events").insert([payload]);
      if(error) console.warn("No pude insertar search_event:", error.message);
    }catch(e){
      console.warn("Error logSearchEvent_:", e?.message || e);
    }
  }


  // Log no-bloqueante (evita que la UI se quede colgada si Supabase tarda)
  async function safeLogSearchEvent_(payload){
    try{
      await withTimeout_(logSearchEvent_(payload), 5000, "log");
    }catch(e){
      // silencioso
    }
  }


  // ======================================================
  // âœ… Helpers multi-tabla (v1 + v2)
  // ======================================================

  function dedupeByKey_(arr, keyFn){
    const out = [];
    const seen = new Set();
    for(const item of (arr||[])){
      const k = keyFn(item);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(item);
    }
    return out;
  }

  function normCell_(v){
  return String(v ?? "")
    .trim()
    .toUpperCase()
    .replace(/\s+/g, " "); // normaliza espacios internos
}

function normCodeCell_(v){
  // para codigos tipo ME229272, AY500MT002, etc.
  return String(v ?? "")
    .trim()
    .toUpperCase()
    .replace(/\s+/g,"")
    .replace(/[^A-Z0-9]/g,"");
}

function uniqueJoin_(arr, sep=" / "){
  const out = [];
  const seen = new Set();
  for(const x of (arr||[])){
    const v = String(x ?? "").trim();
    if(!v) continue;
    const k = v.toUpperCase();
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(v);
  }
  return out.join(sep);
}


  async function resolveOriginals_(codeNorm){
    let all = [];
    for(const t of CAMBIOS_TABLES){
      const { data, error } = await supabase
        .from(t)
        .select("original_norm")
        .or(`original_norm.eq.${codeNorm},cambio_norm.eq.${codeNorm}`)
        .limit(5000);
      if(error) throw error;
      all = all.concat(data || []);
    }

    const originals = unique_((all || []).map(x => x.original_norm).filter(Boolean));
    if(originals.length === 0) return [codeNorm];
    return originals;
  }

  async function fetchCambiosByOriginals_(originalNorms){
  let all = [];
  for(const t of CAMBIOS_TABLES){
    const { data, error } = await supabase
      .from(t)
      .select("cambio, owner, posicion")
      .in("original_norm", originalNorms)
      .limit(5000);
    if(error) throw error;
    all = all.concat(data || []);
  }

  // âœ… DEDUPE FUERTE: 1 fila por "cambio" (sin importar owner)
  // âœ… Si hay varios owner, los unimos en un solo campo
  const map = new Map(); // key=cambioNorm -> { cambio, owners:Set, posicion }
  for(const r of (all || [])){
    const cambioRaw = (r?.cambio ?? "");
    const key = normCodeCell_(cambioRaw);
    if(!key) continue;

    if(!map.has(key)){
      map.set(key, {
        cambio: String(cambioRaw || "").trim(),
        owners: new Set(),
        posicion: String(r?.posicion || "").trim()
      });
    }
    const obj = map.get(key);
    const owner = String(r?.owner || "").trim();
    if(owner) obj.owners.add(owner);

    // si una posicion viene vacia y otra no, guarda la mejor
    const pos = String(r?.posicion || "").trim();
    if(!obj.posicion && pos) obj.posicion = pos;
  }

  let merged = Array.from(map.values()).map(x => ({
    cambio: x.cambio,
    owner: uniqueJoin_(Array.from(x.owners), " / "),
    posicion: x.posicion
  }));

  // orden simple
  merged.sort((a,b)=>{
    const pa = String(a?.posicion||"");
    const pb = String(b?.posicion||"");
    if(pa && pb && pa !== pb) return pa.localeCompare(pb);
    return String(a?.cambio||"").localeCompare(String(b?.cambio||""));
  });

  const rows = merged.map(r => ([
    r.cambio || "",
    r.owner || ""
  ]));

  return { headers: ["cambio", "owner"], rows };
}


  
  // ======================================================
  // âœ… SIMILITUD: sugerir codigos parecidos cuando no hay match
  //  - Estrategia simple:
  //    1) Tomar prefijo (ej: A2761800) del codigo normalizado
  //    2) Buscar original_norm que empiecen por ese prefijo en VEH_TABLES
  //    3) Dedupe + limitar a 10 sugerencias
  // ======================================================
  async function fetchSimilitudByPrefix_(normalized){
    const norm = String(normalized || "").trim().toUpperCase();
    if(!norm) return [];

    const prefLen = Math.min(8, norm.length);
    const prefix = norm.slice(0, prefLen);
    if(prefix.length < 4) return [];

    const selectCols = "original, original_norm, descripcion, vehiculo, modelo, anio_inicio, anio_final";
    let all = [];

    for(const t of VEH_TABLES){
      const { data, error } = await supabase
        .from(t)
        .select(selectCols)
        .ilike("original_norm", prefix + "%")
        .limit(40);

      if(error) throw error;
      all = all.concat(data || []);
    }

    if(all.length === 0) return [];

    const seen = new Set();
    const out = [];
    for(const r of all){
      const k = String(r?.original_norm || "").trim().toUpperCase();
      if(!k || seen.has(k)) continue;
      seen.add(k);
      {
      const disp = String(r?.original ?? "").toString().trim() || k;
      out.push({
        code: disp,          // mostrar ORIGINAL (con guiones)
        code_norm: k,        // mantener original_norm para dedupe/uso interno si hace falta
        desc: (r?.descripcion ?? "").toString().trim(),
        vehiculo: (r?.vehiculo ?? "").toString().trim(),
        modelo: (r?.modelo ?? "").toString().trim(),
        from: r?.anio_inicio ?? "",
        to: r?.anio_final ?? ""
      });
      if(out.length >= 10) break;
    }
    }
    return out;
  }

  function renderSimilitud_(items, searchedNorm){
    const wrap = document.getElementById("simWrap");
    const pill = document.getElementById("pillSimCount");
    const hint = document.getElementById("simHint");
    if(pill) pill.textContent = String((items||[]).length);

    if(!wrap) return;

    if(!items || items.length === 0){
      wrap.innerHTML = '<div class="muted">No hay sugerencias.</div>';
      if(hint) hint.textContent = "No encontramos coincidencia exacta. Si existen codigos parecidos, apareceran aqui.";
      return;
    }

    if(hint) hint.textContent = `No encontramos "${String(searchedNorm||"").toUpperCase()}". Te sugerimos estos codigos similares:`;

    const rows = items.map(it=>{
      const title = escapeHtml_(it.code);
      const sub = [it.vehiculo, it.modelo, (it.from||it.to) ? `${it.from||""}-${it.to||""}` : ""].filter(Boolean).join(" Â· ");
      const desc = it.desc ? `<div class="muted" style="margin-top:4px">${escapeHtml_(it.desc)}</div>` : "";
      const subHtml = sub ? `<div class="muted" style="margin-top:4px">${escapeHtml_(sub)}</div>` : "";
      return `
        <div class="row" style="justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid rgba(20,28,45,.08)">
          <div style="min-width:0">
            <div style="font-weight:900">${title}</div>
            ${subHtml}
            ${desc}
          </div>
          <div style="flex:0 0 auto">
            <button class="btn2" onclick="useSimilarCode_('${escapeJs_(it.code)}')">Usar</button>
          </div>
        </div>
      `;
    }).join("");

    wrap.innerHTML = `<div>${rows}</div>`;
  }

  window.useSimilarCode_ = async function(code){
    try{
      const ci = document.getElementById("code");
      if(ci){
        ci.value = String(code||"").toUpperCase();
        ci.focus();
      }
      if(typeof window.buscar === 'function') { await window.window.buscar && window.buscar(); } else { try{ document.getElementById('btnBuscar')?.click(); }catch(e){} }
      try{ toggleAcc('cardSimilitud', false); }catch(e){}
      try{ toggleAcc('cardProducto', true); }catch(e){}
    }catch(e){}
  }


  function escapeJs_(s){
    return String(s ?? "").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
  }



async function fetchVehiclesByOriginals_(originalNorms){
  // Solo traemos columnas necesarias (y descripcion)
  const selectCols = "vehiculo, anio_inicio, anio_final, modelo, motor, serie, cilindro, posicion, version, descripcion, original_norm";

  let all = [];
  for(const t of VEH_TABLES){
    const { data, error } = await supabase
      .from(t)
      .select(selectCols)
      .in("original_norm", originalNorms)
      .limit(5000);

    if(error) throw error;
    all = all.concat(data || []);
  }

  if(all.length === 0) return { headers: [], rows: [] };

  // âœ… 1) Sacar una descripcion "canon" del grupo (si existe al menos 1)
  const canonDesc = (all.find(r => String(r?.descripcion ?? "").trim() !== "")?.descripcion ?? "").toString().trim();

  // âœ… 2) Dedupe para no repetir la misma fila si existe en v1 y v2
      all = dedupeByKey_(all, r => [
      r.vehiculo,
      r.anio_inicio,
      r.anio_final,
      r.modelo,
      r.motor,
      r.serie,
      r.cilindro,
      r.posicion,
      r.version,
      r.descripcion
    ].map(normCell_).join("|"));


  // âœ… 3) Orden base: vehiculo, modelo, anio_inicio
  all.sort((a,b)=>{
    const va = String(a?.vehiculo||"");
    const vb = String(b?.vehiculo||"");
    if(va !== vb) return va.localeCompare(vb);
    const ma = String(a?.modelo||"");
    const mb = String(b?.modelo||"");
    if(ma !== mb) return ma.localeCompare(mb);
    const ya = Number(a?.anio_inicio || 0);
    const yb = Number(b?.anio_inicio || 0);
    return ya - yb;
  });

  // âœ… 4) Aplicar la descripcion canon a todas las filas (si existe)
  if(canonDesc){
    for(const r of all){
      const cur = String(r?.descripcion ?? "").trim();
      if(!cur) r.descripcion = canonDesc;
    }
  }

  // âœ… Headers EXACTOS
  const headersKeys = [
    "vehiculo","anio_inicio","anio_final","modelo","motor","serie","cilindro","posicion","version","descripcion"
  ];

  const headerLabel = (k) => {
    if(k === "anio_inicio") return "AÃ±o inicio";
    if(k === "anio_final") return "AÃ±o final";
    if(k === "vehiculo") return "Vehiculo";
    if(k === "modelo") return "Modelo";
    if(k === "motor") return "Motor";
    if(k === "serie") return "Serie";
    if(k === "cilindro") return "Cilindro";
    if(k === "posicion") return "Posicion";
    if(k === "version") return "Version";
    if(k === "descripcion") return "Descripcion";
    return k.replace(/_/g," ").replace(/^./, c => c.toUpperCase());
  };

  const headers = headersKeys.map(headerLabel);
  const rows = all.map(obj => headersKeys.map(k => (obj?.[k] ?? "")));

  return { headers, rows };
}


  // ======================================================

  
  // ======================================================
  // âœ… Buscador Vehicular (consulta real a Supabase)
  //  - Vehiculo / Modelo / Motor / Descripcion: ilike "%texto%"
  //  - AÃ±o: match si anio_inicio <= aÃ±o <= anio_final
  //  - Busca en ambas tablas de VEH_TABLES y hace dedupe
  // ======================================================

  function strNorm_(v){ return String(v ?? "").trim().toLowerCase(); }

  function readFiltro_(){
    const vehiculo = strNorm_(document.getElementById("fVehiculo")?.value);
    const modelo   = strNorm_(document.getElementById("fModelo")?.value);
    const motor    = strNorm_(document.getElementById("fMotor")?.value);
    const desc     = strNorm_(document.getElementById("fDescripcion")?.value);

    const anioRaw  = strNorm_(document.getElementById("fAnio")?.value);
    const anioNum  = anioRaw ? Number(anioRaw.replace(/[^0-9]/g,"")) : null;

    const anio = (anioNum && Number.isFinite(anioNum)) ? anioNum : null;
    const hasAny = !!(vehiculo || modelo || motor || desc || anio);
    return { vehiculo, modelo, motor, desc, anio, hasAny };
  }

  function setFiltroPill_(txt, hint){
    const pill = document.getElementById("pillFiltroEstado");
    const hintEl = document.getElementById("filtroHint");
    if(pill) pill.textContent = txt || "Sin filtro";
    if(hintEl){
      if(hint){
        hintEl.style.display = "inline";
        hintEl.textContent = hint;
      }else{
        hintEl.style.display = "none";
        hintEl.textContent = "";
      }
    }
  }

  async function fetchVehiclesByFilters_(f){
    const selectCols = "vehiculo, anio_inicio, anio_final, modelo, motor, serie, cilindro, posicion, version, descripcion, original_norm";

    let all = [];
    for(const t of VEH_TABLES){
      let q = supabase.from(t).select(selectCols).limit(5000);

      if(f.vehiculo) q = q.ilike("vehiculo", "%" + f.vehiculo + "%");
      if(f.modelo)   q = q.ilike("modelo",   "%" + f.modelo   + "%");
      if(f.motor)    q = q.ilike("motor",    "%" + f.motor    + "%");
      if(f.desc)     q = q.ilike("descripcion", "%" + f.desc  + "%");

      if(f.anio){
        // match por rango: inicio <= aÃ±o <= final
        q = q.lte("anio_inicio", f.anio).gte("anio_final", f.anio);
      }

      const { data, error } = await q;
      if(error) throw error;
      all = all.concat(data || []);
    }

    if(all.length === 0) return { headers: [], rows: [] };

    // Dedupe (si existe en v1 y v2)
    all = dedupeByKey_(all, r => [
      r.vehiculo, r.anio_inicio, r.anio_final, r.modelo, r.motor,
      r.serie, r.cilindro, r.posicion, r.version, r.descripcion
    ].map(normCell_).join("|"));

    // Orden base
    all.sort((a,b)=>{
      const va = String(a?.vehiculo||"");
      const vb = String(b?.vehiculo||"");
      if(va !== vb) return va.localeCompare(vb);
      const ma = String(a?.modelo||"");
      const mb = String(b?.modelo||"");
      if(ma !== mb) return ma.localeCompare(mb);
      return (Number(a?.anio_inicio||0) - Number(b?.anio_inicio||0));
    });

    const headersKeys = ["vehiculo","anio_inicio","anio_final","modelo","motor","serie","cilindro","posicion","version","descripcion","original_norm"];
    const headerLabel = (k)=>{
      if(k === "vehiculo") return "Vehiculo";
      if(k === "anio_inicio") return "AÃ±o inicio";
      if(k === "anio_final")  return "AÃ±o final";
      if(k === "modelo") return "Modelo";
      if(k === "motor") return "Motor";
      if(k === "serie") return "Serie";
      if(k === "cilindro") return "Cilindro";
      if(k === "posicion") return "Posicion";
      if(k === "version") return "Version";
      if(k === "descripcion") return "Descripcion";
      if(k === "original_norm") return "Codigo principal";
      return k.replace(/_/g," ").replace(/^./, c => c.toUpperCase());
    };

    const headers = headersKeys.map(headerLabel);
    const rows = all.map(obj => headersKeys.map(k => (obj?.[k] ?? "")));

    return { headers, rows };
  }

  window.aplicarFiltroVehicular = async function(){
    const filtro = readFiltro_();
    if(!filtro.hasAny){
      setFiltroPill_("Sin filtro");
      alert("Escribe al menos un campo para buscar.");
      return;
    }

    // Si ya hay resultado OEM cargado, filtra SOLO eso (mÃ¡s rÃ¡pido)
    if(lastPayload && lastPayload.tablas && lastPayload.tablas.vehicles_full){
      const base = lastPayload.tablas.vehicles_full;
      // Filtrado client-side usando los mismos headers esperados
      const idxVeh = base.headers.findIndex(h => String(h).toLowerCase().includes("vehiculo"));
      const idxY1  = base.headers.findIndex(h => String(h).toLowerCase().includes("aÃ±o inicio") || String(h).toLowerCase().includes("anio inicio"));
      const idxY2  = base.headers.findIndex(h => String(h).toLowerCase().includes("aÃ±o final")  || String(h).toLowerCase().includes("anio final"));
      const idxMod = base.headers.findIndex(h => String(h).toLowerCase().includes("modelo"));
      const idxMot = base.headers.findIndex(h => String(h).toLowerCase().includes("motor"));
      const idxDes = base.headers.findIndex(h => String(h).toLowerCase().includes("descripcion") || String(h).toLowerCase().includes("descripciÃ³n") || String(h).toLowerCase().includes("description"));

      const rows = (base.rows||[]).filter(r=>{
        const vVeh = idxVeh>=0 ? strNorm_(r[idxVeh]) : "";
        const vMod = idxMod>=0 ? strNorm_(r[idxMod]) : "";
        const vMot = idxMot>=0 ? strNorm_(r[idxMot]) : "";
        const vDes = idxDes>=0 ? strNorm_(r[idxDes]) : "";

        if(filtro.vehiculo && !vVeh.includes(filtro.vehiculo)) return false;
        if(filtro.modelo && !vMod.includes(filtro.modelo)) return false;
        if(filtro.motor && !vMot.includes(filtro.motor)) return false;
        if(filtro.desc && !vDes.includes(filtro.desc)) return false;

        if(filtro.anio && (idxY1>=0 || idxY2>=0)){
          const y1 = idxY1>=0 ? Number(String(r[idxY1]??"").replace(/[^0-9]/g,"")) : NaN;
          const y2 = idxY2>=0 ? Number(String(r[idxY2]??"").replace(/[^0-9]/g,"")) : NaN;
          if(Number.isFinite(y1) && Number.isFinite(y2)){
            if(!(filtro.anio >= y1 && filtro.anio <= y2)) return false;
          }
        }
        return true;
      });

      // âœ… Cuando se filtra por Vehiculo/AÃ±o/Modelo/Motor/Descripcion, mostramos "Codigo principal"
      const principal = (lastPayload?.original_norms && lastPayload.original_norms[0]) ? String(lastPayload.original_norms[0]) :
                        (lastPayload?.codigo_norm ? String(lastPayload.codigo_norm) : (lastPayload?.codigo ? String(lastPayload.codigo) : ""));
      const headers2 = base.headers.concat(["Codigo principal"]);
      const rows2 = rows.map(r => (r || []).concat([principal]));
      const filtered = { headers: headers2, rows: rows2 };
      lastPayload.tablas.vehicles = filtered;
      renderTableInto_("vehWrap", filtered);
      renderVehicleLogos_(filtered);
document.getElementById("btnCopyVeh").disabled = !(rows.length>0);
      document.getElementById("counts").textContent =
        "Vehicles: " + rows.length + " | Cambios: " + ((lastPayload.tablas?.cambios?.rows||[]).length || 0);

      document.getElementById("btnExport").disabled = rows.length===0 && ((lastPayload.tablas?.cambios?.rows||[]).length||0)===0;

      const used = [];
      if(filtro.vehiculo) used.push("Vehiculo");
      if(filtro.anio) used.push("AÃ±o");
      if(filtro.modelo) used.push("Modelo");
      if(filtro.motor) used.push("Motor");
      if(filtro.desc) used.push("Descripcion");
      setFiltroPill_("Filtro activo", "Campos: " + used.join(", "));
      return;
    }

    // Si no hay OEM cargado => buscar directo en BD
    setStatus("Buscando vehiculos...");

    try{
      const veh = await fetchVehiclesByFilters_(filtro);

      lastPayload = {
        codigo: "FILTRO_VEHICULAR",
        productUrl: buildGoogleUrl_("vehiculo " + (filtro.vehiculo||"")),
        tablas: { vehicles: veh, cambios: { headers: [], rows: [] }, vehicles_full: veh }
      };

      renderTableInto_("vehWrap", veh);
      renderVehicleLogos_(veh);
renderTableInto_("oeWrap", { headers: [], rows: [] });

      const vehCount = (veh?.rows||[]).length;

      document.getElementById("pillCode").textContent = "Filtro Vehicular";
      document.getElementById("counts").textContent = "Vehicles: " + vehCount + " | Cambios: 0";
      document.getElementById("btnCopyVeh").disabled = vehCount===0;
      document.getElementById("btnCopyOE").disabled = true;
      document.getElementById("btnExport").disabled = vehCount===0;

      const used = [];
      if(filtro.vehiculo) used.push("Vehiculo");
      if(filtro.anio) used.push("AÃ±o");
      if(filtro.modelo) used.push("Modelo");
      if(filtro.motor) used.push("Motor");
      if(filtro.desc) used.push("Descripcion");
      setFiltroPill_(vehCount? "Filtro activo" : "Sin resultados", "Campos: " + used.join(", "));

      setStatus("Listo âœ…");
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e?.message || e));
      alert("Error buscando en BD: " + (e?.message || e));
    }finally{
      __isSearching = false;
      try{ const b=document.getElementById('btnBuscarCodigo'); if(b) b.disabled=false; }catch(e){}
    }
  };

  window.limpiarFiltroVehicular = function(){
    ["fVehiculo","fAnio","fModelo","fMotor","fDescripcion"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
    setFiltroPill_("Sin filtro");

    if(lastPayload && lastPayload.tablas && lastPayload.tablas.vehicles_full){
      lastPayload.tablas.vehicles = lastPayload.tablas.vehicles_full;
      renderTableInto_("vehWrap", lastPayload.tablas.vehicles_full);
      renderVehicleLogos_(lastPayload.tablas.vehicles_full);
const vehCount = (lastPayload.tablas.vehicles_full?.rows||[]).length;
      const cambCount = (lastPayload.tablas?.cambios?.rows||[]).length;

      document.getElementById("btnCopyVeh").disabled = vehCount===0;
      document.getElementById("counts").textContent = "Vehicles: " + vehCount + " | Cambios: " + cambCount;
      document.getElementById("btnExport").disabled = (vehCount===0 && cambCount===0);
    }
  };

  // âœ… Click en "Codigo principal" (desde tabla Vehicles por filtros)
  window.buscarCodigoPrincipal = async function(code){
    const c = String(code || "").trim();
    if(!c) return;
    const input = document.getElementById("code");
    if(input) input.value = c;
    // lleva al buscador de codigo arriba
    try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
    // ejecutar busqueda OEM
    try{
      await window.window.buscar && window.buscar();
    }catch(e){
      // fallback
      const btn = document.querySelector('button[onclick*="buscar"]');
      if(btn) btn.click();
    }
  };



window.limpiar = function(){
    lastPayload = null;
    document.getElementById("btnExport").disabled = true;
    document.getElementById("btnCopyOE").disabled = true;
    document.getElementById("btnCopyVeh").disabled = true;

    document.getElementById("pillCode").textContent = "-";
    document.getElementById("productUrl").textContent = "-";
    document.getElementById("productUrl").href = "#";
    document.getElementById("counts").textContent = "Vehicles: 0 | Cambios: 0";
    const ow = document.getElementById("offersWrap");
    if(ow){ ow.style.display="none"; ow.innerHTML=""; }
    lastOffers = [];
    document.getElementById("notes").textContent = "";

    document.getElementById("oeWrap").innerHTML = "No hay filas detectadas.";
    document.getElementById("vehWrap").innerHTML = "No hay filas detectadas.";

    setStatus("Listo");
    if(isMobile_()) setMobileDefault_();
  };

    window.buscar = async function(){
  const t0 = performance.now();
  const searchId = startSearchGuard_("buscar");

  const raw0 = (document.getElementById("code")?.value || "").trim();
  const raw = raw0.toUpperCase();
  try{ const ci=document.getElementById("code"); if(ci) ci.value = raw; }catch(e){}
  if(!raw){
    setStatus("Escribe un codigo.");
    endSearchGuard_();
    return;
  }

  // Asegura que el pais/ciudad del perfil esten cargados (para guardar country en search_events)
  try{ await ensureMarketLoaded_(); }catch(e){}

  // Marcamos como buscando solo para mostrar estado/spinner, pero NO queremos bloquear nuevas busquedas por mucho tiempo.
  window.__isSearching = true;
  try{ const b=document.getElementById('btnBuscarCodigo'); if(b) b.disabled=true; }catch(e){}
  setStatus("Buscando...");

  const norm = normalizeCode_(raw);

  let released = false;
  const releaseUI_ = () => {
    if(released) return;
    released = true;
    if(isSearchStale_(searchId)) return; // solo el ultimo puede liberar UI
    window.__isSearching = false;
    try{ const b=document.getElementById('btnBuscarCodigo'); if(b) b.disabled=false; }catch(e){}
    try{
      const st = (document.getElementById("status")?.textContent || "");
      if(st.toLowerCase().includes("buscando")) setStatus("Listo âœ…");
    }catch(e){}
    endSearchGuard_();
  };

  try{
    if(isSearchStale_(searchId)) { releaseUI_(); return; }

    const codigoMostrado = raw;

    // 1) ORIGINALS (con fallback para evitar que se quede pegado)
    let originalNorms = [norm];
    try{
      originalNorms = await retryWithTimeout_(
        () => resolveOriginals_(norm),
        { timeoutMs: 45000, label: 'originals', retries: 1 }
      );
      if(!Array.isArray(originalNorms) || originalNorms.length === 0) originalNorms = [norm];
    }catch(e){
      console.warn("resolveOriginals_ fallo/timeout, usando fallback:", e);
      originalNorms = [norm];
    }

    if(isSearchStale_(searchId)) { releaseUI_(); return; }

    // 2) VEHICLES + CAMBIOS (si falla/timeout, devolvemos vacio y seguimos; no queremos colgar la app)
    let veh = { headers: [], rows: [] };
    let camb = { headers: [], rows: [] };
    try{
      const res = await retryWithTimeout_(
        () => Promise.all([
          fetchVehiclesByOriginals_(originalNorms),
          fetchCambiosByOriginals_(originalNorms),
        ]),
        { timeoutMs: 60000, label: 'vehicles/cambios', retries: 0 }
      );
      veh = res?.[0] || veh;
      camb = res?.[1] || camb;
    }catch(e){
      console.warn("vehicles/cambios fallo/timeout, continuando con vacio:", e);
    }

    if(isSearchStale_(searchId)) { releaseUI_(); return; }

    const payload = {
      codigo: codigoMostrado,
      codigo_norm: norm,
      original_norms: originalNorms,
      productUrl: buildGoogleUrl_(codigoMostrado),
      tablas: { vehicles: veh, cambios: camb }
    };

    // 3) Render principal (esto es lo importante). Una vez renderiza, LIBERAMOS la UI.
    render(payload);

    const vehCount = (veh && Array.isArray(veh.rows)) ? veh.rows.length : 0;
    const cambCount = (camb && Array.isArray(camb.rows)) ? camb.rows.length : 0;
    const totalResults = vehCount + cambCount;
    const resultStatus = totalResults > 0 ? "found" : "not_found";

    // âœ… Limpiar inputs y liberar UI INMEDIATAMENTE al terminar el render principal
    clearInputsAfterCodeSearch_();
    setStatus(totalResults > 0 ? "Listo âœ…" : "Sin resultados (Listo âœ…)");
    releaseUI_();

    // 4) Tareas secundarias en background (NO deben bloquear el proximo buscar)
    //    - Ofertas (si no hay, simplemente no muestra nada)
    //    - Similitud solo si no hay resultados
    //    - Log del evento (si falla, no molesta)
    setTimeout(async ()=>{
      // si ya hay otra busqueda activa, no hacemos nada
      if(isSearchStale_(searchId)) return;

      // Ofertas activas
      try{
        lastOffersError = '';
        const offers = await retryWithTimeout_(
          ()=> fetchOffersByOriginals_(originalNorms, norm),
          { timeoutMs: 20000, label: 'offers', retries: 0 }
        );
        if(!isSearchStale_(searchId)){
          lastOffers = offers;
          renderOffersIntoProducto_(lastOffers);
        }
      }catch(e){
        lastOffers = [];
        lastOffersError = (e?.message || String(e||""));
        if(!isSearchStale_(searchId)) renderOffersIntoProducto_([]);
      }

      // Similitud (solo si no hubo resultados)
      if(!isSearchStale_(searchId) && resultStatus === "not_found"){
        try{
          const sim = await retryWithTimeout_(
            ()=> fetchSimilitudByPrefix_(norm),
            { timeoutMs: 15000, label: 'similitud', retries: 0 }
          );
          if(!isSearchStale_(searchId)){
            renderSimilitud_(sim, norm);
            try{ toggleAcc('cardSimilitud', true); }catch(e){}
          }
        }catch(e){
          try{ renderSimilitud_([], norm); }catch(_){}
        }
      }else{
        try{ if(!isSearchStale_(searchId)) renderSimilitud_([], norm); }catch(e){}
      }

      // Log (background)
      try{
        const pos = extractBestPosition_(veh);
        const catFromPos = classifyCategoryFromPosition_(pos);
        const category = catFromPos || classifyCategory_(raw);
        const vehSummary = extractVehicleSummary_(veh);
        const responseMs = Math.round(performance.now() - t0);

        safeLogSearchEvent_({
          queryRaw: raw,
          queryType: "oem",
          normalizedQuery: norm,
          category,
          resultStatus,
          resultsCount: totalResults,
          responseTimeMs: responseMs,
          meta: {
            original_norms_count: Array.isArray(originalNorms) ? originalNorms.length : 0,
            vehicles_count: vehCount,
            cambios_count: cambCount,
            position_sample: pos || null,
            category_source: catFromPos ? "posicion" : "query",
            vehicle_make: vehSummary?.make || null,
            vehicle_model: vehSummary?.model || null,
            vehicle_year_from: vehSummary?.year_from || null,
            vehicle_year_to: vehSummary?.year_to || null,
            vehicle_engine: vehSummary?.engine || null,
            vehicle_serie: vehSummary?.serie || null,
            used_vehicle_tables: VEH_TABLES,
            used_cambios_tables: CAMBIOS_TABLES
          }
        });
      }catch(e){
        // no-op
      }
    }, 0);

  }catch(e){
    console.error(e);
    if(!isSearchStale_(searchId)){
      // Evitar alertas que "bloqueen" la app. Solo status.
      setStatus("Error consultando (se libero la app): " + (e && e.message ? e.message : e));
    }

    try{
      safeLogSearchEvent_({
        queryRaw: raw,
        queryType: "oem",
        normalizedQuery: norm,
        category: classifyCategory_(raw),
        resultStatus: "unknown",
        resultsCount: 0,
        responseTimeMs: Math.round(performance.now() - t0),
        meta: { error: (e && e.message) ? e.message : String(e) }
      });
    }catch(_){}

  }finally{
    // Asegura liberar aunque algo raro pase
    releaseUI_();
  }
};

  // ======================================================
  // âœ… Ofertas: buscar y renderizar debajo de Vehicles/Cambios
  // ======================================================

  function fmtMoney_(n){
    const v = Number(n);
    return Number.isFinite(v) ? v.toFixed(2) : String(n ?? "â€”");
  }

function isOfferActive_(o){
  const exp = o?.expires_at;
  if(!exp) return true; // si no tiene expiracion, la tratamos como activa
  const t = new Date(exp).getTime();
  if(!Number.isFinite(t)) return true;
  return t > Date.now();
}


  async function fetchOffersByOriginals_(originalNorms, codeNorm){
  // âœ… NO mostrar ofertas vencidas:
  //    - Activa si expires_at es NULL, o expires_at > ahora
  const norms = unique_([...(originalNorms||[]), codeNorm].filter(Boolean));
  const selectCols = "id, original, original_norm, brand, description, price, currency, country, expires_at, seller_id, created_at";

  const nowIso = new Date().toISOString();

  try{
    let q = supabase
      .from(OFFERS_TABLE)
      .select(selectCols)
      .in("original_norm", norms)
      .or(`expires_at.is.null,expires_at.gt.${nowIso}`)
      .order("created_at", { ascending: false })
      .limit(25);

    const { data, error } = await q;
    if(error){
      // fallback si la tabla no tiene created_at u order falla
      const { data: d2, error: e2 } = await supabase
        .from(OFFERS_TABLE)
        .select(selectCols)
        .in("original_norm", norms)
        .or(`expires_at.is.null,expires_at.gt.${nowIso}`)
        .limit(25);
      if(e2) throw e2;
      return (d2 || []);
    }
    return (data || []);
  }catch(e){
    lastOffersError = (e?.message || String(e||''));
    console.warn("No pude leer ofertas:", lastOffersError);
    return [];
  }
}

  function renderOffersIntoProducto_(offers){
    const wrap = document.getElementById("offersWrap");
    if(!wrap) return;

    // âœ… Seguridad extra: filtrar vencidas en el cliente tambien
    offers = (offers || []).filter(isOfferActive_);

    if(!offers || offers.length === 0){
      // Si hubo error (ej: RLS bloqueando), mostramos pista
      if(lastOffersError){
        wrap.style.display = "block";
        wrap.innerHTML = '<div class="offerRow"><div class="offerTitle">Ofertas</div></div>'
          + '<div style="margin-top:8px;background:#fff3cd;border:1px solid #ffeeba;border-radius:12px;padding:10px">'
          + '<b>No pude leer ofertas.</b> Posible RLS (policies) o permisos.<br/>'
          + '<span style="font-size:12px;opacity:.9">Detalle: ' + escapeHtml_(lastOffersError) + '</span>'
          + '</div>';
        return;
      }
      wrap.style.display = "none";
      wrap.innerHTML = "";
      return;
    }

    wrap.style.display = "block";

    let html = '';
    html += '<div class="offerRow">';
    html += '  <div class="offerTitle">Ofertas activas (' + offers.length + ')</div>';
    html += '  <div class="offerMeta"><span class="offerTag">Solo ves: Marca + Precio + Pais</span></div>';
    html += '</div>';

    html += '<div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">';
    for(const o of offers){
      const id = o?.id || "";
      const brand = escapeHtml_(o?.brand || "â€”");
      const price = escapeHtml_(fmtMoney_(o?.price));
      const currency = escapeHtml_(o?.currency || "â€”");
      const country = escapeHtml_(o?.country || "â€”");
      const exp = o?.expires_at ? escapeHtml_(String(o.expires_at).replace("T"," ").slice(0,19)) : "â€”";

      html += '<div style="background:#fff;border:1px solid #eef0f6;border-radius:12px;padding:10px">';
      html += '  <div class="offerRow">';
      html += '    <div class="offerMeta">';
      html += '      <span class="offerTag">Marca: ' + brand + '</span>';
      html += '      <span class="offerTag">Precio: ' + price + ' ' + currency + '</span>';
      html += '      <span class="offerTag">Pais: ' + country + '</span>';
      html += '      <span class="offerTag">Expira: ' + exp + '</span>';
      html += '    </div>';
      html += '    <div style="display:flex;gap:8px;flex-wrap:wrap">';
      html += '      <button class="offerBtn offerBtnPrimary" data-offer-id="' + escapeHtml_(id) + '" onclick="openOfferModalById(\'' + escapeHtml_(id) + '\')">Ver / Chat</button>';
      html += '    </div>';
      html += '  </div>';
      html += '</div>';
    }
    html += '</div>';

    wrap.innerHTML = html;
  }

  function openOfferModal_(offer){
    modalOffer = offer || null;
    const back = document.getElementById("offerModalBack");
    const status = document.getElementById("offerModalStatus");
    const msg = document.getElementById("mOfferMsg");

    if(status) status.textContent = "";
    if(msg) msg.value = "";

    const oem = offer?.original || offer?.original_norm || "-";
    const brand = offer?.brand || "â€”";
    const price = fmtMoney_(offer?.price);
    const currency = offer?.currency || "â€”";
    const country = offer?.country || "â€”";
    const exp = offer?.expires_at ? String(offer.expires_at).replace("T"," ").slice(0,19) : "â€”";

    document.getElementById("offerModalTitle").textContent = "Oferta disponible";
    document.getElementById("offerModalSub").textContent = "Consulta al vendedor por esta oferta.";
    document.getElementById("mOfferOEM").textContent = oem;
    document.getElementById("mOfferBrand").textContent = brand;
    document.getElementById("mOfferPrice").textContent = price;
    document.getElementById("mOfferCurrency").textContent = currency;
    document.getElementById("mOfferCountry").textContent = country;
    document.getElementById("mOfferExpires").textContent = exp;

    if(back){
      back.style.display = "flex";
      back.setAttribute("aria-hidden","false");
    }

    // âœ… Bloquear/permitir mensajeria segun sesion
    updateOfferModalAuthUI_();
  }

  function closeOfferModal_(){
    const back = document.getElementById("offerModalBack");
    if(back){
      back.style.display = "none";
      back.setAttribute("aria-hidden","true");
    }
    modalOffer = null;
  }

  // Exponer para onclick en HTML (script type=module)
  window.openOfferModalById = function(offerId){
    const o = (lastOffers || []).find(x => String(x?.id||"") === String(offerId||""));
    if(!o){ alert("No pude abrir la oferta. (id no encontrado)"); return; }
    openOfferModal_(o);
  };

  async function notifyOfferInterest_(offerId, note){
    try{
      const { data } = await supabase.auth.getSession();
      const token = data?.session?.access_token;
      if(!token) return;

      // Endpoint oficial de Supabase Functions
      const url = `${SUPABASE_URL}/functions/v1/notify-offer-interest`;

      await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          offer_id: offerId,
          note: note ? String(note).slice(0, 400) : "" // opcional
        })
      });
    }catch(err){
      console.warn("notifyOfferInterest_ fail:", err?.message || err);
    }
  }


  async function getSessionUser_(){
    try{
      const { data } = await supabase.auth.getSession();
      return data?.session?.user || null;
    }catch(e){
      return null;
    }
  }

  async function updateOfferModalAuthUI_(){
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";

    const btnSend  = document.getElementById("btnSendOfferMsg");
    const btnOpen  = document.getElementById("btnOpenOfferChat");
    const btnLogin = document.getElementById("btnLoginToSend");
    const st       = document.getElementById("offerModalStatus");

    if(isDemo){
      if(btnSend) btnSend.disabled = true;
      if(btnOpen) btnOpen.disabled = true;
      if(btnLogin) btnLogin.style.display = "none";
      if(st && !st.textContent) st.textContent = "Modo DEMO: no se pueden enviar mensajes.";
      return;
    }

    const user = await getSessionUser_();
    const isLogged = !!user;

    if(btnSend) btnSend.disabled = !isLogged;
    if(btnOpen) btnOpen.disabled = !isLogged;

    if(btnLogin){
      btnLogin.style.display = isLogged ? "none" : "inline-flex";
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      btnLogin.onclick = () => { window.location.href = "/?stay=1&next=" + next; };
    }

    if(!isLogged){
      if(st && !st.textContent){
        st.textContent = "Para enviar mensajes debes iniciar sesion.";
      }
    }
  }

  async function sendOfferMessage_(text){
    const status = document.getElementById("offerModalStatus");
    const msg = String(text || "").trim();
    if(!msg){ alert("Escribe un mensaje."); return; }

    // DEMO: no permitir
    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get("demo") === "1";
    if(isDemo){
      alert("En modo DEMO no se pueden enviar mensajes.");
      return;
    }

    // Sesion
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    if(!user){
      alert("Debes iniciar sesion para enviar mensajes.");
      const next = encodeURIComponent(window.location.pathname + window.location.search);
      window.location.href = "/?stay=1&next=" + next;
      return;
    }

    const offerId = modalOffer?.id || null;
    const sellerIdFromOffer = modalOffer?.seller_id || null;

    if(!offerId){
      if(status) status.textContent = "No se encontro la oferta.";
      alert("No se encontro la oferta.");
      return;
    }

    try{
      if(status) status.textContent = "Preparando chat...";

      // 1) Buscar chat existente (offer_id + buyer_id)
      let chatId = null;
      {
        const { data: rows, error } = await supabase
          .from(OFFERS_CHATS_TABLE)
          .select("id")
          .eq("offer_id", offerId)
          .eq("buyer_id", user.id)
          .limit(1);

        if(error) throw error;
        if(rows && rows[0]) chatId = rows[0].id;
      }

      // 2) Si no existe chat, lo creamos usando seller_id guardado en la oferta
      if(!chatId){
        if(!sellerIdFromOffer){
          // Si por alguna razon la oferta no trae seller_id, fallback (opcional)
          if(status) status.textContent = "No pude identificar el vendedor. Abriendo chat de ofertas...";
          const q = new URLSearchParams();
          q.set("offer", offerId);
          if(modalOffer?.original_norm) q.set("code", modalOffer.original_norm);
          q.set("msg", msg);
          window.open(OFFERS_CHAT_PAGE + "?" + q.toString(), "_blank");
          alert("No pude identificar el vendedor desde la oferta. Abrimos Obsolescencia en otra pestaÃ±a.");
          return;
        }

        const { data: created, error: eIns } = await supabase
          .from(OFFERS_CHATS_TABLE)
          .insert([{ offer_id: offerId, buyer_id: user.id, seller_id: sellerIdFromOffer }])
          .select("id")
          .single();

        if(eIns) throw eIns;
        chatId = created?.id || null;
      }

      if(!chatId) throw new Error("No pude crear/encontrar el chat.");

      // 3) Insertar mensaje
      if(status) status.textContent = "Enviando mensaje...";
      const { error: e3 } = await supabase
        .from(OFFERS_MESSAGES_TABLE)
        .insert([{ chat_id: chatId, sender_id: user.id, body: msg }]);

      if(e3) throw e3;

      // 4) Notificar interes al vendedor (email + lead realtime)
      await notifyOfferInterest_(offerId, msg);

      if(status) status.textContent = "Mensaje enviado âœ…";
      alert("Mensaje enviado âœ…");
      return;

    }catch(e){
      console.warn("No pude enviar mensaje:", e?.message || e);
      if(status) status.textContent = "No pude enviar: " + (e?.message || "error");
      alert("No pude enviar el mensaje. Revisa RLS/policies de offer_chats y offer_messages.\n\nDetalle: " + (e?.message || e));
    }
  }

  function render(payload){
    lastPayload = payload;

    const codigo = payload.codigo || "-";
    const productUrl = payload.productUrl || buildGoogleUrl_(codigo);

    document.getElementById("pillCode").textContent = codigo;
    document.getElementById("productUrl").textContent = productUrl;
    document.getElementById("productUrl").href = productUrl;

    const vehicles = payload.tablas?.vehicles || null;
    // âœ… Guardar copia completa para filtros
    if(payload.tablas){
      payload.tablas.vehicles_full = vehicles;
    }
    // reset estado del filtro al renderizar una nueva busqueda
    setFiltroPill_("Sin filtro");
    const cambios  = payload.tablas?.cambios  || null;

    renderTableInto_("vehWrap", vehicles);
    renderTableInto_("oeWrap", cambios);

    // Logos de marcas (si existen en assets/logos/autos/)
    renderVehicleLogos_(vehicles);

    const hasVeh = vehicles && Array.isArray(vehicles.rows) && vehicles.rows.length > 0;
    const hasCamb = cambios && Array.isArray(cambios.rows) && cambios.rows.length > 0;

    document.getElementById("btnCopyVeh").disabled = !hasVeh;
    document.getElementById("btnCopyOE").disabled = !hasCamb;

    document.getElementById("counts").textContent =
      "Vehicles: " + (hasVeh ? vehicles.rows.length : 0) +
      " | Cambios: " + (hasCamb ? cambios.rows.length : 0);

    // reset ofertas (se pintan despues en buscar())
    const ow = document.getElementById("offersWrap");
    if(ow){ ow.style.display="none"; ow.innerHTML=""; }
    lastOffers = [];

    document.getElementById("notes").textContent = "";
    document.getElementById("btnExport").disabled = !(hasVeh || hasCamb);

    setStatus("Listo âœ…");
    if(isMobile_()) setMobileDefault_();
  }

  window.copiarVehicles = async function(){
    const vehicles = lastPayload?.tablas?.vehicles || null;
    const tsv = tableToTSV_(vehicles);
    if(!tsv){ alert("No hay Vehicles para copiar."); return; }
    try{
      await navigator.clipboard.writeText(tsv);
      alert("Vehicles copiado âœ… (pega en Excel)");
    }catch(e){
      alert("No pude copiar. (Tu navegador bloqueo el clipboard)");
    }
  };

  window.copiarOE = async function(){
    const cambios = lastPayload?.tablas?.cambios || null;
    const tsv = tableToTSV_(cambios);
    if(!tsv){ alert("No hay Cambios para copiar."); return; }
    try{
      await navigator.clipboard.writeText(tsv);
      alert("Cambios copiado âœ… (pega en Excel)");
    }catch(e){
      alert("No pude copiar. (Tu navegador bloqueo el clipboard)");
    }
  };

  window.exportar = function(){
    if(!lastPayload){ alert("No hay datos para exportar."); return; }

    const codigo = (lastPayload.codigo || "export").toString();
    const vehicles = lastPayload?.tablas?.vehicles || null;
    const cambios  = lastPayload?.tablas?.cambios  || null;

    const parts = [];
    parts.push("CODIGO\t" + codigo);
    parts.push("");
    parts.push("=== VEHICLES ===");
    parts.push(tableToTSV_(vehicles) || "No hay filas");
    parts.push("");
    parts.push("=== CAMBIOS ===");
    parts.push(tableToTSV_(cambios) || "No hay filas");

    const content = parts.join("\n");
    const blob = new Blob([content], { type:"text/tab-separated-values;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "RepuestoFinder_" + codigo.replace(/[^a-zA-Z0-9_-]/g,"_") + ".tsv";
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  // âœ… init
  await initAuth_();

  // âœ… Forzar MAYUSCULA en el input de codigo (a276... => A276...)
  try{
    const codeInput = document.getElementById("code");
    if(codeInput){
      const up = ()=>{
        const s = String(codeInput.value || "");
        const u = s.toUpperCase();
        if(s !== u){
          const p = codeInput.selectionStart;
          const q = codeInput.selectionEnd;
          codeInput.value = u;
          if(typeof p === "number" && typeof q === "number"){
            codeInput.setSelectionRange(p, q);
          }
        }
      };
      codeInput.addEventListener("input", up);
      codeInput.addEventListener("paste", ()=> setTimeout(up, 0));
    }
  }catch(e){}



  // ===== PRESENCIA ONLINE (APP) =====
  const { data: ses } = await supabase.auth.getSession();
  const user = ses?.session?.user;

  if (user) {
    const PRESENCE_CHANNEL = "rf-online-users";

    const presenceChannel = supabase.channel(PRESENCE_CHANNEL, {
      config: { presence: { key: user.id } }
    });

    await presenceChannel.subscribe(async (status) => {
      if (status === "SUBSCRIBED") {
        await presenceChannel.track({
          at: new Date().toISOString(),
          page: "app"
        });
      }
    });
  }

  await loadProfileMarket_();

  supabase.auth.onAuthStateChange(async (event, session) => {
    // âœ… No cerramos la App: solo ajustamos UI y bloqueamos mensajeria si no hay sesion
    await initAuth_();
    await updateOfferModalAuthUI_();
    await loadProfileMarket_();
  });

</script>
</body>
</html>
