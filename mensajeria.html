<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Mensajer√≠a</title>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.94);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
      --r2:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,.15), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(29,78,216,.14), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1240px;margin:0 auto;padding:22px 16px 40px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);background:var(--card);
      border-radius:var(--r2);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:10px;z-index:20;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      box-shadow:0 10px 20px rgba(37,99,235,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--mut)}
    .userbox{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.7);font-size:12px;color:var(--mut)
    }
    .btn2{
      border:1px solid var(--line);cursor:pointer;border-radius:12px;padding:10px 12px;
      background:rgba(255,255,255,.8);color:var(--txt);font-weight:800;
    }
    .btn2:active{transform:translateY(1px)}
    .grid{display:grid;grid-template-columns: 1.25fr .75fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);background:var(--card);
      border-radius:var(--r2);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      padding:14px;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tab{
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:12px;color:var(--mut);
      display:flex;align-items:center;gap:8px;
    }
    .tab.active{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;border-color:transparent}
    .badgeDot{
      min-width:18px;height:18px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:900;
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.35);
      color:var(--bad);
      padding:0 6px;
    }
    .h2{margin:0 0 6px 0;font-size:15px}
    .mut{color:var(--mut);font-size:12px;margin:0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, .ta, select{
      width:100%;
      border:1px solid var(--line);background:rgba(255,255,255,.82);
      border-radius:14px;padding:11px 12px;font-size:14px;outline:none;
    }
    .ta{min-height:120px;resize:vertical}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);background:rgba(255,255,255,.82);
      border-radius:18px;padding:12px;
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:900;font-size:14px;margin:0}
    .meta{font-size:12px;color:var(--mut);margin-top:4px}
    .tagRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tag{
      font-size:11px;font-weight:900;border-radius:999px;padding:6px 9px;
      border:1px solid var(--line);background:rgba(255,255,255,.75);color:var(--mut)
    }
    .tag.pin{border-color:rgba(37,99,235,.25);background:rgba(37,99,235,.10);color:#1d4ed8}
    .tag.closed{border-color:rgba(239,68,68,.22);background:rgba(239,68,68,.10);color:var(--bad)}
    .badge{
      font-size:11px;font-weight:900;border-radius:999px;padding:7px 10px;
      border:1px solid var(--line);background:rgba(255,255,255,.75);color:var(--mut);
      white-space:nowrap;
    }
    .stars{display:flex;gap:4px;align-items:center}
    .star{
      cursor:pointer;
      width:26px;height:26px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      font-size:14px;
    }
    .star.on{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.15)}
    .miniBtn{
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.82);cursor:pointer;font-weight:900;font-size:12px;
    }
    .miniBtn.pri{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;border-color:transparent}
    .miniBtn.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10);color:var(--bad)}
    .miniBtn.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#b45309}
    .miniBtn.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.10);color:var(--ok)}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 620px){ .twoCols{grid-template-columns:1fr} }
    .chat{
      height:360px;overflow:auto;border:1px solid var(--line);
      border-radius:18px;background:rgba(255,255,255,.7);padding:10px;
    }
    .bubble{
      max-width:85%;
      padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      margin:8px 0;
    }
    .bubble.me{
      margin-left:auto;background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.20);
    }
    .bubble .bmeta{font-size:11px;color:var(--mut);margin-top:6px}
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(15,23,42,.92);color:#fff;border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:12px;font-size:12px;display:none;z-index:99;
      max-width:92vw;
    }
    .note{
      font-size:12px;color:var(--mut);line-height:1.35;
      border:1px dashed rgba(100,116,139,.35);
      border-radius:16px;padding:10px 12px;background:rgba(255,255,255,.6);
    }

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(2,6,23,.45);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:50;
    }
    .modal{
      width:min(720px, 96vw);
      border:1px solid var(--line);background:var(--card);
      border-radius:22px;box-shadow:var(--shadow);
      padding:14px;
    }
    .modalHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .modalHead h3{margin:0;font-size:15px}
    .modalHead p{margin:3px 0 0 0;color:var(--mut);font-size:12px}
    .modalBody{margin-top:10px}
    .modalFoot{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
    .inlineHint{font-size:12px;color:var(--mut);margin-top:6px}
    .dangerBox{
      border:1px solid rgba(239,68,68,.25);
      background:rgba(239,68,68,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .okBox{
      border:1px solid rgba(22,163,74,.25);
      background:rgba(22,163,74,.08);
      border-radius:16px;
      padding:10px 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Mensajer√≠a</h1>
          <p class="mut">Foro abierto (etiquetas, fijados/cerrados) + mensajes a admins</p>
        </div>
      </div>

      <div class="userbox">
        <div class="pill" id="who">Cargando sesi√≥n...</div>
        <button class="btn2" id="btnBack">‚Üê Dashboard</button>
        <button class="btn2" id="btnLogout">Salir</button>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tabForum">
            Foro Abierto
            <span class="badgeDot" id="forumNoti" style="display:none">0</span>
          </button>
          <button class="tab" id="tabPrivate">
            Mensaje a Admin
            <span class="badgeDot" id="pmNoti" style="display:none">0</span>
          </button>
          <span class="pill" id="adminPill" style="display:none">ADMIN</span>
        </div>

        <div class="hr"></div>

        <!-- ERROR/STATUS -->
        <div id="statusBox" class="dangerBox" style="display:none;margin-bottom:12px">
          <b>‚ö†Ô∏è Configuraci√≥n incompleta</b>
          <div class="inlineHint" id="statusMsg">...</div>
          <div class="modalFoot" style="justify-content:flex-start;margin-top:8px">
            <button class="miniBtn" id="btnRetry">Reintentar</button>
            <button class="miniBtn pri" id="btnGoIndex">Ir a Dashboard</button>
          </div>
        </div>

        <!-- FORO -->
        <section id="secForum">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 class="h2">Foro Abierto</h2>
              <p class="mut">Publica, comenta y califica (1‚Äì5). Etiquetas para organizar y admin para moderar.</p>
            </div>
            <div class="row">
              <button class="miniBtn pri" id="btnNewPost">+ Nuevo tema</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="twoCols">
            <div class="row">
              <input class="input" id="qForum" placeholder="Buscar por t√≠tulo, contenido o autor..." />
              <button class="miniBtn" id="btnRefreshForum">Actualizar</button>
            </div>
            <div class="row">
              <select id="tagFilter">
                <option value="">Todas las etiquetas</option>
              </select>
              <select id="sortForum">
                <option value="recent">M√°s recientes</option>
                <option value="pinned">Fijados primero</option>
                <option value="top">Mejor calificados</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="list" id="forumList"></div>

          <!-- Post detail -->
          <div class="hr"></div>
          <div id="postDetail" style="display:none">
            <div class="item">
              <div class="itemTop">
                <div style="min-width:0">
                  <p class="title" id="pdTitle">...</p>
                  <div class="meta" id="pdMeta">...</div>
                  <div class="tagRow" id="pdTags"></div>
                </div>
                <div class="row" style="justify-content:flex-end;align-items:flex-start">
                  <div class="badge" id="pdAvg">‚≠ê 0.0</div>
                </div>
              </div>

              <div class="hr"></div>
              <div id="pdBody" style="white-space:pre-wrap;font-size:14px;line-height:1.35"></div>

              <div class="hr"></div>
              <div class="row" style="justify-content:space-between">
                <div class="row">
                  <span class="mut">Tu calificaci√≥n:</span>
                  <div class="stars" id="pdStars"></div>
                  <span class="mut" id="pdYourRate">‚Äî</span>
                </div>

                <div class="row">
                  <button class="miniBtn" id="btnCloseDetail">Cerrar</button>

                  <!-- Admin tools -->
                  <button class="miniBtn ok" id="btnPin" style="display:none">Fijar</button>
                  <button class="miniBtn warn" id="btnToggleClose" style="display:none">Cerrar tema</button>
                  <button class="miniBtn bad" id="btnDeletePost" style="display:none">Eliminar</button>
                </div>
              </div>

              <div class="hr"></div>
              <h3 class="h2" style="margin-top:0">Comentarios</h3>
              <div id="repliesList" class="list"></div>

              <div class="hr"></div>
              <div class="note" id="closedNote" style="display:none">
                Este tema est√° <b>cerrado</b>. Puedes leerlo, pero no se aceptan m√°s comentarios.
              </div>

              <textarea class="ta" id="replyText" placeholder="Escribe tu comentario..."></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px">
                <button class="miniBtn pri" id="btnSendReply">Publicar comentario</button>
              </div>
            </div>
          </div>
        </section>

        <!-- PRIVADO -->
        <section id="secPrivate" style="display:none">
          <div>
            <h2 class="h2">Mensajes privados a Administradores</h2>
            <p class="mut">Crea un hilo y conversa directo con el equipo admin. (Soporte / debate privado)</p>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between">
            <div class="row" style="flex:1">
              <select id="threadSelect">
                <option value="">‚Äî Selecciona un hilo ‚Äî</option>
              </select>
              <button class="miniBtn" id="btnReloadThreads">Actualizar</button>
            </div>
            <button class="miniBtn pri" id="btnNewThread">+ Nuevo hilo</button>
          </div>

          <div class="hr"></div>

          <div class="chat" id="chatBox"></div>

          <div class="row" style="margin-top:10px">
            <input class="input" id="pmText" placeholder="Escribe tu mensaje..." />
            <button class="miniBtn pri" id="btnSendPM">Enviar</button>
          </div>

          <div class="note" style="margin-top:10px">
            <b>Tip:</b> Si es un caso complejo, pega el c√≥digo del repuesto, pa√≠s, marca y contexto.
          </div>
        </section>
      </div>

      <!-- SIDEBAR -->
      <div class="card">
        <h2 class="h2">Reglas r√°pidas</h2>
        <p class="mut" style="margin-bottom:10px">
          Mantengamos esto √∫til: describe el caso, pon contexto y evita datos sensibles.
        </p>

        <div class="item">
          <p class="title">‚úÖ Foro Abierto</p>
          <p class="mut">Ideas, debates, sugerencias y temas generales (con etiquetas).</p>
        </div>
        <div class="item">
          <p class="title">üîí Mensaje a Admin</p>
          <p class="mut">Soporte, casos espec√≠ficos o conversaci√≥n privada.</p>
        </div>
        <div class="item">
          <p class="title">‚≠ê Calificaci√≥n</p>
          <p class="mut">Cada usuario califica 1 vez por post (1‚Äì5). Se muestra promedio.</p>
        </div>
        <div class="item" id="adminBox" style="display:none">
          <p class="title">üõ°Ô∏è Moderaci√≥n (Admin)</p>
          <p class="mut">Fijar temas, cerrar y eliminar spam.</p>
        </div>

        <div class="hr"></div>

        <h2 class="h2">Tu estado</h2>
        <div class="item">
          <p class="mut" id="meInfo">Cargando...</p>
        </div>

        <div class="hr"></div>
        <button class="btn2" id="btnGoHome" style="width:100%">Ir al Dashboard</button>

        <div class="hr"></div>
        <div class="okBox">
          <b>‚úÖ Recomendaci√≥n</b>
          <div class="inlineHint">
            Si algo no carga, revisa que existan en <code>localStorage</code>:
            <code>rf_sb_url</code> y <code>rf_sb_anon</code>.
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL NUEVO POST -->
  <div class="modalBack" id="mPost">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Nuevo tema</h3>
          <p>Publica un tema en el foro con etiquetas.</p>
        </div>
        <button class="miniBtn" id="mPostClose">Cerrar</button>
      </div>

      <div class="modalBody">
        <input class="input" id="newTitle" placeholder="T√≠tulo del tema" />
        <div style="height:10px"></div>
        <textarea class="ta" id="newBody" placeholder="Escribe el contenido..."></textarea>
        <div class="inlineHint">Etiquetas (separadas por coma). Ej: Idea,Bug,Soporte</div>
        <input class="input" id="newTags" placeholder="Idea,Bug,Soporte" />
      </div>

      <div class="modalFoot">
        <button class="miniBtn" id="mPostCancel">Cancelar</button>
        <button class="miniBtn pri" id="mPostSave">Publicar</button>
      </div>
    </div>
  </div>

  <!-- MODAL NUEVO HILO -->
  <div class="modalBack" id="mThread">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Nuevo hilo a Admin</h3>
          <p>Crea un asunto y luego env√≠as mensajes.</p>
        </div>
        <button class="miniBtn" id="mThreadClose">Cerrar</button>
      </div>

      <div class="modalBody">
        <input class="input" id="threadSubject" placeholder="Asunto (ej: Error en b√∫squeda / Necesito soporte)" />
      </div>

      <div class="modalFoot">
        <button class="miniBtn" id="mThreadCancel">Cancelar</button>
        <button class="miniBtn pri" id="mThreadSave">Crear hilo</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG (AJUSTA AQU√ç SI QUIERES FIJO)
========================= */
const DASHBOARD_URL = "index.html";
const LOGIN_URL = "login.html";

/* Si NO quieres usar localStorage, pega aqu√≠ tu Supabase:
const FORCE_SUPABASE_URL = "https://pjkbipdjxxxzjiuyfkaq.supabase.co";
const FORCE_SUPABASE_ANON = "sb_publishable_G7uvRyHNLSew2HKJY_h6ag_M2NZDYx4";
*/
const FORCE_SUPABASE_URL = "https://pjkbipdjxxxzjiuyfkaq.supabase.co";
const FORCE_SUPABASE_ANON = "b_publishable_G7uvRyHNLSew2HKJY_h6ag_M2NZDYx4";

const DEFAULT_TAGS = ["Idea","Bug","Soporte","Compras","Radar","KPIs","Inventario","Ventas","Importacion","General"];

/* =========================
   HELPERS
========================= */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> t.style.display="none", 2600);
}
function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("es-DO",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }catch(e){ return ""; }
}
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function normalizeTags(arr){
  const set = new Set();
  for(const t of (arr||[])){
    const x = String(t||"").trim();
    if(!x) continue;
    set.add(x);
  }
  return Array.from(set).slice(0,8);
}
function showStatus(msg){
  const box = document.getElementById("statusBox");
  document.getElementById("statusMsg").textContent = msg;
  box.style.display = "";
}
function hideStatus(){
  document.getElementById("statusBox").style.display = "none";
}
function openModal(id){ document.getElementById(id).style.display = "flex"; }
function closeModal(id){ document.getElementById(id).style.display = "none"; }

/* Notificaciones locales */
let ME=null, PROFILE=null, IS_ADMIN=false;
function kForumSeen(){ return `rf_seen_forum_${ME?.id||"x"}`; }
function kThreadSeen(threadId){ return `rf_seen_thread_${ME?.id||"x"}_${threadId}`; }
function getSeenMap(key){ try{ return JSON.parse(localStorage.getItem(key)||"{}"); }catch(e){ return {}; } }
function setSeenMap(key, map){ localStorage.setItem(key, JSON.stringify(map||{})); }
function markForumPostSeen(postId){
  const m = getSeenMap(kForumSeen());
  m[postId] = new Date().toISOString();
  setSeenMap(kForumSeen(), m);
}
function markThreadSeen(threadId){ localStorage.setItem(kThreadSeen(threadId), new Date().toISOString()); }

/* =========================
   SUPABASE INIT (ROBUSTO)
========================= */
function getSupabaseConfig(){
  const url = FORCE_SUPABASE_URL || localStorage.getItem("rf_sb_url") || localStorage.getItem("https://pjkbipdjxxxzjiuyfkaq.supabase.co") || "";
  const anon = FORCE_SUPABASE_ANON || localStorage.getItem("rf_sb_anon") || localStorage.getItem("sb_publishable_G7uvRyHNLSew2HKJY_h6ag_M2NZDYx4") || "";
  return { url, anon };
}
let sb=null;

function initSupabase(){
  const { url, anon } = getSupabaseConfig();

  if(!url || !anon){
    sb = null;
    showStatus("No encuentro tus credenciales de Supabase. Crea en localStorage: rf_sb_url y rf_sb_anon, o p√©galas en FORCE_SUPABASE_URL/ANON dentro de este archivo.");
    return false;
  }

  try{
    sb = supabase.createClient(url, anon);
    hideStatus();
    return true;
  }catch(e){
    sb = null;
    showStatus("Error creando Supabase client: " + (e?.message || e));
    return false;
  }
}

/* =========================
   AUTH
========================= */
async function requireAuth(){
  if(!sb) return false;

  try{
    const { data, error } = await sb.auth.getSession();
    if(error) throw error;

    if(!data.session){
      location.href = LOGIN_URL;
      return false;
    }
    ME = data.session.user;
    return true;
  }catch(e){
    showStatus("No pude validar sesi√≥n. Revisa Supabase URL/ANON y que Auth est√© activo. Detalle: " + (e?.message||e));
    return false;
  }
}

async function loadProfile(){
  // Si tu tabla profiles no existe / RLS bloquea, igual seguimos con email
  try{
    const { data, error } = await sb
      .from("profiles")
      .select("id,email,full_name,role,country,created_at")
      .eq("id", ME.id)
      .maybeSingle();

    if(error) throw error;

    PROFILE = data || { id: ME.id, email: ME.email, full_name: "Usuario", role: "user" };
  }catch(e){
    PROFILE = { id: ME.id, email: ME.email, full_name: "Usuario", role: "user" };
  }

  IS_ADMIN = String(PROFILE.role||"").toLowerCase() === "admin";
  document.getElementById("who").textContent = (PROFILE.full_name||"Usuario") + " ‚Ä¢ " + (PROFILE.role||"user");
  document.getElementById("meInfo").textContent =
    `Nombre: ${PROFILE.full_name||"‚Äî"}\nCorreo: ${ME.email||"‚Äî"}\nRol: ${PROFILE.role||"user"}\nPa√≠s: ${PROFILE.country||"‚Äî"}`;

  if(IS_ADMIN){
    document.getElementById("adminPill").style.display = "";
    document.getElementById("adminBox").style.display = "";
  }
}

/* =========================
   UI Tabs
========================= */
function setTab(which){
  const tabForum = document.getElementById("tabForum");
  const tabPrivate = document.getElementById("tabPrivate");
  const secForum = document.getElementById("secForum");
  const secPrivate = document.getElementById("secPrivate");

  if(which === "forum"){
    tabForum.classList.add("active");
    tabPrivate.classList.remove("active");
    secForum.style.display = "";
    secPrivate.style.display = "none";
  }else{
    tabPrivate.classList.add("active");
    tabForum.classList.remove("active");
    secPrivate.style.display = "";
    secForum.style.display = "none";
  }
}

/* =========================
   FORO
========================= */
let ACTIVE_POST=null;
let CACHED_POSTS=[];
let AVG_MAP={};

function initTagFilter(){
  const sel = document.getElementById("tagFilter");
  sel.innerHTML = `<option value="">Todas las etiquetas</option>`;
  const set = new Set(DEFAULT_TAGS);
  for(const p of CACHED_POSTS){
    for(const t of (p.tags||[])) set.add(t);
  }
  for(const t of Array.from(set).sort((a,b)=>a.localeCompare(b))){
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  }
}

async function loadForum(){
  if(!sb) return;
  const q = (document.getElementById("qForum").value||"").trim().toLowerCase();
  const tag = (document.getElementById("tagFilter").value||"").trim();
  const sortMode = document.getElementById("sortForum").value || "recent";

  const { data: posts, error } = await sb
    .from("forum_posts")
    .select("id,title,body,created_at,author_id,is_pinned,is_closed,tags,profiles:author_id(full_name,email)")
    .order("created_at", { ascending:false })
    .limit(80);

  if(error){
    showStatus("No pude cargar foro. Confirma tablas + columnas (tags,is_pinned,is_closed) + RLS. Detalle: " + error.message);
    return;
  }

  CACHED_POSTS = (posts||[]).map(p=>{
    let tags = p.tags;
    if(typeof tags === "string") tags = tags.split(",").map(x=>x.trim()).filter(Boolean);
    if(!Array.isArray(tags)) tags = [];
    return {...p, tags};
  });

  // ratings promedio
  AVG_MAP = {};
  const { data: rates } = await sb.from("forum_ratings").select("post_id,rating");
  if(rates){
    const acc = {};
    for(const r of rates){
      if(!acc[r.post_id]) acc[r.post_id] = {sum:0,n:0};
      acc[r.post_id].sum += (r.rating||0);
      acc[r.post_id].n += 1;
    }
    for(const k in acc) AVG_MAP[k] = acc[k].n ? (acc[k].sum/acc[k].n) : 0;
  }

  initTagFilter();

  // filtro
  let filtered = CACHED_POSTS.slice();
  if(q){
    filtered = filtered.filter(p =>
      (p.title||"").toLowerCase().includes(q) ||
      (p.body||"").toLowerCase().includes(q) ||
      ((p.profiles?.full_name||"").toLowerCase().includes(q)) ||
      ((p.profiles?.email||"").toLowerCase().includes(q))
    );
  }
  if(tag) filtered = filtered.filter(p => (p.tags||[]).includes(tag));

  // orden
  if(sortMode === "pinned"){
    filtered.sort((a,b)=>{
      const ap=a.is_pinned?1:0, bp=b.is_pinned?1:0;
      if(bp!==ap) return bp-ap;
      return new Date(b.created_at)-new Date(a.created_at);
    });
  }else if(sortMode === "top"){
    filtered.sort((a,b)=>{
      const av=AVG_MAP[a.id]||0, bv=AVG_MAP[b.id]||0;
      if(bv!==av) return bv-av;
      return new Date(b.created_at)-new Date(a.created_at);
    });
  }else{
    filtered.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  }

  const box = document.getElementById("forumList");
  box.innerHTML = "";

  if(!filtered.length){
    box.innerHTML = `<div class="item"><p class="mut">No hay temas con ese filtro. Crea el primero üëá</p></div>`;
    updateForumNoti();
    return;
  }

  for(const p of filtered){
    const avg = AVG_MAP[p.id] || 0;
    const author = p.profiles?.full_name || p.profiles?.email || "Usuario";

    const pins = [];
    if(p.is_pinned) pins.push(`<span class="tag pin">Fijado</span>`);
    if(p.is_closed) pins.push(`<span class="tag closed">Cerrado</span>`);
    const tags = (p.tags||[]).slice(0,6).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("");

    const isNew = await isForumPostNewSinceSeen(p.id);

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div style="min-width:0">
          <p class="title" style="margin:0 0 4px 0">${isNew ? "üîî " : ""}${escapeHtml(p.title||"Sin t√≠tulo")}</p>
          <div class="meta">Por <b>${escapeHtml(author)}</b> ‚Ä¢ ${fmtDate(p.created_at)}</div>
          <div class="tagRow">${pins.join("")}${tags}</div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <div class="badge">‚≠ê ${avg.toFixed(1)}</div>
          <div class="badge">${isNew ? "Nuevo" : "‚Äî"}</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="mut" style="white-space:pre-wrap;line-height:1.35">
        ${escapeHtml((p.body||"").slice(0,220))}${(p.body||"").length>220 ? "..." : ""}
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="miniBtn pri">Ver / Comentar</button>
      </div>
    `;
    el.querySelector("button").addEventListener("click", ()=> openPost(p.id));
    box.appendChild(el);
  }

  updateForumNoti();
}

async function isForumPostNewSinceSeen(postId){
  const seen = getSeenMap(kForumSeen());
  if(!seen[postId]) return true;

  const seenAt = new Date(seen[postId]).getTime();

  const { data, error } = await sb
    .from("forum_replies")
    .select("created_at")
    .eq("post_id", postId)
    .order("created_at", {ascending:false})
    .limit(1);

  if(error || !data || !data.length) return false;
  const lastReplyAt = new Date(data[0].created_at).getTime();
  return lastReplyAt > seenAt;
}

async function updateForumNoti(){
  let c=0;
  for(const p of CACHED_POSTS){
    const isNew = await isForumPostNewSinceSeen(p.id);
    if(isNew) c++;
  }
  const b = document.getElementById("forumNoti");
  if(c>0){ b.textContent=String(c); b.style.display=""; }
  else b.style.display="none";
}

async function openPost(postId){
  const { data: p, error } = await sb
    .from("forum_posts")
    .select("id,title,body,created_at,author_id,is_pinned,is_closed,tags,profiles:author_id(full_name,email)")
    .eq("id", postId)
    .maybeSingle();

  if(error || !p){ toast("No pude abrir el tema."); return; }

  let tags = p.tags;
  if(typeof tags === "string") tags = tags.split(",").map(x=>x.trim()).filter(Boolean);
  if(!Array.isArray(tags)) tags = [];
  p.tags = tags;

  ACTIVE_POST = p;

  const { data: rates } = await sb.from("forum_ratings").select("user_id,rating").eq("post_id", postId);
  let avg=0,n=0,my=null;
  if(rates){
    for(const r of rates){ avg += (r.rating||0); n++; if(r.user_id===ME.id) my=r.rating; }
    avg = n ? avg/n : 0;
  }

  const { data: replies } = await sb
    .from("forum_replies")
    .select("id,post_id,body,created_at,author_id,profiles:author_id(full_name,email)")
    .eq("post_id", postId)
    .order("created_at",{ascending:true});

  const author = p.profiles?.full_name || p.profiles?.email || "Usuario";
  document.getElementById("postDetail").style.display = "";
  document.getElementById("pdTitle").textContent = p.title || "Sin t√≠tulo";
  document.getElementById("pdMeta").textContent = `Por ${author} ‚Ä¢ ${fmtDate(p.created_at)}`;
  document.getElementById("pdBody").textContent = p.body || "";
  document.getElementById("pdAvg").textContent = `‚≠ê ${avg.toFixed(1)}`;

  const tg = document.getElementById("pdTags");
  tg.innerHTML = "";
  if(p.is_pinned) tg.innerHTML += `<span class="tag pin">Fijado</span>`;
  if(p.is_closed) tg.innerHTML += `<span class="tag closed">Cerrado</span>`;
  for(const t of (p.tags||[])) tg.innerHTML += `<span class="tag">${escapeHtml(t)}</span>`;

  const starsBox = document.getElementById("pdStars");
  starsBox.innerHTML="";
  for(let i=1;i<=5;i++){
    const s=document.createElement("div");
    s.className="star"+((my && i<=my)?" on":"");
    s.textContent="‚òÖ";
    s.addEventListener("click", ()=> setRating(postId,i));
    starsBox.appendChild(s);
  }
  document.getElementById("pdYourRate").textContent = my ? `(${my}/5)` : "(sin calificar)";

  const rl=document.getElementById("repliesList");
  rl.innerHTML="";
  if(!replies || !replies.length){
    rl.innerHTML = `<div class="item"><p class="mut">Sin comentarios. S√© el primero üëá</p></div>`;
  }else{
    for(const r of replies){
      const ra = r.profiles?.full_name || r.profiles?.email || "Usuario";
      const canDel = IS_ADMIN || (r.author_id === ME.id);

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="meta"><b>${escapeHtml(ra)}</b> ‚Ä¢ ${fmtDate(r.created_at)}</div>
        <div style="white-space:pre-wrap;line-height:1.35;margin-top:6px">${escapeHtml(r.body||"")}</div>
        ${canDel ? `<div class="row" style="justify-content:flex-end;margin-top:8px">
          <button class="miniBtn bad">Eliminar</button>
        </div>` : ""}
      `;
      if(canDel){
        div.querySelector("button").addEventListener("click", ()=> deleteReply(r.id));
      }
      rl.appendChild(div);
    }
  }

  const closed = !!p.is_closed;
  document.getElementById("closedNote").style.display = closed ? "" : "none";
  document.getElementById("replyText").style.display = closed ? "none" : "";
  document.getElementById("btnSendReply").style.display = closed ? "none" : "";

  const btnPin=document.getElementById("btnPin");
  const btnToggleClose=document.getElementById("btnToggleClose");
  const btnDeletePost=document.getElementById("btnDeletePost");

  if(IS_ADMIN){
    btnPin.style.display = "";
    btnToggleClose.style.display = "";
    btnDeletePost.style.display = "";

    btnPin.textContent = p.is_pinned ? "Quitar fijado" : "Fijar";
    btnToggleClose.textContent = p.is_closed ? "Reabrir tema" : "Cerrar tema";

    btnPin.onclick = ()=> togglePinned(p.id, !p.is_pinned);
    btnToggleClose.onclick = ()=> toggleClosed(p.id, !p.is_closed);
    btnDeletePost.onclick = ()=> deletePost(p.id);
  }else{
    btnPin.style.display = "none";
    btnToggleClose.style.display = "none";
    btnDeletePost.style.display = "none";
  }

  markForumPostSeen(postId);
  await updateForumNoti();
  document.getElementById("postDetail").scrollIntoView({behavior:"smooth", block:"start"});
}

async function setRating(postId, value){
  const { error } = await sb.from("forum_ratings").upsert({post_id:postId,user_id:ME.id,rating:value},{onConflict:"post_id,user_id"});
  if(error){ toast("No pude guardar tu calificaci√≥n."); return; }
  toast("Calificaci√≥n guardada ‚úÖ");
  await openPost(postId);
  await loadForum();
}

async function sendReply(){
  const txt = (document.getElementById("replyText").value||"").trim();
  if(!ACTIVE_POST?.id){ toast("Abre un tema primero."); return; }
  if(ACTIVE_POST.is_closed){ toast("Tema cerrado."); return; }
  if(!txt){ toast("Escribe un comentario."); return; }

  const { error } = await sb.from("forum_replies").insert({post_id:ACTIVE_POST.id, author_id:ME.id, body:txt});
  if(error){ toast("No pude publicar."); return; }

  document.getElementById("replyText").value="";
  toast("Comentario publicado ‚úÖ");
  await openPost(ACTIVE_POST.id);
  await loadForum();
}

async function createPostFromModal(){
  const t = (document.getElementById("newTitle").value||"").trim();
  const b = (document.getElementById("newBody").value||"").trim();
  const tagsRaw = (document.getElementById("newTags").value||"").trim();

  if(!t){ toast("Pon un t√≠tulo."); return; }
  if(!b){ toast("Escribe el contenido."); return; }

  const tags = normalizeTags((tagsRaw ? tagsRaw.split(",") : []).map(x=>x.trim()).filter(Boolean));

  const payload = { title:t, body:b, author_id:ME.id, tags:tags, is_pinned:false, is_closed:false };

  const { error } = await sb.from("forum_posts").insert(payload);
  if(error){
    toast("No pude crear tema. Revisa columnas tags/is_pinned/is_closed y RLS.");
    return;
  }

  closeModal("mPost");
  document.getElementById("newTitle").value="";
  document.getElementById("newBody").value="";
  document.getElementById("newTags").value="";

  toast("Tema creado ‚úÖ");
  await loadForum();
}

/* Moderaci√≥n */
async function togglePinned(postId, val){
  const { error } = await sb.from("forum_posts").update({is_pinned:val}).eq("id",postId);
  if(error){ toast("No pude actualizar fijado."); return; }
  toast(val ? "Tema fijado ‚úÖ" : "Fijado removido ‚úÖ");
  await openPost(postId); await loadForum();
}
async function toggleClosed(postId, val){
  const { error } = await sb.from("forum_posts").update({is_closed:val}).eq("id",postId);
  if(error){ toast("No pude actualizar estado."); return; }
  toast(val ? "Tema cerrado ‚úÖ" : "Tema reabierto ‚úÖ");
  await openPost(postId); await loadForum();
}
async function deletePost(postId){
  if(!confirm("¬øEliminar este tema? (incluye comentarios y ratings)")) return;
  const { error } = await sb.from("forum_posts").delete().eq("id",postId);
  if(error){ toast("No pude eliminar."); return; }
  toast("Tema eliminado ‚úÖ");
  document.getElementById("postDetail").style.display="none";
  ACTIVE_POST=null;
  await loadForum();
}
async function deleteReply(replyId){
  if(!confirm("¬øEliminar este comentario?")) return;
  const { error } = await sb.from("forum_replies").delete().eq("id",replyId);
  if(error){ toast("No pude eliminar comentario."); return; }
  toast("Comentario eliminado ‚úÖ");
  if(ACTIVE_POST?.id) await openPost(ACTIVE_POST.id);
  await loadForum();
}

/* =========================
   PRIVADOS
========================= */
let ACTIVE_THREAD=null;

async function loadMyThreads(){
  const q = sb.from("pm_threads").select("id,subject,created_at,participant_id").order("created_at",{ascending:false});
  if(!IS_ADMIN) q.eq("participant_id", ME.id);

  const { data, error } = await q;
  if(error){ toast("No pude cargar hilos."); return; }

  const sel=document.getElementById("threadSelect");
  sel.innerHTML = `<option value="">‚Äî Selecciona un hilo ‚Äî</option>`;
  for(const th of (data||[])){
    const opt=document.createElement("option");
    opt.value = th.id;
    opt.textContent = `${th.subject||"Sin asunto"} ‚Ä¢ ${fmtDate(th.created_at)}`;
    sel.appendChild(opt);
  }

  await updatePmNoti(data||[]);
}

async function openThread(threadId){
  ACTIVE_THREAD = threadId || null;
  const chat=document.getElementById("chatBox");
  chat.innerHTML="";

  if(!ACTIVE_THREAD){
    chat.innerHTML = `<div class="mut">Selecciona un hilo para ver la conversaci√≥n.</div>`;
    return;
  }

  const { data, error } = await sb
    .from("pm_messages")
    .select("id,thread_id,sender_id,body,created_at")
    .eq("thread_id", ACTIVE_THREAD)
    .order("created_at",{ascending:true});

  if(error){ toast("No pude abrir el hilo."); return; }

  if(!data || !data.length){
    chat.innerHTML = `<div class="mut">Hilo vac√≠o. Env√≠a el primer mensaje üëá</div>`;
  }else{
    for(const m of data){
      const div=document.createElement("div");
      div.className = "bubble" + (m.sender_id===ME.id ? " me":"");
      div.innerHTML = `
        <div style="white-space:pre-wrap;line-height:1.35">${escapeHtml(m.body||"")}</div>
        <div class="bmeta">${fmtDate(m.created_at)}</div>
      `;
      chat.appendChild(div);
    }
    chat.scrollTop = chat.scrollHeight;
  }

  markThreadSeen(ACTIVE_THREAD);
  await updatePmNoti();
}

async function createThreadFromModal(){
  const s=(document.getElementById("threadSubject").value||"").trim();
  if(!s){ toast("Pon un asunto."); return; }

  const { data, error } = await sb
    .from("pm_threads")
    .insert({ participant_id: ME.id, subject: s })
    .select("id")
    .maybeSingle();

  if(error){ toast("No pude crear hilo."); return; }

  closeModal("mThread");
  document.getElementById("threadSubject").value="";
  toast("Hilo creado ‚úÖ");

  await loadMyThreads();
  document.getElementById("threadSelect").value = data.id;
  await openThread(data.id);
}

async function sendPM(){
  const txt=(document.getElementById("pmText").value||"").trim();
  if(!ACTIVE_THREAD){ toast("Selecciona o crea un hilo."); return; }
  if(!txt){ toast("Escribe un mensaje."); return; }

  const { error } = await sb.from("pm_messages").insert({thread_id:ACTIVE_THREAD, sender_id:ME.id, body:txt});
  if(error){ toast("No pude enviar mensaje."); return; }

  document.getElementById("pmText").value="";
  await openThread(ACTIVE_THREAD);
}

async function updatePmNoti(cachedThreads){
  let threads=cachedThreads;
  if(!threads){
    const q = sb.from("pm_threads").select("id,participant_id,created_at").order("created_at",{ascending:false});
    if(!IS_ADMIN) q.eq("participant_id", ME.id);
    const { data } = await q;
    threads = data || [];
  }

  let count=0;
  for(const th of threads){
    const seenIso = localStorage.getItem(kThreadSeen(th.id));
    const seenAt = seenIso ? new Date(seenIso).getTime() : 0;

    const { data: lastMsg } = await sb
      .from("pm_messages")
      .select("created_at")
      .eq("thread_id", th.id)
      .order("created_at",{ascending:false})
      .limit(1);

    if(!lastMsg || !lastMsg.length) continue;
    const lastAt = new Date(lastMsg[0].created_at).getTime();
    if(lastAt > seenAt) count++;
  }

  const b=document.getElementById("pmNoti");
  if(count>0){ b.textContent=String(count); b.style.display=""; }
  else b.style.display="none";
}

/* =========================
   REALTIME
========================= */
function setupRealtime(){
  sb.channel("forum-live")
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"forum_posts"}, ()=> loadForum())
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"forum_replies"}, ()=>{
      if(ACTIVE_POST?.id) openPost(ACTIVE_POST.id);
      updateForumNoti();
    })
    .subscribe();

  sb.channel("pm-live")
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"pm_messages"}, (payload)=>{
      const tid = payload?.new?.thread_id;
      if(!tid) return;
      if(tid === ACTIVE_THREAD) openThread(ACTIVE_THREAD);
      else updatePmNoti();
    })
    .subscribe();
}

/* =========================
   EVENTS (IMPORTANTE: siempre se registran)
========================= */
document.getElementById("btnBack").addEventListener("click", ()=>{
  // robusto: si history no sirve, cae a index.html
  try{
    if(window.history.length > 1) history.back();
    else location.href = DASHBOARD_URL;
  }catch(e){
    location.href = DASHBOARD_URL;
  }
});
document.getElementById("btnGoHome").addEventListener("click", ()=> location.href = DASHBOARD_URL);
document.getElementById("btnGoIndex").addEventListener("click", ()=> location.href = DASHBOARD_URL);

document.getElementById("btnLogout").addEventListener("click", async ()=>{
  // aunque supabase falle, redirige igual
  try{ if(sb) await sb.auth.signOut(); }catch(e){}
  location.href = LOGIN_URL;
});

document.getElementById("tabForum").addEventListener("click", ()=> setTab("forum"));
document.getElementById("tabPrivate").addEventListener("click", async ()=> { setTab("private"); if(sb) await loadMyThreads(); });

document.getElementById("btnNewPost").addEventListener("click", ()=>{
  if(!sb){ toast("Falta Supabase. Revisa el recuadro rojo arriba."); return; }
  openModal("mPost");
});
document.getElementById("btnRefreshForum").addEventListener("click", ()=> sb && loadForum());
document.getElementById("qForum").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sb && loadForum(); });
document.getElementById("tagFilter").addEventListener("change", ()=> sb && loadForum());
document.getElementById("sortForum").addEventListener("change", ()=> sb && loadForum());

document.getElementById("btnSendReply").addEventListener("click", ()=> sb && sendReply());
document.getElementById("btnCloseDetail").addEventListener("click", ()=>{
  document.getElementById("postDetail").style.display="none";
  ACTIVE_POST=null;
});

document.getElementById("btnReloadThreads").addEventListener("click", ()=> sb && loadMyThreads());
document.getElementById("threadSelect").addEventListener("change", (e)=> sb && openThread(e.target.value));
document.getElementById("btnNewThread").addEventListener("click", ()=>{
  if(!sb){ toast("Falta Supabase. Revisa el recuadro rojo arriba."); return; }
  openModal("mThread");
});
document.getElementById("btnSendPM").addEventListener("click", ()=> sb && sendPM());
document.getElementById("pmText").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sb && sendPM(); });

document.getElementById("btnRetry").addEventListener("click", ()=> initAndBoot());

/* Modal events */
document.getElementById("mPostClose").addEventListener("click", ()=> closeModal("mPost"));
document.getElementById("mPostCancel").addEventListener("click", ()=> closeModal("mPost"));
document.getElementById("mPostSave").addEventListener("click", ()=> sb && createPostFromModal());

document.getElementById("mThreadClose").addEventListener("click", ()=> closeModal("mThread"));
document.getElementById("mThreadCancel").addEventListener("click", ()=> closeModal("mThread"));
document.getElementById("mThreadSave").addEventListener("click", ()=> sb && createThreadFromModal());

/* =========================
   INIT
========================= */
async function initAndBoot(){
  const okClient = initSupabase();
  if(!okClient) return;

  const okSession = await requireAuth();
  if(!okSession) return;

  await loadProfile();
  await loadForum();
  await updatePmNoti();
  setupRealtime();
}

initAndBoot();
</script>

<!--
NECESARIO EN SUPABASE:
- forum_posts: columnas tags (text[]), is_pinned (bool), is_closed (bool)
- RLS: admin update/delete en forum_posts, delete en forum_replies
Si te falla ‚Äúcrear tema‚Äù, es por columnas/RLS.
-->

</body>
</html>

