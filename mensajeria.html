<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Mensajer√≠a</title>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.94);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
      --r2:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,.15), transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, rgba(29,78,216,.14), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 40px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);background:var(--card);
      border-radius:var(--r2);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      position:sticky;top:10px;z-index:20;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      box-shadow:0 10px 20px rgba(37,99,235,.25);
    }
    .brand h1{font-size:16px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--mut)}
    .userbox{display:flex;align-items:center;gap:10px}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.7);font-size:12px;color:var(--mut)
    }
    .btn{
      border:0;cursor:pointer;border-radius:12px;padding:10px 12px;
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      color:#fff;font-weight:700;box-shadow:0 12px 22px rgba(37,99,235,.22);
    }
    .btn:active{transform:translateY(1px)}
    .btn2{
      border:1px solid var(--line);cursor:pointer;border-radius:12px;padding:10px 12px;
      background:rgba(255,255,255,.8);color:var(--txt);font-weight:700;
    }
    .grid{
      display:grid;grid-template-columns: 1.2fr .8fr;gap:14px;margin-top:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--line);background:var(--card);
      border-radius:var(--r2);box-shadow:var(--shadow);backdrop-filter: blur(10px);
      padding:14px;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:rgba(255,255,255,.7);
      padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;color:var(--mut)
    }
    .tab.active{
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      color:#fff;border-color:transparent;
    }
    .h2{margin:0 0 6px 0;font-size:15px}
    .mut{color:var(--mut);font-size:12px;margin:0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, .ta, select{
      width:100%;
      border:1px solid var(--line);background:rgba(255,255,255,.82);
      border-radius:14px;padding:11px 12px;font-size:14px;outline:none;
    }
    .ta{min-height:120px;resize:vertical}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);background:rgba(255,255,255,.82);
      border-radius:18px;padding:12px;
    }
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .title{font-weight:900;font-size:14px;margin:0}
    .meta{font-size:12px;color:var(--mut);margin-top:4px}
    .badge{
      font-size:11px;font-weight:900;border-radius:999px;padding:7px 10px;
      border:1px solid var(--line);background:rgba(255,255,255,.75);color:var(--mut)
    }
    .stars{display:flex;gap:4px;align-items:center}
    .star{
      cursor:pointer;
      width:26px;height:26px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      font-size:14px;
    }
    .star.on{
      border-color:rgba(245,158,11,.55);
      background:rgba(245,158,11,.15);
    }
    .miniBtn{
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.82);cursor:pointer;font-weight:800;font-size:12px;
    }
    .miniBtn.pri{
      background:linear-gradient(135deg,var(--pri),var(--pri2));
      color:#fff;border-color:transparent;
    }
    .split{
      display:grid;grid-template-columns:1fr;gap:10px;
    }
    .chat{
      height:360px;overflow:auto;border:1px solid var(--line);
      border-radius:18px;background:rgba(255,255,255,.7);padding:10px;
    }
    .bubble{
      max-width:85%;
      padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      margin:8px 0;
    }
    .bubble.me{
      margin-left:auto;
      background:rgba(37,99,235,.08);
      border-color:rgba(37,99,235,.20);
    }
    .bubble .bmeta{font-size:11px;color:var(--mut);margin-top:6px}
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(15,23,42,.92);color:#fff;border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:12px;font-size:12px;display:none;z-index:99;
      max-width:92vw;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Mensajer√≠a</h1>
          <p class="mut">Foro abierto + mensajes privados a administradores</p>
        </div>
      </div>

      <div class="userbox">
        <div class="pill" id="who">Cargando sesi√≥n...</div>
        <button class="btn2" id="btnBack">‚Üê Dashboard</button>
        <button class="btn2" id="btnLogout">Salir</button>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tabForum">Foro Abierto</button>
          <button class="tab" id="tabPrivate">Mensaje a Admin</button>
        </div>

        <div class="hr"></div>

        <!-- FORO -->
        <section id="secForum">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 class="h2">Foro Abierto</h2>
              <p class="mut">Publica un tema, comenta y califica la utilidad del post (1‚Äì5).</p>
            </div>
            <div class="row">
              <button class="miniBtn pri" id="btnNewPost">+ Nuevo tema</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <input class="input" id="qForum" placeholder="Buscar por titulo, contenido o autor..." />
            <button class="miniBtn" id="btnRefreshForum">Actualizar</button>
          </div>

          <div class="hr"></div>

          <div class="list" id="forumList"></div>

          <!-- Post detail -->
          <div class="hr"></div>
          <div id="postDetail" style="display:none">
            <div class="item">
              <div class="itemTop">
                <div>
                  <p class="title" id="pdTitle">...</p>
                  <div class="meta" id="pdMeta">...</div>
                </div>
                <div class="badge" id="pdAvg">‚≠ê 0.0</div>
              </div>

              <div class="hr"></div>
              <div id="pdBody" style="white-space:pre-wrap;font-size:14px;line-height:1.35"></div>

              <div class="hr"></div>
              <div class="row" style="justify-content:space-between">
                <div class="row">
                  <span class="mut">Tu calificaci√≥n:</span>
                  <div class="stars" id="pdStars"></div>
                  <span class="mut" id="pdYourRate">‚Äî</span>
                </div>
                <div class="row">
                  <button class="miniBtn" id="btnCloseDetail">Cerrar</button>
                </div>
              </div>

              <div class="hr"></div>
              <h3 class="h2" style="margin-top:0">Comentarios</h3>
              <div id="repliesList" class="list"></div>

              <div class="hr"></div>
              <textarea class="ta" id="replyText" placeholder="Escribe tu comentario..."></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px">
                <button class="miniBtn pri" id="btnSendReply">Publicar comentario</button>
              </div>
            </div>
          </div>
        </section>

        <!-- PRIVADO -->
        <section id="secPrivate" style="display:none">
          <div>
            <h2 class="h2">Mensajes privados a Administradores</h2>
            <p class="mut">Crea un hilo y conversa directo con el equipo admin (tipo soporte / debate privado).</p>
          </div>

          <div class="hr"></div>

          <div class="split">
            <div class="row" style="justify-content:space-between">
              <div class="row" style="flex:1">
                <select id="threadSelect">
                  <option value="">‚Äî Selecciona un hilo ‚Äî</option>
                </select>
                <button class="miniBtn" id="btnReloadThreads">Actualizar</button>
              </div>
              <button class="miniBtn pri" id="btnNewThread">+ Nuevo hilo</button>
            </div>

            <div class="chat" id="chatBox"></div>

            <div class="row">
              <input class="input" id="pmText" placeholder="Escribe tu mensaje..." />
              <button class="miniBtn pri" id="btnSendPM">Enviar</button>
            </div>
          </div>
        </section>
      </div>

      <!-- SIDEBAR -->
      <div class="card">
        <h2 class="h2">Reglas r√°pidas</h2>
        <p class="mut" style="margin-bottom:10px">
          Mantengamos esto √∫til: describe el caso, pon contexto y evita datos sensibles.
        </p>
        <div class="item">
          <p class="title">‚úÖ Foro Abierto</p>
          <p class="mut">Ideal para ideas, debates, sugerencias y temas generales.</p>
        </div>
        <div class="item">
          <p class="title">üîí Mensaje a Admin</p>
          <p class="mut">Ideal para soporte, casos espec√≠ficos o conversaci√≥n privada.</p>
        </div>
        <div class="item">
          <p class="title">‚≠ê Calificaci√≥n</p>
          <p class="mut">Cada usuario califica 1 vez por post (1‚Äì5). Se muestra el promedio.</p>
        </div>

        <div class="hr"></div>

        <h2 class="h2">Tu estado</h2>
        <div class="item">
          <p class="mut" id="meInfo">Cargando...</p>
        </div>

        <div class="hr"></div>
        <button class="btn2" id="btnGoHome" style="width:100%">Ir al Dashboard</button>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG + HELPERS
========================= */
const DASHBOARD_URL = "dashboard.html"; // ajusta si tu dashboard usa otro nombre
const LOGIN_URL = "login.html";         // ajusta si tu login usa otro nombre

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> t.style.display="none", 2600);
}

function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("es-DO", {year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }catch(e){ return ""; }
}

// Lee credenciales de Supabase desde localStorage (como solemos hacer en tu proyecto)
function getSupabaseConfig(){
  const url = localStorage.getItem("rf_sb_url") || localStorage.getItem("SUPABASE_URL") || "";
  const anon = localStorage.getItem("rf_sb_anon") || localStorage.getItem("SUPABASE_ANON_KEY") || "";
  return { url, anon };
}

const { url: SUPABASE_URL, anon: SUPABASE_ANON_KEY } = getSupabaseConfig();
if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
  console.warn("Faltan credenciales Supabase en localStorage: rf_sb_url / rf_sb_anon");
}

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let ME = null;          // auth user
let PROFILE = null;     // profiles row
let ACTIVE_POST = null; // selected forum post
let ACTIVE_THREAD = null; // selected private thread

/* =========================
   AUTH GUARD
========================= */
async function requireAuth(){
  const { data } = await sb.auth.getSession();
  if(!data.session){
    location.href = LOGIN_URL;
    return false;
  }
  ME = data.session.user;
  return true;
}

async function loadProfile(){
  // Se asume tabla profiles con id = auth.uid()
  const { data, error } = await sb
    .from("profiles")
    .select("id,email,full_name,role,country,created_at")
    .eq("id", ME.id)
    .maybeSingle();

  if(error) console.warn(error);
  PROFILE = data || { id: ME.id, email: ME.email, full_name: "Usuario", role: "user" };

  const who = document.getElementById("who");
  who.textContent = (PROFILE.full_name || "Usuario") + " ‚Ä¢ " + (PROFILE.role || "user");

  document.getElementById("meInfo").textContent =
    `Nombre: ${PROFILE.full_name || "‚Äî"}\nCorreo: ${ME.email || "‚Äî"}\nRol: ${PROFILE.role || "user"}\nPa√≠s: ${PROFILE.country || "‚Äî"}`;
}

/* =========================
   UI TABS
========================= */
function setTab(which){
  const tabForum = document.getElementById("tabForum");
  const tabPrivate = document.getElementById("tabPrivate");
  const secForum = document.getElementById("secForum");
  const secPrivate = document.getElementById("secPrivate");

  if(which === "forum"){
    tabForum.classList.add("active");
    tabPrivate.classList.remove("active");
    secForum.style.display = "";
    secPrivate.style.display = "none";
  }else{
    tabPrivate.classList.add("active");
    tabForum.classList.remove("active");
    secPrivate.style.display = "";
    secForum.style.display = "none";
  }
}

/* =========================
   FORO: LOAD POSTS
========================= */
async function loadForum(){
  const q = (document.getElementById("qForum").value || "").trim();

  // Obtenemos posts + autor + avg rating
  // avg se calcula con view o query; aqu√≠ lo hacemos con RPC simple via select + luego agregaci√≥n en JS
  const { data: posts, error } = await sb
    .from("forum_posts")
    .select("id,title,body,created_at,author_id,profiles:author_id(full_name,email)")
    .order("created_at", { ascending:false })
    .limit(50);

  if(error){
    console.warn(error);
    toast("No pude cargar el foro (RLS/tabla). Revisa SQL.");
    return;
  }

  // Filtrado local
  let filtered = posts || [];
  if(q){
    const qq = q.toLowerCase();
    filtered = filtered.filter(p =>
      (p.title||"").toLowerCase().includes(qq) ||
      (p.body||"").toLowerCase().includes(qq) ||
      ((p.profiles?.full_name||"").toLowerCase().includes(qq)) ||
      ((p.profiles?.email||"").toLowerCase().includes(qq))
    );
  }

  // ratings promedio por post
  const ids = filtered.map(p=>p.id);
  let avgMap = {};
  if(ids.length){
    const { data: rates, error: er2 } = await sb
      .from("forum_ratings")
      .select("post_id,rating");
    if(!er2 && rates){
      const acc = {};
      for(const r of rates){
        if(!ids.includes(r.post_id)) continue;
        if(!acc[r.post_id]) acc[r.post_id] = {sum:0, n:0};
        acc[r.post_id].sum += (r.rating||0);
        acc[r.post_id].n += 1;
      }
      for(const k in acc){
        avgMap[k] = acc[k].n ? (acc[k].sum/acc[k].n) : 0;
      }
    }
  }

  const box = document.getElementById("forumList");
  box.innerHTML = "";

  if(!filtered.length){
    box.innerHTML = `<div class="item"><p class="mut">No hay temas a√∫n. Crea el primero üëá</p></div>`;
    return;
  }

  for(const p of filtered){
    const avg = avgMap[p.id] || 0;
    const author = p.profiles?.full_name || p.profiles?.email || "Usuario";
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div style="min-width:0">
          <p class="title" style="margin:0 0 4px 0">${escapeHtml(p.title || "Sin t√≠tulo")}</p>
          <div class="meta">
            Por <b>${escapeHtml(author)}</b> ‚Ä¢ ${fmtDate(p.created_at)}
          </div>
        </div>
        <div class="badge">‚≠ê ${avg.toFixed(1)}</div>
      </div>
      <div class="hr"></div>
      <div class="mut" style="white-space:pre-wrap;line-height:1.35">
        ${escapeHtml((p.body||"").slice(0,220))}${(p.body||"").length>220 ? "..." : ""}
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="miniBtn pri">Ver / Comentar</button>
      </div>
    `;
    el.querySelector("button").addEventListener("click", ()=> openPost(p.id));
    box.appendChild(el);
  }
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   FORO: OPEN POST + REPLIES + RATING
========================= */
async function openPost(postId){
  // load post
  const { data: p, error } = await sb
    .from("forum_posts")
    .select("id,title,body,created_at,author_id,profiles:author_id(full_name,email)")
    .eq("id", postId)
    .maybeSingle();

  if(error || !p){
    console.warn(error);
    toast("No pude abrir el tema.");
    return;
  }

  ACTIVE_POST = p;

  // avg + my rating
  const { data: rates } = await sb.from("forum_ratings").select("post_id,user_id,rating").eq("post_id", postId);
  let avg = 0, n=0, my = null;
  if(rates && rates.length){
    for(const r of rates){ avg += (r.rating||0); n++; if(r.user_id===ME.id) my = r.rating; }
    avg = n ? avg/n : 0;
  }

  // replies
  const { data: replies, error: er2 } = await sb
    .from("forum_replies")
    .select("id,post_id,body,created_at,author_id,profiles:author_id(full_name,email)")
    .eq("post_id", postId)
    .order("created_at", {ascending:true});

  if(er2) console.warn(er2);

  // render detail
  const author = p.profiles?.full_name || p.profiles?.email || "Usuario";
  document.getElementById("postDetail").style.display = "";
  document.getElementById("pdTitle").textContent = p.title || "Sin t√≠tulo";
  document.getElementById("pdMeta").textContent = `Por ${author} ‚Ä¢ ${fmtDate(p.created_at)}`;
  document.getElementById("pdBody").textContent = p.body || "";
  document.getElementById("pdAvg").textContent = `‚≠ê ${avg.toFixed(1)}`;

  // stars
  const starsBox = document.getElementById("pdStars");
  starsBox.innerHTML = "";
  for(let i=1;i<=5;i++){
    const s = document.createElement("div");
    s.className = "star" + ((my && i<=my) ? " on" : "");
    s.textContent = "‚òÖ";
    s.title = `${i}`;
    s.addEventListener("click", ()=> setRating(postId, i));
    starsBox.appendChild(s);
  }
  document.getElementById("pdYourRate").textContent = my ? `(${my}/5)` : "(sin calificar)";

  // replies list
  const rl = document.getElementById("repliesList");
  rl.innerHTML = "";
  if(!replies || !replies.length){
    rl.innerHTML = `<div class="item"><p class="mut">Sin comentarios. S√© el primero üëá</p></div>`;
  }else{
    for(const r of replies){
      const ra = r.profiles?.full_name || r.profiles?.email || "Usuario";
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="meta"><b>${escapeHtml(ra)}</b> ‚Ä¢ ${fmtDate(r.created_at)}</div>
        <div style="white-space:pre-wrap;line-height:1.35;margin-top:6px">${escapeHtml(r.body||"")}</div>
      `;
      rl.appendChild(div);
    }
  }

  // scroll to detail
  document.getElementById("postDetail").scrollIntoView({behavior:"smooth", block:"start"});
}

async function setRating(postId, value){
  // upsert rating (1 registro por user/post)
  const payload = { post_id: postId, user_id: ME.id, rating: value };

  const { error } = await sb
    .from("forum_ratings")
    .upsert(payload, { onConflict: "post_id,user_id" });

  if(error){
    console.warn(error);
    toast("No pude guardar tu calificaci√≥n (RLS?).");
    return;
  }
  toast("Calificaci√≥n guardada ‚úÖ");
  await openPost(postId); // refresca avg + estado estrellas
}

async function sendReply(){
  const txt = (document.getElementById("replyText").value || "").trim();
  if(!ACTIVE_POST || !ACTIVE_POST.id){
    toast("Abre un tema primero.");
    return;
  }
  if(!txt){
    toast("Escribe un comentario.");
    return;
  }
  const payload = { post_id: ACTIVE_POST.id, author_id: ME.id, body: txt };

  const { error } = await sb.from("forum_replies").insert(payload);
  if(error){
    console.warn(error);
    toast("No pude publicar (RLS?).");
    return;
  }
  document.getElementById("replyText").value = "";
  toast("Comentario publicado ‚úÖ");
  await openPost(ACTIVE_POST.id);
}

/* =========================
   FORO: NEW POST
========================= */
async function newPost(){
  const title = prompt("T√≠tulo del tema:");
  if(title === null) return;
  const t = title.trim();
  if(!t){ toast("T√≠tulo vac√≠o."); return; }

  const body = prompt("Escribe el contenido del tema:");
  if(body === null) return;
  const b = body.trim();
  if(!b){ toast("Contenido vac√≠o."); return; }

  const payload = { title: t, body: b, author_id: ME.id };
  const { error } = await sb.from("forum_posts").insert(payload);
  if(error){
    console.warn(error);
    toast("No pude crear el tema (RLS/tabla).");
    return;
  }
  toast("Tema creado ‚úÖ");
  await loadForum();
}

/* =========================
   PRIVADO: THREADS + MESSAGES
========================= */
async function loadMyThreads(){
  // Threads donde participant_id = mi user_id
  const { data, error } = await sb
    .from("pm_threads")
    .select("id,subject,created_at,participant_id")
    .eq("participant_id", ME.id)
    .order("created_at", {ascending:false});

  if(error){
    console.warn(error);
    toast("No pude cargar tus hilos privados (RLS/tabla).");
    return;
  }

  const sel = document.getElementById("threadSelect");
  sel.innerHTML = `<option value="">‚Äî Selecciona un hilo ‚Äî</option>`;
  for(const th of (data||[])){
    const opt = document.createElement("option");
    opt.value = th.id;
    opt.textContent = `${th.subject || "Sin asunto"} ‚Ä¢ ${fmtDate(th.created_at)}`;
    sel.appendChild(opt);
  }
}

async function openThread(threadId){
  ACTIVE_THREAD = threadId || null;
  const chat = document.getElementById("chatBox");
  chat.innerHTML = "";

  if(!ACTIVE_THREAD){
    chat.innerHTML = `<div class="mut">Selecciona un hilo para ver la conversaci√≥n.</div>`;
    return;
  }

  const { data, error } = await sb
    .from("pm_messages")
    .select("id,thread_id,sender_id,body,created_at")
    .eq("thread_id", ACTIVE_THREAD)
    .order("created_at", {ascending:true});

  if(error){
    console.warn(error);
    toast("No pude abrir el hilo (RLS?).");
    return;
  }

  if(!data || !data.length){
    chat.innerHTML = `<div class="mut">Hilo vac√≠o. Env√≠a el primer mensaje üëá</div>`;
    return;
  }

  for(const m of data){
    const div = document.createElement("div");
    div.className = "bubble" + (m.sender_id === ME.id ? " me" : "");
    div.innerHTML = `
      <div style="white-space:pre-wrap;line-height:1.35">${escapeHtml(m.body||"")}</div>
      <div class="bmeta">${fmtDate(m.created_at)}</div>
    `;
    chat.appendChild(div);
  }

  chat.scrollTop = chat.scrollHeight;
}

async function newThread(){
  const subject = prompt("Asunto del mensaje a Admin:");
  if(subject === null) return;
  const s = subject.trim();
  if(!s){ toast("Asunto vac√≠o."); return; }

  const { data, error } = await sb
    .from("pm_threads")
    .insert({ participant_id: ME.id, subject: s })
    .select("id")
    .maybeSingle();

  if(error){
    console.warn(error);
    toast("No pude crear el hilo (RLS/tabla).");
    return;
  }

  toast("Hilo creado ‚úÖ");
  await loadMyThreads();
  document.getElementById("threadSelect").value = data.id;
  await openThread(data.id);
}

async function sendPM(){
  const txt = (document.getElementById("pmText").value || "").trim();
  if(!ACTIVE_THREAD){
    toast("Selecciona o crea un hilo primero.");
    return;
  }
  if(!txt){
    toast("Escribe un mensaje.");
    return;
  }

  const payload = { thread_id: ACTIVE_THREAD, sender_id: ME.id, body: txt };
  const { error } = await sb.from("pm_messages").insert(payload);
  if(error){
    console.warn(error);
    toast("No pude enviar el mensaje (RLS?).");
    return;
  }

  document.getElementById("pmText").value = "";
  await openThread(ACTIVE_THREAD);
}

/* =========================
   EVENTS
========================= */
document.getElementById("tabForum").addEventListener("click", ()=> setTab("forum"));
document.getElementById("tabPrivate").addEventListener("click", async ()=> { setTab("private"); await loadMyThreads(); });

document.getElementById("btnNewPost").addEventListener("click", newPost);
document.getElementById("btnRefreshForum").addEventListener("click", loadForum);
document.getElementById("qForum").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadForum(); });

document.getElementById("btnSendReply").addEventListener("click", sendReply);
document.getElementById("btnCloseDetail").addEventListener("click", ()=>{
  document.getElementById("postDetail").style.display = "none";
  ACTIVE_POST = null;
});

document.getElementById("btnNewThread").addEventListener("click", newThread);
document.getElementById("btnReloadThreads").addEventListener("click", loadMyThreads);
document.getElementById("threadSelect").addEventListener("change", (e)=> openThread(e.target.value));
document.getElementById("btnSendPM").addEventListener("click", sendPM);
document.getElementById("pmText").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendPM(); });

document.getElementById("btnBack").addEventListener("click", ()=> location.href = DASHBOARD_URL);
document.getElementById("btnGoHome").addEventListener("click", ()=> location.href = DASHBOARD_URL);

document.getElementById("btnLogout").addEventListener("click", async ()=>{
  await sb.auth.signOut();
  location.href = LOGIN_URL;
});

/* =========================
   INIT
========================= */
(async function init(){
  const ok = await requireAuth();
  if(!ok) return;

  await loadProfile();
  await loadForum();

  // suscripci√≥n en vivo para refrescar mensajes privados (simple)
  sb.channel("pm-live")
    .on("postgres_changes", { event:"INSERT", schema:"public", table:"pm_messages" }, (payload)=>{
      // si estamos viendo el hilo, refresca
      if(payload?.new?.thread_id && payload.new.thread_id === ACTIVE_THREAD){
        openThread(ACTIVE_THREAD);
      }
    })
    .subscribe();

})();
</script>
</body>
</html>
