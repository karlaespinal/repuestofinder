<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>RepuestoFinder ‚Ä¢ Ventas inteligentes</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --b:#e5e7eb;
    --pri:#3b82f6;
    --pri2:#1d4ed8;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --shadow:0 10px 30px rgba(2,6,23,.08);
    --r:18px;
    --r2:14px;
    --pad:14px;
    font-synthesis-weight:none;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:var(--ink);
    background: radial-gradient(1100px 700px at 10% -10%, rgba(59,130,246,.20), transparent 55%),
                radial-gradient(900px 600px at 90% 0%, rgba(16,185,129,.14), transparent 50%),
                var(--bg);
  }
  .topbar{
    position:sticky; top:0; z-index:50;
    background:rgba(245,247,251,.86);
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(229,231,235,.8);
  }
  .topbarInner{
    max-width:1500px; margin:0;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 24px;
    gap:10px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    font-weight:800;
    letter-spacing:.2px;
  }
  .brand .logo{
    width:34px; height:34px; border-radius:12px;
    background:linear-gradient(135deg, rgba(59,130,246,1), rgba(29,78,216,1));
    box-shadow:0 10px 25px rgba(59,130,246,.25);
    display:grid; place-items:center; color:white;
    font-weight:900;
  }
  .chip{
    font-size:12px;
    padding:4px 10px;
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.65);
    border-radius:999px;
    color:var(--muted);
  }
  .actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .btn{
    border:0;
    border-radius:12px;
    padding:10px 12px;
    font-weight:800;
    cursor:pointer;
    background:var(--pri);
    color:white;
    box-shadow:0 12px 26px rgba(59,130,246,.22);
    transition:transform .06s ease, filter .2s ease;
    user-select:none;
    white-space:nowrap;
  }
  .btn:hover{ filter:brightness(.98); }
  .btn:active{ transform:translateY(1px); }
  .btnGhost{
    background:rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.08);
    box-shadow:none;
    color:var(--ink);
  }
  .btnBad{
    background:var(--bad);
    box-shadow:0 12px 26px rgba(239,68,68,.18);
  }
  .btnOk{
    background:var(--ok);
    box-shadow:0 12px 26px rgba(22,163,74,.18);
  }
  .btnSmall{ padding:8px 10px; border-radius:10px; font-size:13px; font-weight:800; }

  /* M√ÅS ancho general + chat m√°s a la derecha */
  .wrap{ max-width:100%; margin:0; padding:18px 16px 50px; }
  .grid{ display:flex; width:100%; gap:0; align-items:stretch; }
  @media (max-width: 1100px){ .grid{ flex-direction:column; } }

  .card{
    background:rgba(255,255,255,.85);
    border:1px solid rgba(229,231,235,.9);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:14px 14px;
    border-bottom:1px solid rgba(229,231,235,.8);
    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.68));
  }
  .cardHead b{ font-size:16px; }
  .cardBody{ padding:14px; }
  .muted{ color:var(--muted); }
  .muted2{ color:var(--muted); font-size:13px; }
  .msg{ display:none; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.08); background:rgba(255,255,255,.7); }
  .msg.err{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }

  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.65);
    font-size:13px;
  }
  .pill.ok{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.08); color:#14532d; }
  .pill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#78350f; }

  /* Tabs */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
  .tabBtn{
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.75);
    border-radius:999px;
    padding:8px 12px;
    font-weight:800;
    cursor:pointer;
    color:var(--ink);
  }
  .tabBtn.active{
    background:rgba(59,130,246,.12);
    border-color:rgba(59,130,246,.35);
  }

  /* Form (1x1) */
  .formGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 620px){ .formGrid{ grid-template-columns:1fr; } }
  .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  .inp, .sel, textarea{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.10);
    padding:10px 12px;
    background:white;
    outline:none;
    font-size:14px;
  }
  textarea{ min-height:84px; resize:vertical; }

  /* Excel-like grid */
  .sheetWrap{
    border:1px solid rgba(0,0,0,.10);
    border-radius:14px;
    overflow:auto;
    background:white;
    max-height:420px;
  }
  .sheet{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:760px;
  }
  .sheet th, .sheet td{
    border-bottom:1px solid rgba(229,231,235,.85);
    border-right:1px solid rgba(229,231,235,.65);
    padding:8px 10px;
    vertical-align:middle;
  }
  .sheet th{
    position:sticky; top:0;
    background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.90));
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    z-index:2;
  }
  .sheet td:first-child, .sheet th:first-child{ position:sticky; left:0; z-index:1; background:white; }
  .sheet th:first-child{ z-index:3; }
  .cell{
    min-height:18px;
    outline:none;
    white-space:nowrap;
  }
  .cell:focus{
    box-shadow: inset 0 0 0 2px rgba(59,130,246,.35);
    border-radius:10px;
  }
  .rowNum{
    width:44px;
    text-align:right;
    color:var(--muted);
    font-size:12px;
    font-weight:900;
    background:rgba(2,6,23,.02);
  }
  .cellSmall{ width:110px; }
  .cellMed{ width:160px; }
  .cellBig{ width:240px; }
  .cellXL{ width:320px; }

  /* Offers table */
  table.simple{ width:100%; border-collapse:separate; border-spacing:0; }
  table.simple th, table.simple td{ text-align:left; padding:10px 10px; border-bottom:1px solid rgba(229,231,235,.85); vertical-align:top; }
  table.simple th{ font-size:12px; color:var(--muted); font-weight:900; }
  table.simple td{ font-size:14px; }
  .tdSmall{ font-size:13px; color:var(--muted); }
  .nowrap{ white-space:nowrap; }
  .tActions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

  /* Chat */
  .chatBox{ height:380px; overflow:auto; border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:10px; background:white; }
  .chatMsg{ padding:8px 10px; border-radius:12px; margin:6px 0; max-width:85%; }
  .chatMe{ background:rgba(59,130,246,.12); margin-left:auto; }
  .chatOther{ background:rgba(0,0,0,.05); margin-right:auto; }
  .chatMeta{ font-size:11px; opacity:.7; margin-top:3px; }
  .chatComposer{ display:flex; gap:8px; margin-top:10px; }
  .hidden{ display:none !important; }

  .modalBack{
    display:none;
    position:fixed; inset:0;
    background:rgba(2,6,23,.55);
    backdrop-filter: blur(6px);
    align-items:center; justify-content:center;
    padding:16px;
    z-index:200;
  }
  .modal{
    width:min(720px, 100%);
    background:white;
    border-radius:18px;
    box-shadow:0 25px 60px rgba(2,6,23,.25);
    border:1px solid rgba(255,255,255,.2);
    overflow:hidden;
  }
  .modalHead{ padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(229,231,235,.85); }
  .modalBody{ padding:14px; }

  /* Chat: bloques colapsables (cliente / articulo) */
  .acc{
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    background:white;
    overflow:hidden;
    margin-bottom:10px;
  }
  .accHead{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px;
    cursor:pointer;
    user-select:none;
    background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.90));
    border-bottom:1px solid rgba(229,231,235,.85);
  }
  .accHead b{ font-size:13px; }
  .accBody{ padding:10px 12px; }
  .kv{ display:flex; gap:8px; align-items:baseline; margin:4px 0; }
  .kv b{ font-size:12px; color:var(--muted); min-width:120px; }
  .kv span{ font-size:13px; color:var(--ink); word-break:break-word; }


  /* Modal Articulos + Chats */
  .modalWide{ width:min(980px, 100%); }
  .modalGrid2{
    display:grid;
    grid-template-columns: 1.1fr 1.2fr;
    gap:12px;
  }
  @media (max-width: 820px){
    .modalGrid2{ grid-template-columns: 1fr; }
  }
  .listCard{
    border:1px solid rgba(0,0,0,.08);
    background:white;
    border-radius:14px;
    padding:10px 12px;
    cursor:pointer;
    margin-bottom:8px;
    transition:transform .06s ease, border-color .2s ease, box-shadow .2s ease;
  }
  .listCard:hover{ border-color:rgba(59,130,246,.35); box-shadow:0 10px 20px rgba(2,6,23,.06); }
  .listCard:active{ transform:translateY(1px); }
  .listCard.active{ border-color:rgba(59,130,246,.55); box-shadow:0 10px 22px rgba(59,130,246,.12); }
  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.65);
    color:var(--muted);
  }
  .dividerLine{ height:1px; background:rgba(229,231,235,.9); margin:10px 0; }


  /* Alignment controls (Bulk sheet) */
  .alignGroup{
    display:inline-flex;
    align-items:center;
    border:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.75);
    border-radius:999px;
    overflow:hidden;
    margin-bottom:2px;
  }
  .alignBtn{
    border:0;
    background:transparent;
    padding:8px 10px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    color:var(--ink);
    font-weight:900;
  }
  .alignBtn:hover{ background:rgba(2,6,23,.04); }
  .alignBtn.active{
    background:rgba(59,130,246,.14);
    color:var(--pri2);
  }
  .alignBtn svg{ width:16px; height:16px; opacity:.85; }

</style>
</head>

<body>
<div class="topbar">
  <div class="topbarInner">
    <div class="brand">
      <div class="logo">RF</div>
      <div>
        <div>Ventas inteligentes</div>
        <div class="muted2">Ofertas temporales por c√≥digo + chat</div>
      </div>
    </div>
    <div class="actions">
      <span class="chip" id="who">‚Äî</span>
      <a class="btn btnGhost btnSmall" href="index.html">Dashboard</a>
      <a class="btn btnGhost btnSmall" href="app.html">App</a>
      <a class="btn btnGhost btnSmall hidden" href="index.html?stay=1" id="loginBtn">Iniciar sesi√≥n</a>
      <button class="btn btnGhost btnSmall" onclick="logout()">Salir</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">

    <!-- IZQUIERDA (full width): administraci√≥n de ofertas -->
    <div class="card" style="flex:1; margin-right:14px;">
      <div class="cardHead">
        <b>Crear / administrar ofertas</b>
        <div class="row">
          <span class="pill" id="pillRole">Rol: ‚Äî</span>
          <span class="pill warn" id="pillAuto">Auto-borrado: requiere tarea</span>
        </div>
      </div>

      <div class="cardBody">
        <div class="muted2">
          El cliente en la App solo ve <b>Marca</b>, <b>Precio</b> y <b>Pa√≠s</b>. La comunicaci√≥n es por chat.
        </div>

        <div class="msg" id="msg"></div>

        <div style="height:12px"></div>

        <!-- Tabs + Config global -->
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="tabs">
              <button class="tabBtn active" id="tabBulk" onclick="showTab('bulk')">Carga r√°pida (Excel)</button>
              <button class="tabBtn" id="tabOne" onclick="showTab('one')">Formulario 1√ó1</button>
            </div>

            <!-- Config global (aplica a todas las filas) -->
            <div class="row" style="margin-top:10px; align-items:flex-end">
              <div class="field" style="min-width:140px">
                <label>Moneda (global)</label>
                <select class="sel" id="gCurrency"></select>
              </div>
              <div class="field" style="min-width:220px; flex:1">
                <label>Pa√≠s (global)</label>
                <select class="sel" id="gCountry"></select>
              </div>
              <div class="field" style="min-width:170px">
                <label>Duraci√≥n (global)</label>
                <select class="sel" id="gDuration">
                  <option value="24h">24 horas</option>
                  <option value="1d">1 d√≠a</option>
                  <option value="7d">1 semana</option>
                  <option value="15d">15 d√≠as</option>
                  <option value="30d">30 d√≠as</option>
                  <option value="2m">2 meses</option>
                  <option value="3m">3 meses</option>
                  <option value="6m">6 meses</option>
                </select>
              </div>
              
              <div class="field" style="min-width:170px; display:flex; flex-direction:column; gap:6px">
                <label>Alinear celdas</label>
                <div class="alignGroup" aria-label="Alinear celdas (OEM/Marca/Precio/Descripci√≥n)">
                  <button class="alignBtn active" id="alignLeft"  type="button" title="Alinear a la izquierda" onclick="setBulkAlign('left')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 6h14M4 10h10M4 14h14M4 18h10"/></svg>
                  </button>
                  <button class="alignBtn" id="alignCenter" type="button" title="Centrar" onclick="setBulkAlign('center')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M5 6h14M7 10h10M5 14h14M7 18h10"/></svg>
                  </button>
                  <button class="alignBtn" id="alignRight" type="button" title="Alinear a la derecha" onclick="setBulkAlign('right')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 6h14M10 10h10M6 14h14M10 18h10"/></svg>
                  </button>
                </div>
              </div>
<div class="pill ok" style="margin-bottom:2px">
                ‚úÖ Se aplica a todas las filas (Excel y 1√ó1)
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn btnGhost btnSmall" onclick="addBulkRows(5)">+5 filas</button>
            <button class="btn btnGhost btnSmall" onclick="clearBulkSheet()">Limpiar hoja</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <!-- BULK (Excel-like) -->
        <div id="bulkPane">
          <div class="pill" style="margin-bottom:10px">
            ‚úÖ Pega directo desde Excel/Sheets (CTRL+V). Orden: OEM, Marca, Precio, Descripci√≥n. (Moneda/Pa√≠s/Duraci√≥n se toman de la configuraci√≥n global).
          </div>

          <div class="row" style="justify-content:space-between; margin-bottom:10px">
            <div class="muted2">
              Columnas: <b>OEM</b> ‚Ä¢ Marca ‚Ä¢ Precio ‚Ä¢ Descripci√≥n
            </div>
            <div class="row">
              <button class="btn btnGhost btnSmall" onclick="downloadTemplate()">Exportar plantilla</button>
              <button class="btn btnGhost btnSmall" onclick="triggerImport()">Importar CSV</button>
              <button class="btn btnOk btnSmall" onclick="bulkSave()">Guardar filas</button>
            </div>
          </div>

          <input type="file" id="bulkFile" class="hidden" accept=".csv,.txt" />

          <div class="sheetWrap" id="sheetWrap">
            <table class="sheet" id="bulkTable" aria-label="Hoja de carga masiva (OEM, Marca, Precio, Descripci√≥n)">
              <thead>
                <tr>
                  <th class="rowNum">#</th>
                  <th>OEM</th>
                  <th>Marca</th>
                  <th class="nowrap">Precio</th>
                  <th>Descripci√≥n (interna)</th>
                </tr>
              </thead>
              <tbody id="bulkBody"></tbody>
            </table>
          </div>

          <div style="height:10px"></div>
          <div class="muted2" id="bulkHint">‚Äî</div>
        </div>

        <!-- ONE BY ONE (se mantiene por si acaso) -->
        <div id="onePane" class="hidden">
          <div class="formGrid">
            <div class="field">
              <label>N√∫mero original (OEM)</label>
              <input class="inp" id="fOriginal" placeholder="Ej: A2762001000"/>
            </div>
            <div class="field">
              <label>Marca</label>
              <input class="inp" id="fBrand" placeholder="Ej: Mercedes-Benz / Mahle / Bosch"/>
            </div>
            <div class="field">
              <label>Precio</label>
              <input class="inp" id="fPrice" placeholder="Ej: 125.50"/>
            </div>
            
            <div class="field" style="grid-column:1/-1">
              <label>Descripci√≥n (interna, no se muestra al cliente)</label>
              <textarea id="fDesc" placeholder="Detalles: condici√≥n, ubicaci√≥n, disponibilidad, notas..."></textarea>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="row">
            <button class="btn" id="btnSave">Guardar oferta</button>
            <button class="btn btnGhost" id="btnClear">Limpiar</button>
            <span class="muted2" id="hint">‚Äî</span>
          </div>
        </div>

        <div style="height:18px"></div>

        <!-- MIS OFERTAS -->
        <div class="row" style="justify-content:space-between">
          <b>Mis ofertas</b>
          <div class="row">
            <input class="inp" id="q" oninput="renderOffers()" placeholder="Filtrar (OEM / marca / pa√≠s)" style="min-width:300px"/>
            <button class="btn btnGhost btnSmall" id="btnRefreshOffers">Actualizar</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <div style="overflow:auto;">
          <table class="simple">
            <thead>
              <tr>
                <th class="nowrap">OEM</th>
                <th>Marca</th>
                <th>Precio</th>
                <th>Pa√≠s</th>
                <th class="nowrap">Expira</th>
                <th class="nowrap" style="text-align:right">Acciones</th>
              </tr>
            </thead>
            <tbody id="offersTbody">
              <tr><td class="tdSmall" colspan="6">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- DERECHA (pegado a la derecha): chats -->
    <div class="card" style="width:380px; min-width:380px;">
      <div class="cardHead">
        <b>Chats de ofertas</b>
        <div class="row">
          <span class="chip" id="chatMeta">‚Äî</span>
          <button class="btn btnGhost btnSmall" id="btnRefreshChats">Actualizar</button>
        </div>
      </div>

      <div class="cardBody">
        <div class="muted2"><b></b> (solo lectura).</div>
        <div class="msg" id="msgChat"></div>
        <div style="height:12px"></div>

        <div class="row" style="align-items:stretch">
          <div style="flex:1; min-width:220px; max-width:280px;">
            <div class="field">
              <label>Buscar chat</label>
              <input class="inp" id="chatFilter" oninput="renderChats()" placeholder="OEM / marca / pa√≠s"/>
            </div>

            <div class="row" style="justify-content:space-between; margin:8px 0 10px">
              <button class="btn btnGhost btnSmall" onclick="openArticleModal()">üóÇÔ∏è Bandeja de chats</button>
              <span class="pill" id="selectedOfferPill" title="Filtra los chats por articulo" style="max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Todos</span>
            </div>
            <div id="chatList" class="hidden"></div>
            <div class="muted2" id="chatListHint" style="margin-top:6px;">Usa <b>Bandeja de chats</b> para seleccionar un chat y responder abajo.</div>
            <div id="chatQuick" style="margin-top:10px;"></div>
          </div>

          <div style="flex:2.2; min-width:260px;">

            <!-- Bloques para ver/ocultar info (cliente / articulo) -->
            <div class="acc" id="accClient">
              <div class="accHead" onclick="toggleChatBlock('client')">
                <b>üë§ Informaci√≥n del cliente</b>
                <span class="muted2" id="clientToggleTxt">Mostrar</span>
              </div>
              <div class="accBody hidden" id="clientBody">
                <div class="kv"><b>Cliente</b><span id="ciBuyer">‚Äî</span></div>
                <div class="kv"><b>Chat creado</b><span id="ciDate">‚Äî</span></div>
              </div>
            </div>

            <div class="acc" id="accArticle">
              <div class="accHead" onclick="toggleChatBlock('article')">
                <b>üì¶ Informaci√≥n del art√≠culo</b>
                <span class="muted2" id="articleToggleTxt">Mostrar</span>
              </div>
              <div class="accBody hidden" id="articleBody">
                <div class="kv"><b>OEM</b><span id="aiOEM">‚Äî</span></div>
                <div class="kv"><b>Marca</b><span id="aiBrand">‚Äî</span></div>
                <div class="kv"><b>Precio</b><span id="aiPrice">‚Äî</span></div>
                <div class="kv"><b>Pa√≠s</b><span id="aiCountry">‚Äî</span></div>
              </div>
            </div>

            <div class="pill" id="chatTitle">Selecciona un chat</div>
            <div style="height:10px"></div>
            <div class="chatBox" id="chatMsgs"></div>

            <div class="chatComposer" id="chatComposer">
              <input class="inp" id="chatInput" placeholder="Escribe un mensaje..."/>
              <button class="btn" onclick="sendMsg()">Enviar</button>
            </div>

            <div class="muted2 hidden" id="adminReadOnly" style="margin-top:8px;">
              Modo administrador: solo lectura.
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal confirm delete -->
<div class="modalBack" id="delBack" onclick="if(event.target.id==='delBack') closeDel()">
  <div class="modal">
    <div class="modalHead">
      <b>Eliminar oferta</b>
      <button class="btn btnGhost btnSmall" onclick="closeDel()">Cerrar</button>
    </div>
    <div class="modalBody">
      <div class="muted2" id="delTxt">‚Äî</div>
      <div style="height:12px"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn btnGhost" onclick="closeDel()">Cancelar</button>
        <button class="btn btnBad" onclick="confirmDel()">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Art√≠culos + Chats -->
<div class="modalBack" id="artBack" onclick="if(event.target.id==='artBack') closeArticleModal()">
  <div class="modal modalWide">
    <div class="modalHead">
      <b>üóÇÔ∏è Bandeja de chats (por art√≠culo)</b>
      <div class="row">
        <button class="btn btnGhost btnSmall" onclick="showAllChatsInModal()">Ver todos</button>
        <button class="btn btnGhost btnSmall" onclick="closeArticleModal()">Cerrar</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="row" style="justify-content:space-between; align-items:flex-end; margin-bottom:10px">
        <div class="field" style="flex:1; min-width:220px">
          <label>Buscar (OEM / marca / pa√≠s)</label>
          <input class="inp" id="artQ" oninput="renderArticleModal()" placeholder="Ej: A276 / MERCEDES / Republica..."/>
        </div>
        <span class="muted2" id="artMeta">‚Äî</span>
      </div>

      <div class="modalGrid2">
        <div>
          <div class="muted2" style="font-weight:900; margin-bottom:8px">Art√≠culos</div>
          <div id="artList" style="max-height:460px; overflow:auto;"></div>
        </div>

        <div>
          <div class="muted2" style="font-weight:900; margin-bottom:8px">Chats del art√≠culo</div>
          <div class="pill" id="artSelectedTitle" style="margin-bottom:10px; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Selecciona un art√≠culo</div>
          <div id="artChats" style="max-height:460px; overflow:auto;"></div>
        </div>
      </div>

      <div class="dividerLine"></div>
      <div class="muted2">
        Tip: al hacer clic en un chat aqu√≠, se selecciona autom√°ticamente abajo para que respondas en el panel principal.
      </div>
    </div>
  </div>
</div>

<script type="module">

  import { supabase } from "./assets/supabaseClient.js";

  const OFFERS_TABLE = "offers";
  const CHATS_TABLE  = "offer_chats";
  const MSGS_TABLE   = "offer_messages";

  const $ = (id)=>document.getElementById(id);

  // ===== Config global (Moneda / Pa√≠s / Duraci√≥n) =====
  const CURRENCIES = [
    { code:"USD", name:"USD (D√≥lar)" },
    { code:"DOP", name:"DOP (Peso RD)" },
    { code:"EUR", name:"EUR (Euro)" },
    { code:"MXN", name:"MXN (Peso MX)" },
    { code:"COP", name:"COP (Peso CO)" },
    { code:"CLP", name:"CLP (Peso CL)" },
    { code:"PEN", name:"PEN (Sol)" },
    { code:"ARS", name:"ARS (Peso AR)" },
    { code:"BRL", name:"BRL (Real)" },
    { code:"GTQ", name:"GTQ (Quetzal)" },
    { code:"CRC", name:"CRC (Col√≥n CR)" },
    { code:"PAB", name:"PAB (Balboa)" }
  ];

  // Lista extensa (puedes ampliar/editar cuando quieras)
  const COUNTRIES = [
    "Afganist√°n","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia","Australia","Austria","Azerbaiy√°n",
    "Bahamas","Banglad√©s","Barbados","Bar√©in","B√©lgica","Belice","Ben√≠n","Bielorrusia","Birmania","Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","Brun√©i","Bulgaria","Burkina Faso","Burundi",
    "Cabo Verde","Camboya","Camer√∫n","Canad√°","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Congo","Corea del Norte","Corea del Sur","Costa Rica","Costa de Marfil","Croacia","Cuba",
    "Dinamarca","Dominica","Ecuador","Egipto","El Salvador","Emiratos √Årabes Unidos","Eritrea","Eslovaquia","Eslovenia","Espa√±a","Estados Unidos","Estonia","Esuatini","Etiop√≠a",
    "Filipinas","Finlandia","Fiyi","Francia",
    "Gab√≥n","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea","Guinea-Bis√°u","Guinea Ecuatorial","Guyana",
    "Hait√≠","Honduras","Hungr√≠a",
    "India","Indonesia","Irak","Ir√°n","Irlanda","Islandia","Islas Marshall","Islas Salom√≥n","Israel","Italia",
    "Jamaica","Jap√≥n","Jordania",
    "Kazajist√°n","Kenia","Kirguist√°n","Kiribati","Kuwait",
    "Laos","Lesoto","Letonia","L√≠bano","Liberia","Libia","Liechtenstein","Lituania","Luxemburgo",
    "Macedonia del Norte","Madagascar","Malasia","Malaui","Maldivas","Mal√≠","Malta","Marruecos","Mauricio","Mauritania","M√©xico","Micronesia","Moldavia","M√≥naco","Mongolia","Montenegro","Mozambique",
    "Namibia","Nauru","Nepal","Nicaragua","N√≠ger","Nigeria","Noruega","Nueva Zelanda",
    "Om√°n",
    "Pa√≠ses Bajos","Pakist√°n","Palaos","Panam√°","Pap√∫a Nueva Guinea","Paraguay","Per√∫","Polonia","Portugal",
    "Reino Unido","Rep√∫blica Centroafricana","Rep√∫blica Checa","Rep√∫blica Dominicana","Rep√∫blica del Congo","Rep√∫blica Democr√°tica del Congo","Ruanda","Rumania","Rusia",
    "Samoa","San Crist√≥bal y Nieves","San Marino","San Vicente y las Granadinas","Santa Luc√≠a","Santo Tom√© y Pr√≠ncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka","Sud√°frica","Sud√°n","Sud√°n del Sur","Suecia","Suiza",
    "Tailandia","Tanzania","Tayikist√°n","Timor Oriental","Togo","Tonga","Trinidad y Tobago","T√∫nez","Turkmenist√°n","Turqu√≠a","Tuvalu",
    "Ucrania","Uganda","Uruguay","Uzbekist√°n",
    "Vanuatu","Vaticano","Venezuela","Vietnam",
    "Yemen","Yibuti",
    "Zambia","Zimbabue"
  ];

  function populateGlobalSelects(){
    const curSel = $("gCurrency");
    const countrySel = $("gCountry");

    if(curSel && curSel.options.length===0){
      CURRENCIES.forEach(c=>{
        const o = document.createElement("option");
        o.value = c.code;
        o.textContent = c.name;
        curSel.appendChild(o);
      });
      curSel.value = "USD";
    }

    if(countrySel && countrySel.options.length===0){
      // placeholder
      const p = document.createElement("option");
      p.value = "";
      p.textContent = "Selecciona un pa√≠s‚Ä¶";
      p.disabled = true;
      p.selected = true;
      countrySel.appendChild(p);

      COUNTRIES.forEach(name=>{
        const o = document.createElement("option");
        o.value = name;
        o.textContent = name;
        countrySel.appendChild(o);
      });

      // default RD si existe
      const rd = Array.from(countrySel.options).find(o=>o.value==="Rep√∫blica Dominicana");
      if(rd){ countrySel.value = "Rep√∫blica Dominicana"; }
    }
  }

  let me = null;
  let myRole = null; // "admin" | null
  let offersCache = [];
  let chatsCache = [];
  let selectedChat = null; // {id, offer_id,...}
  let chatPoll = null;

  // ===== Bulk alignment (left / center / right) =====
  let bulkAlign = (localStorage.getItem("rf_bulk_align") || "left");
  function syncAlignUI_(){
    const aL = document.getElementById("alignLeft");
    const aC = document.getElementById("alignCenter");
    const aR = document.getElementById("alignRight");
    if(aL) aL.classList.toggle("active", bulkAlign==="left");
    if(aC) aC.classList.toggle("active", bulkAlign==="center");
    if(aR) aR.classList.toggle("active", bulkAlign==="right");
  }
  window.setBulkAlign = function(align){
    const v = (align==="center"||align==="right") ? align : "left";
    bulkAlign = v;
    try{ localStorage.setItem("rf_bulk_align", v); }catch(_){}
    // aplicar a celdas existentes (solo bulk sheet)
    document.querySelectorAll("#bulkBody .cell").forEach(el=>{
      el.style.textAlign = v;
    });
    syncAlignUI_();
  }

  // ===== Filtro por art√≠culo (offer) + Modal selector =====
  let offerFilterId = null;        // si tiene valor, filtra la lista de chats
  let modalOfferId  = null;        // offer seleccionado dentro del modal

  function offerTitle_(o){
    if(!o) return "‚Äî";
    const t = `${o.original || "‚Äî"} ‚Ä¢ ${o.brand || "‚Äî"}`;
    return t.trim();
  }

  function setSelectedOfferPill_(){
    const pill = document.getElementById("selectedOfferPill");
    if(!pill) return;
    if(!offerFilterId){
      pill.textContent = "Todos";
      pill.classList.remove("ok");
      return;
    }
    const ch = chatsCache.find(x=>x.offer_id===offerFilterId);
    const o = ch?.offer || null;
    pill.textContent = o ? (o.original || "Art√≠culo") : "Filtrado";
    pill.classList.add("ok");
  }

  window.openArticleModal = function(){
    const back = document.getElementById("artBack");
    if(!back) return;
    // preseleccionar el offer actual si existe
    modalOfferId = offerFilterId || null;
    back.style.display = "flex";
    // si hay texto en Buscar chat, √∫salo como sugerencia en el modal
    const q = document.getElementById("artQ");
    const cf = getChatFilterText_();
    if(q && !q.value && cf) q.value = cf;
    if(q && !q.value) q.value = "";
    renderArticleModal();
    if(modalOfferId) selectOfferInModal(modalOfferId);
    else renderAllChatsInModal_();
  }

  window.closeArticleModal = function(){
    const back = document.getElementById("artBack");
    if(back) back.style.display = "none";
  }

  window.clearOfferFilter = function(){
    offerFilterId = null;
    setSelectedOfferPill_();
    renderChats();
    closeArticleModal();
  }

  
  function getChatFilterText_(){
    return String(document.getElementById("chatFilter")?.value || "").trim();
  }
function getOfferGroups_(){
    // agrupar chats por offer_id
    const map = new Map();
    for(const c of chatsCache){
      if(!c.offer_id) continue;
      const k = c.offer_id;
      if(!map.has(k)){
        map.set(k, { offer_id:k, offer:c.offer || null, chats:[] });
      }
      map.get(k).chats.push(c);
    }
    // convertir a array y ordenar por cantidad desc y fecha desc
    const arr = Array.from(map.values());
    arr.sort((a,b)=>{
      const dc = (b.chats.length - a.chats.length);
      if(dc) return dc;
      const ta = new Date(a.chats[0]?.created_at || 0).getTime();
      const tb = new Date(b.chats[0]?.created_at || 0).getTime();
      return tb - ta;
    });
    return arr;
  }

  
  function renderAllChatsInModal_(){
    const box = document.getElementById("artChats");
    const title = document.getElementById("artSelectedTitle");
    if(title) title.textContent = "Todos los chats";
    if(!box) return;

    const q = String(document.getElementById("artQ")?.value || "").trim().toLowerCase();
    let list = chatsCache.slice();

    if(q){
      list = list.filter(c=>{
        const o = c.offer || {};
        return String(o.original||"").toLowerCase().includes(q) ||
               String(o.brand||"").toLowerCase().includes(q) ||
               String(o.country||"").toLowerCase().includes(q) ||
               String(c.buyer_id||"").toLowerCase().includes(q) ||
               String(c.buyer_company||"").toLowerCase().includes(q);
      });
    }

    if(!list.length){
      box.innerHTML = '<div class="muted2">No hay chats.</div>';
      return;
    }

    box.innerHTML = list.map(c=>{
      const o = c.offer || {};
      const when = new Date(c.created_at).toLocaleString();
      const buyer = buyerName_(c);
      const sub = `${money(o.price,o.currency)} ‚Ä¢ ${o.country || ""}`.trim();
      const active = (selectedChat && selectedChat.id===c.id) ? "active" : "";
      return `
        <div class="listCard ${active}" onclick="pickChatFromModal('${c.id}')">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div style="min-width:0">
              <div style="font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml((o.original||"‚Äî") + " ‚Ä¢ " + (o.brand||"‚Äî"))}</div>
              <div class="muted2" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Cliente: ${escapeHtml(buyer)} ‚Ä¢ ${escapeHtml(when)}</div>
              <div class="tdSmall">${escapeHtml(sub)}</div>
            </div>
            <span class="badge">Abrir</span>
          </div>
        </div>
      `;
    }).join("");
  }

  window.showAllChatsInModal = function(){
    modalOfferId = null;
    renderArticleModal();
    renderAllChatsInModal_();
  }
window.renderArticleModal = function(){
    const q = String(document.getElementById("artQ")?.value || "").trim().toLowerCase();
    const groups = getOfferGroups_();

    let filtered = groups;
    if(q){
      filtered = groups.filter(g=>{
        const o = g.offer || {};
        return String(o.original||"").toLowerCase().includes(q) ||
               String(o.brand||"").toLowerCase().includes(q) ||
               String(o.country||"").toLowerCase().includes(q);
      });
    }

    const meta = document.getElementById("artMeta");
    if(meta) meta.textContent = `${filtered.length} art√≠culo(s)`;

    const list = document.getElementById("artList");
    if(!list) return;

    if(!filtered.length){
      list.innerHTML = '<div class="muted2">No hay art√≠culos con chats.</div>';
      const box = document.getElementById("artChats");
      if(box) box.innerHTML = '<div class="muted2">‚Äî</div>';
      return;
    }

    list.innerHTML = filtered.map(g=>{
      const o = g.offer || {};
      const title = offerTitle_(o);
      const sub = `${money(o.price,o.currency)} ‚Ä¢ ${o.country || ""}`.trim();
      const active = (modalOfferId === g.offer_id) ? "active" : "";
      return `
        <div class="listCard ${active}" onclick="selectOfferInModal('${g.offer_id}')">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div style="min-width:0">
              <div style="font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(title)}</div>
              <div class="muted2" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(sub)}</div>
            </div>
            <span class="badge" title="Cantidad de chats">${g.chats.length}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  window.selectOfferInModal = function(offerId){
    modalOfferId = offerId;

    // actualizar UI izquierda (active)
    renderArticleModal();

    const groups = getOfferGroups_();
    const g = groups.find(x=>x.offer_id===offerId);
    const chats = g?.chats || [];
    const o = g?.offer || null;

    const title = document.getElementById("artSelectedTitle");
    if(title){
      title.textContent = o ? `${o.original || "‚Äî"} ‚Ä¢ ${o.brand || "‚Äî"} ‚Ä¢ ${money(o.price,o.currency)} ‚Ä¢ ${o.country || ""}`.trim()
                            : "Chats del art√≠culo";
    }

    const box = document.getElementById("artChats");
    if(!box) return;

    if(!chats.length){
      box.innerHTML = '<div class="muted2">Este art√≠culo no tiene chats.</div>';
      return;
    }

    box.innerHTML = chats.map(c=>{
      const when = new Date(c.created_at).toLocaleString();
      const buyer = buyerName_(c);
      const active = (selectedChat && selectedChat.id===c.id) ? "active" : "";
      return `
        <div class="listCard ${active}" onclick="pickChatFromModal('${c.id}')">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
            <div style="min-width:0">
              <div style="font-weight:900; font-size:13px;">Cliente: ${escapeHtml(buyer)}</div>
              <div class="muted2">Chat: ${escapeHtml(when)}</div>
            </div>
            <span class="badge">Abrir</span>
          </div>
        </div>
      `;
    }).join("");
  }

  window.pickChatFromModal = function(chatId){
    // aplicar filtro por offer y abrir el chat
    const ch = chatsCache.find(x=>x.id===chatId);
    if(ch){
      offerFilterId = ch.offer_id || null;
      setSelectedOfferPill_();
      renderChats();
      selectChat(chatId);
    }
    closeArticleModal();
  }


  // ===== helpers =====
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }
  function buyerName_(chat){
    const company = String(chat?.buyer_company || "").trim();
    const id = String(chat?.buyer_id || "").trim();
    return company || id || "‚Äî";
  }
  function buyerDisplayWithId_(chat){
    const company = String(chat?.buyer_company || "").trim();
    const id = String(chat?.buyer_id || "").trim();
    if(company && id){
      const shortId = id.length > 10 ? (id.slice(0, 8) + "‚Ä¶") : id;
      return `${company} (${shortId})`;
    }
    return company || id || "‚Äî";
  }

  function setMsg(el, txt, err){
    if(!el) return;
    el.textContent = txt || "";
    el.classList.toggle("err", !!err);
    el.style.display = txt ? "block" : "none";
  }
  function normCode(s){
    return String(s||"").trim().toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
  }
  function parseDuration(v){
    const s = String(v||"").trim().toLowerCase();
    const n = Number(s.replace(/[^0-9]/g,"")) || 0;
    if(s.endsWith("h")) return n * 60 * 60 * 1000;
    if(s.endsWith("d")) return n * 24 * 60 * 60 * 1000;
    return 24 * 60 * 60 * 1000;
  }
  function money(price, cur){
    const p = Number(price);
    const c = String(cur||"USD").toUpperCase();
    if(!Number.isFinite(p)) return "‚Äî";
    return p.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " " + c;
  }
  function explainSetupError(e){
    const msg = String(e?.message || e || "");
    const code = String(e?.code || "");
    const missing = (code === "42P01") || /does not exist/i.test(msg) || /relation .* does not exist/i.test(msg);
    if(missing){
      return "Parece que la BD aun no tiene las tablas de Ofertas/Chats (offers, offer_chats, offer_messages).\n\nSolucion: crea las tablas y politicas RLS en Supabase (te pase el SQL). Luego recarga esta pagina.";
    }
    const denied = (code === "42501") || /permission denied/i.test(msg) || /new row violates row-level security/i.test(msg);
    if(denied){
      return "Permisos/RLS: tu usuario no tiene permiso para esta accion. Revisa las politicas RLS (seller_id = auth.uid()) o si eres admin (profiles.role='admin').";
    }
    return null;
  }

  // ===== Chat: ver/ocultar info (cliente / articulo) =====
  window.toggleChatBlock = function(kind){
    const isClient = kind === "client";
    const body = document.getElementById(isClient ? "clientBody" : "articleBody");
    const txt  = document.getElementById(isClient ? "clientToggleTxt" : "articleToggleTxt");
    if(!body || !txt) return;

    const open = !body.classList.contains("hidden");
    body.classList.toggle("hidden", open);
    txt.textContent = open ? "Mostrar" : "Ocultar";
  }

  function updateChatSideInfo_(){
    // Si aun no hay chat seleccionado
    if(!selectedChat){
      const ids = ["ciBuyer","ciDate","aiOEM","aiBrand","aiPrice","aiCountry"];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.textContent = "‚Äî";
      });
      return;
    }

    const o = selectedChat.offer || {};

    // Cliente
    const buyer = document.getElementById("ciBuyer");
    const date  = document.getElementById("ciDate");
    if(buyer) buyer.textContent = buyerDisplayWithId_(selectedChat);
    if(date)  date.textContent  = selectedChat.created_at ? new Date(selectedChat.created_at).toLocaleString() : "‚Äî";

    // Articulo
    const oem = document.getElementById("aiOEM");
    const br  = document.getElementById("aiBrand");
    const pr  = document.getElementById("aiPrice");
    const co  = document.getElementById("aiCountry");

    if(oem) oem.textContent = o.original || "‚Äî";
    if(br)  br.textContent  = o.brand || "‚Äî";
    if(pr)  pr.textContent  = (o.price!=null && o.price!=="" ? money(o.price, o.currency) : "‚Äî");
    if(co)  co.textContent  = o.country || "‚Äî";
  }

  // ===== Tabs UI =====
  window.showTab = function(which){
    const isBulk = which === "bulk";
    $("bulkPane").classList.toggle("hidden", !isBulk);
    $("onePane").classList.toggle("hidden", isBulk);
    $("tabBulk").classList.toggle("active", isBulk);
    $("tabOne").classList.toggle("active", !isBulk);
  }

  // ===== Auth =====
  async function initAuth(){
    const { data: ses } = await supabase.auth.getSession();
    me = ses?.session?.user || null;

    const params = new URLSearchParams(location.search);
    const isDemo = params.get("demo") === "1";

    if(!me && !isDemo){
      $("who").textContent = "No autenticado";
      $("loginBtn").classList.remove("hidden");
      setMsg($("msg"), "Debes iniciar sesi√≥n para cargar y publicar ofertas.", true);
      offersCache = [];
      chatsCache = [];
      renderOffers();
      renderChats();
      return;
    }

    $("who").textContent = me ? (me.email || me.id || "Usuario") : "Demo";

    // rol (si existe profiles)
    try{
      if(me){
        const { data } = await supabase.from("profiles").select("role").eq("id", me.id).maybeSingle();
        myRole = (data?.role || null);
      }
    }catch(_){}

    const isAdmin = String(myRole||"").toLowerCase() === "admin";
    $("pillRole").textContent = "Rol: " + (isAdmin ? "Admin" : "Vendedor");
    $("pillRole").classList.toggle("ok", !isAdmin);

    // admin read-only en chat
    $("chatComposer").classList.toggle("hidden", isAdmin);
    $("adminReadOnly").classList.toggle("hidden", !isAdmin);

    // aviso auto-borrado (lado BD recomendado)
    $("pillAuto").title = "Para borrar de verdad se recomienda un job en Supabase. Aqu√≠ solo ocultamos expiradas y permitimos borrar manual.";

    // presencia (opcional)
    try{
      if(me){
        const presenceChannel = supabase.channel("rf-online-users", { config:{ presence:{ key: me.id } } });
        await presenceChannel.subscribe(async (status)=>{
          if(status === "SUBSCRIBED"){
            await presenceChannel.track({ at:new Date().toISOString(), page:"obsolescencia" });
          }
        });
      }
    }catch(_){}

    // init sheet
    buildBulkSheet(15);

    await loadOffers(true);
    await loadChats(true);

    supabase.auth.onAuthStateChange((event, session)=>{
      const isDemo2 = (new URLSearchParams(location.search)).get("demo")==="1";
      if(!session && !isDemo2) location.href = "index.html?stay=1";
    });
  }

  async function logout(){
    try{ await supabase.auth.signOut(); }catch(_){}
    location.href = "index.html?stay=1";
  }

  // ===== Create offer (payload) =====
  async function createOfferPayload(payload){
    const { error } = await supabase.from(OFFERS_TABLE).insert([payload]);
    if(error) throw error;
  }

  function clearForm(){
    ["fOriginal","fBrand","fPrice","fDesc"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
    $("hint").textContent = "‚Äî";
    setMsg($("msg"), "", false);
  }

  async function createOfferFromForm(){
    try{
      setMsg($("msg"), "", false);
      if(!me) throw new Error("Debes iniciar sesi√≥n.");

      const original = String($("fOriginal").value||"").trim();
      const brand = String($("fBrand").value||"").trim();
      const desc = String($("fDesc").value||"").trim();
      const country = String($("gCountry").value||"").trim();
      const currency = String($("gCurrency").value||"USD").trim().toUpperCase();
const priceRaw = String($("fPrice").value||"").trim().replace(/,/g,".");
      const price = Number(priceRaw);

      if(!original) throw new Error("Falta el n√∫mero original.");
      if(!brand) throw new Error("Falta la marca.");
      if(!Number.isFinite(price) || price <= 0) throw new Error("Precio inv√°lido.");
      if(!country) throw new Error("Falta el pa√≠s.");

      const durMs = parseDuration($("gDuration").value);
      const expiresAt = new Date(Date.now() + durMs).toISOString();

      const payload = {
        original: original,
        original_norm: normCode(original),
        brand,
        description: desc || null,
        price,
        currency,
        country,
        seller_id: me.id,
        expires_at: expiresAt
      };

      await createOfferPayload(payload);

      $("hint").textContent = "Oferta guardada ‚úÖ";
      clearForm();
      await loadOffers(true);
    }catch(e){
      console.error(e);
      setMsg($("msg"), (explainSetupError(e) || (e?.message || e)), true);
    }
  }

  // ===== Load offers =====
  async function loadOffers(force){
    try{
      if(!me){
        offersCache = [];
        renderOffers();
        return;
      }

      const isAdmin = String(myRole||"").toLowerCase()==="admin";
      const nowIso = new Date().toISOString();

      let q = supabase.from(OFFERS_TABLE)
        .select("id,original,original_norm,brand,price,currency,country,expires_at,created_at,seller_id")
        .gt("expires_at", nowIso)
        .order("created_at", { ascending:false })
        .limit(500);

      if(!isAdmin) q = q.eq("seller_id", me.id);

      const { data, error } = await q;
      if(error) throw error;

      offersCache = data || [];
      renderOffers();
    }catch(e){
      console.error(e);
      setMsg($("msg"), "No pude cargar ofertas: " + (explainSetupError(e) || (e?.message || e)), true);
    }
  }

  function renderOffers(){
    const qq = String($("q").value||"").trim().toLowerCase();
    let rows = offersCache.slice();

    if(qq){
      rows = rows.filter(o=>{
        return String(o.original||"").toLowerCase().includes(qq) ||
               String(o.brand||"").toLowerCase().includes(qq) ||
               String(o.country||"").toLowerCase().includes(qq);
      });
    }

    if(rows.length===0){
      $("offersTbody").innerHTML = '<tr><td colspan="6" class="tdSmall">No hay ofertas.</td></tr>';
      return;
    }

    $("offersTbody").innerHTML = rows.map(o=>{
      const exp = new Date(o.expires_at);
      const expTxt = exp.toLocaleString();
      const leftMs = exp.getTime() - Date.now();
      const warn = leftMs < 6*60*60*1000;
      const pill = warn ? '<span class="pill warn">Pronto</span>' : '<span class="pill ok">Activa</span>';

      return `
        <tr>
          <td class="nowrap"><b>${escapeHtml(o.original||"")}</b><div class="tdSmall">${pill}</div></td>
          <td>${escapeHtml(o.brand||"")}</td>
          <td class="nowrap">${escapeHtml(money(o.price,o.currency))}</td>
          <td>${escapeHtml(o.country||"")}</td>
          <td class="nowrap">${escapeHtml(expTxt)}</td>
          <td style="text-align:right" class="nowrap">
            <div class="tActions">
              <button class="btn btnGhost btnSmall" onclick="openChatsByOffer('${o.id}')">Ver chats</button>
              <button class="btn btnBad btnSmall" onclick="askDel('${o.id}')">Eliminar</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  // ===== Delete offer =====
  let delId = null;
  function askDel(id){
    delId = id;
    const o = offersCache.find(x=>x.id===id);
    $("delTxt").textContent = o ? (`Eliminar oferta ${o.original} (${o.brand})?`) : "Eliminar oferta?";
    $("delBack").style.display = "flex";
  }
  function closeDel(){
    delId = null;
    $("delBack").style.display = "none";
  }
  async function confirmDel(){
    try{
      if(!delId) return;
      const { error } = await supabase.from(OFFERS_TABLE).delete().eq("id", delId);
      if(error) throw error;
      closeDel();
      await loadOffers(true);
      await loadChats(true);
    }catch(e){
      console.error(e);
      setMsg($("msg"), "No pude eliminar: " + (e?.message || e), true);
    }
  }

  // ===== Chats =====
  async function loadChats(force){
    try{
      if(!me){
        chatsCache = [];
        renderChats();
        return;
      }

      const isAdmin = String(myRole||"").toLowerCase()==="admin";

      let q = supabase.from(CHATS_TABLE).select("id,offer_id,buyer_id,seller_id,created_at").order("created_at", { ascending:false }).limit(500);
      if(!isAdmin) q = q.eq("seller_id", me.id);

      const { data: chats, error: chErr } = await q;
      if(chErr) throw chErr;

      const list = chats || [];
      $("chatMeta").textContent = list.length ? (list.length + " chat(s)") : "0 chats";

      const offerIds = Array.from(new Set(list.map(x=>x.offer_id).filter(Boolean)));
      let offersById = {};
      if(offerIds.length){
        const { data: ofs, error: oErr } = await supabase.from(OFFERS_TABLE)
          .select("id,original,brand,price,currency,country")
          .in("id", offerIds)
          .limit(500);
        if(oErr) throw oErr;
        (ofs||[]).forEach(o=> offersById[o.id]=o);
      }

      // traer nombres de compania (buyer) desde profiles
      const buyerIds = Array.from(new Set(list.map(x=>x.buyer_id).filter(Boolean)));
      let buyersById = {};
      if(buyerIds.length){
        const { data: buyers, error: bErr } = await supabase.from("profiles")
          .select("id,company_name")
          .in("id", buyerIds)
          .limit(2000);
        if(bErr) throw bErr;
        (buyers||[]).forEach(p=>{ buyersById[p.id] = p.company_name || null; });
      }

      chatsCache = list.map(c=>({
        ...c,
        offer: offersById[c.offer_id] || null,
        buyer_company: buyersById[c.buyer_id] || null
      }));
      renderChats();
    }catch(e){
      console.error(e);
      setMsg($("msgChat"), "No pude cargar chats: " + (explainSetupError(e) || (e?.message || e)), true);
    }
  }

  function renderChats(){
    const qq = String($("chatFilter").value||"").trim().toLowerCase();
    let list = chatsCache.slice();

    if(offerFilterId){ list = list.filter(c=>c.offer_id===offerFilterId); }

    if(qq){
      list = list.filter(c=>{
        const o = c.offer || {};
        return String(o.original||"").toLowerCase().includes(qq) ||
               String(o.brand||"").toLowerCase().includes(qq) ||
               String(o.country||"").toLowerCase().includes(qq) ||
               String(c.buyer_id||"").toLowerCase().includes(qq) ||
               String(c.buyer_company||"").toLowerCase().includes(qq);
      });
    }

    const hint = document.getElementById("chatListHint");
    const quick = document.getElementById("chatQuick");
    const inlineBox = document.getElementById("chatList");
    const inlineEnabled = inlineBox && !inlineBox.classList.contains("hidden");

    if(hint){
      hint.innerHTML = list.length
        ? `Tienes <b>${list.length}</b> chat(s). Abre la <b>Bandeja de chats</b> para seleccionar el que quieres responder.`
        : `No hay chats.`;
    }
    // Mantener la columna limpia: NO mostramos la lista de chats aqui (solo en el modal).
    if(quick) quick.innerHTML = "";
    if(inlineBox) inlineBox.innerHTML = "";
  }

  window.openChatsByOffer = function(offerId){
    // ahora filtra por articulo y abre el primer chat encontrado
    offerFilterId = offerId || null;
    setSelectedOfferPill_();
    renderChats();

    const chat = chatsCache.find(c=>c.offer_id===offerId);
    if(chat) selectChat(chat.id);
  }

  async function selectChat(chatId){
    const chat = chatsCache.find(c=>c.id===chatId);
    if(!chat) return;
    selectedChat = chat;

    const o = chat.offer || {};
    $("chatTitle").textContent = `Chat ‚Ä¢ ${o.original || "‚Äî"} ‚Ä¢ ${o.brand || "‚Äî"} ‚Ä¢ ${money(o.price,o.currency)} ‚Ä¢ ${o.country || ""}`.trim();
    updateChatSideInfo_();


    await loadMsgs(true);
    startPoll();
    renderChats();
  }

  function startPoll(){
    stopPoll();
    chatPoll = setInterval(()=>loadMsgs(false), 2500);
  }
  function stopPoll(){
    if(chatPoll){ clearInterval(chatPoll); chatPoll=null; }
  }

  async function loadMsgs(scrollBottom){
    try{
      if(!selectedChat) return;
      const { data, error } = await supabase.from(MSGS_TABLE)
        .select("id,chat_id,sender_id,body,created_at")
        .eq("chat_id", selectedChat.id)
        .order("created_at", { ascending:true })
        .limit(300);

      if(error) throw error;

      const isAdmin = String(myRole||"").toLowerCase()==="admin";
      const myId = me?.id;

      $("chatMsgs").innerHTML = (data||[]).map(m=>{
        const mine = (m.sender_id === myId);
        const cls = mine ? "chatMsg chatMe" : "chatMsg chatOther";
        const when = new Date(m.created_at).toLocaleString();
        return `
          <div class="${cls}">
            <div>${escapeHtml(m.body||"")}</div>
            <div class="chatMeta">${escapeHtml(when)}</div>
          </div>
        `;
      }).join("") || '<div class="muted2">No hay mensajes aun.</div>';

      if(scrollBottom){
        const box = $("chatMsgs");
        box.scrollTop = box.scrollHeight;
      }

      $("chatComposer").classList.toggle("hidden", isAdmin);
      $("adminReadOnly").classList.toggle("hidden", !isAdmin);

    }catch(e){
      console.error(e);
      setMsg($("msgChat"), "No pude cargar mensajes: " + (e?.message || e), true);
    }
  }

  async function sendMsg(){
    try{
      const isAdmin = String(myRole||"").toLowerCase()==="admin";
      if(isAdmin) return;

      if(!selectedChat) throw new Error("Selecciona un chat.");
      const txt = String($("chatInput").value||"").trim();
      if(!txt) return;

      $("chatInput").value = "";
      const payload = { chat_id: selectedChat.id, sender_id: me.id, body: txt };

      const { error } = await supabase.from(MSGS_TABLE).insert([payload]);
      if(error) throw error;

      await loadMsgs(true);
    }catch(e){
      console.error(e);
      setMsg($("msgChat"), (explainSetupError(e) || (e?.message || e)), true);
    }
  }

  // ===== BULK SHEET (Excel-like) =====
  const BULK_COLS = [
    { key:"original",  label:"OEM",        placeholder:"A2762001000" },
    { key:"brand",     label:"Marca",      placeholder:"Mahle" },
    { key:"price",     label:"Precio",     placeholder:"125.50" },
    { key:"desc",      label:"Desc",       placeholder:"Notas internas" },
  ];

function buildBulkSheet(rows){
    const tb = $("bulkBody");
    tb.innerHTML = "";
    for(let i=0;i<rows;i++){
      const tr = document.createElement("tr");

      // row number (sticky)
      const tdN = document.createElement("td");
      tdN.className = "rowNum";
      tdN.textContent = String(i+1);
      tr.appendChild(tdN);

      BULK_COLS.forEach((c, idx)=>{
        const td = document.createElement("td");

        const div = document.createElement("div");
        div.className = "cell";
        div.contentEditable = "true";
        div.dataset.r = String(i);
        div.dataset.c = String(idx);
        div.dataset.key = c.key;

        // aplicar alineacion global
        div.style.textAlign = bulkAlign;

        // tama√±os
        if(c.key==="original") td.style.minWidth="190px";
        if(c.key==="brand") td.style.minWidth="170px";
        if(c.key==="price") td.style.minWidth="120px";
        if(c.key==="desc") td.style.minWidth="520px";

        div.setAttribute("spellcheck","false");
        div.title = c.placeholder;

        td.appendChild(div);
        tr.appendChild(td);
      });

      tb.appendChild(tr);
    }

    wireSheetPaste();
    $("bulkHint").textContent = "Listo. Pega desde Excel/Sheets o importa un CSV.";
  }

  window.addBulkRows = function(n){
    n = Number(n)||0;
    if(n<=0) return;
    const cur = $("bulkBody").children.length;
    buildBulkSheet(cur + n);
  }

  window.clearBulkSheet = function(){
    const cells = $("bulkBody").querySelectorAll(".cell");
    cells.forEach(c=> c.textContent="");
    $("bulkHint").textContent = "Hoja limpiada.";
  }

  function getCell(r,c){
    return $("bulkBody").querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
  }

  function wireSheetPaste(){
    const wrap = $("sheetWrap");
    // Pegar TSV/CSV directo en la hoja
    wrap.onpaste = (ev)=>{
      const active = document.activeElement;
      if(!(active && active.classList && active.classList.contains("cell"))) return;

      ev.preventDefault();
      const text = ev.clipboardData.getData("text/plain") || "";
      if(!text.trim()) return;

      const startR = Number(active.dataset.r)||0;
      const startC = Number(active.dataset.c)||0;

      const rows = text.replace(/\r/g,"").split("\n").filter(x=>x.length>0);
      const grid = rows.map(line=>{
        // intenta tab primero
        if(line.includes("\t")) return line.split("\t");
        // luego ; o ,
        const sep = line.includes(";") && !line.includes(",") ? ";" : ",";
        return line.split(sep);
      });

      for(let r=0;r<grid.length;r++){
        for(let c=0;c<grid[r].length;c++){
          const cell = getCell(startR + r, startC + c);
          if(cell) cell.textContent = String(grid[r][c] ?? "").trim();
        }
      }
      $("bulkHint").textContent = `Pegado ‚úÖ (${grid.length} fila(s))`;
    };

    // navegaci√≥n b√°sica con Enter (baja) / Tab (derecha)
    $("bulkBody").onkeydown = (ev)=>{
      const a = document.activeElement;
      if(!(a && a.classList && a.classList.contains("cell"))) return;

      const r = Number(a.dataset.r)||0;
      const c = Number(a.dataset.c)||0;

      if(ev.key === "Enter"){
        ev.preventDefault();
        const next = getCell(r+1, c) || getCell(r, c+1);
        if(next){ next.focus(); document.getSelection()?.collapseToEnd(); }
      }
    };
  }

  // ===== Import / Export template =====
  window.downloadTemplate = function(){
    const header = ["OEM","Marca","Precio","Descripci√≥n"];
    const sample = ["A2762001000","Mahle","125.50","Notas internas"];
    const csv = [header.join(","), sample.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(",")].join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "plantilla_ofertas_repuestofinder.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  window.triggerImport = function(){
    $("bulkFile").click();
  }

  function parseCSV(text){
    // parser simple: acepta CSV con , o ; o \t. Tambi√©n permite comillas.
    const t = String(text||"").replace(/\r/g,"").trim();
    if(!t) return [];
    const lines = t.split("\n").filter(x=>x.trim().length>0);

    // detectar separador por la primera linea (sin comillas)
    const l0 = lines[0];
    const cComma = (l0.match(/,/g)||[]).length;
    const cSemi  = (l0.match(/;/g)||[]).length;
    const cTab   = (l0.match(/\t/g)||[]).length;
    const sep = cTab>=cComma && cTab>=cSemi ? "\t" : (cSemi>cComma ? ";" : ",");

    const out = [];
    for(const line of lines){
      // split respetando comillas
      const row = [];
      let cur = "";
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        }else if(!inQ && ch === sep){
          row.push(cur.trim());
          cur = "";
        }else{
          cur += ch;
        }
      }
      row.push(cur.trim());
      out.push(row);
    }
    return out;
  }

  $("bulkFile").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    try{
      const text = await f.text();
      const grid = parseCSV(text);
      if(!grid.length) return;

      // si parece header, saltar
      const head = grid[0].map(x=>String(x||"").toLowerCase());
      const looksHeader = head.includes("oem") || head.includes("marca") || head.includes("precio");
      const data = looksHeader ? grid.slice(1) : grid;

      const needRows = Math.max(15, data.length);
      buildBulkSheet(needRows);

      for(let r=0;r<data.length;r++){
        for(let c=0;c<Math.min(BULK_COLS.length, data[r].length);c++){
          const cell = getCell(r, c);
          if(cell) cell.textContent = String(data[r][c] ?? "").trim();
        }
      }
      $("bulkHint").textContent = `Importado ‚úÖ (${data.length} fila(s))`;
    }catch(e){
      console.error(e);
      $("bulkHint").textContent = "No pude importar ese archivo.";
    }finally{
      ev.target.value = "";
    }
  });

  function readBulkRows(){
    const rows = [];
    const trList = Array.from($("bulkBody").children);
    for(let r=0;r<trList.length;r++){
      const obj = {};
      for(let c=0;c<BULK_COLS.length;c++){
        const cell = getCell(r,c);
        const key = BULK_COLS[c].key;
        obj[key] = String(cell?.textContent || "").trim();
      }
      rows.push(obj);
    }
    return rows;
  }

  window.bulkSave = async function(){
    try{
      setMsg($("msg"), "", false);
      if(!me) throw new Error("Debes iniciar sesi√≥n.");

      const rows = readBulkRows();

      // validar y convertir
      const good = [];
      const badIdx = [];

      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        const original = r.original;
        const brand = r.brand;
        const country = String($("gCountry").value||"").trim();
        const currency = String($("gCurrency").value||"USD").trim().toUpperCase();
        const duration = String($("gDuration").value||"24h").trim();
const desc = r.desc;

        const price = Number(String(r.price||"").replace(/,/g,"."));
        const any = [original, brand, r.price, desc].some(x=>String(x||"").trim().length>0);
        if(!any) continue; // fila vac√≠a

        if(!original || !brand || !Number.isFinite(price) || price<=0){
          badIdx.push(i+1);
          continue;
        }

        const expiresAt = new Date(Date.now() + parseDuration(duration)).toISOString();

        good.push({
          original,
          original_norm: normCode(original),
          brand,
          description: desc || null,
          price,
          currency: currency || "USD",
          country,
          seller_id: me.id,
          expires_at: expiresAt
        });
      }

      if(!good.length){
        $("bulkHint").textContent = badIdx.length
          ? ("No guard√© nada. Filas con datos pero incompletas: " + badIdx.join(", "))
          : "No hay filas con datos para guardar.";
        return;
      }

      // insertar por lotes (por si son muchas)
      const chunkSize = 100;
      let ok = 0;
      for(let i=0;i<good.length;i+=chunkSize){
        const chunk = good.slice(i, i+chunkSize);
        const { error } = await supabase.from(OFFERS_TABLE).insert(chunk);
        if(error) throw error;
        ok += chunk.length;
      }

      $("bulkHint").textContent = `Guardadas ‚úÖ ${ok} oferta(s)` + (badIdx.length ? (" | Filas incompletas: " + badIdx.join(", ")) : "");
      await loadOffers(true);
    }catch(e){
      console.error(e);
      setMsg($("msg"), (explainSetupError(e) || (e?.message || e)), true);
      $("bulkHint").textContent = "Error al guardar.";
    }
  }

  // ===== Bind UI events (module-safe) =====
  function bindUI(){
    const bSave = $("btnSave");
    if(bSave) bSave.addEventListener("click", (ev)=>{ ev.preventDefault(); createOfferFromForm(); });

    const bClear = $("btnClear");
    if(bClear) bClear.addEventListener("click", (ev)=>{ ev.preventDefault(); clearForm(); });

    const bRO = $("btnRefreshOffers");
    if(bRO) bRO.addEventListener("click", (ev)=>{ ev.preventDefault(); loadOffers(true); });

    const bRC = $("btnRefreshChats");
    if(bRC) bRC.addEventListener("click", (ev)=>{ ev.preventDefault(); loadChats(true); });

    // exponer globals usados por inline handlers
    window.renderOffers  = renderOffers;
    window.renderChats   = renderChats;
    window.logout        = logout;
    window.sendMsg       = sendMsg;

    window.askDel        = askDel;
    window.closeDel      = closeDel;
    window.confirmDel    = confirmDel;
    window.selectChat    = selectChat;
  }

  bindUI();
  populateGlobalSelects();
  // init alignment buttons state
  syncAlignUI_();
  // apply stored alignment when sheet exists
  window.setBulkAlign(bulkAlign);
  initAuth();
</script>

</body>
</html>











