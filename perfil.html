<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Perfil</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.92);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(rgba(246,247,251,.92), rgba(246,247,251,.92)),
        url("assets/bg.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      min-height:100vh;
    }
    .page{ width:min(1180px, 100%); margin:0 auto; padding:18px 18px 28px; }

    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background:rgba(246,247,251,.68);
      border:1px solid rgba(230,232,240,.75);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900; user-select:none;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .brandTitle{line-height:1}
    .brandTitle b{display:block;font-size:15px}
    .brandTitle span{display:block;font-size:12px;color:#94a3b8;font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-top:2px}

    .navRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:10px 12px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnDanger{background:#ef4444;color:#fff}
    .btnDanger:hover{filter:brightness(.95)}
    .btnGhost{background:#fff;border:1px solid var(--line);color:#0f172a}
    .btnSmall{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .btnTiny{ padding:7px 9px; border-radius:10px; font-size:12px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0;font-size:16px;font-weight:900}
    .muted{color:var(--mut);font-size:12px;font-weight:800}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px}
    @media(max-width:700px){ .row{grid-template-columns:1fr} }

    .field label{display:block;font-size:12px;color:#334155;font-weight:900;margin-bottom:6px}
    .inp{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      outline:none;
      font-weight:800;
      color:#0f172a;
    }
    .inp:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      color:#0f172a;
      white-space:nowrap;
    }
    .pill.ok{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.20); color:var(--ok); }
    .pill.warn{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.22); color:#a16207; }
    .pill.bad{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.18); color:#991b1b; }

    .dot{
      width:10px;height:10px;border-radius:999px;
      display:inline-block;
      background:#cbd5e1;
      box-shadow:0 0 0 3px rgba(203,213,225,.35);
    }
    .dot.on{
      background: var(--ok);
      box-shadow:0 0 0 3px rgba(22,163,74,.18);
    }
    .dot.off{
      background: #cbd5e1;
      box-shadow:0 0 0 3px rgba(203,213,225,.35);
    }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      padding:10px 12px;
      border-radius:14px;
      display:none;
    }
    .msg.err{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.18);
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
    .tab{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .tab.active{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.20);
      color:var(--pri);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      background:#fff;
      border:1px solid rgba(230,232,240,.95);
      border-radius:14px;
      overflow:hidden;
    }
    th,td{padding:10px;border-bottom:1px solid rgba(230,232,240,.75);text-align:left;vertical-align:middle}
    th{
      background:rgba(246,247,251,.8);
      font-size:11px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:#94a3b8;
      font-weight:900;
    }
    tr:last-child td{border-bottom:0}

    .topLine{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:16px;
    }
    .modal{
      width:min(720px, 100%);
      background:rgba(255,255,255,.98);
      border:1px solid rgba(230,232,240,.95);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(230,232,240,.9);
      background:rgba(246,247,251,.65);
    }
    .modalHead h3{margin:0;font-size:15px;font-weight:900}
    .modalBody{ padding:14px 16px; }
    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(230,232,240,.9);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      background:rgba(246,247,251,.65);
    }
    .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:900;
      color:#0f172a;
      outline:none;
    }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width:720px){ .two{grid-template-columns:1fr} }
    .hint{
      font-size:12px;
      color:#334155;
      font-weight:800;
      margin-top:8px;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="logo">RF</div>
        <div class="brandTitle">
          <b>RepuestoFinder</b>
          <span>Perfil</span>
        </div>
      </div>

      <div class="navRight">
        <button class="btn btnGhost" onclick="goDashboard()">Dashboard</button>
        <button class="btn btnGhost" id="btnLogout" style="display:none" onclick="logout()">Salir</button>
        <button class="btn btnPrimary" id="btnLogin" style="display:none" onclick="goLogin()">Login</button>
      </div>
    </div>

    <div class="topLine">
      <div>
        <div class="pill" id="whoPill">Cargando sesión…</div>
        <div class="muted" id="whoSub" style="margin-top:6px"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btnGhost btnSmall" onclick="refresh()">Actualizar</button>
        <button class="btn btnGhost btnSmall" onclick="openEdit()">Editar mis datos</button>
      </div>
    </div>

    <div class="msg err" id="banExpired" style="display:none"></div>

    <div class="grid">
      <div class="card">
        <h2>Mis datos</h2>
        <div class="muted">Solo tú ves tus datos. El administrador ve todo.</div>

        <div class="row">
          <div class="field">
            <label>Nombre</label>
            <input class="inp" id="first_name" disabled>
          </div>
          <div class="field">
            <label>Apellido</label>
            <input class="inp" id="last_name" disabled>
          </div>
          <div class="field">
            <label>Empresa</label>
            <input class="inp" id="company_name" disabled>
          </div>
          <div class="field">
            <label>Teléfono</label>
            <input class="inp" id="phone" disabled>
          </div>
          <div class="field">
            <label>Username</label>
            <input class="inp" id="username" disabled>
          </div>
          <div class="field">
            <label>Email</label>
            <input class="inp" id="email" disabled>
          </div>
        </div>

        <div class="msg" id="msgProfile"></div>
      </div>

      <div class="card">
        <h2>Mi membresía</h2>
        <div class="muted">Estado del plan, fechas y días restantes.</div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <span class="pill" id="pillStatus">—</span>
          <span class="pill" id="pillPlan">Plan: —</span>
          <span class="pill" id="pillDays">Días restantes: —</span>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label>Inicio del período</label>
            <input class="inp" id="current_period_start" disabled>
          </div>
          <div class="field">
            <label>Fin del período</label>
            <input class="inp" id="current_period_end" disabled>
          </div>
          <div class="field">
            <label>Último pago</label>
            <input class="inp" id="last_payment_at" disabled>
          </div>
          <div class="field">
            <label>Grace (si aplica)</label>
            <input class="inp" id="grace_end" disabled>
          </div>
        </div>

        <div class="msg" id="msgSub"></div>
      </div>
    </div>

    <!-- Admin -->
    <div class="card" id="adminCard" style="display:none;margin-top:14px">
      <div style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <h2>Administrador</h2>
        <div class="muted">Lista de usuarios y membresías (solo admin).</div>
      </div>

      <div class="tabs" style="margin-top:12px">
        <button class="tab active" id="tabUsers" onclick="switchAdminTab('users')">Usuarios</button>
        <button class="tab" id="tabSubs" onclick="switchAdminTab('subs')">Suscripciones</button>
      </div>

      <div id="paneUsers">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Empresa</th>
              <th>Teléfono</th>
              <th>Username</th>
              <th>Rol</th>
              <th>Activo</th>
            </tr>
          </thead>
          <tbody id="adminUsersBody">
            <tr><td colspan="6" class="muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>

      <div id="paneSubs" style="display:none">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>En línea</th>
              <th>Plan</th>
              <th>Status</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Pago</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="adminSubsBody">
            <tr><td colspan="8" class="muted">Cargando…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="msg" id="msgAdmin"></div>
    </div>

  </div>

  <!-- Modal renovar membresía -->
  <div class="modalBack" id="renewBack">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Renovar membresía</h3>
          <div class="muted" id="renewSubtitle">—</div>
        </div>
        <button class="btn btnGhost btnTiny" onclick="closeRenew()">✕</button>
      </div>

      <div class="modalBody">
        <div class="two">
          <div class="field">
            <label>Plan</label>
            <select class="select" id="renewPlanSelect"></select>
          </div>
          <div class="field">
            <label>Días</label>
            <input class="inp" id="renewDays" type="number" min="1" value="30">
          </div>
        </div>

        <div class="hint">
          Esto intenta renovar creando/actualizando un registro en <b>subscriptions</b> y ajustando <b>profiles.active_plan_id</b>.
          Si tu RLS no permite que el admin edite suscripciones de otros, te saldrá error (y ahí lo hacemos por Edge Function).
        </div>

        <div class="msg" id="renewMsg"></div>
      </div>

      <div class="modalFoot">
        <button class="btn btnGhost" onclick="closeRenew()">Cancelar</button>
        <button class="btn btnPrimary" onclick="confirmRenew()">Confirmar renovación</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";

    const PRESENCE_CHANNEL = "rf-online-users";
    const presenceChannel = supabase.channel(PRESENCE_CHANNEL, {
      config: { presence: { key: user.id } }
    });

    await presenceChannel.subscribe(async (status) => {
      if (status === "SUBSCRIBED") {
        await presenceChannel.track({ at: new Date().toISOString() });
      }
    });


    const $ = (id)=>document.getElementById(id);

    // ====== CONFIG ======
    const PRESENCE_CHANNEL = "rf-online-users"; // canal realtime presence
    const PLANS_TABLE = "plans";                // tabla de planes en supabase
    // ====================

    function setMsg(el, text, isErr){
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    function fmtDate(s){
      if(!s) return "—";
      const d = new Date(s);
      if(isNaN(d.getTime())) return String(s);
      return d.toLocaleString("es-DO", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function daysBetween(now, end){
      try{
        const a = new Date(now).getTime();
        const b = new Date(end).getTime();
        if(isNaN(a) || isNaN(b)) return null;
        const diff = Math.ceil((b - a) / (1000*60*60*24));
        return diff;
      }catch(_){ return null; }
    }

    function setPill(el, text, kind){
      el.textContent = text;
      el.classList.remove("ok","warn","bad");
      if(kind) el.classList.add(kind);
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    function fullName(p){
      const name = [p?.first_name, p?.last_name].filter(Boolean).join(" ").trim();
      return name || p?.username || p?.email || "—";
    }

    // ====== NAV ======
    window.goDashboard = ()=> window.location.href = "index.html";
    window.goLogin = ()=> window.location.href = "login.html";
    window.logout = async ()=>{ await supabase.auth.signOut(); window.location.href = "index.html"; };

    window.openEdit = ()=> {
      ["first_name","last_name","company_name","phone"].forEach(id=>{
        const el = $(id);
        if(el) el.disabled = false;
      });
      setMsg($("msgProfile"), "Edita tus datos y luego presiona 'Actualizar' (guardado se integra luego).", false);
    };

    window.switchAdminTab = (tab)=>{
      $("tabUsers").classList.toggle("active", tab==="users");
      $("tabSubs").classList.toggle("active", tab==="subs");
      $("paneUsers").style.display = (tab==="users") ? "block" : "none";
      $("paneSubs").style.display  = (tab==="subs")  ? "block" : "none";
    };

    // ====== DATA LOADERS ======
    async function loadMyProfile(userId){
      const { data, error } = await supabase
        .from("profiles")
        .select("id,first_name,last_name,company_name,phone,role,status,username,email,country,active_plan_id,activated_at,is_active,created_at,updated_at")
        .eq("id", userId)
        .maybeSingle();

      if(error) throw error;
      return data || null;
    }

    async function loadMySubscription(userId){
      const { data, error } = await supabase
        .from("subscriptions")
        .select("id,user_id,plan_id,status,current_period_start,current_period_end,grace_end,last_payment_at,paypal_subscription_id,paypal_order_id,updated_at")
        .eq("user_id", userId)
        .order("updated_at", { ascending:false })
        .limit(1)
        .maybeSingle();

      if(error) throw error;
      return data || null;
    }

    function fillProfile(p){
      $("first_name").value = p?.first_name || "";
      $("last_name").value = p?.last_name || "";
      $("company_name").value = p?.company_name || "";
      $("phone").value = p?.phone || "";
      $("username").value = p?.username || "";
      $("email").value = p?.email || "";
    }

    function fillSubscription(s, profile){
      const now = new Date();

      const rawStatus = (s?.status || "").toString().toLowerCase();
      const plan = (s?.plan_id ?? profile?.active_plan_id ?? "—");

      const startISO = s?.current_period_start || null;
      const endISO   = s?.current_period_end || null;
      const graceISO = s?.grace_end || null;

      $("current_period_start").value = fmtDate(startISO);
      $("current_period_end").value   = fmtDate(endISO);
      $("last_payment_at").value      = fmtDate(s?.last_payment_at);
      $("grace_end").value            = fmtDate(graceISO);

      const daysToEnd = endISO ? daysBetween(now, endISO) : null;
      const daysToGrace = graceISO ? daysBetween(now, graceISO) : null;

      let computed = "unknown";
      if(endISO){
        if(new Date(now).getTime() <= new Date(endISO).getTime()){
          computed = "active";
        }else{
          if(graceISO && new Date(now).getTime() <= new Date(graceISO).getTime()){
            computed = "grace";
          }else{
            computed = "expired";
          }
        }
      }

      let finalStatus = rawStatus || computed;
      if(computed === "expired") finalStatus = "expired";
      if(computed === "grace") finalStatus = "grace";
      if(!finalStatus) finalStatus = "unknown";

      let statusKind = "warn";
      if(finalStatus === "active") statusKind = "ok";
      if(finalStatus === "expired" || finalStatus === "canceled") statusKind = "bad";
      if(finalStatus === "grace") statusKind = "warn";

      setPill($("pillStatus"), "Estado: " + finalStatus, statusKind);
      setPill($("pillPlan"), "Plan: " + plan, null);

      const shownDays = (daysToEnd === null) ? "—" : String(Math.max(0, daysToEnd));
      let daysKind = "warn";
      if(daysToEnd === null) daysKind = "warn";
      else if(daysToEnd <= 0) daysKind = (finalStatus === "grace") ? "warn" : "bad";
      else if(daysToEnd <= 5) daysKind = "warn";
      else daysKind = "ok";

      setPill($("pillDays"), "Días restantes: " + shownDays, daysKind);

      const ban = $("banExpired");
      if(finalStatus === "expired"){
        ban.style.display = "block";
        ban.classList.add("err");
        ban.innerHTML = `Tu membresía está <b>VENCIDA</b>. Para usar el sistema, renueva tu plan.`;
      }else if(finalStatus === "grace"){
        const dg = (daysToGrace===null) ? "—" : String(Math.max(0, daysToGrace));
        ban.style.display = "block";
        ban.classList.remove("err");
        ban.innerHTML = `Estás en <b>GRACE</b>. Te quedan <b>${dg}</b> días de gracia para renovar.`;
      }else{
        ban.style.display = "none";
      }
    }

    // ====== PRESENCE (ONLINE REAL TIME) ======
    let presenceChannel = null;
    let onlineSet = new Set();       // user_ids online
    let isAdmin = false;
    let myUserId = null;

    function isOnline(userId){
      return onlineSet.has(userId);
    }

    function rebuildOnlineSetFromPresenceState(state){
      const s = new Set();
      // state keys are "presence keys"; we use key=userId
      Object.keys(state || {}).forEach(k => {
        // k puede ser userId si la key es el userId
        s.add(k);
      });
      onlineSet = s;
    }

    async function startPresence(role, userId){
      // Cualquier usuario que esté en esta página reporta "online" por Realtime presence.
      // El admin ve quién está online al instante.
      if(presenceChannel){
        try{ await supabase.removeChannel(presenceChannel); }catch(_){}
        presenceChannel = null;
      }

      presenceChannel = supabase.channel(PRESENCE_CHANNEL, {
        config: { presence: { key: userId } }
      });

      presenceChannel.on("presence", { event: "sync" }, () => {
        const state = presenceChannel.presenceState();
        rebuildOnlineSetFromPresenceState(state);
        if(isAdmin){
          renderAdminSubs(); // re-render para refrescar la columna "En línea"
        }
      });

      presenceChannel.on("presence", { event: "join" }, ({ key }) => {
        if(key) onlineSet.add(key);
        if(isAdmin) renderAdminSubs();
      });

      presenceChannel.on("presence", { event: "leave" }, ({ key }) => {
        if(key) onlineSet.delete(key);
        if(isAdmin) renderAdminSubs();
      });

      await presenceChannel.subscribe(async (status) => {
        if(status === "SUBSCRIBED"){
          try{
            await presenceChannel.track({ at: new Date().toISOString() });
          }catch(_){}
        }
      });
    }

    // ====== ADMIN TABLES ======
    let adminProfiles = [];           // profiles list
    let profilesById = new Map();     // id -> profile
    let adminSubs = [];               // subs list

    async function loadAdminTables(){
      // Cargar profiles
      const { data: users, error: e1 } = await supabase
        .from("profiles")
        .select("id,first_name,last_name,company_name,phone,username,role,is_active,status,email")
        .order("created_at", { ascending:false })
        .limit(500);

      if(e1) throw e1;

      adminProfiles = users || [];
      profilesById = new Map(adminProfiles.map(u => [u.id, u]));

      const ub = $("adminUsersBody");
      ub.innerHTML = adminProfiles.map(u=>{
        const name = fullName(u);
        return `
          <tr>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(u.company_name || "—")}</td>
            <td>${escapeHtml(u.phone || "—")}</td>
            <td>${escapeHtml(u.username || "—")}</td>
            <td>${escapeHtml(u.role || "user")}</td>
            <td>${u.is_active ? '<span class="pill ok">Sí</span>' : '<span class="pill bad">No</span>'}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" class="muted">No hay datos</td></tr>`;

      // Cargar subscriptions
      const { data: subs, error: e2 } = await supabase
        .from("subscriptions")
        .select("id,user_id,plan_id,status,current_period_start,current_period_end,last_payment_at,updated_at")
        .order("updated_at", { ascending:false })
        .limit(500);

      if(e2) throw e2;

      adminSubs = subs || [];
      renderAdminSubs();
    }

    function renderAdminSubs(){
      const sb = $("adminSubsBody");
      if(!sb) return;

      sb.innerHTML = (adminSubs || []).map(s=>{
        const p = profilesById.get(s.user_id) || null;
        const name = p ? fullName(p) : (s.user_id || "—");
        const dleft = s.current_period_end ? daysBetween(new Date(), s.current_period_end) : null;
        const stKind = (String(s.status || "").toLowerCase()==="active")
          ? "ok"
          : (dleft!==null && dleft<=0 ? "bad" : "warn");

        const online = isOnline(s.user_id);
        const dot = online ? `<span class="dot on"></span>` : `<span class="dot off"></span>`;
        const onlineText = online ? `<span class="pill ok">${dot} En línea</span>` : `<span class="pill">${dot} Offline</span>`;

        return `
          <tr>
            <td>${escapeHtml(name)}</td>
            <td>${onlineText}</td>
            <td>${escapeHtml(String(s.plan_id ?? "—"))}</td>
            <td><span class="pill ${stKind}">${escapeHtml(s.status || "—")}</span></td>
            <td>${escapeHtml(fmtDate(s.current_period_start))}</td>
            <td>${escapeHtml(fmtDate(s.current_period_end))}</td>
            <td>${escapeHtml(fmtDate(s.last_payment_at))}</td>
            <td>
              <button class="btn btnPrimary btnTiny" onclick="openRenew('${escapeHtml(s.user_id)}')">Renovar</button>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="8" class="muted">No hay datos</td></tr>`;
    }

    // ====== RENOVAR MODAL ======
    let plansCache = [];
    let renewUserId = null;

    function planLabel(plan){
      // Tratamos de adivinar campos comunes: name/title/label
      const title = plan?.name || plan?.title || plan?.label || plan?.plan_name || ("Plan " + (plan?.id ?? ""));
      const price = plan?.price_usd ?? plan?.price ?? plan?.amount ?? null;
      const days = plan?.days ?? plan?.duration_days ?? plan?.period_days ?? null;
      const extra = [];
      if(price !== null && price !== undefined && price !== "") extra.push(`$${price}`);
      if(days) extra.push(`${days} días`);
      return extra.length ? `${title} • ${extra.join(" • ")}` : String(title);
    }

    async function loadPlansOnce(){
      if(plansCache.length) return plansCache;

      // Intento: traer todo; si tu tabla es diferente igual funciona mostrando lo que exista.
      const { data, error } = await supabase
        .from(PLANS_TABLE)
        .select("*")
        .order("id", { ascending:true });

      if(error){
        // Si tu tabla no se llama "plans" o RLS bloquea, lo reflejamos.
        plansCache = [];
        throw error;
      }

      plansCache = data || [];
      return plansCache;
    }

    window.openRenew = async (userId)=>{
      renewUserId = userId;
      setMsg($("renewMsg"), "", false);
      $("renewSubtitle").textContent = userId ? ("Usuario: " + userId) : "—";
      $("renewDays").value = 30;

      $("renewBack").style.display = "flex";

      try{
        const plans = await loadPlansOnce();
        const sel = $("renewPlanSelect");
        if(!plans.length){
          sel.innerHTML = `<option value="">No hay planes en la tabla "${escapeHtml(PLANS_TABLE)}"</option>`;
          return;
        }

        sel.innerHTML = plans.map(p=>{
          const id = p?.id ?? p?.plan_id ?? "";
          return `<option value="${escapeHtml(String(id))}">${escapeHtml(planLabel(p))}</option>`;
        }).join("");

        // si algún plan trae days, setearlo
        const first = plans[0];
        const d = first?.days ?? first?.duration_days ?? first?.period_days ?? null;
        if(d) $("renewDays").value = d;

        sel.onchange = ()=>{
          const pid = sel.value;
          const picked = plans.find(x => String((x.id ?? x.plan_id)) === String(pid));
          const dd = picked?.days ?? picked?.duration_days ?? picked?.period_days ?? null;
          if(dd) $("renewDays").value = dd;
        };
      }catch(err){
        setMsg($("renewMsg"), "Error cargando planes: " + (err?.message || err), true);
      }
    };

    window.closeRenew = ()=>{
      $("renewBack").style.display = "none";
      renewUserId = null;
    };

    function addDaysISO(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + Number(days || 0));
      return d.toISOString();
    }

    window.confirmRenew = async ()=>{
      if(!renewUserId){
        setMsg($("renewMsg"), "No tengo el usuario para renovar.", true);
        return;
      }

      const planId = $("renewPlanSelect").value;
      const days = Number($("renewDays").value || 30);

      if(!planId){
        setMsg($("renewMsg"), "Selecciona un plan.", true);
        return;
      }
      if(!days || days < 1){
        setMsg($("renewMsg"), "Los días deben ser mayor a 0.", true);
        return;
      }

      try{
        setMsg($("renewMsg"), "Procesando renovación…", false);

        const now = new Date();
        const start = now.toISOString();
        const end = addDaysISO(now, days);

        // 1) Upsert subscription para ese usuario
        // Nota: Esto requiere RLS que permita a admin editar otros users.
        const { error: e1 } = await supabase
          .from("subscriptions")
          .upsert({
            user_id: renewUserId,
            plan_id: planId,
            status: "active",
            current_period_start: start,
            current_period_end: end,
            last_payment_at: start,
            updated_at: start
          }, { onConflict: "user_id" });

        if(e1) throw e1;

        // 2) Update profile (opcional)
        const { error: e2 } = await supabase
          .from("profiles")
          .update({
            active_plan_id: planId,
            is_active: true,
            status: "active",
            updated_at: start
          })
          .eq("id", renewUserId);

        if(e2) throw e2;

        setMsg($("renewMsg"), "✅ Renovación aplicada. Actualizando tablas…", false);

        // refrescar admin subs
        plansCache = plansCache; // keep
        await loadAdminTables();

        // cerrar
        setTimeout(()=> closeRenew(), 650);
      }catch(err){
        setMsg($("renewMsg"), "❌ No se pudo renovar: " + (err?.message || err), true);
      }
    };

    // ====== INIT ======
    async function init(){
      setMsg($("msgProfile"), "", false);
      setMsg($("msgSub"), "", false);
      setMsg($("msgAdmin"), "", false);

      const { data: ses } = await supabase.auth.getSession();
      const user = ses?.session?.user;

      $("btnLogout").style.display = user ? "" : "none";
      $("btnLogin").style.display  = user ? "none" : "";

      if(!user){
        setPill($("whoPill"), "No has iniciado sesión", "bad");
        $("whoSub").textContent = "Inicia sesión para ver tu perfil.";
        return;
      }

      myUserId = user.id;

      setPill($("whoPill"), "Sesión activa", "ok");
      $("whoSub").textContent = "Cargando perfil…";

      try{
        const profile = await loadMyProfile(user.id);
        if(!profile){
          setMsg($("msgProfile"), "No encontré tu perfil en la tabla 'profiles'.", true);
          return;
        }
        fillProfile(profile);

        const role = (profile.role || "user").toLowerCase();
        isAdmin = (role === "admin");

        // ✅ (3) UID/Rol solo admin
        if(isAdmin){
          $("whoSub").textContent = `UID: ${user.id} • Rol: ${role}`;
        }else{
          // Para usuarios normales: no mostrar UID
          const nice = fullName(profile);
          const mail = profile.email ? ` • ${profile.email}` : "";
          $("whoSub").textContent = `${nice}${mail}`;
        }

        // suscripción
        const sub = await loadMySubscription(user.id);
        fillSubscription(sub, profile);

        // ✅ presence (online)
        await startPresence(role, user.id);

        // admin tables
        if(isAdmin){
          $("adminCard").style.display = "block";
          await loadAdminTables();
        }else{
          $("adminCard").style.display = "none";
        }
      }catch(err){
        setMsg($("msgProfile"), "Error cargando: " + (err?.message || err), true);
      }
    }

    window.refresh = init;

    init();
  </script>
</body>
</html>

