<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RepuestoFinder - Perfil</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg:#f6f7fb;
      --card:rgba(255,255,255,.92);
      --line:rgba(230,232,240,.95);
      --txt:#0f172a;
      --mut:#64748b;
      --pri:#2563eb;
      --pri2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37,99,235,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(rgba(246,247,251,.92), rgba(246,247,251,.92)),
        url("assets/bg.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      min-height:100vh;
    }
    .page{ width:min(1180px, 100%); margin:0 auto; padding:18px 18px 28px; }

    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background:rgba(246,247,251,.68);
      border:1px solid rgba(230,232,240,.75);
      border-radius:18px;
      box-shadow:0 10px 26px rgba(2,6,23,.08);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:#111;color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:900; user-select:none;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
    }
    .brandTitle{line-height:1}
    .brandTitle b{display:block;font-size:15px}
    .brandTitle span{display:block;font-size:12px;color:#94a3b8;font-weight:800;letter-spacing:.4px;text-transform:uppercase;margin-top:2px}

    .navRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:12px; padding:10px 12px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{background:var(--pri);color:#fff}
    .btnPrimary:hover{background:var(--pri2)}
    .btnDanger{background:#ef4444;color:#fff}
    .btnDanger:hover{filter:brightness(.95)}
    .btnGhost{background:#fff;border:1px solid var(--line);color:#0f172a}
    .btnSmall{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .btnTiny{ padding:7px 9px; border-radius:10px; font-size:12px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0;font-size:16px;font-weight:900}
    .muted{color:var(--mut);font-size:12px;font-weight:800}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px}
    @media(max-width:700px){ .row{grid-template-columns:1fr} }

    .field label{display:block;font-size:12px;color:#334155;font-weight:900;margin-bottom:6px}
    .inp{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      outline:none;
      font-weight:800;
      color:#0f172a;
    }
    .inp:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      color:#0f172a;
      white-space:nowrap;
    }
    .pill.ok{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.20); color:var(--ok); }
    .pill.warn{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.22); color:#a16207; }
    .pill.bad{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.18); color:#991b1b; }

    .dot{
      width:10px;height:10px;border-radius:999px;
      display:inline-block;
      background:#cbd5e1;
      box-shadow:0 0 0 3px rgba(203,213,225,.35);
    }
    .dot.on{
      background: var(--ok);
      box-shadow:0 0 0 3px rgba(22,163,74,.18);
    }
    .dot.off{
      background: #cbd5e1;
      box-shadow:0 0 0 3px rgba(203,213,225,.35);
    }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      padding:10px 12px;
      border-radius:14px;
      display:none;
    }
    .msg.err{
      background:rgba(239,68,68,.08);
      border-color:rgba(239,68,68,.18);
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
    .tab{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .tab.active{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.20);
      color:var(--pri);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      background:#fff;
      border:1px solid rgba(230,232,240,.95);
      border-radius:14px;
      overflow:hidden;
    }
    th,td{padding:10px;border-bottom:1px solid rgba(230,232,240,.75);text-align:left;vertical-align:middle}
    th{
      background:rgba(246,247,251,.8);
      font-size:11px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:#94a3b8;
      font-weight:900;
    }
    tr:last-child td{border-bottom:0}

    .topLine{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding:16px;
    }
    .modal{
      width:min(720px, 100%);
      background:rgba(255,255,255,.98);
      border:1px solid rgba(230,232,240,.95);
      border-radius:22px;
      box-shadow:0 30px 80px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(230,232,240,.9);
      background:rgba(246,247,251,.65);
    }
    .modalHead h3{margin:0;font-size:15px;font-weight:900}
    .modalBody{ padding:14px 16px; }
    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(230,232,240,.9);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
      background:rgba(246,247,251,.65);
    }
    .select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(230,232,240,.95);
      background:#fff;
      font-weight:900;
      color:#0f172a;
      outline:none;
    }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width:720px){ .two{grid-template-columns:1fr} }
    .hint{
      font-size:12px;
      color:#334155;
      font-weight:800;
      margin-top:8px;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="nav">
      <div class="brand">
        <div class="logo">RF</div>
        <div class="brandTitle">
          <b>RepuestoFinder</b>
          <span>Perfil</span>
        </div>
      </div>

      <div class="navRight">
        <button class="btn btnGhost" onclick="goDashboard()">Dashboard</button>
        <button class="btn btnGhost" id="btnLogout" style="display:none" onclick="logout()">Salir</button>
        <button class="btn btnPrimary" id="btnLogin" style="display:none" onclick="goLogin()">Login</button>
      </div>
    </div>

    <div class="topLine">
      <div>
        <div class="pill" id="whoPill">Cargando sesi√≥n‚Ä¶</div>
        <div class="muted" id="whoSub" style="margin-top:6px"></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btnGhost btnSmall" onclick="refresh()">Actualizar</button>

        <!-- NUEVO: Visible solo para usuarios normales (lo activamos por JS) -->
        <button class="btn btnPrimary btnSmall" id="btnPayPlans" style="display:none" onclick="openPayPlans()">
          Renovar / Upgrade
        </button>

        <button class="btn btnGhost btnSmall" onclick="openEdit()">Editar mis datos</button>
      </div>
    </div>

    <div class="msg err" id="banExpired" style="display:none"></div>

    <div class="grid">
      <div class="card">
        <h2>Mis datos</h2>
        <div class="muted">Solo t√∫ ves tus datos.</div>

        <div class="row">
          <div class="field">
            <label>Nombre</label>
            <input class="inp" id="first_name" disabled>
          </div>
          <div class="field">
            <label>Apellido</label>
            <input class="inp" id="last_name" disabled>
          </div>
          <div class="field">
            <label>Empresa</label>
            <input class="inp" id="company_name" disabled>
          </div>
          <div class="field">
            <label>Tel√©fono</label>
            <input class="inp" id="phone" disabled>
          </div>
          <div class="field">
            <label>Username</label>
            <input class="inp" id="username" disabled>
          </div>
          <div class="field">
            <label>Email</label>
            <input class="inp" id="email" disabled>
          </div>
        </div>

        <div class="msg" id="msgProfile"></div>
      </div>

      <div class="card">
        <h2>Mi membres√≠a</h2>
        <div class="muted">Estado del plan, fechas y d√≠as restantes.</div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <span class="pill" id="pillStatus">‚Äî</span>
          <span class="pill" id="pillPlan">Plan: ‚Äî</span>
          <span class="pill" id="pillDays">D√≠as restantes: ‚Äî</span>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="field">
            <label>Inicio del per√≠odo</label>
            <input class="inp" id="current_period_start" disabled>
          </div>
          <div class="field">
            <label>Fin del per√≠odo</label>
            <input class="inp" id="current_period_end" disabled>
          </div>
          <div class="field">
            <label>√öltimo pago</label>
            <input class="inp" id="last_payment_at" disabled>
          </div>
          <div class="field">
            <label>Grace (si aplica)</label>
            <input class="inp" id="grace_end" disabled>
          </div>
        </div>

        <div class="msg" id="msgSub"></div>
      </div>
    </div>

    <!-- Admin -->
    <div class="card" id="adminCard" style="display:none;margin-top:14px">
      <div style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <h2>Administrador</h2>
        <div class="muted">Lista de usuarios y membres√≠as (solo admin).</div>
      </div>

      <div class="tabs" style="margin-top:12px">
        <button class="tab active" id="tabUsers" onclick="switchAdminTab('users')">Usuarios</button>
        <button class="tab" id="tabSubs" onclick="switchAdminTab('subs')">Suscripciones</button>
        <button class="tab" id="tabPlans" onclick="switchAdminTab('plans')">Planes & Accesos</button>
      </div>

      <div id="paneUsers">
        <table>
          <thead>
            <tr>
              <th>Nombre / Correo</th>
              <th>Empresa</th>
              <th>Tel√©fono</th>
              <th>Username</th>
              <th>Rol</th>
              <th>Activo</th>
            </tr>
          </thead>
          <tbody id="adminUsersBody">
            <tr><td colspan="6" class="muted">Cargando‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div id="paneSubs" style="display:none">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>En l√≠nea</th>
              <th>Plan</th>
              <th>Status</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Pago</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="adminSubsBody">
            <tr><td colspan="8" class="muted">Cargando‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Planes y control de accesos por plan (Herramientas) -->
      <div id="panePlans" style="display:none">
        <div class="muted" style="margin:6px 0 10px">
          Define qu√© se ve/usa en <b>Herramientas</b> seg√∫n el plan (ej: Plan 1 solo App + Radar).
          Esto intenta leer/escribir la columna <b>plans.features</b> (JSON). Si no existe, agrega la columna (ver SQL abajo).
        </div>

        <table>
          <thead id="adminPlansHead"></thead>
          <tbody id="adminPlansBody">
            <tr><td colspan="6" class="muted">Cargando‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="msg" id="msgAdmin"></div>
    </div>

  </div>

  <!-- Modal renovar membres√≠a -->
  <div class="modalBack" id="renewBack">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>Renovar membres√≠a</h3>
          <div class="muted" id="renewSubtitle">‚Äî</div>
        </div>
        <button class="btn btnGhost btnTiny" onclick="closeRenew()">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="two">
          <div class="field">
            <label>Plan</label>
            <select class="select" id="renewPlanSelect"></select>
          </div>
          <div class="field">
            <label>D√≠as</label>
            <input class="inp" id="renewDays" type="number" min="1" value="30">
          </div>
        </div>

        <div class="hint">
          Esto intenta renovar creando/actualizando un registro en <b>subscriptions</b> y ajustando <b>profiles.active_plan_id</b>.
          Si tu RLS no permite que el admin edite suscripciones de otros, te saldr√° error (y ah√≠ lo hacemos por Edge Function).
        </div>

        <div class="msg" id="renewMsg"></div>
      </div>

      <div class="modalFoot">
        <button class="btn btnGhost" onclick="closeRenew()">Cancelar</button>
        <button class="btn btnPrimary" onclick="confirmRenew()">Confirmar renovaci√≥n</button>
      </div>
    </div>
  </div>

  <!-- Modal Planes (Usuarios) -->
<div class="modalBack" id="payBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3>Renovar / Upgrade de Plan</h3>
        <div class="muted" id="paySubtitle">Elige un plan y paga con PayPal.</div>
      </div>
      <button class="btn btnGhost btnTiny" onclick="closePayPlans()">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="msg" id="payMsg"></div>

      <div class="hint" style="margin-bottom:10px">
        üíô Gracias por volver. Elige el plan que mejor te convenga y completa el pago.
      </div>

      <div id="plansWrap" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>

      <div class="hint" id="paypalHint" style="display:none;margin-top:10px">
        Si no ves el bot√≥n de PayPal, revisa tu <b>PAYPAL_CLIENT_ID</b> o bloqueadores del navegador.
      </div>
    </div>

    <div class="modalFoot">
      <button class="btn btnGhost" onclick="closePayPlans()">Cerrar</button>
    </div>
  </div>
</div>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";

    // ========= CATALOGO UNICO DE HERRAMIENTAS (1 solo lugar) =========
    // Agrega herramientas aqu√≠ y el Admin ver√° los permisos autom√°ticamente.
    const TOOLS_CATALOG = [
      { key: "app",        label: "App", managed: true },
      { key: "radar",      label: "Radar de Demanda", managed: true },
      { key: "kpis",       label: "KPIs y Analisis", managed: true },
      { key: "mensajeria", label: "Mensajer√≠a", managed: true },
      { key: "obsolescencia", label: "Ofertas de Art√≠culos", managed: true },
    ];


    const $ = (id)=>document.getElementById(id);

    // ====== CONFIG ======
    const PRESENCE_CHANNEL = "rf-online-users"; // canal realtime presence
    const PLANS_TABLE = "plans";                // tabla de planes en supabase
    // ====================

    // ====== PAYPAL CONFIG ======
    // Pon aqu√≠ TU Client ID de PayPal (LIVE)
    const PAYPAL_CLIENT_ID = "Af-d9pElEYJg1Qwoq0alwJkSNXfAEPf3skFWcidb7G7S3plO76_GSPgIM76e79hHVOU_Qul20sCi6fCM";
    const PAYPAL_CURRENCY = "USD";

    // Nombres de tus Edge Functions en Supabase (ajusta si usan otros nombres)
    const FN_PAYPAL_CREATE = "paypal-create-order-renew";
    const FN_PAYPAL_CAPTURE = "paypal-capture-order-renew";

    function setMsg(el, text, isErr){
      if(!el) return;
      el.textContent = text || "";
      el.classList.toggle("err", !!isErr);
      el.style.display = text ? "block" : "none";
    }

    function fmtDate(s){
      if(!s) return "‚Äî";
      const d = new Date(s);
      if(isNaN(d.getTime())) return String(s);
      return d.toLocaleString("es-DO", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    function daysBetween(now, end){
      try{
        const a = new Date(now).getTime();
        const b = new Date(end).getTime();
        if(isNaN(a) || isNaN(b)) return null;
        const diff = Math.ceil((b - a) / (1000*60*60*24));
        return diff;
      }catch(_){ return null; }
    }

    function setPill(el, text, kind){
      el.textContent = text;
      el.classList.remove("ok","warn","bad");
      if(kind) el.classList.add(kind);
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    function fullName(p){
      const name = [p?.first_name, p?.last_name].filter(Boolean).join(" ").trim();
      return name || p?.username || p?.email || "‚Äî";
    }

    // ====== NAV ======
    window.goDashboard = ()=> window.location.href = "index.html";
    window.goLogin = ()=> window.location.href = "login.html";
    window.logout = async ()=>{ await supabase.auth.signOut(); window.location.href = "index.html"; };

    window.openEdit = ()=> {
      ["first_name","last_name","company_name","phone"].forEach(id=>{
        const el = $(id);
        if(el) el.disabled = false;
      });
      setMsg($("msgProfile"), "Edita tus datos y luego presiona 'Actualizar' (guardado se integra luego).", false);
    };

    window.switchAdminTab = (tab)=>{
      $("tabUsers").classList.toggle("active", tab==="users");
      $("tabSubs").classList.toggle("active", tab==="subs");
      $("tabPlans").classList.toggle("active", tab==="plans");
      $("paneUsers").style.display = (tab==="users") ? "block" : "none";
      $("paneSubs").style.display  = (tab==="subs")  ? "block" : "none";
      $("panePlans").style.display = (tab==="plans") ? "block" : "none";
    };

    // ====== DATA LOADERS ======
    async function loadMyProfile(userId){
      const { data, error } = await supabase
        .from("profiles")
        .select("id,first_name,last_name,company_name,phone,role,status,username,email,country,active_plan_id,activated_at,is_active,created_at,updated_at")
        .eq("id", userId)
        .maybeSingle();

      if(error) throw error;
      return data || null;
    }

    async function loadMySubscription(userId){
      const { data, error } = await supabase
        .from("subscriptions")
        .select("id,user_id,plan_id,status,current_period_start,current_period_end,grace_end,last_payment_at,paypal_subscription_id,paypal_order_id,updated_at")
        .eq("user_id", userId)
        .order("updated_at", { ascending:false })
        .limit(1)
        .maybeSingle();

      if(error) throw error;
      return data || null;
    }

    function fillProfile(p){
      $("first_name").value = p?.first_name || "";
      $("last_name").value = p?.last_name || "";
      $("company_name").value = p?.company_name || "";
      $("phone").value = p?.phone || "";
      $("username").value = p?.username || "";
      $("email").value = p?.email || "";
    }

    function fillSubscription(s, profile){
      const now = new Date();

      const rawStatus = (s?.status || "").toString().toLowerCase();
      const plan = (s?.plan_id ?? profile?.active_plan_id ?? "‚Äî");

      const startISO = s?.current_period_start || null;
      const endISO   = s?.current_period_end || null;
      const graceISO = s?.grace_end || null;

      $("current_period_start").value = fmtDate(startISO);
      $("current_period_end").value   = fmtDate(endISO);
      $("last_payment_at").value      = fmtDate(s?.last_payment_at);
      $("grace_end").value            = fmtDate(graceISO);

      const daysToEnd = endISO ? daysBetween(now, endISO) : null;
      const daysToGrace = graceISO ? daysBetween(now, graceISO) : null;

      let computed = "unknown";
      if(endISO){
        if(new Date(now).getTime() <= new Date(endISO).getTime()){
          computed = "active";
        }else{
          if(graceISO && new Date(now).getTime() <= new Date(graceISO).getTime()){
            computed = "grace";
          }else{
            computed = "expired";
          }
        }
      }

      let finalStatus = rawStatus || computed;
      if(computed === "expired") finalStatus = "expired";
      if(computed === "grace") finalStatus = "grace";
      if(!finalStatus) finalStatus = "unknown";

      let statusKind = "warn";
      if(finalStatus === "active") statusKind = "ok";
      if(finalStatus === "expired" || finalStatus === "canceled") statusKind = "bad";
      if(finalStatus === "grace") statusKind = "warn";

      setPill($("pillStatus"), "Estado: " + finalStatus, statusKind);
      setPill($("pillPlan"), "Plan: " + plan, null);

      const shownDays = (daysToEnd === null) ? "‚Äî" : String(Math.max(0, daysToEnd));
      let daysKind = "warn";
      if(daysToEnd === null) daysKind = "warn";
      else if(daysToEnd <= 0) daysKind = (finalStatus === "grace") ? "warn" : "bad";
      else if(daysToEnd <= 5) daysKind = "warn";
      else daysKind = "ok";

      setPill($("pillDays"), "D√≠as restantes: " + shownDays, daysKind);

      const ban = $("banExpired");
      if(finalStatus === "expired"){
        ban.style.display = "block";
        ban.classList.add("err");
        ban.innerHTML = `Tu membres√≠a est√° <b>VENCIDA</b>. Para usar el sistema, renueva tu plan.`;
      }else if(finalStatus === "grace"){
        const dg = (daysToGrace===null) ? "‚Äî" : String(Math.max(0, daysToGrace));
        ban.style.display = "block";
        ban.classList.remove("err");
        ban.innerHTML = `Est√°s en <b>GRACE</b>. Te quedan <b>${dg}</b> d√≠as de gracia para renovar.`;
      }else{
        ban.style.display = "none";
      }
    }

    // ====== PRESENCE (ONLINE REAL TIME) ======
    let presenceChannel = null;
    let onlineSet = new Set();       // user_ids online
    let isAdmin = false;
    let myUserId = null;

    function isOnline(userId){
      return onlineSet.has(userId);
    }

    function rebuildOnlineSetFromPresenceState(state){
      const s = new Set();
      // state keys are "presence keys"; we use key=userId
      Object.keys(state || {}).forEach(k => {
        // k puede ser userId si la key es el userId
        s.add(k);
      });
      onlineSet = s;
    }

    async function startPresence(role, userId){
      // Cualquier usuario que est√© en esta p√°gina reporta "online" por Realtime presence.
      // El admin ve qui√©n est√° online al instante.
      if(presenceChannel){
        try{ await supabase.removeChannel(presenceChannel); }catch(_){}
        presenceChannel = null;
      }

      presenceChannel = supabase.channel(PRESENCE_CHANNEL, {
        config: { presence: { key: userId } }
      });

      presenceChannel.on("presence", { event: "sync" }, () => {
        const state = presenceChannel.presenceState();
        rebuildOnlineSetFromPresenceState(state);
        if(isAdmin){
          renderAdminSubs(); // re-render para refrescar la columna "En l√≠nea"
        }
      });

      presenceChannel.on("presence", { event: "join" }, ({ key }) => {
        if(key) onlineSet.add(key);
        if(isAdmin) renderAdminSubs();
      });

      presenceChannel.on("presence", { event: "leave" }, ({ key }) => {
        if(key) onlineSet.delete(key);
        if(isAdmin) renderAdminSubs();
      });

      await presenceChannel.subscribe(async (status) => {
        if(status === "SUBSCRIBED"){
          try{
            await presenceChannel.track({ at: new Date().toISOString() });
          }catch(_){}
        }
      });
    }

    // ====== MINI PRESENCE BLOQUE PARA OTRAS P√ÅGINAS ======
    // Este bloque simplificado puedes copiar en app.html, index.html, dashboard.html, etc.
    // Solo agregalo despu√©s de obtener el user.id en esas p√°ginas:
    /*
    const PRESENCE_CHANNEL = "rf-online-users";
    const presenceChannel = supabase.channel(PRESENCE_CHANNEL, {
      config: { presence: { key: user.id } }
    });

    await presenceChannel.subscribe(async (status) => {
      if (status === "SUBSCRIBED") {
        await presenceChannel.track({ at: new Date().toISOString() });
      }
    });
    */

    // ====== ADMIN TABLES ======
    let adminProfiles = [];           // profiles list
    let profilesById = new Map();     // id -> profile
    let adminSubs = [];               // subs list

    async function loadAdminTables(){
      // Cargar profiles
      const { data: users, error: e1 } = await supabase
        .from("profiles")
        .select("id,first_name,last_name,company_name,phone,username,role,is_active,status,email")
        .limit(1000);


      if(e1) throw e1;

      adminProfiles = users || [];
      profilesById = new Map(adminProfiles.map(u => [u.id, u]));

      const ub = $("adminUsersBody");
      ub.innerHTML = adminProfiles.map(u=>{
        return `
          <tr>
            <td>
              <div style="font-weight:900">
                ${escapeHtml([u.first_name, u.last_name].filter(Boolean).join(" ") || u.username || "Sin nombre")}
              </div>
              <div class="muted" style="margin-top:2px">
                ${escapeHtml(u.email || "")}
              </div>
            </td>
            <td>${escapeHtml(u.company_name || "‚Äî")}</td>
            <td>${escapeHtml(u.phone || "‚Äî")}</td>
            <td>${escapeHtml(u.username || "‚Äî")}</td>
            <td>${escapeHtml(u.role || "user")}</td>
            <td>${u.is_active ? '<span class="pill ok">S√≠</span>' : '<span class="pill bad">No</span>'}</td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" class="muted">No hay datos</td></tr>`;

      // Cargar subscriptions
      const { data: subs, error: e2 } = await supabase
        .from("subscriptions")
        .select("id,user_id,plan_id,status,current_period_start,current_period_end,last_payment_at,updated_at")
        .order("updated_at", { ascending:false })
        .limit(500);

      if(e2) throw e2;

      adminSubs = subs || [];
      renderAdminSubs();
    }

    function renderAdminSubs(){
      const sb = $("adminSubsBody");
      if(!sb) return;

      sb.innerHTML = (adminSubs || []).map(s=>{
        const p = profilesById.get(s.user_id) || null;
        const name = p ? fullName(p) : (s.user_id || "‚Äî");
        const dleft = s.current_period_end ? daysBetween(new Date(), s.current_period_end) : null;
        const stKind = (String(s.status || "").toLowerCase()==="active")
          ? "ok"
          : (dleft!==null && dleft<=0 ? "bad" : "warn");

        const online = isOnline(s.user_id);
        const dot = online ? `<span class="dot on"></span>` : `<span class="dot off"></span>`;
        const onlineText = online ? `<span class="pill ok">${dot} En l√≠nea</span>` : `<span class="pill">${dot} Offline</span>`;

        return `
          <tr>
            <td>
              <div style="font-weight:900">
                ${escapeHtml(name)}
              </div>
              <div class="muted" style="margin-top:2px">
                ${escapeHtml(p?.email || "")}
              </div>
              ${!p ? `<div class="muted" style="margin-top:2px;color:#ef4444">Sin perfil (falta fila en profiles)</div>` : ``}
            </td>
            <td>${onlineText}</td>
            <td>${escapeHtml(String(s.plan_id ?? "‚Äî"))}</td>
            <td><span class="pill ${stKind}">${escapeHtml(s.status || "‚Äî")}</span></td>
            <td>${escapeHtml(fmtDate(s.current_period_start))}</td>
            <td>${escapeHtml(fmtDate(s.current_period_end))}</td>
            <td>${escapeHtml(fmtDate(s.last_payment_at))}</td>
            <td>
              <button class="btn btnPrimary btnTiny" onclick="openRenew('${escapeHtml(s.user_id)}')">Renovar</button>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="8" class="muted">No hay datos</td></tr>`;
    }

    // ====== RENOVAR MODAL ======
    let plansCache = [];
    let renewUserId = null;

    function planLabel(plan){
      // Tratamos de adivinar campos comunes: name/title/label
      const title = plan?.name || plan?.title || plan?.label || plan?.plan_name || ("Plan " + (plan?.id ?? ""));
      const price = plan?.price_usd ?? plan?.price ?? plan?.amount ?? null;
      const days = plan?.days ?? plan?.duration_days ?? plan?.period_days ?? null;
      const extra = [];
      if(price !== null && price !== undefined && price !== "") extra.push(`$${price}`);
      if(days) extra.push(`${days} d√≠as`);
      return extra.length ? `${title} ‚Ä¢ ${extra.join(" ‚Ä¢ ")}` : String(title);
    }

    async function loadPlansOnce(){
      if(plansCache.length) return plansCache;

      // Intento: traer todo; si tu tabla es diferente igual funciona mostrando lo que exista.
      const { data, error } = await supabase
        .from(PLANS_TABLE)
        .select("*")
        .order("id", { ascending:true });

      if(error){
        // Si tu tabla no se llama "plans" o RLS bloquea, lo reflejamos.
        plansCache = [];
        throw error;
      }

      plansCache = data || [];
      return plansCache;
    }

    // ====== ADMIN: Planes & Accesos (Herramientas) ======
    function normBool(v){ return v === true || v === 1 || v === "1" || v === "true"; }
    function normFeatures(features){
      // features esperado: {app, radar, kpis, mensajeria}
      const f = (features && typeof features === "object") ? features : {};
      return {
        app: normBool(f.app),
        radar: normBool(f.radar),
        kpis: normBool(f.kpis),
        mensajeria: normBool(f.mensajeria)
      };
    }

    function planName(p){
      return p?.name || p?.title || p?.label || p?.plan_name || ("Plan " + (p?.id ?? ""));
    }

    async function renderAdminPlans(){
      const head = $("adminPlansHead");
      const body = $("adminPlansBody");
      if(!body) return;

      const tools = (TOOLS_CATALOG || []).filter(t => t && t.managed);

      // Header din√°mico
      if(head){
        head.innerHTML = `
          <tr>
            <th>Plan</th>
            ${tools.map(t=>`<th>${escapeHtml(t.label || t.key)}</th>`).join("")}
            <th>Acci√≥n</th>
          </tr>
        `;
      }

      (async ()=>{
        try{
          const plans = await loadPlansOnce();
          if(!plans.length){
            const cols = 2 + tools.length;
            body.innerHTML = `<tr><td colspan="${cols}" class="muted">No hay planes.</td></tr>`;
            return;
          }

          body.innerHTML = plans.map(p=>{
            const pid = String(p?.id ?? p?.plan_id ?? "");
            const f = normFeatures(p?.features);

            const checks = tools.map(t=>{
              const key = t.key;
              const id = `pf_${key}_${pid}`;
              const checked = f[key] ? "checked" : "";
              return `<td><input type="checkbox" id="${escapeHtml(id)}" ${checked}></td>`;
            }).join("");

            return `
              <tr>
                <td>
                  <div style="font-weight:900">${escapeHtml(planName(p))}</div>
                  <div class="muted" style="margin-top:2px">ID: ${escapeHtml(pid || "‚Äî")}</div>
                </td>
                ${checks}
                <td>
                  <button class="btn btnPrimary btnTiny" onclick="savePlanFeatures('${escapeHtml(pid)}')">Guardar</button>
                </td>
              </tr>
            `;
          }).join("");

        }catch(err){
          const cols = 2 + tools.length;
          body.innerHTML = `<tr><td colspan="${cols}" class="muted">Error cargando planes: ${escapeHtml(err?.message || err)}</td></tr>`;
        }
      })();
    }

window.savePlanFeatures = async (planId)=>{
      try{
        if(!planId) return;

        const tools = (TOOLS_CATALOG || []).filter(t => t && t.managed);
        const features = {};

        tools.forEach(t=>{
          const key = t.key;
          const el = document.getElementById(`pf_${key}_` + planId);
          features[key] = !!(el && el.checked);
        });

        const { error } = await supabase
          .from(PLANS_TABLE)
          .update({ features })
          .eq("id", planId);

        if(error) throw error;

        showAdminMsg("‚úÖ Guardado. Permisos actualizados para el plan " + planId);
      }catch(err){
        showAdminMsg("‚ùå No se pudo guardar: " + (err?.message || err), true);
      }
    };

    window.openRenew = async (userId)=>{
      renewUserId = userId;
      setMsg($("renewMsg"), "", false);
      $("renewSubtitle").textContent = userId ? ("Usuario: " + userId) : "‚Äî";
      $("renewDays").value = 30;

      $("renewBack").style.display = "flex";

      try{
        const plans = await loadPlansOnce();
        const sel = $("renewPlanSelect");
        if(!plans.length){
          sel.innerHTML = `<option value="">No hay planes en la tabla "${escapeHtml(PLANS_TABLE)}"</option>`;
          return;
        }

        sel.innerHTML = plans.map(p=>{
          const id = p?.id ?? p?.plan_id ?? "";
          return `<option value="${escapeHtml(String(id))}">${escapeHtml(planLabel(p))}</option>`;
        }).join("");

        // si alg√∫n plan trae days, setearlo
        const first = plans[0];
        const d = first?.days ?? first?.duration_days ?? first?.period_days ?? null;
        if(d) $("renewDays").value = d;

        sel.onchange = ()=>{
          const pid = sel.value;
          const picked = plans.find(x => String((x.id ?? x.plan_id)) === String(pid));
          const dd = picked?.days ?? picked?.duration_days ?? picked?.period_days ?? null;
          if(dd) $("renewDays").value = dd;
        };
      }catch(err){
        setMsg($("renewMsg"), "Error cargando planes: " + (err?.message || err), true);
      }
    };

    window.closeRenew = ()=>{
      $("renewBack").style.display = "none";
      renewUserId = null;
    };

    function addDaysISO(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + Number(days || 0));
      return d.toISOString();
    }

    window.confirmRenew = async ()=>{
      if(!renewUserId){
        setMsg($("renewMsg"), "No tengo el usuario para renovar.", true);
        return;
      }

      const planId = $("renewPlanSelect").value;
      const days = Number($("renewDays").value || 30);

      if(!planId){
        setMsg($("renewMsg"), "Selecciona un plan.", true);
        return;
      }
      if(!days || days < 1){
        setMsg($("renewMsg"), "Los d√≠as deben ser mayor a 0.", true);
        return;
      }

      try{
        setMsg($("renewMsg"), "Procesando renovaci√≥n‚Ä¶", false);

        const now = new Date();
        const start = now.toISOString();
        const end = addDaysISO(now, days);

        // 1) Upsert subscription para ese usuario
        // Nota: Esto requiere RLS que permita a admin editar otros users.
        const { error: e1 } = await supabase
          .from("subscriptions")
          .upsert({
            user_id: renewUserId,
            plan_id: planId,
            status: "active",
            current_period_start: start,
            current_period_end: end,
            last_payment_at: start,
            updated_at: start
          }, { onConflict: "user_id" });

        if(e1) throw e1;

        // 2) Update profile (opcional)
        const { error: e2 } = await supabase
          .from("profiles")
          .update({
            active_plan_id: planId,
            is_active: true,
            status: "active",
            updated_at: start
          })
          .eq("id", renewUserId);

        if(e2) throw e2;

        setMsg($("renewMsg"), "‚úÖ Renovaci√≥n aplicada. Actualizando tablas‚Ä¶", false);

        // refrescar admin subs
        plansCache = plansCache; // keep
        await loadAdminTables();

        // cerrar
        setTimeout(()=> closeRenew(), 650);
      }catch(err){
        setMsg($("renewMsg"), "‚ùå No se pudo renovar: " + (err?.message || err), true);
      }
    };

    // ====== USER PAY MODAL (PLANS + PAYPAL) ======
    let paySelectedPlan = null;
    let paypalSdkLoaded = false;

    function money(v){
      if(v === null || v === undefined || v === "") return "";
      const n = Number(v);
      if(isNaN(n)) return String(v);
      return n.toFixed(2);
    }

    function getPlanFields(p){
      // Normalizamos campos comunes: id, name, price, days, etc.
      const id = p?.id ?? p?.plan_id ?? null;
      const name = p?.name || p?.title || p?.label || p?.plan_name || ("Plan " + id);
      const price = p?.price_usd ?? p?.price ?? p?.amount ?? null;
      const days = p?.days ?? p?.duration_days ?? p?.period_days ?? null;
      const desc = p?.description ?? p?.details ?? "";
      return { id, name, price, days, desc };
    }

    async function ensurePaypalSdk(){
      if(paypalSdkLoaded) return true;

      // Si no hay client id, mostramos mensaje y no intentamos cargar
      if(!PAYPAL_CLIENT_ID || PAYPAL_CLIENT_ID.includes("PEGA_AQUI")){
        setMsg($("payMsg"), "‚ö†Ô∏è Falta configurar PAYPAL_CLIENT_ID en perfil.html", true);
        $("paypalHint").style.display = "block";
        return false;
      }

      return new Promise((resolve) => {
        const s = document.createElement("script");
        s.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(PAYPAL_CLIENT_ID)}&currency=${encodeURIComponent(PAYPAL_CURRENCY)}`;
        s.onload = () => { paypalSdkLoaded = true; resolve(true); };
        s.onerror = () => { resolve(false); };
        document.head.appendChild(s);
      });
    }

    window.openPayPlans = async ()=>{
      setMsg($("payMsg"), "", false);
      $("payBack").style.display = "flex";
      $("paypalHint").style.display = "none";

      try{
        const plans = await loadPlansOnce(); // ya la tienes hecha
        if(!plans.length){
          $("plansWrap").innerHTML = `<div class="muted">No hay planes disponibles.</div>`;
          return;
        }

        // Render cards
        $("plansWrap").innerHTML = plans.map((p)=>{
          const f = getPlanFields(p);
          const meta = [
            (f.price !== null && f.price !== undefined) ? `$${money(f.price)} ${PAYPAL_CURRENCY}` : null,
            f.days ? `${f.days} d√≠as` : null
          ].filter(Boolean).join(" ‚Ä¢ ");

          return `
            <div style="border:1px solid rgba(230,232,240,.95);border-radius:16px;padding:12px;background:#fff">
              <div style="font-weight:900;font-size:14px">${escapeHtml(f.name)}</div>
              <div class="muted" style="margin-top:4px">${escapeHtml(meta || "‚Äî")}</div>
              ${f.desc ? `<div class="muted" style="margin-top:6px">${escapeHtml(f.desc)}</div>` : ``}

              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between">
                <button class="btn btnPrimary btnTiny" onclick="selectPlanForPay('${escapeHtml(String(f.id))}')">
                  Elegir
                </button>
                <span class="pill" id="pillPlan_${escapeHtml(String(f.id))}">No seleccionado</span>
              </div>

              <div style="margin-top:10px;display:none" id="ppBox_${escapeHtml(String(f.id))}">
                <div class="muted" style="margin-bottom:8px">Paga con PayPal:</div>
                <div id="ppBtn_${escapeHtml(String(f.id))}"></div>
              </div>
            </div>
          `;
        }).join("");

      }catch(err){
        setMsg($("payMsg"), "Error cargando planes: " + (err?.message || err), true);
      }
    };

    window.closePayPlans = ()=>{
      $("payBack").style.display = "none";
      paySelectedPlan = null;
    };

    window.selectPlanForPay = async (planId)=>{
      setMsg($("payMsg"), "", false);

      // Reset pills + hide all paypal boxes
      const cards = $("plansWrap").querySelectorAll("[id^='ppBox_']");
      cards.forEach(x => x.style.display = "none");
      const pills = $("plansWrap").querySelectorAll("[id^='pillPlan_']");
      pills.forEach(p => p.textContent = "No seleccionado");

      paySelectedPlan = planId;

      const pill = $("pillPlan_" + planId);
      if(pill) pill.textContent = "Seleccionado ‚úÖ";

      const ok = await ensurePaypalSdk();
      if(!ok){
        $("paypalHint").style.display = "block";
        return;
      }

      const box = $("ppBox_" + planId);
      const btnHost = $("ppBtn_" + planId);
      if(!box || !btnHost){
        setMsg($("payMsg"), "No pude preparar el bot√≥n de PayPal.", true);
        return;
      }

      box.style.display = "block";
      btnHost.innerHTML = ""; // limpiar si ya hab√≠a

      // Render PayPal button (CORRECTO)
      const { data: ses } = await supabase.auth.getSession();
      const accessToken = ses?.session?.access_token || "";

      window.paypal.Buttons({
        style: { layout: "vertical" },

        createOrder: async () => {
          try {
            setMsg($("payMsg"), "Creando orden‚Ä¶", false);

            const { data, error } = await supabase.functions.invoke(FN_PAYPAL_CREATE, {
              headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : {},
              body: { plan_id: Number(planId) } // üëà IMPORTANTE
            });

            if (error) {
              const msg = (error?.context?.response)
                ? await error.context.response.text()
                : (error.message || "Error en createOrder");
              throw new Error(msg);
            }

            const oid = data?.orderID || data?.id;
            if (!oid) throw new Error("No devolvio orderID. Respuesta: " + JSON.stringify(data));
            return oid;

          } catch (err) {
            setMsg($("payMsg"), "‚ùå Error creando orden: " + (err?.message || err), true);
            throw err;
          }
        },

        onApprove: async (data) => {
          try {
            setMsg($("payMsg"), "Procesando pago‚Ä¶", false);

            const { data: cap, error: e2 } = await supabase.functions.invoke(FN_PAYPAL_CAPTURE, {
              headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : {},
              body: { order_id: data.orderID, plan_id: Number(planId) }
            });

            if (e2) {
              const msg = (e2?.context?.response)
                ? await e2.context.response.text()
                : (e2.message || "Error capturando pago");
              throw new Error(msg);
            }

            if (!cap?.ok) throw new Error("Capture no ok: " + JSON.stringify(cap));

            setMsg($("payMsg"), "‚úÖ ¬°Gracias por volver! Tu plan fue actualizado.", false);
            await init();
            setTimeout(() => closePayPlans(), 900);

          } catch (err) {
            setMsg($("payMsg"), "‚ùå No se pudo completar el pago: " + (err?.message || err), true);
          }
        },

        onError: (err) => {
          setMsg($("payMsg"), "‚ùå PayPal error: " + (err?.message || err), true);
        }
      }).render("#ppBtn_" + planId);
    };

    // ====== INIT ======
    async function init(){
      setMsg($("msgProfile"), "", false);
      setMsg($("msgSub"), "", false);
      setMsg($("msgAdmin"), "", false);

      const { data: ses } = await supabase.auth.getSession();
      const user = ses?.session?.user;

      $("btnLogout").style.display = user ? "" : "none";
      $("btnLogin").style.display  = user ? "none" : "";

      if(!user){
        setPill($("whoPill"), "No has iniciado sesi√≥n", "bad");
        $("whoSub").textContent = "Inicia sesi√≥n para ver tu perfil.";
        return;
      }

      myUserId = user.id;

      setPill($("whoPill"), "Sesi√≥n activa", "ok");
      $("whoSub").textContent = "Cargando perfil‚Ä¶";

      try{
        const profile = await loadMyProfile(user.id);
        if(!profile){
          setMsg($("msgProfile"), "No encontr√© tu perfil en la tabla 'profiles'.", true);
          return;
        }
        fillProfile(profile);

        const role = (profile.role || "user").toLowerCase();
        isAdmin = (role === "admin");

        // ‚úÖ (3) UID/Rol solo admin
        if(isAdmin){
          $("whoSub").textContent = `UID: ${user.id} ‚Ä¢ Rol: ${role}`;
        }else{
          // Para usuarios normales: no mostrar UID
          const nice = fullName(profile);
          const mail = profile.email ? ` ‚Ä¢ ${profile.email}` : "";
          $("whoSub").textContent = `${nice}${mail}`;
        }

        // suscripci√≥n
        const sub = await loadMySubscription(user.id);
        fillSubscription(sub, profile);

        // ‚úÖ presence (online)
        await startPresence(role, user.id);

        // admin tables
        if(isAdmin){
          $("adminCard").style.display = "block";
          await loadAdminTables();
          await renderAdminPlans();
        }else{
          $("adminCard").style.display = "none";
        }

        // Bot√≥n de renovar/upgrade SOLO para usuarios normales
        $("btnPayPlans").style.display = isAdmin ? "none" : "";

      }catch(err){
        setMsg($("msgProfile"), "Error cargando: " + (err?.message || err), true);
      }
    }

    window.refresh = init;

    init();
  </script>
</body>
</html>

