<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Crear cuenta - Repuesto FinderRD</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#2563eb;
      --brand2:#60a5fa;
      --good:#16a34a;
      --bad:#dc2626;
      --shadow:0 14px 45px rgba(2,8,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(180deg,#f8fafc, #eef2ff 70%, #f8fafc);
      color:var(--text);
      padding:24px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:26px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    header{
      padding:22px 26px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background:linear-gradient(90deg,#ffffff, #f8fafc);
    }
    header h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    header p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13.5px;
    }
    .step{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      padding:8px 12px;
      border-radius:999px;
      height:fit-content;
      white-space:nowrap;
    }
    main{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:0;
      min-height:540px;
    }
    .left, .right{ padding:22px 26px; }
    .left{ border-right:1px solid var(--line); }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px 14px;
    }
    .field{ display:flex; flex-direction:column; gap:7px; }
    label{
      font-size:12px;
      font-weight:700;
      color:#0b1220;
    }
    input, select{
      width:100%;
      height:44px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    input:focus, select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }
    .full{ grid-column: 1 / -1; }
    .terms{
      margin-top:10px;
      padding:14px 14px;
      border:1px dashed #cbd5e1;
      border-radius:16px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      background:#fafcff;
    }
    .terms small{ color:var(--muted); display:block; margin-top:3px; line-height:1.35; }
    .msg{
      margin-top:14px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#f8fafc;
      font-size:13.5px;
      color:var(--muted);
    }
    .msg.good{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.06); color:#14532d; }
    .msg.bad{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.06); color:#7f1d1d; }
    .btnRow{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    button{
      cursor:pointer;
      border:none;
      border-radius:14px;
      height:44px;
      padding:0 14px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .btnGhost{
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      color:#0f172a;
    }
    .btnPrimary{
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      color:#fff;
    }
    .right h2{
      margin:0 0 10px;
      font-size:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .plans{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .plan{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:center;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease;
      background:#fff;
    }
    .plan:hover{ transform: translateY(-1px); border-color:#bfdbfe; }
    .plan.active{
      border-color:#60a5fa;
      box-shadow:0 0 0 4px rgba(96,165,250,.18);
    }
    .icon{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(180deg,#dbeafe,#eff6ff);
      border:1px solid #bfdbfe;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex-shrink:0;
    }
    .pname{ font-weight:900; font-size:13.2px; margin:0; }
    .pdesc{ margin:2px 0 0; font-size:12px; color:var(--muted); line-height:1.2; }
    .price{ margin-left:auto; font-weight:900; }
    .hint{
      margin-top:14px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:#0f172a;
      font-size:13px;
      line-height:1.35;
    }
    .payBox{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      background:#fff;
    }
    .payTitle{
      display:flex; align-items:center; justify-content:space-between;
      font-weight:900;
      font-size:13px;
      margin:0 0 10px;
    }
    .payErr{
      margin-top:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(220,38,38,.35);
      background:rgba(220,38,38,.06);
      color:#7f1d1d;
      font-size:13px;
      display:none;
    }
    footer{
      padding:14px 26px 18px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background:#fcfdff;
    }
    @media (max-width: 980px){
      main{ grid-template-columns:1fr; }
      .left{ border-right:none; border-bottom:1px solid var(--line); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns:1fr; }
      header{ flex-direction:column; align-items:flex-start; }
      .plans{ grid-template-columns:1fr; }
      .btnRow{ justify-content:stretch; }
      button{ width:100%; }
    }
  </style>

  <!-- PayPal SDK (tu client-id se carga abajo) -->
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Crear cuenta y activar con PayPal</h1>
      <p>Completa tus datos, acepta los términos, elige un plan y paga. Tu cuenta queda activa al instante.</p>
    </div>
    <div class="step" id="stepBadge">Paso 1/2</div>
  </header>

  <main>
    <section class="left">
      <div class="grid">
        <div class="field">
          <label>Nombre</label>
          <input id="first_name" placeholder="Luis"/>
        </div>
        <div class="field">
          <label>Apellido</label>
          <input id="last_name" placeholder="Espinal"/>
        </div>

        <div class="field full">
          <label>Nombre de la compañía</label>
          <input id="company_name" placeholder="Repuesto FinderRD"/>
        </div>

        <div class="field">
          <label>Número de teléfono</label>
          <input id="phone" placeholder="+1 809 000 0000"/>
        </div>
        <div class="field">
          <label>Correo</label>
          <input id="email" placeholder="correo@ejemplo.com"/>
        </div>

        <div class="field">
          <label>Username (opcional)</label>
          <input id="username" placeholder="luis783"/>
        </div>
        <div class="field">
          <label>País</label>
          <select id="pais">
            <option value="República Dominicana">República Dominicana</option>
            <option value="Estados Unidos">Estados Unidos</option>
            <option value="Puerto Rico">Puerto Rico</option>
            <option value="España">España</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="field">
          <label>Clave</label>
          <input id="pass" type="password" placeholder="••••••••"/>
        </div>
        <div class="field">
          <label>Validar la clave</label>
          <input id="pass2" type="password" placeholder="••••••••"/>
        </div>
      </div>

      <div class="terms">
        <input id="agree" type="checkbox" style="width:18px;height:18px;margin-top:2px"/>
        <div>
          <div style="font-weight:900;font-size:13px;">Acepto los términos</div>
          <small>Al registrarte aceptas las condiciones de uso y política de servicio.
            <a href="#" style="color:#2563eb;font-weight:800;text-decoration:none;">Ver términos</a>.
          </small>
        </div>
      </div>

      <div id="msg" class="msg">Completa el formulario y selecciona un plan para continuar.</div>

      <div class="btnRow">
        <button class="btnGhost" id="demoBtn">Llenar demo</button>
      </div>

      <div class="msg" style="margin-top:10px;">
        <b>Nota:</b> En este flujo, la cuenta se crea después del pago (más seguro). Si ya tienes cuenta, al final te manda al login.
      </div>
    </section>

    <section class="right">
      <h2>
        <span>Elige tu plan</span>
        <span style="font-size:12px;color:var(--muted);font-weight:900;">PLANES ACTIVOS POR 30 DÍAS</span>
      </h2>

      <div class="plans" id="plansBox"></div>

      <div class="hint" id="payHint">
        Primero pagas y luego se crea tu cuenta automáticamente.<br/>
        <b>Al finalizar, inicia sesión y listo ✅</b>
      </div>

      <div class="payBox">
        <div class="payTitle">
          <span>Pago con PayPal</span>
          <span id="payStatus" style="font-weight:800;color:var(--muted);font-size:12px;">—</span>
        </div>

        <div id="paypal-button-container"></div>

        <div id="payErr" class="payErr"></div>
      </div>
    </section>
  </main>

  <footer>
    <span>© 2026 RepuestoFinder</span>
    <span>Soporte: soporte@repuestofinder.com</span>
  </footer>
</div>

<script type="module">
  import { supabase } from "./assets/supabaseClient.js";

  // ---------- Helpers ----------
  const el = (id) => document.getElementById(id);

  function showMsg(text, type=""){
    const m = el("msg");
    m.className = "msg" + (type ? " " + type : "");
    m.textContent = text;
  }
  function showPayErr(text){
    const p = el("payErr");
    if(!text){
      p.style.display = "none";
      p.textContent = "";
      return;
    }
    p.style.display = "block";
    p.textContent = text;
  }
  function setStep(n){
    el("stepBadge").textContent = n === 1 ? "Paso 1/2" : "Paso 2/2";
  }

  function cleanPhone(v){
    return String(v||"").trim().replace(/[^\d+]/g,"");
  }

  // ---------- Plans ----------
  let plans = [];
  let selectedPlanId = null;
  let paypalRendered = false;
  let currentOrderId = "";
  let formLocked = false;

  function setFormLocked(locked){
    formLocked = !!locked;
    const ids = ["first_name","last_name","company_name","phone","email","username","pais","pass","pass2","agree"];
    ids.forEach(id => {
      const node = document.getElementById(id);
      if(node) node.disabled = formLocked;
    });
    // bloquear selección de plan
    document.querySelectorAll(".plan").forEach(p => {
      p.style.pointerEvents = formLocked ? "none" : "auto";
      p.style.opacity = formLocked ? "0.78" : "1";
    });
  }

  async function loadPlans(){
    el("payStatus").textContent = "Cargando planes…";
    const { data, error } = await supabase
      .from("plans")
      .select("id, name, description, price_usd, duration_days, is_active, order_index")
      .eq("is_active", true)
      .order("order_index", { ascending: true });

    if(error){
      el("payStatus").textContent = "Error";
      showMsg("No se pudieron cargar los planes: " + error.message, "bad");
      return;
    }

    plans = data || [];
    renderPlans();
    el("payStatus").textContent = "Listo";
  }

  function renderPlans(){
    const box = el("plansBox");
    box.innerHTML = "";

    plans.forEach((p, idx) => {
      const card = document.createElement("div");
      card.className = "plan" + (idx===0 ? " active" : "");
      if(idx===0) selectedPlanId = p.id;

      card.innerHTML = `
        <div class="icon">
          <img src="assets/plan-${p.id}.png" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"/>
        </div>
        <div style="min-width:0">
          <div class="pname">${p.name}</div>
          <div class="pdesc">${p.description || ""}</div>
        </div>
        <div class="price">US$ ${Number(p.price_usd).toFixed(2)}</div>
      `;

      card.addEventListener("click", () => {
        if(formLocked) return; // ya hay orden creada, no cambiar
        document.querySelectorAll(".plan").forEach(x => x.classList.remove("active"));
        card.classList.add("active");
        selectedPlanId = p.id;
      });

      box.appendChild(card);
    });
  }

  // ---------- Form ----------
  function validateForm(){
    const first_name = (el("first_name").value||"").trim();
    const last_name = (el("last_name").value||"").trim();
    const company_name = (el("company_name").value||"").trim();
    const phone = (el("phone").value||"").trim();
    const email = (el("email").value||"").trim();
    const username = (el("username").value||"").trim();
    const pais = (el("pais").value||"").trim();
    const pass = (el("pass").value||"").trim();
    const pass2 = (el("pass2").value||"").trim();
    const agree = el("agree").checked;

    if(!first_name) return { ok:false, msg:"Completa tu nombre.", type:"bad" };
    if(!last_name) return { ok:false, msg:"Completa tu apellido.", type:"bad" };
    if(!company_name) return { ok:false, msg:"Completa el nombre de la compañía.", type:"bad" };
    if(!phone) return { ok:false, msg:"Completa el teléfono.", type:"bad" };
    if(!email || !email.includes("@")) return { ok:false, msg:"Completa un correo válido.", type:"bad" };
    if(!pass || pass.length < 6) return { ok:false, msg:"La clave debe tener al menos 6 caracteres.", type:"bad" };
    if(pass !== pass2) return { ok:false, msg:"Las claves no coinciden.", type:"bad" };
    if(!selectedPlanId) return { ok:false, msg:"Selecciona un plan.", type:"bad" };
    if(!agree) return { ok:false, msg:"Debes aceptar los términos para continuar.", type:"bad" };

    return {
      ok:true,
      signup:{
        first_name,
        last_name,
        company_name,
        phone,
        email,
        username: username || null,
        country: pais || null,
        password: pass
      }
    };
  }

  function mustBeReadyToPay(){
    const v = validateForm();
    if(!v.ok) return v.msg;
    return "";
  }

  // Demo
  el("demoBtn").addEventListener("click", () => {
    el("first_name").value = "Luisaa";
    el("last_name").value = "Espinalaa";
    el("company_name").value = "Repuesto FinderRDaaa";
    el("phone").value = "+1 809 000 0000";
    el("email").value = `demo+${Date.now()}@mail.com`;
    el("username").value = "luis783aa";
    el("pais").value = "República Dominicana";
    el("pass").value = "123456";
    el("pass2").value = "123456";
    el("agree").checked = true;
    showMsg("Demo listo ✅ Selecciona plan y paga.", "good");
  });

  // ---------- PayPal ----------
  function initPayPal(){
    if(!window.paypal){
      showPayErr("No se pudo cargar PayPal SDK. Verifica el Client ID.");
      return;
    }
    if(paypalRendered) return;
    paypalRendered = true;

    window.paypal.Buttons({
      style: { layout: "vertical" },

      createOrder: async () => {
        const msg = mustBeReadyToPay();
        if(msg){ showMsg(msg, "bad"); showPayErr(msg); throw new Error(msg); }

        // Si ya existe una orden creada en esta sesión, reúsala (evita cobros duplicados por reintentos)
        if(currentOrderId){
          setStep(2);
          el("payHint").textContent = "✅ Orden ya creada. Completa el pago para crear tu cuenta.";
          return currentOrderId;
        }

        showPayErr("");
        showMsg("Listo ✅ Ahora confirma el pago con PayPal…", "good");

        const { signup } = validateForm();

        const { data, error } = await supabase.functions.invoke("paypal-create-order-public", {
          body: { plan_id: selectedPlanId, signup }
        });

        if(error){
          const ctx = error?.context || {};
          const detail = ctx?.body ? JSON.stringify(ctx.body) : "";
          throw new Error((error?.message || "Error al crear orden.") + (detail ? " | " + detail : ""));
        }
        if(!data?.orderID) throw new Error("No se recibió orderID.");

        setStep(2);
        currentOrderId = data.orderID;
        setFormLocked(true);
        el("payHint").textContent = "✅ Orden creada. Completa el pago para crear tu cuenta.";
        return data.orderID;
      },

      onApprove: async (data) => {
        try{
          showPayErr("");
          showMsg("Procesando pago…", "good");

          const v = validateForm();
          if(!v.ok){
            showMsg(v.msg, "bad");
            showPayErr(v.msg);
            throw new Error(v.msg);
          }

          const signup = v.signup;

          const payload = {
            orderID: data.orderID,
            plan_id: selectedPlanId,
            email: signup.email,
            password: signup.password,
            first_name: signup.first_name,
            last_name: signup.last_name,
            company_name: signup.company_name,
            phone: cleanPhone(signup.phone),
            country: signup.country || "República Dominicana",
            username: signup.username || ""
          };

          const { data: out, error } = await supabase.functions.invoke("paypal-capture-order-public", {
            body: payload
          });

          if(error){
            const ctx = error?.context || {};
            const detail = ctx?.body ? JSON.stringify(ctx.body) : "";
            throw new Error((error?.message || "Error al capturar.") + (detail ? " | " + detail : ""));
          }

          if(out?.ok){
            alert("Pago completado ✅ Cuenta activada. Ahora inicia sesión.");
            location.href = "index.html";
            return;
          }

          throw new Error(out?.message || "No se pudo crear cuenta: respuesta inesperada.");
        }catch(e){
          showPayErr("Pago no pudo confirmarse: " + (e?.message || e));
          showMsg("Ocurrió un error al activar la cuenta. Verifica el mensaje y reintenta.", "bad");
        }
      },

      onError: (err) => {
        showPayErr("Error PayPal: " + (err?.message || err));
      }
    }).render("#paypal-button-container");
  }

  // Cargar PayPal SDK (tu client-id)
  // OJO: si tú ya lo cargas en el HTML, puedes borrar este bloque.
  const PAYPAL_CLIENT_ID = window.PAYPAL_CLIENT_ID || "";
  if(PAYPAL_CLIENT_ID){
    const s = document.createElement("script");
    s.src = "https://www.paypal.com/sdk/js?client-id=" + encodeURIComponent(PAYPAL_CLIENT_ID) + "&currency=USD&intent=capture";
    s.onload = () => initPayPal();
    s.onerror = () => showPayErr("No se pudo cargar el SDK de PayPal.");
    document.head.appendChild(s);
  }else{
    // Si no hay variable global, asume que ya está en el HTML
    initPayPal();
  }

  await loadPlans();
</script>
</body>
</html>



